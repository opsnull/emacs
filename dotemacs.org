#+AUTHOR: å¼ ä¿Š(geekard@qq.com)
#+Options: toc:nil h:4
#+STARTUP: overview
#+PROPERTY: header-args:emacs-lisp :tangle yes :results silent :exports code
#+TOC: headlines 4
#+LATEX_COMPILER: xelatex
#+LATEX_CLASS: ctexart
#+LATEX_HEADER: \usepackage{mystyle}
#+OPTIONS: prop:t ^:nil

* menu
:PROPERTIES:
:TOC:      :include all :ignore this
:END:
:CONTENTS:
- [[#install][install]]
- [[#init][init]]
- [[#package][package]]
- [[#tuning][tuning]]
- [[#face][face]]
- [[#font][font]]
- [[#completion][completion]]
- [[#goto][goto]]
- [[#rime][rime]]
- [[#dict][dict]]
- [[#email][email]]
  - [[#gnupg][gnupg]]
  - [[#mbsync][mbsync]]
  - [[#proxychains][proxychains]]
  - [[#mu4e][mu4e]]
  - [[#org-mime][org-mime]]
- [[#org][org]]
  - [[#org][org]]
  - [[#face][face]]
  - [[#fill][fill]]
  - [[#slide][slide]]
  - [[#capture][capture]]
  - [[#image][image]]
  - [[#agenda][agenda]]
  - [[#babel][babel]]
  - [[#notify][notify]]
  - [[#tex][tex]]
  - [[#template][template]]
- [[#pdf][pdf]]
- [[#rss][rss]]
- [[#twitter][twitter]]
- [[#magit][magit]]
- [[#ediff][ediff]]
- [[#coding][coding]]
  - [[#flycheck][flycheck]]
  - [[#lsp][lsp]]
  - [[#python][python]]
    - [[#pyenv][pyenv]]
    - [[#python-mode][python-mode]]
    - [[#lsp-pyright][lsp-pyright]]
  - [[#java][java]]
  - [[#go][go]]
  - [[#markdown][markdown]]
  - [[#dockerfile][dockerfile]]
  - [[#ansible][ansible]]
  - [[#web][web]]
    - [[#typescript][typescript]]
    - [[#js2-mode][js2-mode]]
    - [[#web-mode][web-mode]]
    - [[#prettier][prettier]]
  - [[#yaml][yaml]]
  - [[#devdocs][devdocs]]
  - [[#direnv][direnv]]
  - [[#dap][dap]]
- [[#project][project]]
- [[#treemacs][treemacs]]
- [[#web][web]]
- [[#vterm][vterm]]
- [[#eshell][eshell]]
- [[#tramp][tramp]]
- [[#others][others]]
- [[#refs][refs]]
- [[#archived][archived]]
:END:

* install

ç¼–è¯‘å®‰è£… Emacs 28ï¼š
#+begin_src shell :tangle no
brew unlink emacs-plus@27
brew reinstall gcc libgccjit
brew install emacs-plus@28 --with-no-titlebar --with-no-frame-refocus --with-xwidgets --with-native-comp --with-nobu417-big-sur-icon
brew link --overwrite emacs-plus@28
ln -sf /usr/local/opt/emacs-plus@28/Emacs.app /Applications
#+end_src

å»ºç«‹ç›®å½•:
#+begin_src shell :tangle no
mkdir -p ~/.emacs.d/backup
mkdir -p ~/.emacs.d/autosave
mkdir -p ~/.emacs.d/.cache
mkdir -p ~/.emacs.d/snippets
mkdir -p ~/.emacs.d/.cache/lsp/npm/pyright/lib
mkdir -p ~/.mail/attachments
#+end_src

å®‰è£…å‘½ä»¤å·¥å…·ï¼š
#+begin_src shell :tangle no
# é»˜è®¤å®‰è£…åˆ°å½“å‰å®¶ç›®å½•çš„ pyenv ä¸­ï¼Œå¦‚æœé¡¹ç›®ä½¿ç”¨å…¶å®ƒ pyenv åˆ™éœ€è¦å•ç‹¬å®‰è£…
pip install ipython ansible jieba

# latex ä¸­æ–‡å­—ä½“
git clone https://github.com/googlefonts/noto-cjk.git

which npm || brew install npm
which nvm || brew install nvm
# npm æºå›½å†…é•œåƒ
npm config set registry=http://registry.npm.taobao.org
#+end_src

* init

 =early-init.el= æ˜¯ Emacs å¯åŠ¨æ—¶æœ€å¼€å§‹æ‰§è¡Œçš„æ–‡ä»¶ï¼Œç”±äºå¾ˆå¤šåŒ…è¿˜æ²¡æœ‰åŠ è½½ï¼Œæ‰§è¡Œå¤æ‚é€»è¾‘å¯èƒ½å¯¼è‡´ Emacs å¯åŠ¨æ—¶æ‚„æ— å£°æ¯å¤±è´¥ï¼Œæ‰€
 ä»¥è¯¥æ–‡ä»¶å°½é‡ä»¥å˜é‡å®šä¹‰ä¸ºä¸»ã€‚

#+begin_src emacs-lisp :tangle ~/.emacs.d/early-init.el
;; Emacs 28
(when (fboundp 'native-compile-async)
  (setenv "LIBRARY_PATH"
          (concat (getenv "LIBRARY_PATH")
                  "/usr/local/opt/gcc/lib/gcc/11:/usr/local/opt/gcc/lib/gcc/11/gcc/x86_64-apple-darwin20/11.2.0"))
  (setq native-comp-speed 2)
  (setq native-comp-async-jobs-number 4)
  (setq native-comp-deferred-compilation nil)
  (setq native-comp-deferred-compilation-deny-list '())
  (setq native-comp-async-report-warnings-errors 'silent))

(setq byte-compile-warnings '(cl-functions))

;; å…³é—­ package.el(åç»­ä½¿ç”¨ straight.el)
(setq package-enable-at-startup nil)

(setq debug-on-error t)
(add-hook 'emacs-startup-hook (lambda () (setq debug-on-error nil)))

;; è®¾ç½®ç¼©æ”¾çš„æ¨¡å¼,é¿å… Mac ç³»ç»Ÿæœ€å¤§åŒ–çª—å£åå³è¾¹å’Œä¸‹è¾¹æœ‰ç©ºéš™ã€‚
(setq frame-resize-pixelwise t)

;;(set-frame-parameter (selected-frame) 'fullscreen 'maximized)
;;(add-hook 'after-init-hook #'toggle-frame-fullscreen)

(set-frame-parameter (selected-frame) 'maximized 'fullscreen)
(add-hook 'after-init-hook #'toggle-frame-maximized)

;; ç¬¬ä¸€ä¸ª frame è§„æ ¼
(setq initial-frame-alist '((top . 10 ) (left . 10) (width . 200) (height . 60)))
;; åç»­ frame è§„æ ¼
(setq default-frame-alist '((top . 10 ) (left . 10) (width . 200) (height . 60)))

;; åœ¨å•ç‹¬æ–‡ä»¶ä¿å­˜è‡ªå®šä¹‰é…ç½®
(setq custom-file (expand-file-name "~/.emacs.d/custom.el"))
(add-hook 'after-init-hook (lambda () (when (file-exists-p custom-file) (load custom-file))))

;; æŒ‰ä¸­æ–‡æŠ˜è¡Œ
(setq word-wrap-by-category t)

;; ä¸ªäººä¿¡æ¯
(setq user-full-name "zhangjun")
(setq user-mail-address "geekard@qq.com")

;; Use my email-address for encryption
(setq-default epa-file-encrypt-to user-mail-address)

;; Make sure we always use this
(setq-default epa-file-select-keys nil)

;; ä½¿ç”¨ minibuffer è¾“å…¥ GPG å¯†ç 
(setq-default epa-pinentry-mode 'loopback)

;; åŠ å¯†è®¤è¯ä¿¡æ¯æ–‡ä»¶
(setq auth-sources '("~/.authinfo.gpg"))

(setq auth-source-cache-expiry nil) ;;default is 7200 (2h)
;;(setq auth-source-debug t)

(defun org-clocking-buffer (&rest _))
#+end_src

* package

ä¸º =straight.el= æä¾›è½¯ä»¶åŒ…åˆ—è¡¨çš„ä»“åº“ï¼š
#+begin_src emacs-lisp
(require 'package)
(setq package-archives '(("celpa" . "https://celpa.conao3.com/packages/")
                         ("elpa" . "https://elpa.gnu.org/packages/")
                         ("melpa" . "https://melpa.org/packages/")))
#+end_src

ä½¿ç”¨ =use-package + straight= æ›¿ä»£ Emacs çš„ =package.el=, å®ƒç”¨ =Git checkout + build= æœºåˆ¶å®‰è£…è½¯ä»¶åŒ…ï¼ˆè€Œéç›´æ¥ä»ä»“åº“ä¸‹è½½ï¼‰ï¼š

#+begin_src emacs-lisp
;; åŠ è½½æœ€æ–°ç‰ˆæœ¬å­—èŠ‚ç 
(setq load-prefer-newer t)

;; use-package é»˜è®¤ä½¿ç”¨ straight å®‰è£…åŒ…
(setq straight-use-package-by-default t)
(setq straight-vc-git-default-clone-depth 1)
(setq straight-recipes-gnu-elpa-use-mirror t)
(setq straight-check-for-modifications '(check-on-save find-when-checking watch-files))
(setq straight-check-for-modifications nil)
(setq straight-host-usernames '((github . "opsnull")))

(defvar bootstrap-version)
(let ((bootstrap-file
       (expand-file-name "straight/repos/straight.el/bootstrap.el" user-emacs-directory))
      (bootstrap-version 5))
  (unless (file-exists-p bootstrap-file)
    (with-current-buffer
        (url-retrieve-synchronously
         "https://raw.githubusercontent.com/raxod502/straight.el/develop/install.el"
         'silent 'inhibit-cookies)
      (goto-char (point-max))
      (eval-print-last-sexp)))
  (load bootstrap-file nil 'nomessage))

;; å®‰è£… use-package
(straight-use-package 'use-package)
(setq use-package-verbose t)
(setq use-package-compute-statistics t)

;; use-package æ”¯æŒ :ensure-system-package
(use-package use-package-ensure-system-package)
#+end_src

=exec-path-from-shell= å°† Shell ç¯å¢ƒå˜é‡æ‹·è´åˆ° Emacs ç¯å¢ƒä¸­ï¼Œé¿å…æ‰¾ä¸åˆ°ç”¨æˆ·å‘½ä»¤:
#+begin_src emacs-lisp
(use-package exec-path-from-shell
  ;; å³æ—¶åŠ è½½, å¦åˆ™ä¸ç”Ÿæ•ˆã€‚
  :demand t
  :custom
  (exec-path-from-shell-check-startup-files nil)
  (exec-path-from-shell-variables '("PATH" "MANPATH" "GOPATH" "GOPROXY" "GOPRIVATE"))
  :config
  (when (memq window-system '(mac ns x))
    (exec-path-from-shell-initialize)))
#+end_src

* tuning

#+begin_src emacs-lisp
;; å¢åŠ  IO æ€§èƒ½
(setq read-process-output-max (* 1024 1024))

;; Don't ping things that look like domain names.
(setq ffap-machine-p-known 'reject)

;; Speed up startup
(setq auto-mode-case-fold nil)

;; å¢åŠ é•¿è¡Œå¤„ç†æ€§èƒ½
(setq bidi-inhibit-bpa t)
(setq-default bidi-display-reordering 'left-to-right)
(setq-default bidi-paragraph-direction 'left-to-right)

;; ä¸ç¼©æ”¾ frame
(setq frame-inhibit-implied-resize t)

;; fontify time
(setq jit-lock-defer-time 0.1)
(setq jit-lock-context-time 0.1)

;; Reduce rendering/line scan work for Emacs by not rendering cursors or regions
;; in non-focused windows.
(setq-default cursor-in-non-selected-windows nil)
(setq highlight-nonselected-windows nil)

;; ä½¿ç”¨å­—ä½“ç¼“å­˜ï¼Œé¿å…å¡é¡¿
(setq inhibit-compacting-font-caches t)

;; Garbage Collector Magic Hack
(use-package gcmh
  :demand t
  :init
  ;; Debugï¼šShow garbage collections in minibuffer
  ;;(setq garbage-collection-messages t)
  ;;(setq gcmh-verbose t)
  (setq gcmh-idle-delay 0.5)
  (setq gcmh-high-cons-threshold (* 64 1024 1024))
  (gcmh-mode)
  (gcmh-set-high-threshold))
#+end_src
+ ä¸»è¦å‚è€ƒè‡ª [[https://github.com/hlissner/doom-emacs/blob/develop/core/core.el][doom core.el]]:

* face

#+begin_src emacs-lisp
(tool-bar-mode -1)
(scroll-bar-mode -1)
(menu-bar-mode -1)
;; æŒ‡é’ˆä¸é—ªåŠ¨
(blink-cursor-mode -1)
(set-fringe-mode 10)

(setq inhibit-startup-screen t)
(setq inhibit-startup-message t)
(setq inhibit-startup-echo-area-message t)

(setq initial-major-mode 'fundamental-mode)
(setq initial-scratch-message nil)

;; ä¸Šä¸‹åˆ†å±
(setq split-width-threshold nil)

;; é«˜äº®åŒ¹é…çš„æ‹¬å·
(show-paren-mode t)
(setq show-paren-style 'parentheses)

(setq-default indicate-empty-lines t)
(when (not indicate-empty-lines)
  (toggle-indicate-empty-lines))

;; å¢å¼ºçª—å£èƒŒæ™¯å¯¹æ¯”åº¦
(use-package solaire-mode
  :demand t
  :config (solaire-global-mode +1))

;; Stretch cursor to the glyph width
(setq-default x-stretch-cursor t)

;; ä¸»é¢˜é¢„è§ˆ: https://emacsthemes.com/
(use-package doom-themes
  :demand t
  :custom-face
  (doom-modeline-buffer-file ((t (:inherit (mode-line bold)))))
  :custom
  (doom-themes-enable-bold t)
  (doom-themes-enable-italic t)
  (doom-themes-treemacs-theme "doom-colors")
  ;; pad the mode-line in 4px on each side
  (doom-themes-padded-modeline t)
  :config
  ;;(load-theme 'doom-gruvbox t)
  ;; Enable flashing mode-line on errors
  (doom-themes-visual-bell-config)
  (doom-themes-treemacs-config)
  (doom-themes-org-config))

;; è·Ÿéš Mac è‡ªåŠ¨åˆ‡æ¢æ·±æµ…ä¸»é¢˜
(defun my/load-light-theme () (interactive) (load-theme 'doom-one-light t))
(defun my/load-dark-theme () (interactive) (load-theme 'doom-palenight t))
(add-hook 'ns-system-appearance-change-functions
          (lambda (appearance)
            (pcase appearance
              ('light (my/load-light-theme))
              ('dark (my/load-dark-theme)))))

(display-battery-mode t)
(column-number-mode t)
(size-indication-mode -1)
(display-time-mode t)
(setq display-time-24hr-format t)
(setq display-time-default-load-average nil)
(setq display-time-load-average-threshold 5)
(setq display-time-format "%m/%d[%u]%H:%M")
(setq display-time-day-and-date t)
(setq indicate-buffer-boundaries (quote left))

;; åŠ è½½é¡ºåº: doom-theme -> doom-modeline -> cnfonts -> all-the-icons, å¦åˆ™ doom-modeline å³ä¸‹è§’å†…å®¹ä¼šæº¢å‡ºã€‚
(use-package doom-modeline
  :demand t
  :after(doom-themes)
  :custom
  ;; ä¸æ˜¾ç¤ºæ¢è¡Œå’Œç¼–ç ï¼ˆèŠ‚çœç©ºé—´ï¼‰
  (doom-modeline-buffer-encoding nil)
  ;; ä½¿ç”¨ HUD æ˜¾å¼å…‰æ ‡ä½ç½®(é»˜è®¤æ˜¯ bar)
  (doom-modeline-hud t)
  ;; æ˜¾ç¤ºè¯­è¨€ç¯å¢ƒç‰ˆæœ¬ï¼ˆå¦‚ go/python)
  (doom-modeline-env-version t)
  ;; ä¸æ˜¾ç¤ºé¡¹ç›®ç›®å½•ï¼Œå¦åˆ™ TRAMP å˜æ…¢ï¼šhttps://github.com/bbatsov/projectile/issues/657
  ;;(doom-modeline-buffer-file-name-style 'file-name)
  (doom-modeline-buffer-file-name-style 'truncate-except-project)
  (doom-modeline-vcs-max-length 20)
  (doom-modeline-github nil)
  (doom-modeline-height 2)
  :init
  (doom-modeline-mode 1)
  ;; :config
  ;; (doom-modeline-def-modeline 'main
  ;;   ;; left-hand segment list, å»æ‰ remote-hostï¼Œé¿å…ç¼–è¾‘è¿œç¨‹æ–‡ä»¶æ—¶å¡ä½ã€‚
  ;;   '(bar workspace-name window-number modals matches buffer-info buffer-position word-count parrot selection-info)
  ;;   ;; right-hand segment listï¼Œå°¾éƒ¨å¢åŠ ç©ºæ ¼ï¼Œé¿å…æº¢å‡ºã€‚
  ;;   '(objed-state misc-info battery grip debug repl lsp minor-modes input-method major-mode process vcs checker " "))
  )

(use-package dashboard
  :demand t
  :after (projectile)
  :config
  (setq dashboard-banner-logo-title "Happy hacking, Zhang Jun - Emacs â™¥ you!")
  ;;(setq dashboard-startup-banner (expand-file-name "~/.emacs.d/myself.png"))
  ;;(setq dashboard-projects-backend 'project-el)
  (setq dashboard-projects-backend #'projectile)
  (setq dashboard-center-content t)
  (setq dashboard-set-heading-icons t)
  (setq dashboard-set-navigator t)
  (setq dashboard-set-file-icons t)
  (setq dashboard-items '((recents . 10) (projects . 8) (bookmarks . 3) (agenda . 3)))
  (dashboard-setup-startup-hook))

;; æ˜¾ç¤ºå…‰æ ‡ä½ç½®
(use-package beacon :config (beacon-mode 1))

;; åˆ‡æ¢åˆ°é€æ˜èƒŒæ™¯(çœŸé€æ˜!)
(defun my/toggle-transparency ()
  (interactive)
  (set-frame-parameter (selected-frame) 'alpha '(90 . 90))
  (add-to-list 'default-frame-alist '(alpha . (90 . 90))))
#+end_src
+ æ›´æ–° fire-code å­—ä½“ï¼š =M-x fira-code-mode-install-fonts=
+ æ›´æ–° icon å­—ä½“ï¼š =M-x all-the-icons-install-fonts=

* font

+  ä¸­æ–‡ï¼šæ›´çº±ç­‰å®½é»‘ä½“ Sarasa Mono SC: https://github.com/be5invis/Sarasa-Gothic
+  è‹±æ–‡: JuliaMono: https://juliamono.netlify.app/download/
+  è‹±æ–‡ï¼šIosevka SS14(Monospace & JetBrains Mono Style): https://github.com/be5invis/Iosevka
+  èŠ±åœ’æ˜æœï¼šHanaMinBï¼šhttp://fonts.jp/hanazono/
+  Emacs é»˜è®¤åå¤‡å­—ä½“ï¼šSymbola: https://dn-works.com/ufas/

#+begin_src emacs-lisp

(use-package cnfonts
  :demand t
  :ensure-system-package
  ("/Users/zhangjun/Library/Fonts/JuliaMono-Regular.ttf" .
   "brew tap homebrew/cask-fonts; brew install --cask font-juliamono")
  :after (doom-modeline)
  :init
  (setq cnfonts-personal-fontnames '(("JuliaMono" "Iosevka SS14" "Fira Code") ("Sarasa Mono SC") ("HanaMinB")))
  ;; å…è®¸å­—ä½“ç¼©æ”¾(éƒ¨åˆ†ä¸»é¢˜å¦‚ lenven ä¾èµ–)
  (setq cnfonts-use-face-font-rescale t)
  :config
  ;; è‡ªå®šä¹‰ emoji å’Œ symbol å­—ä½“, å¿…é¡»é€šè¿‡ cnfonts-set-font-finish-hook è°ƒç”¨æ‰ä¼šç”Ÿæ•ˆã€‚
  (defun my/set-fonts (&optional font)
    (setq use-default-font-for-symbols nil)
    (set-fontset-font t '(#x1f000 . #x1faff) (font-spec :family "Apple Color Emoji"))
    (set-fontset-font t 'symbol (font-spec :family "Apple Symbols" :size 20)))
  (add-hook 'cnfonts-set-font-finish-hook 'my/set-fonts)
  (cnfonts-enable))

(use-package all-the-icons
  :demand t
  :after (cnfonts))

;; fire-code-mode å’Œ set-fontset-font åªèƒ½åœ¨ GUI æ¨¡å¼ä¸‹ä½¿ç”¨ã€‚
(when (display-graphic-p)
  (use-package fira-code-mode
    :custom
    (fira-code-mode-disabled-ligatures '("[]" "#{" "#(" "#_" "#_(" "x"))
    :hook prog-mode))
#+end_src
+ æŸ¥çœ‹ emacs æ”¯æŒçš„å­—ä½“ï¼š =(print (font-family-list))=;

* completion

å¢é‡è¡¥å…¨ï¼š
#+begin_src emacs-lisp
(defun my/minibuffer-backward-kill (arg)
  "When minibuffer is completing a file name delete up to parent folder, otherwise delete a word"
  (interactive "p")
  (if minibuffer-completing-file-name
      (if (string-match-p "/." (minibuffer-contents))
          (zap-up-to-char (- arg) ?/)
        (delete-minibuffer-contents))
    (backward-kill-word arg)))

(use-package vertico
  :demand t
  :bind
  (:map vertico-map
        :map minibuffer-local-map
        ("M-h" . my/minibuffer-backward-kill))
  :config
  ;; Do not allow the cursor in the minibuffer prompt
  (setq minibuffer-prompt-properties '(read-only t cursor-intangible t face minibuffer-prompt))
  ;; Emacs 28: Hide commands in M-x which do not work in the current mode.
  ;; Vertico commands are hidden in normal buffers.
  (setq read-extended-command-predicate #'command-completion-default-include-p)
  ;; Enable recursive minibuffers
  (setq enable-recursive-minibuffers t)
  (setq vertico-count 20)
  ;;(setq vertico-cycle t)
  (vertico-mode 1))

(use-package posframe :demand)
(use-package vertico-posframe
  :straight (vertico-posframe :host github :repo "tumashu/vertico-posframe")
  :config
  (setq vertico-posframe-parameters
        '((left-fringe . 8)
          (right-fringe . 8)
          ;;(alpha . 80)
          ))
  ;; åœ¨å…‰æ ‡ä½ç½®çš„ä¸Šæ–¹æ˜¾ç¤º posframe, é¿å…é®ä½å…‰æ ‡ä¸‹æ–¹çš„å†…å®¹
  (defun my/posframe-poshandler-p0.5p0-to-f0.5p1 (info)
    (let ((x (car (posframe-poshandler-p0.5p0-to-f0.5f0 info)))
          ;; ç¬¬ä¸‰ä¸ªå‚æ•° t è¡¨ç¤º upward
          (y (cdr (posframe-poshandler-point-1 info nil t))))
      (cons x y)))
  (setq vertico-posframe-poshandler 'my/posframe-poshandler-p0.5p0-to-f0.5p1)
  (vertico-posframe-mode 1))

;; ä½¿ç”¨ orderless è¿‡æ»¤å€™é€‰è€…, æ”¯æŒå¤šç§ dispatch ç»„åˆ, å¦‚ !zhangjun hang$
;; Recognizes the following patterns:
;; * ~flex flex~
;; * =literal literal=
;; * %char-fold char-fold%
;; * `initialism initialism`
;; * !without-literal without-literal!
;; * .ext (file extension)
;; * regexp$ (regexp matching at end)
;; https://github.com/minad/consult/wiki
(use-package orderless
  :demand t
  :config
  (defvar +orderless-dispatch-alist
    '((?% . char-fold-to-regexp)
      (?! . orderless-without-literal)
      (?`. orderless-initialism)
      (?= . orderless-literal)
      (?~ . orderless-flex)))
  (defun +orderless-dispatch (pattern index _total)
    (cond
     ;; Ensure that $ works with Consult commands, which add disambiguation suffixes
     ((string-suffix-p "$" pattern)
      `(orderless-regexp . ,(concat (substring pattern 0 -1) "[\x100000-\x10FFFD]*$")))
     ;; File extensions
     ((and
       ;; Completing filename or eshell
       (or minibuffer-completing-file-name
           (derived-mode-p 'eshell-mode))
       ;; File extension
       (string-match-p "\\`\\.." pattern))
      `(orderless-regexp . ,(concat "\\." (substring pattern 1) "[\x100000-\x10FFFD]*$")))
     ;; Ignore single !
     ((string= "!" pattern) `(orderless-literal . ""))
     ;; Prefix and suffix
     ((if-let (x (assq (aref pattern 0) +orderless-dispatch-alist))
          (cons (cdr x) (substring pattern 1))
        (when-let (x (assq (aref pattern (1- (length pattern))) +orderless-dispatch-alist))
          (cons (cdr x) (substring pattern 0 -1)))))))

  ;; Define orderless style with initialism by default
  (orderless-define-completion-style +orderless-with-initialism
    (orderless-matching-styles '(orderless-initialism orderless-literal orderless-regexp)))

  (setq completion-styles '(orderless)
        completion-category-defaults nil
        completion-category-overrides
        '((file (styles partial-completion))
          (command (styles +orderless-with-initialism))
          (variable (styles +orderless-with-initialism))
          (symbol (styles +orderless-with-initialism)))
        ;; allow escaping space with backslash!
        orderless-component-separator #'orderless-escapable-split-on-space
        orderless-style-dispatchers '(+orderless-dispatch)))

(use-package consult
  :ensure-system-package (rg . ripgrep)
  :bind
  (;; C-c bindings (mode-specific-map)
   ("C-c h" . consult-history)
   ("C-c m" . consult-mode-command)
   ("C-c b" . consult-bookmark)
   ("C-c k" . consult-kmacro)
   ;; C-x bindings (ctl-x-map)
   ("C-x M-:" . consult-complex-command)
   ("C-x b" . consult-buffer)
   ("C-x 4 b" . consult-buffer-other-window)
   ("C-x 5 b" . consult-buffer-other-frame)
   ;; Custom M-# bindings for fast register access
   ("M-#" . consult-register-load)
   ("M-'" . consult-register-store)
   ("C-M-#" . consult-register)
   ;; Other custom bindings
   ("M-y" . consult-yank-pop)
   ("<help> a" . consult-apropos)
   ;; M-g bindings (goto-map)
   ("M-g e" . consult-compile-error)
   ("M-g f" . consult-flycheck)
   ("M-g g" . consult-goto-line)
   ("M-g M-g" . consult-goto-line)
   ("M-g o" . consult-outline)
   ("M-g m" . consult-mark)
   ("M-g k" . consult-global-mark)
   ("M-g i" . consult-imenu)
   ("M-g I" . consult-project-imenu)
   ;; M-s bindings (search-map)
   ;; consult-find ä¸æ”¯æŒé¢„è§ˆ
   ("M-s f" . consult-find)
   ("M-s L" . consult-locate)
   ("M-s F" . consult-locate)
   ("M-s g" . consult-grep)
   ("M-s G" . consult-git-grep)
   ("M-s r" . consult-ripgrep)
   ("M-s l" . consult-line)
   ("M-s L" . consult-line-multi)
   ("M-s m" . consult-multi-occur)
   ("M-s k" . consult-keep-lines)
   ("M-s u" . consult-focus-lines)
   ;; Isearch integration
   ("M-s e" . consult-isearch)
   :map isearch-mode-map
   ("M-e" . consult-isearch)
   ("M-s e" . consult-isearch)
   ("M-s l" . consult-line))
  :hook
  (completion-list-mode . consult-preview-at-point-mode)
  :init
  ;; å¦‚æœæœç´¢å­—ç¬¦å°‘äº 5ï¼Œå¯ä»¥æ·»åŠ åç¼€#å¼€å§‹æœç´¢ï¼Œå¦‚ #gr#ã€‚
  (setq consult-async-min-input 5)
  (setq consult-async-refresh-delay 0.15)
  (setq consult-async-input-debounce 0.1)
  (setq consult-async-input-throttle 0.2)
  ;; é¢„è§ˆ register
  (setq register-preview-delay 0.1
        register-preview-function #'consult-register-format)
  (advice-add #'register-preview :override #'consult-register-window)

  ;; Optionally replace `completing-read-multiple' with an enhanced version.
  (advice-add #'completing-read-multiple :override #'consult-completing-read-multiple)

  ;; Use Consult to select xref locations with preview
  (setq xref-show-xrefs-function #'consult-xref
        xref-show-definitions-function #'consult-xref)
  :config
  ;; æŒ‰ C-l æ¿€æ´»é¢„è§ˆï¼Œå¦åˆ™ buffer åˆ—è¡¨ä¸­æœ‰å¤§æ–‡ä»¶æˆ–è¿œç¨‹æ–‡ä»¶æ—¶ä¼šå¡ä½ã€‚
  (setq consult-preview-key (kbd "C-l"))
  (setq consult-narrow-key "<")

  (autoload 'projectile-project-root "projectile")
  (setq consult-project-root-function #'projectile-project-root))

;;å¦‚æœæ˜¯è¿œç¨‹ç›®å½•æ–‡ä»¶ï¼Œç›´æ¥è¿”å› nilï¼ˆä½¿ç”¨ default-directory)ï¼Œ é˜²æ­¢å¡ä¸»ã€‚
;; (setq consult-project-root-function
;;       (lambda ()
;;         (unless (file-remote-p default-directory)
;;           (when-let (project (project-current))
;;             (car (project-roots project)))))))

(use-package marginalia
  :init
  ;; æ˜¾ç¤ºç»å¯¹æ—¶é—´
  (setq marginalia-max-relative-age 0)
  (marginalia-mode)
  :config
  ;; ä¸ç»™ file åŠ æ³¨é‡Šï¼Œé˜²æ­¢ TRAMP å˜æ…¢ã€‚
  (setq marginalia-annotator-registry
        (assq-delete-all 'file marginalia-annotator-registry))
  (setq marginalia-annotator-registry
        (assq-delete-all 'project-file marginalia-annotator-registry)))

(use-package embark
  :init
  ;; Optionally replace the key help with a completing-read interface
  (setq prefix-help-command #'embark-prefix-help-command)
  :config
  (setq embark-prompter 'embark-keymap-prompter)
  ;; Hide the mode line of the Embark live/completions buffers
  (add-to-list 'display-buffer-alist
               '("\\`\\*Embark Collect \\(Live\\|Completions\\)\\*"
                 nil
                 (window-parameters (mode-line-format . none))))
  :bind
  (("C-;" . embark-act)
   ("C-h B" . embark-bindings)))

(use-package embark-consult
  :after (embark consult)
  :demand t ;; only necessary if you have the hook below
  :hook
  ;; if you want to have consult previews as you move around an auto-updating embark collect buffer
  (embark-collect-mode . consult-preview-at-point-mode))

(use-package consult-dir
  :bind (("C-x C-d" . consult-dir)
         :map minibuffer-local-completion-map
         ("C-x C-d" . consult-dir)
         ("C-x C-j" . consult-dir-jump-file)))
#+end_src
+ ä½¿ç”¨ gnu find å‘½ä»¤, éœ€è¦åŠ ç¯å¢ƒå˜é‡ ~export PATH="/usr/local/opt/findutils/libexec/gnubin:$PATH"~

è‡ªåŠ¨è¡¥å…¨ï¼š
#+begin_src emacs-lisp
;; æ¥è‡ª https://github.com/company-mode/company-mode/blob/master/company.el#L2779
(defun company-doc-buffer (&optional string)
  (with-current-buffer (get-buffer-create "*company-documentation*")
    (erase-buffer)
    (fundamental-mode)
    (when string
      (save-excursion
        (insert string)
        (visual-line-mode)))
    (current-buffer)))

(use-package corfu
  :demand
  :straight '(corfu :host github :repo "minad/corfu")
  :custom
  (corfu-cycle t)                ;; Enable cycling for `corfu-next/previous'
  (corfu-auto t)                 ;; Enable auto completion
  (corfu-commit-predicate nil)   ;; Do not commit selected candidates on next input
  (corfu-quit-at-boundary nil)     ;; Automatically quit at word boundary
  (corfu-quit-no-match t)        ;; Automatically quit if there is no match
  (corfu-scroll-margin 5)        ;; Use scroll margin
  (corfu-preview-current t)
  (corfu-auto-prefix 3)
  :config
  (corfu-global-mode))

;; Dabbrev works with Corfu
(use-package dabbrev
  :demand
  :bind
  (("M-/" . dabbrev-completion)
   ("C-M-/" . dabbrev-expand)))

;; TAB cycle if there are only few candidates
(setq completion-cycle-threshold 3)
(setq completion-ignore-case t)
;; Enable indentation+completion using the TAB key.
;; `completion-at-point' is often bound to M-TAB.
(setq tab-always-indent 'complete)
(setq c-tab-always-indent 'complete)

(use-package kind-icon
  :straight '(kind-icon :host github :repo "jdtsmith/kind-icon")
  :after corfu
  :demand
  :custom
  ;; to compute blended background correctly
  (kind-icon-default-face 'corfu-background)
  :config
  (add-to-list 'corfu-margin-formatters #'kind-icon-margin-formatter))
#+end_src

#+begin_src emacs-lisp :tangle no
(use-package company
  :bind
  (:map company-mode-map
        ([remap completion-at-point] . company-complete)
        :map company-active-map
        ([escape] . company-abort)
        ("C-p"     . company-select-previous)
        ("C-n"     . company-select-next)
        ("C-s"     . company-filter-candidates)
        ([tab]     . company-complete-common-or-cycle)
        ([backtab] . company-select-previous-or-abort)
        :map company-search-map
        ([escape] . company-search-abort)
        ("C-p"    . company-select-previous)
        ("C-n"    . company-select-next))
  :custom
  ;; trigger completion immediately.
  (company-idle-delay 0)
  (company-echo-delay 0)
  ;; allow input string that do not match candidate words
  ;; å¼€å¯åæœ‰å¤§é‡ä¸åŒ¹é…çš„å€™é€‰æƒ…å†µï¼Œæ•…å…³é—­
  ;;(company-require-match nil)
  ;; number the candidates (use M-1, M-2 etc to select completions).
  (company-show-numbers t)
  ;; pop up a completion menu by tapping a character
  (company-minimum-prefix-length 1)
  (company-tooltip-limit 14)
  (company-tooltip-align-annotations t)
  ;; Only search the current buffer for `company-dabbrev' (a backend that
  ;; suggests text your open buffers). This prevents Company from causing
  ;; lag once you have a lot of buffers open.
  (company-dabbrev-other-buffers nil)
  ;; Make `company-dabbrev' fully case-sensitive, to improve UX with
  ;; domain-specific words with particular casing.
  (company-dabbrev-ignore-case nil)
  ;; Don't downcase the returned candidates.
  (company-dabbrev-downcase nil)
  ;; å€™é€‰æ¡†å®½åº¦
  (company-tooltip-minimum-width 70)
  (company-tooltip-maximum-width 100)
  (company-global-modes '(not message-mode help-mode eshell-mode))
  ;; è¡¥å…¨åç«¯
  (company-backends '(company-capf
                      (company-dabbrev-code company-keywords company-files)
                      company-dabbrev))
  :config
  ;; é«˜äº®å€™é€‰è€…ï¼ˆorderless æ’åºï¼‰
  (defun just-one-face (fn &rest args)
    (let ((orderless-match-faces [completions-common-part]))
      (apply fn args)))
  (advice-add 'company-capf--candidates :around #'just-one-face)
  (global-company-mode t))

(use-package company-emoji
  :demand t
  :after (company)
  :config
  (company-emoji-init)
  (add-to-list 'company-backends 'company-emoji))

(use-package restclient
  :mode ("\\.http\\'" . restclient-mode)
  :config
  (use-package restclient-test :diminish :hook (restclient-mode . restclient-test-mode))

  (with-eval-after-load 'company
    (use-package company-restclient
      :defines company-backends
      :init (add-to-list 'company-backends 'company-restclient))))

(use-package company-ansible
  :after (ansible)
  :config
  (add-hook 'ansible-hook (lambda() (add-to-list 'company-backends 'company-ansible))))
#+end_src


ç‰‡æ®µï¼š
#+begin_src emacs-lisp
;;(shell-command "mkdir -p ~/.emacs.d/snippets")
(use-package yasnippet
  :demand t
  :commands yas-minor-mode
  :config
  ;;(global-set-key (kbd "C-c s") 'company-yasnippet)
  (add-to-list 'yas-snippet-dirs "~/.emacs.d/snippets")
  (yas-global-mode 1))
(use-package yasnippet-snippets :demand t)
(use-package yasnippet-classic-snippets :demand t)
#+end_src
+ å…³é—­ company-snippets å€™é€‰æç¤ºï¼Œæ‰‹åŠ¨è§¦å‘ snippets è¡¥å…¨ï¼ˆ =C-c s= ï¼‰ï¼Œå¦åˆ™æç¤ºå¤ªå¤šçš„ snippets å€™é€‰é¡¹ã€‚

* goto

è·³è½¬åˆ°ä¸Šæ¬¡ä¿®æ”¹ä½ç½®ï¼š
#+begin_src emacs-lisp
(use-package goto-chg
  :config
  (global-set-key (kbd "C->") 'goto-last-change)
  (global-set-key (kbd "C-<") 'goto-last-change-reverse))
#+end_src

è·³è½¬åˆ°ç‰¹å®šå­—ç¬¦æˆ–è¡Œï¼š
#+begin_src emacs-lisp
(use-package avy
  :config
  (setq avy-all-windows nil)
  (setq avy-background t)
  :bind
  ("M-g c" . avy-goto-char-2)
  ("M-g l" . avy-goto-line))
#+end_src

è·³è½¬åˆ°æŒ‡å®šçª—å£ï¼š
#+begin_src emacs-lisp
(use-package ace-window
  :init
  ;; ä½¿ç”¨å­—æ¯è€Œéæ•°å­—æ ‡è®°çª—å£ï¼Œä¾¿äºè·³è½¬
  (setq aw-keys '(?a ?s ?d ?f ?g ?h ?j ?k ?l))
  :config
  ;; è®¾ç½®ä¸º frame åä¼šå¿½ç•¥ treemacs frameï¼Œå¦åˆ™å³ä½¿ä¸¤ä¸ªçª—å£æ—¶ä¹Ÿä¼šæç¤ºé€‰æ‹©
  (setq aw-scope 'frame)
  ;; æ€»æ˜¯æç¤ºçª—å£é€‰æ‹©, è¿™æ ·å³ä½¿ä¸¤ä¸ªçª—å£ä¹Ÿå¯ä»¥æ‰§è¡Œä¸­é—´å‘½ä»¤
  ;;(setq aw-dispatch-always t)
  ;; modeline æ˜¾ç¤ºçª—å£ç¼–å·
  ;;(ace-window-display-mode +1)
  (global-set-key (kbd "M-o") 'ace-window)
  ;; è°ƒå¤§çª—å£é€‰æ‹©å­—ç¬¦
  (custom-set-faces
   '(aw-leading-char-face
     ((t (:inherit ace-jump-face-foreground :foreground "red" :height 2.0))))))
#+end_src

* rime

Mac ç³»ç»Ÿå®‰è£… RIME è¾“å…¥æ³•ï¼š
1. ä¸‹è½½ é¼ é¬šç®¡ Squirrel [[https://rime.im/download/]]ï¼Œå®ƒåŒ…å«è¾“å…¥æ³•æ–¹æ¡ˆã€‚
2. ä¸‹è½½ Squirrel ä½¿ç”¨çš„ [[https://github.com/rime/librime/releases][librime]] ï¼ˆä» Squirrel çš„ [[https://github.com/rime/squirrel/blob/master/CHANGELOG.md][CHANGELOG]] ä¸­è·å–ç‰ˆæœ¬ï¼‰
3. é‡æ–°ç™»å½•ç”¨æˆ·ï¼Œç„¶åå°±å¯ä»¥ä½¿ç”¨ =Control-+= æ¥è§¦å‘ RIME è¾“å…¥æ³•äº†ã€‚
4. åœ¨ Mac çš„è¾“å…¥æ³•é…ç½®ç¨‹åºä¸­å°† é¼ é¡»ç®¡ å»æ‰ï¼Œåªä¿ç•™ ABC å’Œæœç‹—è¾“å…¥æ³•ï¼›
5. éƒ¨ç½²ç”Ÿæ•ˆ,:
   + å¦‚æœä¿®æ”¹äº† =~/Library/Rime= ä¸‹çš„é…ç½®ï¼Œå¿…é¡»ç‚¹å‡»é¼ é¡»ç®¡çš„ â€œé‡æ–°éƒ¨ç½²â€ æ‰èƒ½ç”Ÿæ•ˆã€‚
   + å¯¹äº emacs-rimeï¼Œå¦‚æœä¿®æ”¹äº† =~/Library/Rime= ä¸‹çš„é…ç½®ï¼Œéœ€è¦æ‰§è¡Œ =M-x rime-deploy= ç”Ÿæ•ˆï¼›

ä¸‹è½½ librime åº“, emacs-rime ä½¿ç”¨å®ƒä¸ç³»ç»Ÿçš„ RIME äº¤äº’ï¼š
#+Begin_src bash :tangle no
curl -L -O https://github.com/rime/librime/releases/download/1.7.2/rime-1.7.2-osx.zip
unzip rime-1.7.2-osx.zip -d ~/.emacs.d/librime
rm -rf rime-1.7.2-osx.zip
# å¦‚æœ MacOS Gatekeeper é˜»æ­¢ç¬¬ä¸‰æ–¹è½¯ä»¶è¿è¡Œï¼Œå¯ä»¥æš‚æ—¶å…³é—­å®ƒï¼š
sudo spctl --master-disable
# åç»­å†å¼€å¯ï¼šsudo spctl --master-enable
#+end_src

ä» [[https://github.com/fkxxyz/rime-cloverpinyin][rime-cloverpinyin]] ä¸‹è½½æœ€æ–°çš„è¯åº“æ–¹æ¡ˆå®‰è£…åŒ…ï¼ˆæ–‡ä»¶åä¸åŒ…å« build), è§£å‹åé…ç½®æ‹·è´åˆ° =~/Library/Rime= ç›®å½•ã€‚

é…ç½® Emacs:
#+begin_src emacs-lisp
(use-package rime
  ;; ä¸ºç¨‹åºè®¾ç½®é»˜è®¤ç³»ç»Ÿè¾“å…¥æ³•
  :ensure-system-package ("/Applications/SwitchKey.app" . "brew install --cask switchkey")
  :custom
  (rime-user-data-dir "~/Library/Rime/")
  (rime-librime-root "~/.emacs.d/librime/dist")
  (rime-emacs-module-header-root "/usr/local/Cellar/emacs-plus@28/28.0.50/include")
  :bind
  ( :map rime-active-mode-map
    ;; å¼ºåˆ¶åˆ‡æ¢åˆ°è‹±æ–‡æ¨¡å¼ï¼Œç›´åˆ°æŒ‰å›è½¦ã€‚
    ("M-j" . 'rime-inline-ascii)
    :map rime-mode-map
    ;; ä¸­è‹±æ–‡åˆ‡æ¢
    ("C-=" . 'rime-send-keybinding)
    ;; è¾“å…¥æ³•èœå•
    ("C-+" . 'rime-send-keybinding)
    ;; ä¸­è‹±æ–‡æ ‡ç‚¹åˆ‡æ¢
    ("C-." . 'rime-send-keybinding)
    ;; å…¨åŠè§’åˆ‡æ¢
    ("C-," . 'rime-send-keybinding)
    ;; å¼ºåˆ¶åˆ‡æ¢åˆ°ä¸­æ–‡æ¨¡å¼
    ("M-j" . 'rime-force-enable))
  :config
  ;; Emacs will automatically set default-input-method to rfc1345 if locale is
  ;; UTF-8. https://github.com/purcell/emacs.d/issues/320
  ;; ä½¿ç”¨ [SwitchKey](https://github.com/itsuhane/SwitchKey) å°† Emacs çš„é»˜è®¤ç³»ç»Ÿè¾“å…¥æ³•è®¾ç½®ä¸ºè‹±æ–‡ï¼Œé¿å…å¹²æ‰° RIMEã€‚
  (add-hook 'emacs-startup-hook (lambda () (setq default-input-method "rime")))
  ;; åˆ‡æ¢åˆ° vterm-mode ç±»å‹å¤–çš„ buffer æ—¶æ¿€æ´» rime è¾“å…¥æ³•ã€‚
  (defadvice switch-to-buffer (after activate-input-method activate)
    (if (string-match "vterm-mode" (symbol-name major-mode))
        (activate-input-method nil)
      (activate-input-method "rime")))
  ;; modline è¾“å…¥æ³•å›¾æ ‡é«˜äº®, ç”¨æ¥åŒºåˆ†ä¸­è‹±æ–‡è¾“å…¥çŠ¶æ€
  (setq mode-line-mule-info '((:eval (rime-lighter))))
  ;; support shift-l, shift-r, control-l, control-r, åªæœ‰å½“ä½¿ç”¨ç³»ç»Ÿ RIME è¾“å…¥æ³•æ—¶æ‰æœ‰æ•ˆã€‚
  (setq rime-inline-ascii-trigger 'shift-l)
  ;; ä¸´æ—¶è‹±æ–‡æ¨¡å¼
  (setq rime-disable-predicates
        '(rime-predicate-ace-window-p
          rime-predicate-hydra-p
          rime-predicate-current-uppercase-letter-p
          rime-predicate-after-alphabet-char-p
          rime-predicate-prog-in-code-p
          rime-predicate-after-ascii-char-p))
  (setq rime-posframe-properties (list :font "Sarasa Gothic SC" :internal-border-width 6))
  (setq rime-show-candidate 'posframe))
#+end_src

RIME è¾“å…¥æ³•è‡ªå®šä¹‰ç¼ºçœé…ç½®ä¸­æ–‡ï¼š
#+begin_src yaml :tangle ~/Library/Rime/default.custom.yaml
patch:
  schema_list:
  - schema: clover  # ä½¿ç”¨ clover è¾“å…¥æ³•æ–¹æ¡ˆ
  menu/page_size: 9
  ascii_composer/good_old_caps_lock: true
  ascii_composer/switch_key:
    Caps_Lock: commit_code
    Shift_L: inline_ascii
    Shift_R: commit
    Control_L: commit_code
    Control_R: commit_code
  switcher/hotkeys:
  - F4
  - "Control+plus" # ä½¿ç”¨ C-+ è°ƒå‡ºè¾“å…¥æ³•èœå•
  key_binder/bindings:
  - { when: composing, accept: ISO_Left_Tab, send: Page_Up }
  - { when: composing, accept: Shift+Tab, send: Page_Up }
  - { when: composing, accept: Tab, send: Page_Down }
  - { when: has_menu, accept: equal, send: Page_Down }
  - { when: has_menu, accept: bracketright, send: Page_Down }
  - { when: paging, accept: minus, send: Page_Up }                 # ä¸Šä¸€é¡µ
  - { when: paging, accept: bracketleft, send: Page_Up }           # ä¸‹ä¸€é¡µ
  - { when: always, accept: "Control+equal", toggle: ascii_mode}   # ä¸­è‹±æ–‡åˆ‡æ¢
  - { when: always, accept: "Control+period", toggle: ascii_punct} # ä¸­è‹±æ–‡æ ‡ç‚¹åˆ‡æ¢
  - { when: always, accept: "Control+comma", toggle: full_shape}   # å…¨è§’/åŠè§’åˆ‡æ¢
# æ›´å¤šå¿«æ·é”®å‚è€ƒ: https://github.com/Iorest/rime-setting/blob/master/default.custom.yaml
#+end_src

ä¸‰å¶è‰è¾“å…¥æ–¹æ¡ˆ(clover) é…ç½®:
#+begin_src yaml :tangle ~/Library/Rime/clover.custom.yaml
patch:
  switches:
  - name: zh_simp_s2t
    reset: 0
    states: [ ç®€, ç¹ ]
  - name: emoji_suggestion
    reset: 0   # ä¸æç¤ºè¾“å‡º emoji å­—ä½“
    states: [ "ğŸˆšï¸ï¸\uFE0E", "ğŸˆ¶ï¸ï¸\uFE0F" ]
  - name: symbol_support
    reset: 0 # å®‰è£…åŒ…ä¸­é»˜è®¤ä¸º 1, å¿…é¡»è®¾ç½®ä¸º 0, å¦åˆ™æ¿€æ´»è¾“å…¥æ³•å emacs å¡æ­»ã€‚
    states: [ "æ— ç¬¦", "ç¬¦" ]
  - name: ascii_punct
    reset: 0
    states: ["ã€‚ï¼Œ", ".,"]
  - name: full_shape
    reset: 0
    states: [ åŠ, å…¨ ]
  - name: ascii_mode
    reset: 0
    states: [ ä¸­, è‹± ]
  speller:
    algebra:
    - erase/^xx$/                      # ç¬¬ä¸€è¡Œä¿ç•™
    - derive/^([zcs])h/$1/             # zh, ch, sh => z, c, s
    - derive/^([zcs])([^h])/$1h$2/     # z, c, s => zh, ch, sh
    - derive/^n/l/                     # n => l
    - derive/^l/n/                     # l => n
    - derive/([ei])n$/$1ng/            # en => eng, in => ing
    - derive/([ei])ng$/$1n/            # eng => en, ing => in
    - derive/ao$/oa/                   # oa = ao
    - derive/([iu])a(o|ng?)$/a$1$2/    # aio = iao; aing = iang; aung = uang
    - derive/([aeiou])ng$/$1gn/        # gn = ng
    - derive/un$/uen/    # uen = un
    - derive/ui$/uei/    # uei = ui
    - derive/iu$/iou/    # iou = ui
    - derive/tie$/tei/   # tei = tie
    - derive/i$/ii/      # ii = i
    - derive/u$/uu/      # ui = u
#+end_src

ä¸‹è½½[[https://github.com/felixonmars/fcitx5-pinyin-zhwiki/releases][è‚¥çŒ«ä¸­æ–‡ç»´åŸºç™¾ä¸‡å¤§è¯åº“ï¼ˆfelixonmars/fcitx5-pinyin-zhwiki)]], æ”¾åˆ° =~/Library/Rime= ç›®å½•ï¼š
#+begin_src shell :tangle no
cd ~/Library/Rime
wget https://github.com/felixonmars/fcitx5-pinyin-zhwiki/releases/download/0.2.3/zhwiki-20210911.dict.yaml
#+end_src

ä¿®æ”¹æ–‡ä»¶ =~/Library/Rime/clover.dict.yaml=, å†…å®¹å¦‚ä¸‹ï¼š
#+begin_src yaml :tangle ~/Library/Rime/clover.dict.yaml
name: clover
version: "1"
sort: by_weight

import_tables:
  - clover.base
  - clover.phrase
  - zhwiki-20210911
  - THUOCL_animal
  - THUOCL_caijing
  - THUOCL_car
  - THUOCL_chengyu
  - THUOCL_diming
  - THUOCL_food
  - THUOCL_IT
  - THUOCL_law
  - THUOCL_lishimingren
  - THUOCL_medical
  - THUOCL_poem
  - sogou_new_words
#+end_src

ç„¶åæ‰§è¡Œå‘½ä»¤ =M-x rime-deploy= ç”Ÿæ•ˆã€‚è¾“å…¥ =weiyamu=, å¦‚æœå†…å®¹æ˜¯ =é³šäºšç›®= åˆ™è¯æ˜å¯¼å…¥æˆåŠŸã€‚

* dict

#+BEGIN_SRC  emacs-lisp
(use-package youdao-dictionary
  :bind
  (("C-c y" . youdao-dictionary-search-at-point))
  :init
  (setq url-automatic-caching t)
  (setq youdao-dictionary-use-chinese-word-segmentation t)
  :config
  ;; ä½¿ç”¨ jieba è¿›è¡Œä¸­æ–‡åˆ†è¯: pip install jieba
  (use-package chinese-word-at-point :demand t))

(use-package go-translate
  :config
  (setq gts-translate-list '(("en" "zh")))
  (setq gts-default-translator
        (gts-translator
         :picker (gts-prompt-picker)
         :engines (list (gts-google-engine) (gts-google-rpc-engine))
         :render (gts-posframe-pin-render))))
#+end_src
+ Google ç¿»è¯‘: =M-x gts-do-translate=;

* email

#+begin_src emacs-lisp
(use-package emacs
  :straight (:type built-in)
  :ensure-system-package
  ((mu . mu)
   (mbsync . isync)
   (gpg . gnupg)
   (proxychains4 . proxychains-ng)
   (openssl . openssl@1.1)))
#+end_src
+ mbsync(isync): åŒæ­¥é‚®ä»¶åˆ°æœ¬åœ°ï¼›
+ mu(å¸¦ mu4e emacs åŒ…): ç´¢å¼•å’Œè¯»å–é‚®ä»¶ï¼›
+ proxychains-ng: ä»»æ„ socket ä»£ç†, è®¿é—® gmail ä½¿ç”¨;
+ gnupg: åŠ å¯†ï¼›
+ openssl@1.1: æä¾› isync å’Œ msmtp æ‰€éœ€çš„æ ¹è¯ä¹¦ï¼›

** gnupg

#+begin_src shell :tangle no
# ç”ŸæˆåŠ å¯† key
$ gpg --gen-key
# ç”ŸæˆåŠé”€è¯ä¹¦
$ gpg --gen-revoke B1D06C306F507C66
# æŸ¥çœ‹ key
$ gpg --list-keys
/Users/zhangjun/.gnupg/pubring.kbx
----------------------------------
pub   ed25519 2021-10-03 [SC] [æœ‰æ•ˆè‡³ï¼š2023-10-03]
10BC65EE905F64CCAFF5E123B1D06C306F507C66
uid             [ ç»å¯¹ ] zhangjun <geekard@qq.com>
sub   cv25519 2021-10-03 [E] [æœ‰æ•ˆè‡³ï¼š2023-10-03]
#+end_src
+ uid æ˜¯ zhangjun æˆ– geekard@qq.com æˆ– hash, å¯¹åº”çš„ hash å€¼å¯ä»¥ä½¿ç”¨ =gpg -a --export |gpg
  --list-packets --verbose= è·å–æˆ– =M-x epa-list-keys= ã€‚
+ å‚è€ƒ: [[https://ruanyifeng.com/blog/2013/07/gpg.html][é˜®ä¸€å³° GPG å…¥é—¨æ•™ç¨‹]]

åˆ›å»º qq å’Œ gmail åŠ å¯†å¯†ç æ–‡ä»¶ï¼š
 #+begin_src shell :tangle no
$ mkdir ~/.mail
$ echo my.qq.password >.mail/qq.pwd
$ gpg --encrypt --recipient 'geekard@qq.com' ~/.mail/qq.pwd

$ echo my.gmail.password >.mail/gmail/gmail.pwd
$ gpg --encrypt --recipient 'geekard@qq.com' ~/.mail/gmail.pwd

$ ls ~/.mail/*.gpg
/Users/zhangjun/.mail/gmail.pwd.gpg  /Users/zhangjun/.mail/qq.pwd.gpg

# åˆ é™¤åŸå§‹æ˜æ–‡å¯†ç 
rm ~/.mail/{qq,gmail}.pwd
 #+end_src

è§£å‹å¯†ç æ–‡ä»¶: =gpg --quiet --for-your-eyes-only --no-tty --decrypt ~/.mail/qq.pwd.gpg=

** mbsync

#+begin_src txt :tangle ~/.mbsyncrc
########################################
# qq.com
########################################
IMAPAccount qq
Host imap.qq.com
User geekard@qq.com
PassCmd "gpg --quiet --for-your-eyes-only --no-tty --decrypt \~/.mail/qq.pwd.gpg"
Port 993
AuthMechs LOGIN
SSLType IMAPS
#CertificateFile /etc/ssl/certs/ca-certificates.crt # Linux
CertificateFile /usr/local/etc/openssl@1.1/cert.pem  # MacOS

IMAPStore qq-remote
Account qq

MaildirStore qq-local
# The trailing "/" is important
Path ~/.mail/qq/
Inbox ~/.mail/qq/Inbox/
# The SubFolders option allows to represent all IMAP subfolders as local subfolders
SubFolders Verbatim

## Connections
Channel qq-inbox
Far :qq-remote:"INBOX"
Near :qq-local:"Inbox"
Create Near
Expunge Both
SyncState *

Channel qq-drafts
Far :qq-remote:"Drafts"
Near :qq-local:"Drafts"
Create Near
Expunge Both
SyncState *

Channel qq-sent
Far :qq-remote:"Sent Messages"
Near :qq-local:"Sent"
Create Near
Expunge Both
SyncState *

Channel qq-trash
Far :qq-remote:"Deleted Messages"
Near :qq-local:"Trash"
Create Near
Expunge Both
SyncState *

## Groups
Group qq
Channel qq-inbox
Channel qq-drafts
Channel qq-sent
Channel qq-trash

########################################
# gmail
########################################
IMAPAccount gmail
Host imap.gmail.com
User geekard@gmail.com
PassCmd "gpg --quiet --for-your-eyes-only --no-tty --decrypt \~/.mail/gmail.pwd.gpg"
SSLType IMAPS
AuthMechs PLAIN
CertificateFile /usr/local/etc/openssl@1.1/cert.pem  # MacOS

IMAPStore gmail-remote
Account gmail

MaildirStore gmail-local
# The trailing "/" is important
Path ~/.mail/gmail/
Inbox ~/.mail/gmail/inbox

Channel gmail-default
Far :gmail-remote:
Near :gmail-local:Inbox
#Patterns INBOX
Create Near
Expunge Both
SyncState *

Channel gmail-sent
Far :gmail-remote:"[Gmail]/Sent Mail"
Near  :gmail-local:Sent
Create Near
Expunge Both
SyncState *

Channel gmail-trash
Far :gmail-remote:"[Gmail]/Trash"
Near  :gmail-local:Trash
Create Near
Expunge Both
SyncState *

Channel gmail-archive
Far :gmail-remote:"[Gmail]/All Mail"
Near  :gmail-local:All
Create Near
Expunge Both
SyncState *

Channel gmail-junk
Far :gmail-remote:"[Gmail]/Spam"
Near  :gmail-local:Junk
Create Near
Expunge Both
SyncState *

Group gmail
Channel gmail-default
Channel gmail-trash
Channel gmail-archive
Channel gmail-sent
Channel gmail-junk
#+end_src

åŒæ­¥é‚®ä»¶:
#+begin_src shell
$ mkdir -p ~/.mail/qq/{Sent,Drafts,Trash,Archive}
$ mkdir -p ~/.mail/gmail/{All,Sent,Drafts,Junk,Trash}
$ mbsync --all
#+end_src
+ ä½¿ç”¨ https://gitlab.com/shackra/goimapnotify å¯ä»¥å®ç°è‡ªåŠ¨è°ƒç”¨ mbsync åŒæ­¥é‚®ä»¶ã€‚

** proxychains

proxychains ä¸ºä¸æ”¯æŒä»£ç†çš„å‘½ä»¤è¡Œç¨‹åºï¼ˆå¦‚ mbsync )æä¾›ä»»æ„ socks ä»£ç†åŠŸèƒ½ï¼š
#+begin_src shell :tangle no
$ mkdir .proxychains/
$ cp /usr/local/Cellar/proxychains-ng/4.14/.bottle/etc/proxychains.conf ~/.proxychains/proxychains.conf
#+end_src

åœ¨ proxychains.conf çš„ ProxyList ä¸­æ·»åŠ  socks5 ä»£ç†åœ°å€:
#+begin_src text :tangle no
[ProxyList]
socks5  127.0.0.1 13659
#+end_src

æµ‹è¯• gmail:
#+begin_src shell :tangle no
$ proxychains4 mbsync gmail
#+end_src

** mu4e

#+begin_src shell
# åˆå§‹åŒ–ç´¢å¼•, æŒ‡å®šè‡ªå·±çš„ email åœ°å€åˆ—è¡¨
$ mu init --maildir ~/.mail/ --my-address=geekard@qq.com --my-address=geekard@gmail.com
# å»ºç«‹ç´¢å¼•
$ mu index
# æ£€ç´¢ç´¢å¼•
$ mu find github
# æŸ¥çœ‹ä¿¡æ¯
$ mu info
#+end_src
+ ç´¢å¼•ä½ç½®ï¼š =~/.cache/mu=

#+begin_src emacs-lisp
(use-package mu4e
  :demand t
  ;; ä½¿ç”¨ mu4e/* ç›®å½•ä¸‹çš„ lisp æ–‡ä»¶, è·³è¿‡ straight çš„ build è¿‡ç¨‹;
  :straight (:host github :repo "djcb/mu" :branch "master" :files ("mu4e/*") :build nil)
  :config
  ;; Run mu4e in the background to sync mail periodically
  (mu4e t)

  (setq shr-color-visible-luminance-min 80)

  ;; View images inline in message view buffer
  (setq mu4e-view-show-images t)
  (setq mu4e-view-image-max-width 800)
  (when (fboundp 'imagemagick-register-types)
    (imagemagick-register-types))

  ;; show full addresses in view message (instead of just names)
  (setq mu4e-view-show-addresses t)

  ;; Do not insert signature in sent emails
  (setq mu4e-compose-signature-auto-include nil)

  ;; every new email composition using current frame
  (setq mu4e-compose-in-new-frame nil)
  (setq mu4e-compose-format-flowed nil)

  ;; It is OK to use non-ascii characters
  (setq mu4e-use-fancy-chars t)
  (setq mu4e-attachment-dir "~/.mail/attachments")

  ;; This enabled the thread like viewing of email similar to gmail's UI.
  (setq mu4e-headers-include-related t)
  ;; Do not display duplicate messages
  (setq mu4e-headers-skip-duplicates t)
  (setq mu4e-headers-date-format "%Y/%m/%d")

  (setq mu4e-change-filenames-when-moving t)
  (setq mu4e-display-update-status-in-modeline t)
  (setq mu4e-hide-index-messages t)
  (setq mu4e-date-format "%y/%m/%d")

  ;; Do not confirm on quit
  (setq mu4e-confirm-quit nil)

  ;; use mu4e as MUA in emacs
  (setq mail-user-agent 'mu4e-user-agent)

  ;; Kill message buffer after email is sent
  (setq message-kill-buffer-on-exit t)

  ;; å›å¤é‚®ä»¶æ—¶ï¼Œæ’å…¥é‚®ä»¶å¼•ç”¨ä¿¡æ¯
  (setq message-citation-line-function 'message-insert-formatted-citation-line)
  (setq message-citation-line-format "On %a, %b %d %Y, %f wrote:\n")

  (setq gnus-unbuttonized-mime-types nil)

  ;; mu find æœç´¢ä»»æ„å•ä¸ªä¸­æ–‡å­—ç¬¦ã€‚
  (setenv "XAPIAN_CJK_NGRAM" "yes")

  (add-to-list 'mu4e-view-actions '("browser" . mu4e-action-view-in-browser) t)
  (add-hook 'mu4e-view-mode-hook
            (lambda()
              ;; try to emulate some of the eww key-bindings
              (local-set-key (kbd "<tab>") 'shr-next-link)
              (local-set-key (kbd "<backtab>") 'shr-previous-link)))

  ;; ä½¿ç”¨ proxychains4 socks5 ä»£ç†å‘¨æœŸåŒæ­¥é‚®ä»¶
  (setq mu4e-get-mail-command  "proxychains4 mbsync -a")
  (setq mu4e-update-interval 3600)

  ;; ä½¿ç”¨ gnus å‘é€é‚®ä»¶
  (setq message-send-mail-function 'smtpmail-send-it)
  (setq smtpmail-debug-info t)
  (setq smtpmail-debug-verb t)

  (setq mu4e-user-mailing-lists '("geekard@qq.com" "geekard@gmail.com"))

  ;; root maildir
  (setq mu4e-maildir "~/.mail")

  (setq mu4e-contexts
        `( ,(make-mu4e-context
             :name "gmail"
             :enter-func (lambda () (mu4e-message "Switch to the gmail context"))
             :match-func (lambda (msg)
                           (when msg
                             (or (mu4e-message-contact-field-matches msg '(:to :bcc :cc) "geekard@gmail.com")
                                 (string-match-p "^/gmail" (mu4e-message-field msg :maildir)))))
             :leave-func (lambda () (mu4e-clear-caches))
             :vars '((user-mail-address            . "geekard@gmail.com")
                     (user-full-name               . "å¼ ä¿Š(Jun Zhang)")
                     (smtpmail-default-smtp-server . "smtp.gmail.com")
                     (smtpmail-smtp-server         . "smtp.gmail.com")
                     (smtpmail-smtp-user           . "geekard@gmail.com")
                     (smtpmail-smtp-service        . 587)
                     (smtpmail-stream-type         . starttls)
                     (mu4e-compose-signature       . (concat "---\n zhangjun \n"))
                     (mu4e-sent-folder      . "/gmail/Sent") ;; folder for sent messages
                     (mu4e-drafts-folder    . "/gmail/Drafts") ;; unfinished messages
                     (mu4e-trash-folder     . "/gmail/Junk") ;; trashed messages
                     (mu4e-refile-folder    . "/gmail/Archive"))) ;; ;; saved messages
           ,(make-mu4e-context
             :name "qq"
             :enter-func (lambda () (mu4e-message "Switch to the qq context"))
             :match-func (lambda (msg)
                           (when msg
                             (or (mu4e-message-contact-field-matches msg '(:to :bcc :cc) "geekard@qq.com")
                                 (string-match-p "^/qq" (mu4e-message-field msg :maildir)))))
             :leave-func (lambda () (mu4e-clear-caches))
             :vars '(
                     (user-mail-address            . "geekard@qq.com")
                     (user-full-name               . "å¼ ä¿Š(Jun Zhang)")
                     (smtpmail-default-smtp-server . "smtp.qq.com")
                     (smtpmail-smtp-server         . "smtp.qq.com")
                     (smtpmail-smtp-user           . "geekard@qq.com")
                     (smtpmail-smtp-service        . 465)
                     (smtpmail-stream-type         . ssl)
                     (mu4e-compose-signature       . (concat "---\n Zhang Jun \n"))
                     (mu4e-sent-folder      . "/qq/Sent")
                     (mu4e-drafts-folder    . "/qq/Drafts")
                     (mu4e-trash-folder     . "/qq/Trash")
                     (mu4e-refile-folder    . "/qq/Archive")
                     )))))
;; ä¸º message æ·»åŠ  Tag
(with-eval-after-load 'mu4e
  (add-to-list 'mu4e-marks
               '(tag
                 :char       "g"
                 :prompt     "gtag"
                 :ask-target (lambda () (read-string "Add Tag: "))
                 :action      (lambda (docid msg target)
                                (mu4e-action-retag-message msg (concat "+" target)))))
  (mu4e~headers-defun-mark-for tag)
  (define-key mu4e-headers-mode-map (kbd "g") 'mu4e-headers-mark-for-tag)

  ;; åœ¨ Dired ä¸­æ ‡è®°æ–‡ä»¶, ç„¶å C-c RET C-a æ¥å‘é€é™„ä»¶
  (add-hook 'dired-mode-hook 'turn-on-gnus-dired-mode)

  ;; å‘é€å‰ç¡®è®¤
  (add-hook 'message-send-hook
            (lambda ()
              (unless (yes-or-no-p "Sure you want to send this?")
                (signal 'quit nil))))

  ;; å…ˆé€‰æ‹©é‚®ä»¶, ç„¶åæŒ‰ r, è‡ªåŠ¨ refile åˆ°å¯¹åº”ç›®å½•
  (setq mu4e-refile-folder
        (lambda (msg)
          (cond
           ;; messages to the mu mailing list go to the /mu folder
           ((mu4e-message-contact-field-matches msg :to "mu-discuss@googlegroups.com") "/mu")
           ;; messages sent directly to some spefic address me go to /private
           ((mu4e-message-contact-field-matches msg :to "me@example.com") "/private")
           ;; messages with football or soccer in the subject go to /football
           ((string-match "football\\|soccer" (mu4e-message-field msg :subject)) "/football")
           ;; messages sent by me go to the sent folder
           ((mu4e-message-sent-by-me msg (mu4e-personal-addresses)) mu4e-sent-folder)
           ;; everything else goes to /archive
           ;; important to have a catch-all at the end!
           (t  "/archive")))))
#+end_src
+ mu4e çš„ä½¿ç”¨è¯¦æƒ…å‚è€ƒåœ¨çº¿ Info æ‰‹å†Œ [[info:mu4e#Top][mu4e#Top]]ã€‚

mu4e é»˜è®¤ä½¿ç”¨ gnus å‘é€ SMTP é‚®ä»¶, è€Œ gnus ä» =~/.authinfo.gpg= è¯»å– SMTP æœåŠ¡å™¨çš„å¸å·ä¿¡æ¯:

#+begin_src txt :tangle no
machine smtp.qq.com login geekard@qq.com password {QQ æˆæƒç }
machine smtp.gmail.com login geekard@gmail.com password {Gmail å¯†ç }
#+end_src

ä½¿ç”¨ mu4e-alert å’Œ notifier(é€šè¿‡ terminal-notifier ç¨‹åº) è¿›è¡Œæ¡Œé¢é€šçŸ¥:
#+begin_src emacs-lisp
(use-package mu4e-alert
  :disabled
  :after mu4e
  :config
  (mu4e-alert-set-default-style 'notifier)
  ;; (mu4e-alert-set-default-style 'growl)
  (add-hook 'after-init-hook #'mu4e-alert-enable-notifications)
  ;; enable mode line display
  (add-hook 'after-init-hook #'mu4e-alert-enable-mode-line-display)
  (setq mu4e-alert-email-notification-types '(count)))
#+end_src

ä½¿ç”¨ mu4e-maildirs-extension åœ¨ mu4e-main-view å±•ç¤º Maildirs æ¦‚è§ˆã€‚
#+begin_src emacs-lisp
(use-package mu4e-maildirs-extension
  :after mu4e
  :config
  (mu4e-maildirs-extension))
#+end_src

mu4e-views ä½¿ç”¨ xwdigets æ¥æ˜¾ç¤º html æ ¼å¼é‚®ä»¶ï¼š
#+begin_src emacs-lisp
(use-package mu4e-views
  :after mu4e
  :bind (:map mu4e-headers-mode-map
              ("v" . mu4e-views-mu4e-select-view-msg-method) ;; åˆ‡æ¢å±•ç¤ºç±»å‹
              ("M-n" . mu4e-views-cursor-msg-view-window-down) ;; from headers window scroll the email view
              ("M-p" . mu4e-views-cursor-msg-view-window-up) ;; from headers window scroll the email view
              ("f" . mu4e-views-toggle-auto-view-selected-message) ;; toggle opening messages automatically when moving in the headers view
              ("i" . mu4e-views-mu4e-view-as-nonblocked-html) ;; show currently selected email with all remote content
              )
  :config
  (setq mu4e-views-completion-method 'default) ;; use ivy for completion
  (setq mu4e-views-default-view-method "html") ;; make xwidgets default
  (mu4e-views-mu4e-use-view-msg-method "html") ;; select the default
  (setq mu4e-views-next-previous-message-behaviour 'stick-to-current-window) ;; when pressing n and p stay in the current window
  (setq mu4e-views-auto-view-selected-message t)) ;; automatically open messages when moving in the headers view
#+end_src
+ æµ‹è¯• Emacs æ˜¯å¦æ”¯æŒ xwdigets: (xwidget-webkit-browse-url "https://www.gnu.org/");
+ åœ¨ mu4e-header ä¸­ä½¿ç”¨ v æ¥åˆ‡æ¢é‚®ä»¶æ˜¾ç¤ºæ–¹å¼;

** org-mime
org-mime ä½¿ç”¨ org-mode æ¥ç¼–è¾‘å’Œå‘é€ html æ ¼å¼é‚®ä»¶ï¼š
#+begin_src emacs-lisp
(use-package org-mime
  :after mu4e
  :config
  (setq org-mime-export-options '(:section-numbers nil :with-author nil :with-toc nil))
  ;; Prompt for confirmation if message has no HTML
  (add-hook 'message-send-hook 'org-mime-confirm-when-no-multipart))
#+end_src

ä½¿ç”¨æ–¹æ³•ï¼š
+ M-x org-mime-htmlize
+ M-x org-mime-edit-mail-in-org-mode
+ M-x org-mime-revert-to-plain-text-mail

* org
** org
#+begin_src emacs-lisp
(use-package org
  :straight (org :repo "https://git.savannah.gnu.org/git/emacs/org-mode.git")
  :ensure auctex
  ;; latext pdf ä»£ç é«˜äº®
  :ensure-system-package (pygmentize . pygments)
  :config
  (setq org-ellipsis "â–¾"
        org-highlight-latex-and-related '(latex)
        ;; éšè— // å’Œ ** æ ‡è®°
        org-hide-emphasis-markers t
        org-hide-block-startup nil
        org-hidden-keywords '(title)
        org-cycle-separator-lines 2
        org-default-notes-file "~/docs/orgs/note.org"
        org-log-into-drawer t
        org-log-done 'note
        org-image-actual-width '(300)
        org-export-with-broken-links t
        org-agenda-start-day "-7d"
        org-agenda-span 21
        org-agenda-include-diary t
        org-html-doctype "html5"
        org-html-html5-fancy t
        org-html-self-link-headlines t
        org-html-preamble "<a name=\"top\" id=\"top\"></a>"
        org-cycle-level-faces t
        org-n-level-faces 4
        org-startup-folded 'content
        ;; ä½¿ç”¨ R_{s} å½¢å¼çš„ä¸‹æ ‡ï¼ˆé»˜è®¤æ˜¯ R_s, å®¹æ˜“ä¸æ­£å¸¸å†…å®¹æ··æ·†)
        org-use-sub-superscripts nil
        org-startup-indented t
        org-link-file-path-type 'absolute)
  (setq org-todo-keywords
        '((sequence "â˜ TODO(t)" "PROJ(p)" "âš” INPROCESS(s)" "âš‘ WAITING(w)"
                    "|" "â˜Ÿ NEXT(n)" "âœ° Important(i)" "âœ” DONE(d)" "âœ˜ CANCELED(c@)")
          (sequence "âœ NOTE(N)" "FIXME(f)" "â˜• BREAK(b)" "â¤ Love(l)" "REVIEW(r)" )))
  (setq org-refile-targets
        '(("~/docs/orgs/later.org" :level . 1)
          ("~/docs/orgs/gtd.org" :maxlevel . 3)))

  (global-set-key (kbd "C-c l") 'org-store-link)
  (global-set-key (kbd "C-c a") 'org-agenda)
  (global-set-key (kbd "C-c c") 'org-capture)
  (global-set-key (kbd "C-c b") 'org-switchb)
  (add-hook 'org-mode-hook 'turn-on-auto-fill)
  (add-hook 'org-mode-hook (lambda ()
                             (display-line-numbers-mode 0)
                             ;; corfu å°† TAB é‡å®šä¹‰ä¸º Complete
                             ;;(setq tab-always-indent t)
                             ;; (setq c-tab-always-indent t)
                             )))

(use-package htmlize)

;; è‡ªåŠ¨åˆ›å»ºå’Œæ›´æ–°ç›®å½•
(use-package org-make-toc
  :config
  (add-hook 'org-mode-hook #'org-make-toc-mode))
#+END_SRC
+ org-make-toc: [[https://github.com/alphapapa/org-make-toc][å‚è€ƒå®˜æ–¹æ–‡æ¡£]]ã€‚

** face
#+begin_src emacs-lisp
(defun my/org-faces ()
  (setq-default line-spacing 1)
  (dolist (face '((org-level-1 . 1.2)
                  (org-level-2 . 1.1)
                  (org-level-3 . 1.05)
                  (org-level-4 . 1.0)
                  (org-level-5 . 1.1)
                  (org-level-6 . 1.1)
                  (org-level-7 . 1.1)
                  (org-level-8 . 1.1)))
    (set-face-attribute (car face) nil :weight 'medium :height (cdr face)))
  (custom-theme-set-faces
   'user
   ;; è°ƒå¤§ org-block å­—ä½“
   '(org-block ((t (:font "JuliaMono-15" :inherit fixed-pitch))))
   ;; è°ƒå° height
   '(org-block-begin-line ((t (:underline "#A7A6AA" :height 0.8))))
   '(org-block-end-line ((t (:underline "#A7A6AA" :height 0.8))))
   '(org-document-title ((t (:foreground "#ffb86c" :weight bold :height 1.5))))
   '(org-document-info ((t (:foreground "dark orange"))))
   '(org-document-info-keyword ((t (:height 0.8))))
   '(org-link ((t (:foreground "royal blue" :underline t))))
   '(org-meta-line ((t ( :height 0.8))))
   '(org-property-value ((t (:height 0.8))) t)
   '(org-drawer ((t (:height 0.8))) t)
   '(org-special-keyword ((t (:height 0.8))))
   '(org-table ((t (:foreground "#83a598"))))
   '(org-tag ((t (:weight bold :height 0.8))))))
(add-hook 'org-mode-hook 'my/org-faces)

(use-package org-superstar
  :after (org)
  :hook
  (org-mode . org-superstar-mode)
  :custom
  (org-superstar-remove-leading-stars t)
  (org-superstar-headline-bullets-list '("â—‰" "â—‹" "â—" "â—‹" "â—" "â—‹" "â—")))

(use-package org-fancy-priorities
  :after (org)
  :hook
  (org-mode . org-fancy-priorities-mode)
  :config
  (setq org-fancy-priorities-list '("[A] âš¡" "[B] â¬†" "[C] â¬‡" "[D] â˜•")))

;;Make invisible parts of Org elements appear visible.
(use-package org-appear
  :custom
  (org-appear-autolinks t)
  :hook (org-mode . org-appear-mode))
#+end_src

** fill

å†…å®¹å±…ä¸­æ˜¾ç¤º:
#+begin_src emacs-lisp
(defun my/org-mode-visual-fill (fill width)
  (setq-default
   ;; è‡ªåŠ¨æ¢è¡Œçš„å­—ç¬¦æ•°
   fill-column fill
   ;; window å¯è§†åŒ–è¡Œå®½åº¦ï¼Œå€¼åº”è¯¥æ¯” fill-column å¤§ï¼Œå¦åˆ™è¶…å‡ºçš„å­—ç¬¦è¢«éšè—ã€‚
   visual-fill-column-width width
   visual-fill-column-fringes-outside-margins nil
   ;; ä½¿ç”¨ setq-default æ¥è®¾ç½®å±…ä¸­, å¦åˆ™å¯èƒ½ä¸ç”Ÿæ•ˆã€‚
   visual-fill-column-center-text t)
  (visual-fill-column-mode 1))

(use-package visual-fill-column
  :demand t
  :after (org)
  :hook
  (org-mode . (lambda () (my/org-mode-visual-fill 120 140)))
  :config
  ;; æ–‡å­—ç¼©æ”¾æ—¶è‡ªåŠ¨è°ƒæ•´ visual-fill-column-width
  (advice-add 'text-scale-adjust :after #'visual-fill-column-adjust))
#+end_src
+ å¦‚æœæ–‡å­—å±…ä¸­å¤±æ•ˆ, å¯ä»¥æ‰§è¡Œ =M-x redraw-display= å‘½ä»¤ç”Ÿæ•ˆã€‚

** slide

#+begin_src emacs-lisp
(use-package org-tree-slide
  :after (org)
  :commands org-tree-slide-mode
  :bind
  (:map org-mode-map
        ("<f8>" . org-tree-slide-mode)
        :map org-tree-slide-mode-map
        ("<f9>" . org-tree-slide-content)
        ("<left>" . org-tree-slide-move-previous-tree)
        ("<right>" . org-tree-slide-move-next-tree))
  :hook
  ((org-tree-slide-play . (lambda ()
                            (blink-cursor-mode -1)
                            (setq-default x-stretch-cursor -1)
                            (beacon-mode -1)
                            (redraw-display)
                            (org-display-inline-images)
                            (text-scale-increase 2)
                            (read-only-mode 1)))
   (org-tree-slide-stop . (lambda ()
                            (blink-cursor-mode +1)
                            (setq-default x-stretch-cursor t)
                            (text-scale-increase 0)
                            (beacon-mode +1)
                            (read-only-mode -1))))
  :config
  (setq org-tree-slide-slide-in-effect t)
  (setq org-tree-slide-activate-message "Presentation started.")
  (setq org-tree-slide-deactivate-message "Presentation ended.")
  (setq org-tree-slide-content-margin-top 0)
  (setq org-tree-slide-heading-emphasis t)
  (setq org-tree-slide-header t)

    ;; https://github.com/takaxp/org-tree-slide/issues/42#issuecomment-936481999
  (defvar my-hide-org-meta-line-p nil)
  (defun my-hide-org-meta-line ()
    (interactive)
    (setq my-hide-org-meta-line-p t)
    (set-face-attribute 'org-meta-line nil :foreground (face-attribute 'default :background)))
  (defun my-show-org-meta-line ()
    (interactive)
    (setq my-hide-org-meta-line-p nil)
    (set-face-attribute 'org-meta-line nil :foreground nil))
  (defun my-toggle-org-meta-line ()
    (interactive)
    (if my-hide-org-meta-line-p
        (my-show-org-meta-line) (my-hide-org-meta-line)))

  (add-hook 'org-tree-slide-play-hook #'my-hide-org-meta-line)
  (add-hook 'org-tree-slide-stop-hook #'my-show-org-meta-line))
#+end_src
+ å¦‚æœæ–‡å­—å±…ä¸­å¤±æ•ˆ, å¯ä»¥æ‰§è¡Œ =M-x redraw-display= å‘½ä»¤æ¥ç”Ÿæ•ˆã€‚

** capture

è‡ªåŠ¨ Capture æµè§ˆå™¨å‘æ¥çš„ç½‘å€æˆ–é€‰ä¸­çš„å†…å®¹:
#+begin_src emacs-lisp
(require 'org-protocol)
(require 'org-capture)
(add-to-list 'org-capture-templates
             '("c" "Capture" entry (file+headline "~/docs/orgs/capture.org" "Capture")
               "* %^{Title}\nDate: %U\nSource: %:annotation\nContent:\n%:initial"
               :empty-lines 1))
(add-to-list 'org-capture-templates
             '("i" "Inbox" entry (file+headline "~/docs/orgs/inbox.org" "Inbox")
               "* â˜ TODO [#B] %U %i%?"))
(add-to-list 'org-capture-templates
             '("l" "Later" entry (file+headline "~/docs/orgs/later.org" "Later")
               "* â˜ TODO [#C] %U %i%?" :empty-lines 1))
(add-to-list 'org-capture-templates
             '("g" "GTD" entry (file+datetree "~/docs/orgs/gtd.org")
               "* â˜ TODO [#B] %U %i%?"))
#+end_src

** image

æ‹–æ‹½ä¿å­˜å›¾ç‰‡æˆ– F6 ä¿å­˜å‰ªè´´æ¿ä¸­å›¾ç‰‡:
#+begin_src emacs-lisp
(use-package org-download
  :ensure-system-package pngpaste
  :bind
  ("<f6>" . org-download-screenshot)
  :config
  (setq-default org-download-image-dir "./images/")
  (setq org-download-method 'directory
        org-download-display-inline-images 'posframe
        org-download-screenshot-method "pngpaste %s"
        org-download-image-attr-list '("#+ATTR_HTML: :width 400 :align center"))
  (add-hook 'dired-mode-hook 'org-download-enable)
  (org-download-enable))
#+end_src

** agenda

#+begin_src emacs-lisp
(setq org-agenda-time-grid
      (quote ((daily today require-timed)
              (300 600 900 1200 1500 1800 2100 2400)
              "......"
              "-----------------------------------------------------"
              )))
;; org-agenda å±•ç¤ºçš„æ–‡ä»¶
(setq org-agenda-files
      '("~/docs/orgs/inbox.org"
        "~/docs/orgs/gtd.org"
        "~/docs/orgs/later.org"
        "~/docs/orgs/capture.org"))

(setq diary-file "~/docs/orgs/diary")
(setq diary-mail-addr "geekard@qq.com")
;; è·å–ç»çº¬åº¦ï¼šhttps://www.latlong.net/
(setq calendar-latitude +39.904202)
(setq calendar-longitude +116.407394)
(setq calendar-location-name "åŒ—äº¬")
(setq calendar-remove-frame-by-deleting t)
;; æ¯å‘¨ç¬¬ä¸€å¤©æ˜¯å‘¨ä¸€
(setq calendar-week-start-day 1)
;; æ ‡è®°æœ‰è®°å½•çš„æ—¥å­
(setq mark-diary-entries-in-calendar t)
;; æ ‡è®°èŠ‚å‡æ—¥
(setq mark-holidays-in-calendar nil)
;; ä¸æ˜¾ç¤ºèŠ‚æ—¥åˆ—è¡¨
(setq view-calendar-holidays-initially nil)
(setq org-agenda-include-diary t)

;; é™¤å»åŸºç£å¾’ã€å¸Œä¼¯æ¥å’Œä¼Šæ–¯å…°æ•™çš„èŠ‚æ—¥ã€‚
(setq christian-holidays nil
      hebrew-holidays nil
      islamic-holidays nil
      solar-holidays nil
      bahai-holidays nil)

(setq mark-diary-entries-in-calendar t
      appt-issue-message nil
      mark-holidays-in-calendar t
      view-calendar-holidays-initially nil)

(setq diary-date-forms '((year "/" month "/" day "[^/0-9]"))
      calendar-date-display-form '(year "/" month "/" day)
      calendar-time-display-form
      '(24-hours ":" minutes (if time-zone " (") time-zone (if time-zone ")")))

(add-hook 'today-visible-calendar-hook 'calendar-mark-today)

(autoload 'chinese-year "cal-china" "Chinese year data" t)

(setq calendar-load-hook
      '(lambda ()
         (set-face-foreground 'diary-face   "skyblue")
         (set-face-background 'holiday-face "slate blue")
         (set-face-foreground 'holiday-face "white")))

(use-package org-super-agenda)
#+end_src

** babel

#+begin_src emacs-lisp
(setq org-confirm-babel-evaluate nil
      org-src-fontify-natively t
      ;; add a special face to #+begin_quote and #+begin_verse block
      org-fontify-quote-and-verse-blocks t
      ;; ä¸è‡ªåŠ¨ç¼©è¿›
      org-src-preserve-indentation t
      org-edit-src-content-indentation 0
      ;; åœ¨å½“å‰ window ç¼–è¾‘ SRC Block
      org-src-window-setup 'current-window
      org-src-tab-acts-natively t)

(require 'org)
(use-package ob-go)
(use-package ox-reveal)
(use-package ox-gfm)

(org-babel-do-load-languages
 'org-babel-load-languages
 '((shell . t)
   (js . t)
   (go . t)
   (emacs-lisp . t)
   (python . t)
   (dot . t)
   (css . t)))
#+end_src

** notify
å€’è®¡æ—¶ç»“æŸé€šçŸ¥:
#+BEGIN_SRC  emacs-lisp
(use-package emacs
  :straight (:type built-in)
  :ensure-system-package terminal-notifier)

(defvar terminal-notifier-command (executable-find "terminal-notifier") "The path to terminal-notifier.")

(defun terminal-notifier-notify (title message)
  (start-process "terminal-notifier"
                 "terminal-notifier"
                 terminal-notifier-command
                 "-title" title
                 "-sound" "default"
                 "-message" message
                 "-activate" "org.gnu.Emacs"))

(defun timed-notification (time msg)
  (interactive "sNotification when (e.g: 2 minutes, 60 seconds, 3 days): \nsMessage: ")
  (run-at-time time nil (lambda (msg) (terminal-notifier-notify "Emacs" msg)) msg))

;;(terminal-notifier-notify "Emacs notification" "Something amusing happened")
(setq org-show-notification-handler (lambda (msg) (timed-notification nil msg)))
#+end_src

** tex

#+begin_src emacs-lisp
(require 'ox-latex)
(with-eval-after-load 'ox-latex
  ;;https://yuchi.me/post/export-org-mode-in-chinese-to-pdf-with-custom-latex-class/
  ;; http://orgmode.org/worg/org-faq.html#using-xelatex-for-pdf-export
  ;; latexmk runs pdflatex/xelatex (whatever is specified) multiple times
  ;; automatically to resolve the cross-references.
  (setq org-latex-pdf-process '("latexmk -xelatex -quiet -shell-escape -f %f"))
  ;; ;; Alist of packages to be inserted in every LaTeX header.
  ;; (setq org-latex-packages-alist
  ;;       (quote (("" "color" t)
  ;;               ("" "xcolor" t)
  ;;               ("" "listings" t)
  ;;               ("" "fontspec" t)
  ;;               ("" "parskip" t) ;; å¢åŠ æ­£æ–‡æ®µè½çš„é—´è·
  ;;               ("AUTO" "inputenc" t))))
  (add-to-list 'org-latex-classes
               '("ctexart"
                 "\\documentclass[lang=cn,11pt,a4paper]{ctexart}
                 [NO-DEFAULT-PACKAGES]
                 [PACKAGES]
                 [EXTRA]"
                 ("\\section{%s}" . "\\section*{%s}")
                 ("\\subsection{%s}" . "\\subsection*{%s}")
                 ("\\subsubsection{%s}" . "\\subsubsection*{%s}")
                 ("\\paragraph{%s}" . "\\paragraph*{%s}")
                 ("\\subparagraph{%s}" . "\\subparagraph*{%s}")))
  ;; è‡ªå®šä¹‰ latex è¯­è¨€ç¯å¢ƒ(åŸºäº tcolorbox)
  ;; å‚è€ƒ: https://blog.shimanoke.com/ja/posts/output-latex-code-with-tcolorbox/
  (setq org-latex-custom-lang-environments
        '((c "\\begin{programlist}[label={%l}]{c}{: %c}\n%s\\end{programlist}")
          (ditaa "\\begin{programlist}[label={%l}]{text}{: %c}\n%s\\end{programlist}")
          (emacs-lisp "\\begin{programlist}[label={%l}]{lisp}{: %c}\n%s\\end{programlist}")
          (ruby "\\begin{programlist}[label={%l}]{ruby}{: %c}\n%s\\end{programlist}")
          (latex "\\begin{programlist}[label={%l}]{latex}{: %c}\n%s\\end{programlist}")
          (go "\\begin{programlist}[label={%l}]{go}{: %c}\n%s\\end{programlist}")
          (lua "\\begin{programlist}[label={%l}]{lua}{: %c}\n%s\\end{programlist}")
          (java "\\begin{programlist}[label={%l}]{java}{: %c}\n%s\\end{programlist}")
          (javascript "\\begin{programlist}[label={%l}]{javascript}{: %c}\n%s\\end{programlist}")
          (json "\\begin{programlist}[label={%l}]{json}{: %c}\n%s\\end{programlist}")
          (plantuml "\\begin{programlist}[label={%l}]{text}{: %c}\n%s\\end{programlist}")
          (yaml "\\begin{programlist}[label={%l}]{yaml}{: %c}\n%s\\end{programlist}")
          (maxima "\\begin{programlist}[label={%l}]{text}{: %c}\n%s\\end{programlist}")
          (ipython "\\begin{programlist}[label={%l}]{python}{: %c}\n%s\\end{programlist}")
          (python "\\begin{programlist}[label={%l}]{python}{: %c}\n%s\\end{programlist}")
          (perl "\\begin{programlist}[label={%l}]{perl}{: %c}\n%s\\end{programlist}")
          (html "\\begin{programlist}[label={%l}]{html}{: %c}\n%s\\end{programlist}")
          (org "\\begin{programlist}[label={%l}]{text}{: %c}\n%s\\end{programlist}")
          (typescript "\\begin{programlist}[label={%l}]{typescript}{: %c}\n%s\\end{programlist}")
          (scss "\\begin{programlist}[label={%l}]{scss}{: %c}\n%s\\end{programlist}")
          (sh "\\begin{programlist}[label={%l}]{shell}{: %c}\n%s\\end{programlist}")
          (shell "\\begin{programlist}[label={%l}]{shell}{: %c}\n%s\\end{programlist}")
          (shellinput "\\begin{shellinput}[%c]\n%s\\end{shellinput}")
          (shelloutput "\\begin{shelloutput}[%c]\n%s\\end{shelloutput}")))
  (setq org-latex-listings 'listings))
#+end_src
+ minted åŒ…æä¾›ä»£ç è¯­æ³•é«˜äº®çš„åŠŸèƒ½(TexLive é»˜è®¤å®‰è£…), å®ƒä¾èµ– pygements ã€‚
+ å˜é‡ =org-latex-minted-langs= åˆ—å‡º Emacs Major-Mode ä¸ minted è¯­è¨€ç±»å‹
  ï¼ˆpygmentize -L lexersï¼‰çš„å…³ç³», å¦‚æœä¸¤è€…ä¸€è‡´ï¼ˆå¦‚ go-[mod] å’Œ go), åˆ™ä¸éœ€è¦åˆ—å‡ºã€‚
+ minted çš„ fontfamily åªå¯¹é¢„å®šä¹‰çš„ tt/courier/helvetica æœ‰æ•ˆã€‚

å®‰è£… noto-cjk ä¸­æ–‡å­—ä½“: =git clone https://github.com/googlefonts/noto-cjk.git=

è‡ªå®šä¹‰æ ·å¼ mystyle.sty:
#+begin_src latex :tangle  ~/.emacs.d/mystyle.sty
% å®‰è£…è§å…‰ç¬”æ•ˆæœçš„å¼ºè°ƒå®åŒ… breakfbox(https://blog.shimanoke.com/ja/posts/change-latex-emph/)
% 1. å…‹éš† https://github.com/doraTeX/breakfbox åˆ° /usr/local/texlive/texmf-local/tex/latex
% 2. åˆ·æ–°æ•°æ®åº“:  sudo mktexlsr

% é»„è‰²èƒŒæ™¯é«˜äº®å¼ºè°ƒï¼ˆæ¥æºäº breakfbox)
\usepackage{uline--}
\renewcommand{\emph}[1]{
  {\sffamily\bfseries\itshape
    \uline[
      background,
      color={[rgb]{1,1,0.0}},
      width=0.8em,position=1pt]{#1}}}

% è‡ªå®šä¹‰ programlist è¯­è¨€ç¯å¢ƒ
% https://blog.shimanoke.com/ja/posts/output-latex-code-with-tcolorbox/
\usepackage{tcolorbox}
\tcbuselibrary{breakable,skins,raster,external,listings,minted}
\tcbEXTERNALIZE
\newtcblisting[
  auto counter,
  number within=section]{programlist}[3][]{
  listing engine=minted,
  minted style=emacs,
  minted language=#2,
  minted options={autogobble,fontsize=\footnotesize,breaklines,breakanywhere,baselinestretch=1.2,linenos,numbersep=3mm},
  title={\sffamily\bfseries ä»£ç å— \thetcbcounter},
  %title={\sffamily\bfseries ä»£ç å— \thetcbcounter #3},
  after,
  breakable=true,
  lowerbox=ignored,
  hyphenationfix=true,
  colback=blue!5!white,
  colframe=blue!85!black,
  listing only,
  enhanced,
  drop fuzzy shadow southeast,
  left=5mm,
  overlay={\begin{tcbclipinterior}\fill[red!20!blue!20!white] (frame.south west) rectangle ([xshift=5mm]frame.north west);\end{tcbclipinterior}},
  #1
}

\usepackage{hyperref}
\hypersetup{
  pdfborder={0 0 0},
  colorlinks=true,
  linkcolor={winered},
  urlcolor={winered},
  filecolor={winered},
  citecolor={winered},
  linktoc=all}

\usepackage{fontspec}
\usepackage[utf8]{inputenc}
\setmainfont{Sarasa Mono SC}
\setsansfont{Sarasa Mono SC}[Scale=MatchLowercase]
\setmonofont{Sarasa Mono SC}[Scale=MatchLowercase]
% \setCJKmainfont[BoldFont={Adobe Heiti Std}, ItalicFont={Adobe Kaiti Std}]{Adobe Song Std}
\setCJKmainfont[BoldFont = Noto Serif SC]{Noto Serif SC}
\setCJKsansfont{Noto Sans SC}
\setCJKmonofont{Noto Sans Mono CJK SC}

\XeTeXlinebreaklocale "zh"
\XeTeXlinebreakskip = 0pt plus 1pt minus 0.1pt

% add the email cmd
\newcommand\email[1]{\href{mailto:#1}{\nolinkurl{#1}}}

\usepackage{color}
% define the hyperref color
\usepackage{xcolor}
\definecolor{winered}{rgb}{0.5,0,0}
\definecolor{lightgrey}{rgb}{0.95,0.95,0.95}
\definecolor{commentcolor}{RGB}{0,100,0}
\definecolor{frenchplum}{RGB}{190,20,83}
% ä»£ç å—ä½¿ç”¨çš„èƒŒæ™¯
\definecolor{LightGray}{gray}{0.9}

\usepackage{parskip}
\usepackage{etoolbox}
\usepackage{calc}

\usepackage[scale=0.85]{geometry}
%\setlength{\headsep}{5pt}

\usepackage{amsthm}
\usepackage{amsmath}
\usepackage{amssymb}
\usepackage{indentfirst}
\usepackage{booktabs}
\usepackage{multicol}
\usepackage{multirow}
\usepackage{linegoal}
\usepackage{graphicx}
\usepackage{fancyvrb}
\usepackage{abstract}
\usepackage{hologo}

\linespread{1.35}
\graphicspath{{image/}{figure/}{fig/}{img/}{images/}}

\usepackage[font=small,labelfont={bf}]{caption}
\captionsetup[table]{skip=3pt}
\captionsetup[figure]{skip=3pt}

\usepackage[shortlabels,inline]{enumitem}
\setlist{nolistsep}
#+end_src

åœ¨ org æ–‡æ¡£çš„å¤´éƒ¨æ·»åŠ å‚æ•°ï¼š
#+begin_verse :tangle no
#+LATEX_COMPILER: xelatex
#+LATEX_CLASS: ctexart
#+LATEX_HEADER: \usepackage{mystyle}
#+OPTIONS: prop:t ^:nil
#+end_verse

** template

These templates enable you to type things like =<el= and then hit Tab to expand the template.
#+begin_src emacs-lisp
(require 'org-tempo)

(add-to-list 'org-structure-template-alist '("sh" . "src sh"))
(add-to-list 'org-structure-template-alist '("el" . "src emacs-lisp"))
(add-to-list 'org-structure-template-alist '("sc" . "src scheme"))
(add-to-list 'org-structure-template-alist '("ts" . "src typescript"))
(add-to-list 'org-structure-template-alist '("py" . "src python"))
(add-to-list 'org-structure-template-alist '("go" . "src go"))
(add-to-list 'org-structure-template-alist '("yaml" . "src yaml"))
(add-to-list 'org-structure-template-alist '("json" . "src json"))
#+end_src

* pdf

#+begin_src emacs-lisp
(use-package pdf-tools
  :demand t
  :ensure-system-package
  ((pdfinfo . poppler)
   (automake . automake)
   (mutool . mupdf)
   ("/usr/local/opt/zlib" . zlib))
  :init
  ;; ä½¿ç”¨ scaling ç¡®ä¿ä¸­æ–‡å­—ä½“ä¸æ¨¡ç³Š
  (setq pdf-view-use-scaling t)
  (setq pdf-view-use-imagemagick nil)
  (setq pdf-annot-activate-created-annotations t)
  (setq pdf-view-resize-factor 1.1)
  ;; open pdfs scaled to fit page
  (setq-default pdf-view-display-size 'fit-page)
  ;; automatically annotate highlights
  (setq pdf-annot-activate-created-annotations t)
  :hook
  ((pdf-view-mode . pdf-view-themed-minor-mode)
   (pdf-view-mode . pdf-view-auto-slice-minor-mode)
   (pdf-view-mode . pdf-isearch-minor-mode))
  :config
  ;; use normal isearch
  (define-key pdf-view-mode-map (kbd "C-s") 'isearch-forward)
  (add-hook 'pdf-view-mode-hook (lambda() (linum-mode -1)))
  (setq pdf-info-epdfinfo-program "/usr/local/bin/epdfinfo")
  (setenv "PKG_CONFIG_PATH" "/usr/local/opt/zlib/lib/pkgconfig:/usr/local/opt/pkgconfig:/usr/local/lib/pkgconfig")
  (pdf-tools-install))

;; pdf è½¬ä¸º png æ—¶ä½¿ç”¨æ›´é«˜åˆ†è¾¨ç‡ï¼ˆé»˜è®¤ 90ï¼‰
(setq doc-view-resolution 144)
#+end_src

+ pdf-tools é»˜è®¤æ˜¯ç™½åº•é»‘å­—ï¼Œå¯ä»¥ï¼š
  + æ·±è‰²æ¨¡å¼ï¼š =M-x pdf-view-midnight-minor-mode=
  + ä¸»é¢˜æ¨¡å¼ï¼š =M-x pdf-view-themed-minor-mode=
+ æœç´¢ä¸­æ–‡æ—¶ï¼Œéœ€è¦ä½¿ç”¨ç³»ç»Ÿä¸­æ–‡è¾“å…¥æ³•å’Œ isearch æ¨¡å¼, æˆ–è€…ä½¿ç”¨ =M-s o(occur)= ï¼›phi-search ä¸ pdf-tools ä¸å…¼å®¹ï¼›

* rss

#+begin_src emacs-lisp
(use-package elfeed
  :demand t
  :config
  (setq elfeed-db-directory (expand-file-name "elfeed" user-emacs-directory))
  (setq elfeed-show-entry-switch 'display-buffer)
  (setq elfeed-curl-timeout 30)
  (setf url-queue-timeout 40)
  (push "-k" elfeed-curl-extra-arguments)
  (setq elfeed-search-filter "@1-months-ago +unread")
  ;; åœ¨åŒä¸€ä¸ª buffer ä¸­æ˜¾ç¤º entry
  (setq elfeed-show-unique-buffers nil)
  (setq elfeed-search-title-max-width 150)
  (setq elfeed-search-date-format '("%Y-%m-%d %H:%M" 20 :left))
  (setq elfeed-log-level 'warn))

(use-package elfeed-org
  :custom ((rmh-elfeed-org-files (list "~/.emacs.d/elfeed.org")))
  :hook
  ((elfeed-dashboard-mode . elfeed-org)
  (elfeed-show-mode . elfeed-org))
  :config
  (progn
    (defun my/reload-org-feeds ()
      (interactive)
      (rmh-elfeed-org-process rmh-elfeed-org-files rmh-elfeed-org-tree-id))
    (advice-add 'elfeed-dashboard-update :before #'my/reload-org-feeds)))

(use-package elfeed-dashboard
  :config
  (global-set-key (kbd "C-c f") 'elfeed-dashboard)
  (setq elfeed-dashboard-file "~/.emacs.d/elfeed-dashboard.org")
  ;; update feed counts on elfeed-quit
  (advice-add 'elfeed-search-quit-window :after #'elfeed-dashboard-update-links))

(use-package elfeed-score
  :config
  (progn
    (elfeed-score-enable)
    (define-key elfeed-search-mode-map "=" elfeed-score-map)))

(use-package elfeed-goodies
  :config
  (setq elfeed-goodies/entry-pane-position 'bottom)
  (setq elfeed-goodies/feed-source-column-width 30)
  (setq elfeed-goodies/tag-column-width 30)
  (setq elfeed-goodies/powerline-default-separator 'arrow)
  (elfeed-goodies/setup))

;; feed æ”¶è—ï¼Œ http://pragmaticemacs.com/emacs/star-and-unstar-articles-in-elfeed/
(require 'elfeed)
(defalias 'elfeed-toggle-star
  (elfeed-expose #'elfeed-search-toggle-all 'star))

(eval-after-load 'elfeed-search
  '(define-key elfeed-search-mode-map (kbd "m") 'elfeed-toggle-star))

;; face for starred articles
(defface elfeed-search-star-title-face
  '((t :foreground "#f77"))
  "Marks a starred Elfeed entry.")

(push '(star elfeed-search-star-title-face) elfeed-search-face-alist)

;; elfeed-goodies æ˜¾ç¤ºæ—¥æœŸæ 
;;https://github.com/algernon/elfeed-goodies/issues/15#issuecomment-243358901
(defun elfeed-goodies/search-header-draw ()
  "Returns the string to be used as the Elfeed header."
  (if (zerop (elfeed-db-last-update))
      (elfeed-search--intro-header)
    (let* ((separator-left (intern (format "powerline-%s-%s"
                                           elfeed-goodies/powerline-default-separator
                                           (car powerline-default-separator-dir))))
           (separator-right (intern (format "powerline-%s-%s"
                                            elfeed-goodies/powerline-default-separator
                                            (cdr powerline-default-separator-dir))))
           (db-time (seconds-to-time (elfeed-db-last-update)))
           (stats (-elfeed/feed-stats))
           (search-filter (cond
                           (elfeed-search-filter-active
                            "")
                           (elfeed-search-filter
                            elfeed-search-filter)
                           (""))))
      (if (>= (window-width) (* (frame-width) elfeed-goodies/wide-threshold))
          (search-header/draw-wide separator-left separator-right search-filter stats db-time)
        (search-header/draw-tight separator-left separator-right search-filter stats db-time)))))

(defun elfeed-goodies/entry-line-draw (entry)
  "Print ENTRY to the buffer."
  (let* ((title (or (elfeed-meta entry :title) (elfeed-entry-title entry) ""))
         (date (elfeed-search-format-date (elfeed-entry-date entry)))
         (title-faces (elfeed-search--faces (elfeed-entry-tags entry)))
         (feed (elfeed-entry-feed entry))
         (feed-title
          (when feed
            (or (elfeed-meta feed :title) (elfeed-feed-title feed))))
         (tags (mapcar #'symbol-name (elfeed-entry-tags entry)))
         (tags-str (concat "[" (mapconcat 'identity tags ",") "]"))
         (title-width (- (window-width) elfeed-goodies/feed-source-column-width
                         elfeed-goodies/tag-column-width 4))
         (title-column (elfeed-format-column
                        title (elfeed-clamp
                               elfeed-search-title-min-width
                               title-width
                               title-width)
                        :left))
         (tag-column (elfeed-format-column
                      tags-str (elfeed-clamp (length tags-str)
                                             elfeed-goodies/tag-column-width
                                             elfeed-goodies/tag-column-width)
                      :left))
         (feed-column (elfeed-format-column
                       feed-title (elfeed-clamp elfeed-goodies/feed-source-column-width
                                                elfeed-goodies/feed-source-column-width
                                                elfeed-goodies/feed-source-column-width)
                       :left)))

    (if (>= (window-width) (* (frame-width) elfeed-goodies/wide-threshold))
        (progn
          (insert (propertize date 'face 'elfeed-search-date-face) " ")
          (insert (propertize feed-column 'face 'elfeed-search-feed-face) " ")
          (insert (propertize tag-column 'face 'elfeed-search-tag-face) " ")
          (insert (propertize title 'face title-faces 'kbd-help title)))
      (insert (propertize title 'face title-faces 'kbd-help title)))))
#+end_src

elfeed-score è§„åˆ™æ–‡ä»¶([[https://www.unwoundstack.com/doc/elfeed-score/curr][è¯­æ³•å‚è€ƒ]]):
#+begin_src emacs-lisp :tangle ~/.emacs.d/elfeed.score
;;; Elfeed score file                                     -*- lisp -*-
(
;; ("title"
;;   (:text "opsnull" :value 250 :type S))
;;  ("content"
;;   (:text "type erasure" :value 500 :type s))
 ("title-or-content"
;;  (:text "emacs" :title-value 150 :content-value 100 :type s)
  (:text "opsnull" :title-value 150 :content-value 100 :type w))
 ("feed"
  (:text "Irreal" :value 250 :type S :attr t)
  (:text "emacs-news â€“ sacha chua" :value 350 :type S :attr t :comment "Essential!"))
;; ("authors"
;;  (:text "opsnull" :value 500 :type s))
;; ("tag"
;;  (:tags (t . reddit-question)
;;         :value 750
;;         :comment "Add 750 points to any entry with a tag of reddit-question"))
 (mark -2500))
#+end_src

* twitter

#+begin_src emacs-lisp
(use-package twittering-mode
  :commands (twit)
  :init
  ;; è§£å†³æŠ¥é”™"epa--decode-coding-string not defined"
  (defalias 'epa--decode-coding-string 'decode-coding-string)
  (setq twittering-icon-mode t)
  (setq twittering-use-icon-storage t)
  ;; è§£å†³å†…ç½®çš„ twitter æ ¹è¯ä¹¦å¤±æ•ˆçš„é—®é¢˜
  (setq twittering-allow-insecure-server-cert t)
  (setq twittering-use-master-password t))
#+end_src
+ é»˜è®¤å°† OAuth Token åŠ å¯†ä¿å­˜åˆ° =~/.twittering-mode.gpg=, ç¬¬ä¸€æ¬¡éœ€è¦è¾“å…¥ä¸¤æ¬¡ç›¸åŒçš„åŠ å¯†å¯†ç ã€‚

* magit

magit æ˜¯ emacs æœ€å¼ºå¤§ã€æœ€å¥½ç”¨çš„ç‰ˆæœ¬æ§åˆ¶ç³»ç»Ÿæ“ä½œç•Œé¢ï¼Œæ²¡æœ‰ä¹‹ä¸€ï¼
#+begin_src emacs-lisp
;; Don't warn for following symlinked files
(setq vc-follow-symlinks t)

(use-package magit
  :custom
  ;; åœ¨å½“å‰ window ä¸­æ˜¾ç¤º magit buffer
  (magit-display-buffer-function #'magit-display-buffer-same-window-except-diff-v1)
  ;; è‡ªåŠ¨ kill magit buffers
  (defun mu-magit-kill-buffers ()
    "Restore window configuration and kill all Magit buffers."
    (interactive)
    (let ((buffers (magit-mode-get-buffers)))
      (magit-restore-window-configuration)
      (mapc #'kill-buffer buffers)))

  (bind-key "q" #'mu-magit-kill-buffers magit-status-mode-map)
  (bind-key "q" #'mu-magit-kill-buffers magit-log-mode-map)
  (bind-key "q" #'mu-magit-kill-buffers magit-mode-map))
#+end_src
+ =(setq auto-revert-check-vc-info t)= è‡ªåŠ¨ revert bufferï¼Œç¡®ä¿ modeline ä¸Šçš„åˆ†æ”¯åæ­£ç¡®ï¼Œä½†æ˜¯ CPU Profile æ˜¾ç¤ºæ¯”è¾ƒå½±å“æ€§èƒ½ï¼Œ
  æ•…æš‚ä¸å¼€å¯ã€‚

git-link æ ¹æ®ä»“åº“åœ°å€ã€commit ç­‰ä¿¡æ¯ä¸ºå…‰æ ‡ä½ç½®ç”Ÿæˆ URL:
#+begin_src emacs-lisp
(use-package git-link
  :config
  (global-set-key (kbd "C-c g l") 'git-link)
  (setq git-link-use-commit t))
#+end_src

* ediff

#+begin_src emacs-lisp
(use-package ediff
  :straight (:type built-in)
  :config
  ;; å¿½ç•¥ç©ºæ ¼
  (setq ediff-diff-options "-w")
  (setq ediff-split-window-function 'split-window-horizontally)
  ;; ä¸åˆ›å»ºæ–°çš„ frame æ¥æ˜¾ç¤º Control-Panel
  (setq ediff-window-setup-function #'ediff-setup-windows-plain)
  ;; å¯åŠ¨ ediff å‰å…³é—­ treemacs frame, å¦åˆ™ Control-Panel æ˜¾ç¤ºå¼‚å¸¸
  (add-hook 'ediff-before-setup-hook
            (lambda ()
              (require 'treemacs)
              (if (string-match "visible" (symbol-name (treemacs-current-visibility)))
                  (delete-window (treemacs-get-local-window)) ) ))

  ;; ediff æ—¶è‡ªåŠ¨å±•å¼€ org-mode, https://dotemacs.readthedocs.io/en/latest/#ediff
  (defun f-ediff-org-showhide (buf command &rest cmdargs)
    "If buffer exists and is orgmode then execute command"
    (when buf
      (when (eq (buffer-local-value 'major-mode (get-buffer buf)) 'org-mode)
        (save-excursion (set-buffer buf) (apply command cmdargs)))))

  (defun f-ediff-org-unfold-tree-element ()
    "Unfold tree at diff location"
    (f-ediff-org-showhide ediff-buffer-A 'org-reveal)
    (f-ediff-org-showhide ediff-buffer-B 'org-reveal)
    (f-ediff-org-showhide ediff-buffer-C 'org-reveal))

  (defun f-ediff-org-fold-tree ()
    "Fold tree back to top level"
    (f-ediff-org-showhide ediff-buffer-A 'hide-sublevels 1)
    (f-ediff-org-showhide ediff-buffer-B 'hide-sublevels 1)
    (f-ediff-org-showhide ediff-buffer-C 'hide-sublevels 1))

  (add-hook 'ediff-select-hook 'f-ediff-org-unfold-tree-element)
  (add-hook 'ediff-unselect-hook 'f-ediff-org-fold-tree))
#+end_src

* coding
** flycheck

flycheck æ˜¯ç°ä»£çš„åœ¨çº¿è¯­æ³•æ£€æŸ¥å·¥å…·, ç”¨äºå–ä»£ emacs å†…ç½®çš„ flymake å·¥å…·ã€‚å®ƒä½¿ç”¨ç³»
ç»Ÿå®‰è£…çš„å·¥å…·å¯¹ buffer è¿›è¡Œæ£€æŸ¥ï¼š
+ C-c ! v (flycheck-verify-setup): æŸ¥çœ‹å½“å‰ buffer ä½¿ç”¨ checker(é»˜è®¤ä½¿ç”¨ lsp
  checker) ã€‚
+ C-c ! l (flycheck-list-errors): åˆ—å‡ºå½“å‰ workspace æ‰€æœ‰ error ã€‚

#+begin_src emacs-lisp
(use-package flycheck
  :demand t
  :config
  ;; é«˜äº®å‡ºç°é”™è¯¯çš„åˆ—ä½ç½®
  (setq flycheck-highlighting-mode (quote columns))
  (setq flycheck-check-syntax-automatically '(save idle-change mode-enabled))
  (define-key flycheck-mode-map (kbd "M-g n") #'flycheck-next-error)
  (define-key flycheck-mode-map (kbd "M-g p") #'flycheck-previous-error)
  :hook
  (prog-mode . flycheck-mode))

;; flycheck-pos-tip ç”¨äºåœ¨çº¿æ˜¾ç¤º flycheck é”™è¯¯ï¼š
(use-package flycheck-pos-tip
  :after (flycheck)
  :config
  (flycheck-pos-tip-mode))

;; flycheck å®æ—¶é¢„è§ˆ
(use-package consult-flycheck
  :after (consult flycheck)
  :bind
  (:map flycheck-command-map ("!" . consult-flycheck)))
#+end_src
+ M-g f æˆ– C-c !! (consult-flycheck)

** lsp

#+begin_src emacs-lisp
(use-package lsp-mode
  :hook
  ((java-mode . lsp)
  (python-mode . lsp)
  (go-mode . lsp)
  ;;(yaml-mode . lsp)
  ;;(js-mode . lsp)
  (web-mode . lsp)
  (tide-mode . lsp)
  (typescript-mode . lsp)
  (dockerfile-mode . lsp))
  :custom
  ;; è°ƒè¯•æ¨¡å¼ï¼ˆå¼€å¯åéå¸¸å½±å“æ€§èƒ½ï¼‰
  ;;(lsp-log-io t)
  (lsp-enable-folding t)
  ;; lsp æ˜¾ç¤ºçš„ links ä¸å‡†ç¡®ä¸”å¯¼è‡´ treemacs ç›®å½•æ˜¾ç¤ºå¼‚å¸¸ï¼Œæ•…å…³é—­ã€‚
  ;; https://github.com/hlissner/doom-emacs/issues/2911
  ;; https://github.com/Alexander-Miller/treemacs/issues/626
  (lsp-enable-links nil)
  ;; ä¸åœ¨ modeline ä¸Šæ˜¾ç¤º code-actions ä¿¡æ¯
  (lsp-modeline-code-actions-enable nil)
  (lsp-keymap-prefix "C-c l")
  (lsp-auto-guess-root t)
  (lsp-diagnostics-provider :flycheck)
  (lsp-diagnostics-flycheck-default-level 'warning)
  ;; flycheck ä¼šåœ¨ modeline å±•ç¤ºæ£€æŸ¥æƒ…å†µ, æ•…æ²¡å¿…è¦å†å±•ç¤º
  (lsp-modeline-diagnostics-enable nil)
  (lsp-completion-provider :capf)
  (lsp-enable-symbol-highlighting t)
  (lsp-headerline-breadcrumb-enable t)
  (lsp-headerline-breadcrumb-segments '(path-up-to-project file symbols))
  ;; å¯ç”¨ snippet åæ‰æ”¯æŒå‡½æ•°æˆ–æ–¹æ³•çš„ placeholder æç¤º
  (lsp-enable-snippet t)
  (lsp-eldoc-render-all t)
  ;; ä½¿ç”¨ posframe åœ¨å…‰æ ‡ä½ç½®å¤„æ˜¾ç¤ºå‡½æ•°ç­¾å
  (lsp-signature-function 'lsp-signature-posframe)
  (lsp-signature-doc-lines 20)
  ;; å¢åŠ  IO æ€§èƒ½
  (process-adaptive-read-buffering nil)
  ;; refresh the highlights, lenses, links
  (lsp-idle-delay 0.1)
  (lsp-keep-workspace-alive nil)
  (lsp-enable-file-watchers nil)
  (lsp-restart 'auto-restart)
  :config
  (dolist (dir '("[/\\\\][^/\\\\]*\\.\\(json\\|html\\|pyc\\|class\\|log\\|jade\\|md\\)\\'"
                 "[/\\\\]resources/META-INF\\'"
                 "[/\\\\]vendor\\'"
                 "[/\\\\]\\.settings\\'"
                 "[/\\\\]\\.project\\'"
                 "[/\\\\]\\.travis\\'"
                 "[/\\\\]bazel-*"
                 "[/\\\\]\\.cache"
                 "[/\\\\]\\.clwb$"))
    (push dir lsp-file-watch-ignored-directories))
  :bind
  (:map lsp-mode-map
        ("C-c f" . lsp-format-region)
        ("C-c d" . lsp-describe-thing-at-point)
        ("C-c a" . lsp-execute-code-action)
        ("C-c r" . lsp-rename)))
#+end_src

consult-lsp æä¾›ä¸¤ä¸ªéå¸¸æœ‰ç”¨çš„å‘½ä»¤ï¼šconsult-lsp-symbols å’Œ consult-lsp-diagnosticsï¼š
#+begin_src emacs-lisp
(use-package consult-lsp
  :after (lsp-mode consult)
  :config
  (define-key lsp-mode-map [remap xref-find-apropos] #'consult-lsp-symbols))
#+end_src
+ consult-lsp-symbols: C-M-.

lsp-ui æ˜¾ç¤ºå¸®åŠ©ä¿¡æ¯ï¼š
#+begin_src emacs-lisp
(use-package lsp-ui
  :after (lsp-mode flycheck)
  :custom
  ;; å…³é—­ cursor hover, ä½† mouse hover æ—¶æ˜¾ç¤ºæ–‡æ¡£
  (lsp-ui-doc-show-with-cursor nil)
  ;; ä¸æ˜¾ç¤ºç›®å½•(ä¸€èˆ¬æ¯”è¾ƒé•¿è¢«æˆªæ–­)
  (lsp-ui-peek-show-directory t)
  ;; æ–‡ä»¶åˆ—è¡¨å®½åº¦
  (lsp-ui-peek-list-width 70)
  (lsp-ui-doc-delay 0.1)
  ;; å¯ç”¨ flycheck é›†æˆ
  (lsp-ui-flycheck-enable t)
  (lsp-ui-sideline-enable nil)
  :config
  (define-key lsp-ui-mode-map [remap xref-find-definitions] #'lsp-ui-peek-find-definitions)
  (define-key lsp-ui-mode-map [remap xref-find-references] #'lsp-ui-peek-find-references))
#+end_src
+ lsp-mode å’Œ lsp-ui çš„ç‰¹æ€§å¯ä»¥[[https://emacs-lsp.github.io/lsp-mode/tutorials/how-to-turn-off/][å‚è€ƒè¿™ä¸ªé¡µé¢]]æ¥è¿›è¡Œé€‰æ‹©æ€§çš„æ‰“å¼€å’Œå…³é—­ï¼›

** python
*** pyenv

=pyenv= å’Œ =pyenv-virtualen= å¯ä»¥ä¸ºé¡¹ç›®æˆ–ç³»ç»ŸæŒ‡å®šä¸åŒéš”ç¦»çš„ python æˆ– venv ç‰ˆæœ¬ã€‚

#+begin_src emacs-lisp
(use-package emacs
  :straight (:type built-in)
  :ensure-system-package
  ((pyenv . "brew install --HEAD pyenv")
   (pyenv-virtualenv . "brew install --HEAD pyenv-virtualenv")))
#+end_src

ä¸ºäº†åœ¨è¿›å…¥é¡¹ç›®ç›®å½•æ—¶è‡ªåŠ¨åˆ‡æ¢åˆ°æŒ‡å®š pyenv æˆ– venv ç‰ˆæœ¬ï¼Œéœ€è¦é…ç½® =~/.bashrc= ï¼š
#+begin_src shell :results none
eval "$(pyenv init -)"
eval "$(pyenv virtualenv-init -)"
eval "$(jenv init -)"
#+end_src

pyenv ä½¿ç”¨æ–¹æ³•ï¼š
1. åˆ—å‡ºå¯ä»¥å®‰è£…çš„ python ç‰ˆæœ¬ï¼š =pyenv install -l=
2. å®‰è£…æŒ‡å®šçš„ python ç‰ˆæœ¬ï¼š =pyenv install <version>=
3. åˆ›å»ºä¸€ä¸ª pyenv virtualenvï¼š =pyenv virtualenv [version] <virtualenv-name>=
4. ä¸ºé¡¹ç›®æŒ‡å®š python ç‰ˆæœ¬æˆ–ä¸Šä¸€æ­¥åˆ›å»ºçš„ virtualenv åç§°ï¼š
   + åœ¨é¡¹ç›®æ ¹ç›®å½•æ‰§è¡Œ =pyenv local <version1> <version2>=
5. æŒ‡å®šç”¨æˆ·é»˜è®¤ä½¿ç”¨ 3.9.0 python ç‰ˆæœ¬:
   + åœ¨å®¶ç›®å½•æ‰§è¡Œå‘½ä»¤: =cd ~ && pyenv local 3.9.0=
   + åç»­å®¶ç›®å½•ä¸‹æ‰§è¡Œ pip  å‘½ä»¤å®‰è£…çš„åŒ…éƒ½æ˜¯ 3.x ç‰ˆæœ¬ã€‚
6. å¦‚æœè™šæ‹Ÿç¯å¢ƒä¸­æ²¡æœ‰ pip å‘½ä»¤ï¼Œå®‰è£…ï¼š =python -m ensurepip=

*** python-mode

#+begin_src emacs-lisp
(defun my/python-setup-shell (&rest args)
  "Set up python shell"
  (if (executable-find "ipython")
      (progn
        (setq python-shell-interpreter "ipython")
        ;; ipython version >= 5
        (setq python-shell-interpreter-args "--simple-prompt -i"))
    (progn
      (setq python-shell-interpreter "python")
      (setq python-shell-interpreter-args "-i"))))

(defun my/python-setup-checkers (&rest args)
  (when (fboundp 'flycheck-set-checker-executable)
    (let ((pylint (executable-find "pylint"))
          (flake8 (executable-find "flake8")))
      (when pylint
        (flycheck-set-checker-executable "python-pylint" pylint))
      (when flake8
        (flycheck-set-checker-executable "python-flake8" flake8)))))

(use-package python
  :after (flycheck)
  :ensure-system-package
  ((pylint . pylint)
   (flake8 . flake8)
   (ipython . "pip install ipython"))
  :hook
  (python-mode . (lambda ()
                   (my/python-setup-shell)
                   (my/python-setup-checkers)
                   (setq indent-tabs-mode nil)
                   (setq tab-width 4)
                   (setq python-indent-offset 4))))
#+end_src

*** lsp-pyright

å¾®è½¯ä¸å†ç»´æŠ¤ python-language-serverï¼Œä¸»åŠ›å‘å±• pyright å’Œ pyglanceï¼Œæ‰€ä»¥ä¸å†ä½¿ç”¨
lsp-python-ms å’Œ pylsï¼Œè€Œä½¿ç”¨ lsp-pyrightã€‚

#+begin_src emacs-lisp
;;(shell-command "mkdir -p ~/.emacs.d/.cache/lsp/npm/pyright/lib")
(use-package lsp-pyright
  :after (python)
  :ensure-system-package
  ((pyright . "sudo npm update -g pyright")
   (yapf . "pip install yapf"))
  :preface
  ;; ä½¿ç”¨ yapf æ ¼å¼åŒ– python ä»£ç 
  (defun lsp-pyright-format-buffer ()
    (interactive)
    (when (and (executable-find "yapf") buffer-file-name)
      (call-process "yapf" nil nil nil "-i" buffer-file-name)))
  :hook
  (python-mode . (lambda ()
                   (require 'lsp-pyright)
                   (add-hook 'after-save-hook #'lsp-pyright-format-buffer t t)))
  :init
  (when (executable-find "python3")
    (setq lsp-pyright-python-executable-cmd "python3")))
#+end_src

pyright _ä¸ä½¿ç”¨_ pyenv çš„ ~.python-version~ æŒ‡å®šçš„ python ç‰ˆæœ¬æˆ– venvï¼Œéœ€è¦åœ¨é¡¹ç›®çš„
=pyrightconfig.json= æ–‡ä»¶ä¸­é…ç½® venv å’Œ venvPath å‚æ•°æ¥æŒ‡å®š python ç¯å¢ƒï¼š
+ venvPathï¼šæŒ‡å®šæŸ¥æ‰¾ venv ç›®å½•çš„ä¸Šçº§ç›®å½•ï¼Œå¯ä»¥åŒ…å«å¤šä¸ª venv ç¯å¢ƒï¼›
+ venvï¼šæŒ‡å®š venvPath ç›®å½•ä¸‹çš„ã€ä½¿ç”¨çš„è™šæ‹Ÿç¯å¢ƒåç§°ã€‚pyright åœ¨ venv ä¸­æœç´¢ pip
  å®‰è£…çš„åŒ…;

å®‰è£… =pyenv-pyright= æ’ä»¶æ¥æ–¹ä¾¿çš„åˆ›å»ºå’Œæ›´æ–° =pyrightconfig.json= æ–‡ä»¶ï¼š
#+begin_src shell :results none
git clone https://github.com/alefpereira/pyenv-pyright.git $(pyenv root)/plugins/pyenv-pyright
#+end_src

ä½¿ç”¨æ–¹æ³•ï¼š
1. ä½¿ç”¨ =pyenv local= ä¸ºé¡¹ç›®æŒ‡å®š pyenv virtualenv;
2. ä½¿ç”¨ =pyenv pyright= æ¥è‡ªåŠ¨é…ç½® =pyrightconfig.json= ä½¿ç”¨ä¸Šä¸€æ­¥æŒ‡å®šçš„ virtualenvï¼›

pyright å‡è®¾æºæ–‡ä»¶ä½äºé¡¹ç›® scr ç›®å½•ä¸‹ï¼Œä½†å®é™…å¯èƒ½ä¼šåœ¨å¤šä¸ªå…¶å®ƒå­ç›®å½•ï¼ˆç”šè‡³åµŒå¥—æƒ…
å†µï¼‰ä¸­æ”¾ç½®é¡¹ç›®æºç ï¼Œå³ =multi-root= æ¨¡å¼ï¼ˆå¯¹åº”äº vscode ä¸­çš„å¤š worksapce ç›®å½•)ï¼Œè¿™
æ—¶å¯èƒ½å‡ºç°å¤§é‡ import é”™è¯¯ï¼Œå¯ä»¥é€šè¿‡åœ¨é¡¹ç›®æ ¹ç›®å½•é…ç½® =pyrightconfig.json= æ–‡ä»¶æ¥è§£
å†³ï¼Œä¾‹å¦‚ï¼ˆå‚è€ƒï¼špython module [[https://github.com/microsoft/pyright/blob/main/docs/import-resolution.md][Import Resolution]]ï¼‰ï¼š
#+begin_src json :results none
{
    "venv": "venv-2.7.18",
    "venvPath": "/Users/zhangjun/.pyenv/versions",
    "verboseOutput": true,
    "reportMissingTypeStubs": false,
    "executionEnvironments": [
        {
            "root": "scripts",
            "extraPaths": [
                ".",  // scripts ç›®å½•ä¸‹ py æ–‡ä»¶å¯¼å…¥åŒçº§ py æ–‡ä»¶çš„æƒ…å†µ
                "scripts/appinstance_apply"
            ]
        }
    ]
}
#+end_src

executionEnvironmentsï¼š
1. åˆ—è¡¨ä¸­ root æŒ‡å®šå„ workspace çš„å­ç›®å½•ï¼Œæ˜¯æœ‰æœç´¢ä¼˜å…ˆçº§çš„ï¼Œæ‰€ä»¥å¦‚æœæœ‰ç›¸åŒè·¯å¾„å‰
   ç¼€çš„æƒ…å†µï¼Œåº”è¯¥ä»é•¿åˆ°çŸ­ä¾åˆ—å‡ºæ¥ï¼š æ ¹æ® python æ–‡ä»¶çš„ from/import è¯­å¥æ¥ç¡®å®š
   root è·¯å¾„ï¼šå³ä»é¡¹ç›®æ ¹ç›®å½•ï¼ˆpyrightconfig.json æ–‡ä»¶æ‰€åœ¨ç›®å½•ï¼‰å¼€å§‹åˆ°æ–‡ä»¶ä¸­å¯¼å…¥
   è·¯å¾„æœ€å¼€å§‹æ‰€åœ¨ç›®å½•ä¹‹é—´çš„ç›®å½•ï¼Œéƒ½åº”è¯¥æ˜¯ rootã€‚
2. extraPaths åˆ—è¡¨ä¸­çš„è·¯å¾„å¯ä»¥æ˜¯ç»å¯¹è·¯å¾„æˆ–ç›¸å¯¹è·¯å¾„ï¼ˆç›¸å¯¹äº pyrightconfig.json æ–‡
   ä»¶ï¼‰ï¼Œç”¨äºæ·»åŠ é¢å¤–çš„ python module æœç´¢è·¯å¾„ï¼›
   + æ·»åŠ  "." æ˜¯å› ä¸ºéœ€è¦å°† scripts æ‰€åœ¨çš„ç›®å½•ä¹Ÿæ·»åŠ åˆ° module æœç´¢è·¯å¾„ï¼Œè€Œä¸ä»…ä»…
     æ˜¯ scripts ä¸‹çš„å­ç›®å½•ï¼›
3. å®˜æ–¹çš„å®ä¾‹å‚è€ƒï¼š[[https://github.com/microsoft/pyright/blob/main/docs/configuration.md#sample-config-file][Sample Config File]] å’Œ [[https://github.com/microsoft/pyright/blob/main/packages/pyright-internal/src/tests/testState.test.ts][testState.test.ts]]ï¼›

[[https://github.com/Microsoft/pyright/issues/21][pyright ä¸æ”¯æŒ python 2.x]]ï¼Œå¦‚æœåœ¨ä¸Šé¢æ–‡ä»¶é…ç½® ="pythonVersion": "2.7"= åˆ™ä¼šæŠ¥é”™ã€‚

ä¿®æ”¹ pyrightconfig.json åï¼Œéœ€è¦æ‰§è¡Œ ~M-x lsp-workspace-restart~ æ¥é‡å¯ lspï¼Œå¦‚æœ
è¿˜æ˜¯æœ‰é—®é¢˜ï¼Œåˆ™å¯ä»¥æŸ¥çœ‹ =*lsp-log*= buffer çš„æ—¥å¿—ã€‚

** java

é»˜è®¤å°† lsp java server å®‰è£…åˆ° ~/.emacs.d/.cache/lsp/eclipse.jdt.ls ç›®å½•ã€‚

æ‰‹åŠ¨å®‰è£… lombok:
#+begin_src shell :results none
mvn dependency:get -DrepoUrl=http://download.java.net/maven/2/ -DgroupId=org.projectlombok -DartifactId=lombok -Dversion=1.18.6
#+end_src

#+begin_src emacs-lisp
(use-package lsp-java
  :disabled t
  :after (lsp-mode)
  :init
  ;; æŒ‡å®šè¿è¡Œ jdtls çš„ java ç¨‹åº
  (setq lsp-java-java-path "/Library/Java/JavaVirtualMachines/jdk-11.0.9.jdk/Contents/Home")
  ;; æŒ‡å®š jdtls ç¼–è¯‘æºç ä½¿ç”¨çš„ jdk ç‰ˆæœ¬ï¼ˆé»˜è®¤æ˜¯å¯åŠ¨ jdtls çš„ java ç‰ˆæœ¬ï¼‰ã€‚
  ;; https://marketplace.visualstudio.com/items?itemName=redhat.java
  ;; æŸ¥çœ‹æ‰€æœ‰ java ç‰ˆæœ¬ï¼š/usr/libexec/java_home -verbose
  (setq lsp-java-configuration-runtimes
        '[(:name "Java SE 8" :path "/Library/Java/JavaVirtualMachines/jdk1.8.0_271.jdk/Contents/Home" :default t)
          (:name "Java SE 11.0.9" :path "/Library/Java/JavaVirtualMachines/jdk-11.0.9.jdk/Contents/Home")
          (:name "Java SE 15.0.1" :path "/Library/Java/JavaVirtualMachines/jdk-15.0.1.jdk/Contents/Home")])
  ;; jdk11 ä¸æ”¯æŒ -Xbootclasspath/a: å‚æ•°ã€‚
  (setq lsp-java-vmargs
        (list "-noverify" "-Xmx2G" "-XX:+UseG1GC" "-XX:+UseStringDeduplication"
              (concat "-javaagent:" (expand-file-name "~/.m2/repository/org/projectlombok/lombok/1.18.6/lombok-1.18.6.jar"))))
  :hook (java-mode . lsp)
  :config
  (use-package dap-java :disabled t))
#+end_src

** go

#+begin_src emacs-lisp
(use-package go-mode
  :after (lsp-mode)
  :ensure-system-package (gopls . "go get golang.org/x/tools/gopls@latest")
  :init
  (defun lsp-go-install-save-hooks ()
    (add-hook 'before-save-hook #'lsp-format-buffer t t)
    (add-hook 'before-save-hook #'lsp-organize-imports t t))
  :custom
  (lsp-gopls-staticcheck t)
  (lsp-gopls-complete-unimported t)
  :hook
  (go-mode . lsp-go-install-save-hooks)
  :config
  (lsp-register-custom-settings
   `(("gopls.completeUnimported" t t)
     ("gopls.experimentalWorkspaceModule" t t)
     ("gopls.allExperiments" t t))))
#+end_src
+ gopls ç¨³å®šå˜é‡å¯ä»¥é€šè¿‡ setq æ¥è®¾ç½®ï¼Œå¦‚ (setq lsp-gopls-use-placeholders nil),
  è¯¦ç»†å‚è€ƒ [[https://github.com/emacs-lsp/lsp-mode/blob/master/clients/lsp-go.el][lsp-go]] ï¼Œå®éªŒå˜é‡é€šè¿‡ =lsp-register-custom-settings= è®¾ç½®ã€‚
+ éœ€è¦å¼€å¯ =gopls.experimentalWorkspaceModule= æ”¯æŒåµŒå…¥å¼ module, å¦åˆ™å¯èƒ½å‡ºé”™ï¼š
#+begin_quote
emacs errors loading workspace: You are working in a nested module. Please open it as a separate workspace folder. Learn more:
#+end_quote

go-playground æä¾›å¿«æ·çš„æœ¬åœ°åŒ–ä»£ç æ‰§è¡ŒåŠŸèƒ½:
#+begin_src emacs-lisp
(use-package go-playground :demand t)
#+end_src

** markdown

multimarkdown å°† markdown è½¬æ¢ä¸º html è¿›è¡Œ previewï¼Œå¯ä»¥ç»“åˆ xwidget webkit æˆ–
grip è¿›è¡Œå®æ—¶é¢„è§ˆï¼š

#+begin_src emacs-lisp
(use-package markdown-mode
  :ensure-system-package multimarkdown
  :commands (markdown-mode gfm-mode)
  :mode
  (("README\\.md\\'" . gfm-mode)
   ("\\.md\\'" . markdown-mode)
   ("\\.markdown\\'" . markdown-mode))
  :init
  (when (executable-find "multimarkdown")
    (setq markdown-command "multimarkdown"))
  (setq markdown-enable-wiki-links t)
  (setq markdown-italic-underscore t)
  (setq markdown-asymmetric-header t)
  (setq markdown-make-gfm-checkboxes-buttons t)
  (setq markdown-gfm-uppercase-checkbox t)
  (setq markdown-fontify-code-blocks-natively t)
  (setq markdown-gfm-additional-languages "Mermaid")
  (setq markdown-content-type "application/xhtml+xml")
  (setq markdown-css-paths '("https://cdn.jsdelivr.net/npm/github-markdown-css/github-markdown.min.css"
                             "https://cdn.jsdelivr.net/gh/highlightjs/cdn-release/build/styles/github.min.css"))
  (setq markdown-xhtml-header-content "
<meta name='viewport' content='width=device-width, initial-scale=1, shrink-to-fit=no'>
<style>
body {
  box-sizing: border-box;
  max-width: 740px;
  width: 100%;
  margin: 40px auto;
  padding: 0 10px;
}
</style>
<link rel='stylesheet' href='https://cdn.jsdelivr.net/gh/highlightjs/cdn-release/build/styles/default.min.css'>
<script src='https://cdn.jsdelivr.net/gh/highlightjs/cdn-release/build/highlight.min.js'></script>
<script>
document.addEventListener('DOMContentLoaded', () => {
  document.body.classList.add('markdown-body');
  document.querySelectorAll('pre code').forEach((code) => {
    if (code.className != 'mermaid') {
      hljs.highlightBlock(code);
    }
  });
});
</script>
<script src='https://unpkg.com/mermaid@8.4.8/dist/mermaid.min.js'></script>
<script>
mermaid.initialize({
  theme: 'default',  // default, forest, dark, neutral
  startOnLoad: true
});
</script>
"))
#+end_src

ä½¿ç”¨ grip æ¥é¢„è§ˆ markdown æ–‡ä»¶ï¼Œå®ƒè°ƒç”¨ github markdown API æ¥æ¸²æŸ“æ–‡ä»¶ï¼Œä»è€Œç¡®ä¿æ¸²æŸ“ååˆ†éš”å’Œ Github ä¸€è‡´ã€‚ä¸ºäº†é¿å… API è°ƒ
ç”¨é¢‘ç‡é™åˆ¶ï¼Œå¯ä»¥åˆ›å»ºä¸€ä¸ªç©º scop çš„Access Tokenï¼Œç„¶åå°† username å’Œ token ä¿å­˜åˆ° =~/.authinfo.gpg= æ–‡ä»¶ä¸­ï¼š

#+begin_src bash :results none
machine api.github.com login geekard@qq.com password YOUR_TOKEN
#+end_src

åœ¨ Markdown Buffer ä¸­ï¼Œæ‰§è¡Œ =M-x grip-mode= æ¥å¯ç”¨å®æ—¶é¢„è§ˆï¼Œç„¶åå¯ä»¥æ‰§è¡Œå¦‚ä¸‹å‘½ä»¤ï¼š
+ M-x grip-start-preview
+ M-x grip-stop-preview
+ M-x grip-restart-preview
+ M-x grip-browse-preview ä½¿ç”¨æµè§ˆå™¨æ¥é¢„è§ˆ
#+begin_src emacs-lisp
(use-package grip-mode
  :ensure-system-package
  (grip . "pip install grip")
  :bind
  (:map markdown-mode-command-map ("g" . grip-mode))
  :config
  (setq grip-preview-use-webkit nil)
  ;; æ”¯æŒç½‘ç»œè®¿é—®ï¼ˆé»˜è®¤ localhostï¼‰
  (setq grip-preview-host "0.0.0.0")
  ;; ä¿å­˜æ–‡ä»¶æ—¶æ‰æ›´æ–°é¢„è§ˆ
  (setq grip-update-after-change nil)
  ;; ä» ~/.authinfo æ–‡ä»¶è·å–è®¤è¯ä¿¡æ¯
  (require 'auth-source)
  (let ((credential (auth-source-user-and-password "api.github.com")))
    (setq grip-github-user (car credential)
          grip-github-password (cadr credential))))
#+end_src

ä¸º markdown æ–‡ä»¶æ·»åŠ ç›®å½•ï¼š
#+begin_src emacs-lisp
(use-package markdown-toc
  :after(markdown-mode)
  :bind (:map markdown-mode-command-map
              ("r" . markdown-toc-generate-or-refresh-toc)))
#+end_src

** dockerfile

#+begin_src emacs-lisp
(use-package dockerfile-mode
  :ensure-system-package
  (docker-langserver . "npm install -g dockerfile-language-server-nodejs")
  :config
  (add-to-list 'auto-mode-alist '("Dockerfile\\'" . dockerfile-mode)))
#+end_src

** ansible

#+begin_src emacs-lisp
(use-package ansible
  :after (yaml-mode)
  :config
  (add-hook 'yaml-mode-hook (lambda () (ansible 1))))

;; ansible-doc ä½¿ç”¨ç³»ç»Ÿçš„ ansible-doc å‘½ä»¤æœç´¢æ–‡æ¡£
(use-package ansible-doc
  :ensure-system-package (ansible-doc . "pip install ansible")
  :after (ansible yasnippet)
  :config
  (add-hook 'ansible-hook (lambda() (ansible-doc-mode) (yas-minor-mode-on)))
  (define-key ansible-doc-mode-map (kbd "M-?") #'ansible-doc))
#+end_src

** web
*** typescript

#+begin_src emacs-lisp
(defun my/use-eslint-from-node-modules ()
  ;; use local eslint from node_modules before global
  ;; http://emacs.stackexchange.com/questions/21205/flycheck-with-file-relative-eslint-executable
  (let* ((root (locate-dominating-file (or (buffer-file-name) default-directory) "node_modules"))
         (eslint (and root (expand-file-name "node_modules/eslint/bin/eslint.js" root))))
    (when (and eslint (file-executable-p eslint))
      (setq-local flycheck-javascript-eslint-executable eslint))))

;; (shell-command "which npm &>/dev/null || brew install npm &>/dev/null")
(defun my/setup-tide-mode ()
  "Use hl-identifier-mode only on js or ts buffers."
  (when (and (stringp buffer-file-name)
             (string-match "\\.[tj]sx?\\'" buffer-file-name))
    (tide-setup)
    (add-hook 'flycheck-mode-hook #'my/use-eslint-from-node-modules)
    (tide-hl-identifier-mode +1)))

;; for .ts and .tsx file
(use-package typescript-mode
  :ensure-system-package
  (eslint . "npm install -g eslint babel-eslint eslint-plugin-react")
  :init
  (add-to-list 'auto-mode-alist '("\\.tsx?\\'" . typescript-mode))
  :hook
  ((typescript-mode . my/setup-tide-mode))
  :config
  (flycheck-add-mode 'typescript-tslint 'typescript-mode)
  (setq typescript-indent-level 2))
#+end_src
+ å®‰è£… eslint npm åŒ…åï¼Œå®‰è£…è¯­è¨€æœåŠ¡å™¨ =M-x lsp-install-server RET eslint RET= ã€‚

tide æ˜¯ typescript/javascript äº¤äº’å¼å¼€å‘ç¯å¢ƒï¼Œæ”¯æŒ js-modeï¼ˆEmacs 27 å†…ç½®ï¼‰ã€
js2-modeã€web-modeï¼ˆç¼–è¾‘æ¨¡æ¿æ–‡ä»¶ï¼Œå¦‚ HTMLã€Go Template ç­‰ï¼‰ã€typescript-modeã€‚

é€šè¿‡è°ƒç”¨ ts-ls(npm install -g typescript-language-server)è¯­è¨€æœåŠ¡å™¨ï¼Œç»“åˆ company
å’Œ lsp ä¸º js/ts æä¾›ä»£ç è¡¥å…¨å’Œå¯¼èˆªã€‚

jsts-ls(javascript-typescript-stdio) ä¸å†ç»´æŠ¤äº†ï¼š
https://github.com/sourcegraph/javascript-typescript-langserver

#+begin_src  emacs-lisp
(use-package tide
  :hook ((before-save . tide-format-before-save))
  :ensure-system-package
  ((typescript-language-server . "npm install -g typescript-language-server")
  (tsc . "npm install -g typescript"))
  :config
  ;; å¼€å¯ tsserver çš„ debug æ—¥å¿—æ¨¡å¼
  (setq tide-tsserver-process-environment '("TSS_LOG=-level verbose -file /tmp/tss.log")))
#+end_src

*** js2-mode

js-mode (Emacs 27 å†…ç½®) å’Œ js2-mode ï¼ˆjs-mode çš„å¢å¼ºï¼Œä¸»è¦æ˜¯ jsx ç›¸å…³ï¼‰ç”¨äºç¼–è¾‘
.js å’Œ .jsx æ–‡ä»¶ã€‚

js-mode in Emacs 27 includes full support for syntax highlighting and indenting
of JSX syntax. The currently recommended solution is to install Emacs 27 and use
js-mode as the major mode. To make use of the JS2 AST and the packages that
integrate with it, we recommend js2-minor-mode.
https://github.com/mooz/js2-mode#react-and-jsx

#+begin_src emacs-lisp
(use-package js2-mode
  :after (tide flycheck)
  :config
  ;; js-mode-map å°† M-. ç»‘å®šåˆ° js-find-symbol, æ²¡æœ‰ä½¿ç”¨ tide å’Œ lsp, æ‰€ä»¥éœ€è¦è§£
  ;; ç»‘ã€‚è¿™æ · M-. è¢« tide ç»‘å®šåˆ° tide-jump-to-definition.
  (define-key js-mode-map (kbd "M-.") nil)
  ;;(add-to-list 'auto-mode-alist '("\\.js\\'" . js2-mode))
  (add-hook 'js-mode-hook 'js2-minor-mode)
  ;; ä¸º js/jsx æ–‡ä»¶å¯åŠ¨ tide.
  (add-hook 'js-mode-hook 'my/setup-tide-mode)
  ;; disable jshint since we prefer eslint checking
  (setq-default flycheck-disabled-checkers (append flycheck-disabled-checkers '(javascript-jshint)))
  (flycheck-add-mode 'javascript-eslint 'js-mode)
  (flycheck-add-next-checker 'javascript-eslint 'javascript-tide 'append)
  (flycheck-add-next-checker 'javascript-eslint 'jsx-tide 'append)
  (add-to-list 'interpreter-mode-alist '("node" . js2-mode)))
#+end_src
+ ç»§ç»­ä½¿ç”¨ Emacs è‡ªå¸¦çš„ js-mode, js2 ä½œä¸º minor mode æ¥ä½¿ç”¨ã€‚
*** web-mode

web-mode ç”¨äºç¼–è¾‘ html/css/jinja2/gotmpl/tmpl ç­‰æ¨¡æ¿æ–‡ä»¶ï¼Œä¸ç”¨äºç¼–è¾‘
js/jsx/ts/tsx ç­‰ç±»å‹æ–‡ä»¶ã€‚

#+begin_src  emacs-lisp
(use-package web-mode
  :after (flycheck)
  :init
  (add-to-list 'auto-mode-alist '("\\.jinja2?\\'" . web-mode))
  (add-to-list 'auto-mode-alist '("\\.css?\\'" . web-mode))
  (add-to-list 'auto-mode-alist '("\\.html?\\'" . web-mode))
  (add-to-list 'auto-mode-alist '("\\.tmpl\\'" . web-mode))
  (add-to-list 'auto-mode-alist '("\\.gotmpl\\'" . web-mode))
  :custom
  (web-mode-enable-auto-pairing t)
  (web-mode-enable-css-colorization t)
  (web-mode-markup-indent-offset 4)
  (web-mode-css-indent-offset 4)
  (web-mode-code-indent-offset 4)
  (web-mode-enable-auto-quoting nil)
  (web-mode-enable-block-face t)
  (web-mode-enable-current-element-highlight t)
  :config
  (flycheck-add-mode 'javascript-eslint 'web-mode))

(defun my/json-format ()
  (interactive)
  (save-excursion
    (shell-command-on-region (mark) (point) "python -m json.tool" (buffer-name) t)))
#+end_src

*** prettier

ä¿å­˜æ–‡ä»¶æ—¶è‡ªåŠ¨æ ¼å¼åŒ–, æ”¯æŒ html/java/js/js2/typescript/json/yaml/python/sh ç­‰è¯­
è¨€, è¯¦æƒ…å‚è€ƒå˜é‡ prettier-major-mode-parsers:

#+begin_src emacs-lisp
(use-package prettier
  ;; TRAMP æ”¯æŒçš„æœ‰é—®é¢˜, æ•…å…³é—­ã€‚
  :disabled t
  :ensure-system-package (prettier . "npm -g install prettier")
  :diminish
  :hook (prog-mode . prettier-mode)
  :init (setq prettier-mode-sync-config-flag nil))
#+end_src

** yaml

#+begin_src  emacs-lisp
(use-package yaml-mode
  :ensure-system-package
  (yaml-language-server . "npm install -g yaml-language-server")
  :hook
  (yaml-mode . (lambda () (define-key yaml-mode-map "\C-m" 'newline-and-indent)))
  :config
  (add-to-list 'auto-mode-alist '("\\.yml\\'" . yaml-mode))
  (add-to-list 'auto-mode-alist '("\\.yaml\\'" . yaml-mode)))
#+end_src

** devdocs

ç¦»çº¿æŸ¥è¯¢ devdocs æ–‡æ¡£:
#+begin_src emacs-lisp
(use-package devdocs
  :bind ("C-c b" . devdocs-lookup)
  :config
  (add-to-list 'completion-category-defaults '(devdocs (styles . (flex))))
  (add-hook 'python-mode-hook (lambda () (setq-local devdocs-current-docs '("python~3.9"))))
  (add-hook 'go-mode-hook (lambda () (setq-local devdocs-current-docs '("go")))))
#+end_src
+ å®‰è£…æ–‡æ¡£: M-x devdocs-install
+ æ›´æ–°å½“å‰ä½¿ç”¨çš„æ–‡æ¡£ç›®å½•: C-u M-x dovdocs-lookup

** direnv

ç›®å½•å˜é‡æ˜¯åªå¯¹ç‰¹å®šç›®å½•åŠå­ç›®å½•æœ‰æ•ˆçš„ shell ç¯å¢ƒå˜é‡ï¼Œä¸»è¦ä½¿ç”¨åœºæ™¯æ˜¯æ ¹æ®ç›®å½•å˜é‡
æ¥æŒ‡å®šç‰ˆæœ¬çš„ python å’Œ golang ã€‚

å…ˆå®‰è£… direnv å‘½ä»¤ =brew install direnv=, ç„¶ååœ¨ ~/.bashrc ä¸­æ·»åŠ :
#+begin_src shell :tangle no
eval "$(direnv hook bash)"
#+end_src

å®‰è£… emacs envrc è½¯ä»¶åŒ…ï¼Œå®ƒè°ƒç”¨ direnv å‘½ä»¤è·å–å½“å‰æ–‡ä»¶æˆ–ç›®å½•çš„ç¯å¢ƒå˜é‡ï¼Œç„¶åæ›´
æ–° emacs å˜é‡ =process-environment= å’Œ =exec-path= ï¼Œè¿™æ · emacs åç»­å¯åŠ¨çš„å‘½ä»¤å°±ä¼šç»§
æ‰¿è¿™äº›ç¯å¢ƒå˜é‡ï¼ˆdirenv åŒ…æ˜¯å…¨å±€çš„ï¼Œè€Œ envrc æ˜¯ buffer-local çš„)ï¼š

#+begin_src emacs-lisp
(use-package envrc
  :ensure-system-package direnv
  :hook (after-init . envrc-global-mode)
  :config
  (define-key envrc-mode-map (kbd "C-c e") 'envrc-command-map))
#+end_src
+ C-c e a: envrc-allow
+ C-c e d: envrc-deny
+ C-c e r: envrc-reload

ä½¿ç”¨æ­¥éª¤ï¼š
1. åœ¨å¯¹åº”ç›®å½•åˆ›å»º =.envrc= æ–‡ä»¶;
2. å‘ .envrc æ–‡ä»¶æ·»åŠ  shell ç¯å¢ƒå˜é‡;
3. æ‰§è¡Œ =direnv allow .= ç”Ÿæ•ˆç¯å¢ƒå˜é‡;

å¦‚æœæŸäº›å˜é‡æœªè¢« lsp è¯†åˆ«ï¼Œåˆ™éœ€è¦æ‰“å¼€ .envrc æ‰€åœ¨ç›®å½•çš„æ–‡ä»¶åæ‰§è¡Œ =M-x
lsp-workspace-restart= æ¥é‡å¯ lsp ã€‚

** dap

#+begin_src emacs-lisp
(use-package dap-mode
  :disabled t
  :config
  (dap-auto-configure-mode 1)
  (require 'dap-chrome))
#+end_src
+ æ‰§è¡Œ =M-x dap-chrome-setup= å®‰è£… VSCode Chrome Debug Extension.

* project

#+begin_src emacs-lisp
(use-package posframe-project-term
  :straight (posframe-project-term :host github :repo "zwpaper/posframe-project-term")
  :bind
  (("C-c t" . posframe-project-term-toggle)))

(use-package projectile
  :config
  (projectile-global-mode)
  (define-key projectile-mode-map (kbd "C-c p") 'projectile-command-map)
  (projectile-mode +1)
  ;; selectrum/vertico ä½¿ç”¨ 'default
  (setq projectile-completion-system 'default)
  (add-to-list 'projectile-ignored-projects (concat (getenv "HOME") "/" "/root" "/tmp" "/etc" "/home"))
  (dolist (dirs '(".cache"
                  ".dropbox"
                  ".git"
                  ".hg"
                  ".svn"
                  ".nx"
                  "elpa"
                  "auto"
                  "bak"
                  "__pycache__"
                  "vendor"
                  "node_modules"
                  "logs"
                  "target"
                  ".idea"
                  "build"
                  ".devcontainer"
                  ".settings"
                  ".gradle"
                  ".vscode"))
    (add-to-list 'projectile-globally-ignored-directories dirs))
  (dolist (item '("GPATH"
                  "GRTAGS"
                  "GTAGS"
                  "GSYMS"
                  "TAGS"
                  ".tags"
                  ".classpath"
                  ".project"
                  ".DS_Store"
                  "__init__.py"))
    (add-to-list 'projectile-globally-ignored-files item))
  (dolist (list '("\\.elc\\'"
                  "\\.o\\'"
                  "\\.class\\'"
                  "\\.out\\'"
                  "\\.pdf\\'"
                  "\\.pyc\\'"
                  "\\.rel\\'"
                  "\\.rip\\'"
                  "\\.swp\\'"
                  "\\.iml\\'"
                  "\\.bak\\'"
                  "\\.log\\'"
                  "~\\'"))
    (add-to-list 'projectile-globally-ignored-file-suffixes list))

  ;; Disable projectile on remote buffers
  ;; https://www.murilopereira.com/a-rabbit-hole-full-of-lisp/
  ;; https://github.com/syl20bnr/spacemacs/issues/11381#issuecomment-481239700
  ;;(defadvice projectile-project-root (around ignore-remote first activate)
  ;;  (unless (file-remote-p default-directory 'no-identification) ad-do-it))

  ;; å¼€å¯ cache è§£å†³ TRAMP æ…¢çš„é—®é¢˜ï¼Œhttps://github.com/bbatsov/projectile/pull/1129
  (setq projectile-enable-caching t)
  (setq projectile-file-exists-remote-cache-expire (* 10 60))
  (setq projectile-dynamic-mode-line nil)
  ;; Make projectile to be usable in every directory (even without the presence of project file):
  ;;(setq projectile-require-project-root nil)
  (setq projectile-require-project-root 'prompt))

(defun my/project-discover ()
  (interactive)
  (dolist (search-path '("~/codes/" "~/go/src/github.com/*" "~/go/src/k8s.io/*" "~/go/src/gitlab.*/*/*"))
    (dolist (file (file-expand-wildcards search-path))
      (message "-> %s" file)
      (when (file-directory-p file)
          (projectile-add-known-project file)
          (message "add project %s..." file)))))

(use-package treemacs-projectile :after (treemacs projectile))
#+end_src

* treemacs

#+begin_src emacs-lisp
;;(shell-command "mkdir -p ~/.emacs.d/.cache")
(use-package treemacs
  :init
  (with-eval-after-load 'winum (define-key winum-keymap (kbd "M-0") #'treemacs-select-window))
  :config
  (progn
    (setq
     treemacs-collapse-dirs                 (if treemacs-python-executable 3 0)
     treemacs-deferred-git-apply-delay      0.1
     treemacs-display-in-side-window        t
     treemacs-eldoc-display                 t
     treemacs-file-event-delay              500
     treemacs-file-follow-delay             0.01
     treemacs-follow-after-init             t
     treemacs-git-command-pipe              ""
     treemacs-goto-tag-strategy             'refetch-index
     treemacs-indentation                   1
     treemacs-indentation-string            " "
     treemacs-is-never-other-window         t
     treemacs-max-git-entries               1000
     treemacs-missing-project-action        'ask
     treemacs-no-png-images                 nil
     treemacs-no-delete-other-windows       t
     treemacs-persist-file                  (expand-file-name ".cache/treemacs-persist" user-emacs-directory)
     treemacs-position                      'left
     treemacs-recenter-distance             0.01
     treemacs-recenter-after-file-follow    t
     treemacs-recenter-after-tag-follow     t
     treemacs-recenter-after-project-jump   'always
     treemacs-recenter-after-project-expand 'on-distance
     treemacs-shownn-cursor                 t
     treemacs-show-hidden-files             t
     treemacs-silent-filewatch              nil
     treemacs-silent-refresh                nil
     treemacs-sorting                       'alphabetic-asc
     treemacs-select-when-already-in-treemacs 'stay
     treemacs-space-between-root-nodes      nil
     treemacs-tag-follow-cleanup            t
     treemacs-tag-follow-delay              1
     treemacs-width                         35
     treemacs-width-increment               5
     treemacs-width-is-initially-locked     nil
     treemacs-project-follow-cleanup        t
     imenu-auto-rescan                      t)
    (treemacs-resize-icons 11)
    (treemacs-follow-mode t)
    ;;(treemacs-tag-follow-mode t)
    ;; è‡ªåŠ¨åˆ‡æ¢åˆ°å½“å‰ buffer çš„ project
    (treemacs-project-follow-mode t)
    (treemacs-filewatch-mode t)
    (treemacs-fringe-indicator-mode 'always)
    (treemacs-indent-guide-mode t)
    (pcase (cons (not (null (executable-find "git"))) (not (null treemacs-python-executable)))
      (`(t . t) (treemacs-git-mode 'deferred))
      (`(t . _) (treemacs-git-mode 'simple)))
    (treemacs-hide-gitignored-files-mode nil))
  :bind
  (:map global-map
        ("M-0"       . treemacs-select-window)
        ("C-x t 1"   . treemacs-delete-other-windows)
        ("C-x t t"   . treemacs)
        ("C-x t B"   . treemacs-bookmark)
        ("C-x t C-t" . treemacs-find-file)
        ("C-x t M-t" . treemacs-find-tag)))

(with-eval-after-load 'treemacs
  (define-key treemacs-mode-map [mouse-1] #'treemacs-single-click-expand-action))

(use-package treemacs-magit :after (treemacs magit))

;; C-c p s r(projectile-ripgrep) ä¾èµ– ripgrep åŒ…
(use-package ripgrep
  :ensure-system-package (rg . ripgrep))

(use-package deadgrep
  :ensure-system-package (rg . ripgrep)
  :bind ("<f5>" . deadgrep))

(setq grep-highlight-matches t)
#+end_src

* web

ä½¿ç”¨ Mac é»˜è®¤æµè§ˆå™¨æ‰“å¼€ URL:
#+begin_src emacs-lisp
;; æ‰§è¡Œ browser-url æ—¶ä½¿ç”¨ Mac é»˜è®¤æµè§ˆå™¨
(setq browse-url-browser-function 'browse-url-default-macosx-browser)

;; ä¹Ÿå¯ä»¥ä½¿ç”¨è‡ªå®šä¹‰ç¨‹åº
;; (setq browse-url-browser-function 'browse-url-generic
;;       browse-url-generic-program "mychrome")
;;(setq browse-url-chrome-program "mychrome")
#+end_src

ä¸Šé¢å¼•ç”¨çš„ mychrome ç¨‹åºï¼š
#+begin_src bash  :tangle ~/go/bin/mychrome
#!/bin/bash
open -a 'Google Chrome' $*
#+end_src

åœ¨çº¿æœç´¢ï¼š
#+begin_src emacs-lisp
(use-package engine-mode
  :config
  (engine-mode t)
  ;;(setq engine/browser-function 'eww-browse-url)
  (defengine github
    "https://github.com/search?ref=simplesearch&q=%s"
    :keybinding "h")

  (defengine google
    "http://www.google.com/search?ie=utf-8&oe=utf-8&q=%s"
    :keybinding "g")

  (defengine twitter
    "https://twitter.com/search?q=%s"
    :keybinding "t")

  (defengine wikipedia
    "http://www.wikipedia.org/search-redirect.php?language=en&go=Go&search=%s"
    :keybinding "w"
    :docstring "Searchin' the wikis."))
#+end_src
+ æœç´¢å‰ç¼€å‘½ä»¤ï¼š =C-x /= ã€‚å¯ä»¥å…ˆé€‰ä¸­ region å†æ‰§è¡Œä¸Šé¢çš„æœç´¢ã€‚
+ ä¿®å¤å¯åŠ¨æŠ¥é”™:  =rm ~/.emacs.d/elpa/engine-mode*/engine-mode-*.el*=;

ä¹¦ç­¾ç®¡ç†å™¨:
#+begin_src emacs-lisp
(use-package ebuku
  :ensure-system-package (buku . "pip3 install buku")
  :config
  ;; ä¸é™åˆ¶ç»“æœ
  (setq ebuku-results-limit 0))
#+end_src
+ =buku --ai= å¯¼å…¥ Firefox/Chrome ä¹¦ç­¾;
+ =M-x ebuku= : æµè§ˆå’Œç¼–è¾‘å¯¼å…¥çš„ä¹¦ç­¾, ç‚¹å‡» URL ä½¿ç”¨ Mac æµè§ˆå™¨æ‰“å¼€ã€‚

å…¨å±€ socks5 ä»£ç†ï¼š
#+begin_src emacs-lisp
;; æ·»åŠ ç¯å¢ƒå˜é‡ export PATH="/usr/local/opt/curl/bin:$PATH"
(use-package emacs
  :straight (:type built-in)
  :ensure-system-package ("/usr/local/opt/curl/bin/curl" . "brew install curl"))

(setq my/socks-host "127.0.0.1")
(setq my/socks-port 13659)
(setq my/socks-proxy (format "socks5h://%s:%d" my/socks-host my/socks-port))

(use-package mb-url-http
  :demand
  :straight (mb-url :repo "dochang/mb-url")
  :commands (mb-url-http-around-advice)
  :init
  (require 'auth-source)
  (let ((credential (auth-source-user-and-password "api.github.com")))
    (setq github-user (car credential)
          github-password (cadr credential))
    (setq github-auth (concat github-user ":" github-password))
    (setq mb-url-http-backend 'mb-url-http-curl
          mb-url-http-curl-program "/usr/local/opt/curl/bin/curl"
          mb-url-http-curl-switches `("-k" "-x" ,my/socks-proxy
                                      ;;"--max-time" "300"
                                      ;;"-u" ,github-auth
                                      ;;"--user-agent" "User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/94.0.4606.71 Safari/537.36"
                                      ))))

(defun proxy-socks-show ()
  "Show SOCKS proxy."
  (interactive)
  (when (fboundp 'cadddr)
    (if (bound-and-true-p socks-noproxy)
        (message "Current SOCKS%d proxy is %s:%d" 5 my/socks-host my/socks-port)
      (message "No SOCKS proxy"))))

(defun proxy-socks-enable ()
  "ä½¿ç”¨ socks ä»£ç† url è®¿é—®è¯·æ±‚ã€‚"
  (interactive)
  (require 'socks)
  (setq url-gateway-method 'socks
        socks-noproxy '("localhost" "10.0.0.0/8" "172.0.0.0/8" "*cn" "*alibaba-inc.com" "*taobao.com")
        socks-server `("Default server" ,my/socks-host ,my/socks-port 5))
  (setenv "all_proxy" my/socks-proxy)
  (proxy-socks-show)
  ;;url-retrieve ä½¿ç”¨ curl ä½œä¸ºåç«¯å®ç°, æ”¯æŒå…¨å±€ socks5 ä»£ç†
  (advice-add 'url-http :around 'mb-url-http-around-advice))

(defun proxy-socks-disable ()
  "Disable SOCKS proxy."
  (interactive)
  (require 'socks)
  (setq url-gateway-method 'native
        socks-noproxy nil)
  (setenv "all_proxy" "")
  (proxy-socks-show))

(defun proxy-socks-toggle ()
  "Toggle SOCKS proxy."
  (interactive)
  (require 'socks)
  (if (bound-and-true-p socks-noproxy)
      (proxy-socks-disable)
    (proxy-socks-enable)))
#+end_src

+ Mac è‡ªå¸¦çš„ curl ä¸æ”¯æŒ socks ä»£ç†, éœ€è¦å®‰è£… =brew install curl= å¹¶è®¾ç½® ~export PATH="/usr/local/opt/curl/bin:$PATH"~
+ [[https://emacstalk.github.io/post/007/][url-retrieve ä½¿ç”¨ curl ä½œä¸ºåç«¯å®ç°]], è¿™æ ·å…¨å±€å¯ä½¿ç”¨ socks5 ä»£ç†ã€‚
+ éœ€è¦æ·»åŠ  =--user-agent= é…ç½®, å¦åˆ™ä¼šè¢« Google 403 Forbidden;

* vterm

#+begin_src emacs-lisp
(use-package vterm
  :ensure-system-package
  ((cmake . cmake)
   (glibtool . libtool)
   (exiftran . exiftran))
  :config
  (setq vterm-max-scrollback 100000)
  ;; vterm buffer åç§°ï¼Œéœ€è¦é…ç½® shell æ¥æ”¯æŒï¼ˆå¦‚ bash çš„ PROMPT_COMMANDï¼‰ã€‚
  (setq vterm-buffer-name-string "vterm: %s")
  (add-hook 'vterm-mode-hook
            (lambda ()
              (setf truncate-lines nil)
              (setq-local show-paren-mode nil)
              (yas-minor-mode -1)
              (flycheck-mode -1)))
  ;; ä½¿ç”¨ M-y(consult-yank-pop) ç²˜è´´å‰ªè´´æ¿å†å²ä¸­çš„å†…å®¹
  (define-key vterm-mode-map [remap consult-yank-pop] #'vterm-yank-pop)
  :bind
  (:map vterm-mode-map ("C-l" . nil))
  ;; é˜²æ­¢è¾“å…¥æ³•åˆ‡æ¢å†²çªã€‚
  (:map vterm-mode-map ("C-\\" . nil)) )

(use-package multi-vterm
  :after (vterm)
  :config
  (define-key vterm-mode-map (kbd "M-RET") 'multi-vterm))

(use-package vterm-toggle
  :after (vterm)
  :custom
  ;; ç”±äº TRAMP æ¨¡å¼ä¸‹å…³é—­äº† projectileï¼Œscope ä¸èƒ½è®¾ç½®ä¸º 'projectã€‚
  ;;(vterm-toggle-scope 'dedicated)
  (vterm-toggle-scope 'project)
  :config
  (global-set-key (kbd "C-`") 'vterm-toggle)
  (global-set-key (kbd "C-~") 'vterm-toggle-cd)
  (define-key vterm-mode-map (kbd "C-RET") #'vterm-toggle-insert-cd)
  ;; Switch to an idle vterm buffer and insert a cd command
  ;; Or create 1 new vterm buffer
  (define-key vterm-mode-map (kbd "s-i") 'vterm-toggle-cd-show)
  (define-key vterm-mode-map (kbd "s-n") 'vterm-toggle-forward)
  (define-key vterm-mode-map (kbd "s-p") 'vterm-toggle-backward))
#+end_src

* eshell

#+begin_src emacs-lisp
(setq explicit-shell-file-name "/bin/bash")
(setq shell-file-name "/bin/bash")
(setq shell-command-prompt-show-cwd t)
(setq explicit-bash.exe-args '("--noediting" "--login" "-i"))
(setenv "SHELL" shell-file-name)
(setenv "ESHELL" "bash")
(add-hook 'comint-output-filter-functions 'comint-strip-ctrl-m)

;; æç¤ºç¬¦åªè¯»
(setq comint-prompt-read-only t)
;; å‘½ä»¤è¡¥å…¨
(setq shell-command-completion-mode t)

;; é«˜äº®æ¨¡å¼
(autoload 'ansi-color-for-comint-mode-on "ansi-color" nil t)
(add-hook 'shell-mode-hook 'ansi-color-for-comint-mode-on t)
#+end_src

* tramp

#+begin_src emacs-lisp
(setq  tramp-ssh-controlmaster-options
       (concat "-o ControlMaster=auto "
               "-o ControlPath='tramp.%%C' "
               "-o ControlPersist=600 "
               "-o ServerAliveCountMax=60 "
               "-o ServerAliveInterval=10 ")
       ;; Disable version control on tramp buffers to avoid freezes.
       vc-ignore-dir-regexp (format "\\(%s\\)\\|\\(%s\\)" vc-ignore-dir-regexp tramp-file-name-regexp)
       ;; Donâ€™t clean up recentf tramp buffers.
       recentf-auto-cleanup 'never
       ;; è°ƒå¤§è¿œç¨‹æ–‡ä»¶åè¿‡æœŸæ—¶é—´ï¼ˆé»˜è®¤ 10s), æé«˜æŸ¥æ‰¾è¿œç¨‹æ–‡ä»¶æ€§èƒ½
       remote-file-name-inhibit-cache 600
       ;;tramp-verbose 10
       ;; å¢åŠ å‹ç¼©ä¼ è¾“çš„æ–‡ä»¶èµ·å§‹å¤§å°ï¼ˆé»˜è®¤ 4KBï¼‰ï¼Œå¦åˆ™å®¹æ˜“å‡ºé”™ï¼š â€œgzip: (stdin): unexpected end of fileâ€
       tramp-inline-compress-start-size (* 1024 8)
       ;; å½“æ–‡ä»¶å¤§å°è¶…è¿‡ tramp-copy-size-limit æ—¶ï¼Œç”¨ external methods(å¦‚ scpï¼‰æ¥ä¼ è¾“ï¼Œä»è€Œå¤§å¤§æé«˜æ‹·è´æ•ˆç‡ã€‚
       tramp-copy-size-limit (* 1024 1024 2)
       ;; Store TRAMP auto-save files locally.
       tramp-auto-save-directory (expand-file-name "tramp-auto-save" user-emacs-directory)
       ;; A more representative name for this file.
       tramp-persistency-file-name (expand-file-name "tramp-connection-history" user-emacs-directory)
       ;; Cache SSH passwords during the whole Emacs session.
       password-cache-expiry nil
       tramp-default-method "ssh"
       tramp-default-remote-shell "/bin/bash"
       tramp-default-user "root"
       tramp-terminal-type "tramp")

;; è‡ªå®šä¹‰è¿œç¨‹ç¯å¢ƒå˜é‡
(let ((process-environment tramp-remote-process-environment))
  ;; è®¾ç½®è¿œç¨‹ç¯å¢ƒå˜é‡ VTERM_TRAMP, è¿œç¨‹æœºå™¨çš„ ~/.emacs_bashrc æ ¹æ®è¿™ä¸ªå˜é‡è®¾ç½® VTERM å‚æ•°ã€‚
  (setenv "VTERM_TRAMP" "true")
  (setq tramp-remote-process-environment process-environment))

;; è¿œç¨‹æœºå™¨åˆ—è¡¨
(require 'epa-file)
(epa-file-enable)
(load "~/.emacs.d/sshenv.el.gpg")

;; åˆ‡æ¢ buffer æ—¶è‡ªåŠ¨è®¾ç½® VTERM_HOSTNAME ç¯å¢ƒå˜é‡ä¸ºå¤šè·³çš„æœ€åä¸€ä¸ªä¸»æœºåï¼Œå¹¶é€šè¿‡ vterm-environment ä¼ é€’åˆ°è¿œç¨‹ç¯å¢ƒä¸­ã€‚è¿œç¨‹
;; æœºå™¨çš„ ~/.emacs_bashrc æ ¹æ®è¿™ä¸ªå˜é‡è®¾ç½® Buffer åç§°å’Œæœºå™¨è®¿é—®åœ°å€ä¸ºä¸»æœºåï¼Œæ­£ç¡®è®¾ç½®ç›®å½•è·Ÿè¸ªã€‚è§£å†³å¤šè·³æ—¶ IP é‡å¤çš„é—®é¢˜ã€‚
(defvar my/remote-host "")
(add-hook
 'buffer-list-update-hook
 (lambda ()
   (if  (file-remote-p default-directory)
       (progn
         (setq my/remote-host (file-remote-p default-directory 'host))
         ;; åŠ¨æ€è®¡ç®— ENV=VALUE
         (require 'vterm)
         (setq vterm-environment `(,(concat "VTERM_HOSTNAME=" my/remote-host)))
         ;; å…³é—­ treemacs, é¿å…å»ºç«‹æ–°è¿æ¥è€—æ—¶
         (require 'treemacs)
         (if (string-match "visible" (symbol-name (treemacs-current-visibility)))
             (delete-window (treemacs-get-local-window)))))
   (progn)))
#+end_src
+ =tramp-default-method= ç¼ºçœå€¼ä¸º scp, ä¸æ”¯æŒå¤šè·³ï¼ˆä½†æ‹·è´å¤§æ–‡ä»¶æ—¶æ€§èƒ½æ›´é«˜ï¼‰ï¼Œå†æ‰“å¼€å¤šè·³è¿œç¨‹æ–‡ä»¶æ—¶æ¯æ¬¡éƒ½éœ€è¦ä¿®æ”¹ /- ä¸­çš„ -
  ä¸º sshï¼Œè¾ƒéº»çƒ¦ï¼Œæ‰€ä»¥è®¾ç½®ä¸º sshã€‚

* others
#+begin_src emacs-lisp
;; Editing of grep buffers, can be used together with consult-grep via embark-export.
(use-package wgrep)

;; é€€å‡ºè‡ªåŠ¨æ€æ‰è¿›ç¨‹
(setq confirm-kill-processes nil)

;;å¯åŠ¨ isearch è¿›è¡Œæœç´¢æ—¶ï¼ŒM-<, M->, C-v å’Œ M-v è¿™äº›æŒ‰é”®ä¸ä¼šæ‰“æ–­æœç´¢
(setq isearch-allow-motion t)

;; ç›´æ¥åœ¨ minibuffer ä¸­ç¼–è¾‘ query(rime æ¢æµ‹åˆ° minibuffer æ—¶è‡ªåŠ¨å…³é—­è¾“å…¥æ³•)
(use-package isearch-mb
  :demand t
  :config
  (setq-default
   ;; Match count next to the minibuffer prompt
   isearch-lazy-count t
   ;; Don't be stingy with history; default is to keep just 16 entries
   search-ring-max 200
   regexp-search-ring-max 200)

  ;; ä¹ æƒ¯ä½¿ç”¨ regexp ç±»å‹çš„ isearch
  (global-set-key (kbd "C-s") 'isearch-forward-regexp)
  (global-set-key (kbd "C-r") 'isearch-backward-regexp)

  (add-to-list 'isearch-mb--with-buffer #'consult-isearch)
  (define-key isearch-mb-minibuffer-map (kbd "M-r") #'consult-isearch)

  (add-to-list 'isearch-mb--after-exit #'consult-line)
  (define-key isearch-mb-minibuffer-map (kbd "M-s l") 'consult-line)
  (isearch-mb-mode t))

;; æ™ºèƒ½æ‹¬å·
(use-package smartparens
  :config
  (smartparens-global-mode t)
  (show-smartparens-global-mode t))

;; å½©è‰²æ‹¬å·
(use-package rainbow-delimiters
  :hook
  (prog-mode . rainbow-delimiters-mode))

;; æ™ºèƒ½æ‰©å±•åŒºåŸŸ
(use-package expand-region
  :bind
  ("M-@" . er/expand-region))

;; æ˜¾ç¤ºç¼©è¿›
(use-package highlight-indent-guides
  :custom
  (highlight-indent-guides-method 'character)
  (highlight-indent-guides-responsive 'stack)
  (highlight-indent-guides-delay 0.1)
  :config
  (add-hook 'python-mode-hook 'highlight-indent-guides-mode)
  (add-hook 'yaml-mode-hook 'highlight-indent-guides-mode)
  (add-hook 'js-mode-hook 'highlight-indent-guides-mode)
  (add-hook 'web-mode-hook 'highlight-indent-guides-mode))

;; ä½¿ç”¨ fundamental-mode æ‰“å¼€å¤§æ–‡ä»¶ã€‚
(defun my/large-file-hook ()
  "If a file is over a given size, make the buffer read only."
  (when (and (> (buffer-size) (* 1024 1))
             (or (string-equal (file-name-extension (buffer-file-name)) "json")
                 (string-equal (file-name-extension (buffer-file-name)) "yaml")
                 (string-equal (file-name-extension (buffer-file-name)) "yml")
                 (string-equal (file-name-extension (buffer-file-name)) "log")))
    (fundamental-mode)
    (setq buffer-read-only t)
    (font-lock-mode -1)
    (rainbow-delimiters-mode -1)
    (smartparens-global-mode -1)
    (show-smartparens-mode -1)
    (smartparens-mode -1)))
(add-hook 'find-file-hook 'my/large-file-hook)
;; é»˜è®¤ç›´æ¥ç”¨ fundamental-mode æ‰“å¼€ json å’Œ log æ–‡ä»¶, ç¡®ä¿å…¶å®ƒ major-mode ä¸ä¼šå…ˆæ‰§è¡Œã€‚
(add-to-list 'auto-mode-alist '("\\.log?\\'" . fundamental-mode))
(add-to-list 'auto-mode-alist '("\\.json?\\'" . fundamental-mode))

;; å¤§æ–‡ä»¶ä¸æ˜¾ç¤ºè¡Œå·
(setq large-file-warning-threshold nil)
(setq line-number-display-limit large-file-warning-threshold)
(setq line-number-display-limit-width 1000)
(dolist (mode '(text-mode-hook prog-mode-hook conf-mode-hook))
  (add-hook mode (lambda () (display-line-numbers-mode 1))))

;; è‡ªåŠ¨æ ¹æ®çª—å£å¤§å°æ˜¾ç¤ºå›¾ç‰‡
(setq image-transform-resize t)
(auto-image-file-mode t)

(add-hook 'before-save-hook 'whitespace-cleanup)

;; Provide undo/redo commands for window changes.
(winner-mode t)

;; Don't lock files.
(setq create-lockfiles nil)

;; å‰ªè´´æ¿å†å²è®°å½•æ•°é‡
(setq kill-ring-max 100)

;; macOS modifiers.
(setq mac-command-modifier 'meta)
;; option ä½œä¸º Super é”®(æŒ‰é”®ç»‘å®šç”¨ s- è¡¨ç¤ºï¼ŒS- è¡¨ç¤º Shift)
(setq mac-option-modifier 'super)
;; fn ä½œä¸º Hyper é”®(æŒ‰é”®ç»‘å®šç”¨ H- è¡¨ç¤º)
(setq ns-function-modifier 'hyper)

(require 'server)
(unless (server-running-p) (server-start))

;; è®°å½•æœ€è¿‘ 100 æ¬¡æŒ‰é”®ï¼Œå¯ä»¥é€šè¿‡ M-x view-lossage æ¥æŸ¥çœ‹è¾“å…¥çš„å†…å®¹ã€‚
(lossage-size 100)

;; Highlight current line.
;;(global-hl-line-mode t)

;; It's nice to maintain a little margin
(setq scroll-margin 2)

;; Keep cursor position when scrolling.
(setq scroll-preserve-screen-position 1)

;; åˆ‡æ¢åˆ°å·²æœ‰çš„ frame
(setq display-buffer-reuse-frames t)

(setq auto-window-vscroll nil)
;; å¹³æ»‘åœ°è¿›è¡ŒåŠå±æ»šåŠ¨ï¼Œé¿å…æ»šåŠ¨å recenter æ“ä½œ
(setq scroll-step 1)
(setq scroll-conservatively 10000)
(setq scroll-margin 0)
(setq auto-window-vscroll nil)

;; Remember point position between sessions.
(require 'saveplace)
(save-place-mode t)

;; Better unique buffer names for files with the same base name.
(require 'uniquify)
(setq uniquify-buffer-name-style 'forward)

(setq use-short-answers t)
(setq confirm-kill-emacs #'y-or-n-p)

;; bookmark å‘ç”Ÿå˜åŒ–æ—¶è‡ªåŠ¨ä¿å­˜ï¼ˆé»˜è®¤æ˜¯ Emacs æ­£å¸¸é€€å‡ºæ—¶ä¿å­˜ï¼‰
(setq bookmark-save-flag 1)

;; å…³é—­å‡ºé”™æç¤ºå£°
(setq ring-bell-function 'ignore)

(setq ad-redefinition-action 'accept)

;; Make Finder's "Open with Emacs" create a buffer in the existing Emacs frame.
(setq ns-pop-up-frames nil)

;; é¿å…æ‰§è¡Œ ns-print-buffer å‘½ä»¤ã€‚
(global-unset-key (kbd "s-p"))

;; é¿å…æ‰§è¡Œ ns-open-file-using-panel å‘½ä»¤ã€‚
(global-unset-key (kbd "s-o"))
(global-unset-key (kbd "s-t"))

(recentf-mode +1)

;;Preserve Minibuffer History
(use-package savehist
  :demand t
  :config
  (setq history-length 25)
  (savehist-mode 1))

;; fill-column çš„å€¼åº”è¯¥å°äº visual-fill-column-widthï¼Œå¦åˆ™å±…ä¸­æ˜¾ç¤ºæ—¶è¡Œå†…å®¹ä¼šè¿‡é•¿è€Œè¢«éšè—ã€‚
(setq-default fill-column 100
              comment-fill-column 0
              recentf-max-menu-items 100
              recentf-max-saved-items 100
              tab-width 4
              ;; Make it impossible to insert tabs.
              indent-tabs-mode nil
              debug-on-error nil
              message-log-max t
              load-prefer-newer t
              ad-redefinition-action 'accept)

(setq recentf-exclude `(,(expand-file-name "straight/build/" user-emacs-directory)
                        ,(expand-file-name "eln-cache/" user-emacs-directory)
                        ,(expand-file-name "etc/" user-emacs-directory)
                        ,(expand-file-name "var/" user-emacs-directory)
                        "/tmp" ".gz" ".tgz" ".xz" ".zip" "/ssh:" ".png" ".jpg" "/\\.git/" ".gitignore" "\\.log"
                        ,(concat package-user-dir "/.*-autoloads\\.el\\'")))

;; ä½¿ç”¨ç³»ç»Ÿå‰ªè´´æ¿ï¼Œè¿™æ ·å¯ä»¥å’Œå…¶å®ƒç¨‹åºç›¸äº’ç²˜è´´ã€‚
(setq x-select-enable-clipboard t)
(setq select-enable-clipboard t)
(setq x-select-enable-primary t)
(setq select-enable-primary t)

;; ç²˜è´´äºå…‰æ ‡å¤„, è€Œä¸æ˜¯é¼ æ ‡æŒ‡é’ˆå¤„ã€‚
(setq mouse-yank-at-point t)

(when window-system
  ;; Scroll one line at a time (less "jumpy" than defaults)
  (setq mouse-wheel-scroll-amount '(1 ((shift) . hscroll))
        mouse-wheel-scroll-amount-horizontal 1
        mouse-wheel-follow-mouse t
        mouse-wheel-progressive-speed nil)
  (xterm-mouse-mode t)
  ;; é»˜è®¤æ‰§è¡Œ mouse-wheel-text-scale å‘½ä»¤, å®¹æ˜“è§¦ç¢°è¯¯æ“ä½œï¼Œæ•…å…³é—­ã€‚
  (global-unset-key (kbd "C-<wheel-down>"))
  (global-unset-key (kbd "C-<wheel-up>"))
  ;;Disable dialog boxes since they weren't working in Mac OSX
  (setq use-file-dialog nil
        use-dialog-box nil
        next-screen-context-lines 5))

(global-set-key (kbd "S-C-<left>") 'shrink-window-horizontally)
(global-set-key (kbd "S-C-<right>") 'enlarge-window-horizontally)
(global-set-key (kbd "S-C-<down>") 'shrink-window)
(global-set-key (kbd "S-C-<up>") 'enlarge-window)

(global-set-key (kbd "C-x C-b") 'ibuffer)
(with-eval-after-load 'ibuffer
  (setq ibuffer-expert t)
  (setq ibuffer-display-summary nil)
  (setq ibuffer-use-other-window nil)
  (setq ibuffer-show-empty-filter-groups nil)
  (setq ibuffer-movement-cycle nil)
  (setq ibuffer-default-sorting-mode 'filename/process)
  (setq ibuffer-use-header-line t)
  (setq ibuffer-default-shrink-to-minimum-size nil)
  (setq ibuffer-saved-filter-groups nil)
  (setq ibuffer-old-time 48)
  (add-hook 'ibuffer-mode-hook #'hl-line-mode))

(with-eval-after-load 'dired
  ;; re-use dired buffer, available in Emacs 28
  ;; @see https://debbugs.gnu.org/cgi/bugreport.cgi?bug=20598
  (setq dired-kill-when-opening-new-dired-buffer t)
  (setq dired-recursive-copies 'always)
  (setq dired-recursive-deletes 'always)
  ;; search file name only when focus is over file
  (setq dired-isearch-filenames 'dwim)
  ;; when there is two dired buffer, Emacs will select another buffer
  ;; as target buffer (target for copying files, for example).
  ;; It's similar to windows commander.
  (setq dired-dwim-target t)
  ;; @see https://emacs.stackexchange.com/questions/5649/sort-file-names-numbered-in-dired/5650#5650
  (setq dired-listing-switches "-laGh1v --group-directories-first")
  (dired-async-mode 1)
  (put 'dired-find-alternate-file 'disabled nil))

(use-package undo-tree
  :init
  (global-undo-tree-mode 1))

;; dired æ˜¾ç¤ºé«˜äº®å¢å¼º
(use-package diredfl :config (diredfl-global-mode))

;; ESC Cancels All
(global-set-key (kbd "<escape>") 'keyboard-escape-quit)

;; ç®¡ç† minior mode
(use-package manage-minor-mode)
(defvar hidden-minor-modes '(whitespace-mode))

;;(shell-command "mkdir -p ~/.emacs.d/backup")
(defvar backup-dir (expand-file-name "~/.emacs.d/backup/"))
(setq backup-by-copying t
      backup-directory-alist (list (cons ".*" backup-dir))
      delete-old-versions t
      kept-new-versions 6
      kept-old-versions 2
      version-control t)

;;(shell-command "mkdir -p ~/.emacs.d/autosave")
(defvar autosave-dir (expand-file-name "~/.emacs.d/autosave/"))
(setq auto-save-list-file-prefix autosave-dir
      auto-save-file-name-transforms `((".*" ,autosave-dir t)))

;; UTF8 stuff.
(prefer-coding-system 'utf-8)
(setq locale-coding-system 'utf-8)
(setq default-buffer-file-coding-system 'utf-8)
(set-buffer-file-coding-system 'utf-8)
(set-language-environment "UTF-8")
(set-default buffer-file-coding-system 'utf8)
(set-default-coding-systems 'utf-8)
(setenv "LANG" "zh_CN.UTF-8")
(setenv "LC_ALL" "zh_CN.UTF-8")
(setenv "LC_CTYPE" "zh_CN.UTF-8")

(use-package osx-trash
  :ensure-system-package trash
  :config
  (when (eq system-type 'darwin)
    (osx-trash-setup))
  ;; Delete files to trash
  (setq-default delete-by-moving-to-trash t))

;; åœ¨å¸®åŠ©æ–‡æ¡£åº•éƒ¨æ˜¾ç¤º lisp demo
(use-package elisp-demos
  :config
  (advice-add 'describe-function-1 :after #'elisp-demos-advice-describe-function-1)
  (advice-add 'helpful-update :after #'elisp-demos-advice-helpful-update))

;; Switch to help buffer when it's opened.
(setq help-window-select t)

;; ç›¸æ¯” Emacs å†…ç½® Help, æä¾›æ›´å¤šä¸Šä¸‹æ–‡ä¿¡æ¯ã€‚
(use-package helpful
  :config
  ;; Note that the built-in `describe-function' includes both functions
  ;; and macros. `helpful-function' is functions only, so we provide
  ;; `helpful-callable' as a drop-in replacement.
  (global-set-key (kbd "C-h f") #'helpful-callable)
  (global-set-key (kbd "C-h v") #'helpful-variable)
  (global-set-key (kbd "C-h k") #'helpful-key)

  ;; Lookup the current symbol at point. C-c C-d is a common keybinding
  ;; for this in lisp modes.
  (global-set-key (kbd "C-c C-d") #'helpful-at-point)

  ;; Look up *F*unctions (excludes macros).
  ;;
  ;; By default, C-h F is bound to `Info-goto-emacs-command-node'. Helpful
  ;; already links to the manual, if a function is referenced there.
  (global-set-key (kbd "C-h F") #'helpful-function)

  ;; Look up *C*ommands.
  ;;
  ;; By default, C-h C is bound to describe `describe-coding-system'. I
  ;; don't find this very useful, but it's frequently useful to only
  ;; look at interactive functions.
  (global-set-key (kbd "C-h C") #'helpful-command))

;; åœ¨ Finder ä¸­æ‰“å¼€å½“å‰æ–‡ä»¶
(use-package reveal-in-osx-finder :commands (reveal-in-osx-finder))
#+end_src
+ osx-trash ä¸æ”¯æŒ TRAMP åˆ é™¤è¿œç¨‹æ–‡ä»¶ï¼Œè§£å†³åŠæ³•ï¼šç”¨ %m æ ‡è®°æ–‡ä»¶ï¼Œç„¶åæŒ‰ ! æ‰§è¡Œ rm å‘½ä»¤ã€‚

* refs

æœ¬é…ç½®å‚è€ƒäº†ä»¥ä¸‹ä»“åº“ä»£ç ï¼š

1. [[https://github.com/seagle0128/.emacs.d][seagle0128/.emacs.d]]
2. [[https://gitlab.com/protesilaos/dotfiles][protesilaos/dotfiles]]
3. [[https://github.com/bbatsov/prelude][bbatsov/prelude]]
4. [[https://github.com/MatthewZMD/.emacs.d][MatthewZMD/.emacs.d]]
5. [[https://github.com/condy0919/.emacs.d][condy0919/.emacs.d]]
6. [[https://github.com/manateelazycat/lazycat-emacs][manateelazycat/lazycat-emacs]]
7. [[https://github.com/jiacai2050/dotfiles][jiacai2050/dotfiles]]
8. [[https://config.daviwil.com/emacs][daviwil]]

* archived

project é…ç½®å‚è€ƒï¼š
1. [[https://github.com/jiacai2050/dotfiles/blob/master/.config/emacs/i-basic.el][jiacai2050/dotfiles]]
2. [[https://gitlab.com/protesilaos/dotfiles/-/blob/master/emacs/.emacs.d/prot-lisp/prot-project.el][protesilaos/dotfiles]]

#+begin_src emacs-lisp :tangle no
(use-package find-file-in-project
  :config
  ;; ffip adds `ffap-guess-file-name-at-point' automatically and it is crazy slow on TRAMP buffers.
  ;; https://github.com/mpereira/.emacs.d/#find-file-in-project
  (remove-hook 'file-name-at-point-functions 'ffap-guess-file-name-at-point))

;;ç±»ä¼¼äº consult-grep å’Œ consult-find, ä½†å‰åç«¯éƒ½å¼‚æ­¥ä¸”æ”¯æŒ fuzzy æœç´¢ã€‚
(use-package affe
  :after (orderless)
  :ensure-system-package
  ((gfind . findutils)
   (fd . fd)
   (fzf . fzf)
   (rg . ripgrep))
  :bind
  (;; bind-c bindings (mode-specific-map)
   ("M-s g" . affe-grep)
   ("M-s f" . affe-find))
  :config
  (setq affe-count 200)
  ;; Configure Orderless
  (setq affe-regexp-function #'orderless-pattern-compiler
        affe-highlight-function #'orderless--highlight)
  ;; Manual preview key for `affe-grep'
  (consult-customize affe-grep :preview-key (kbd "M-.")))

(use-package project
  :after (vterm)
  :config
  (setq project-switch-commands
    '((?f "File" project-find-file)
          (?g "Grep" project-find-regexp)
          (?d "Dired" project-dired)
          (?b "Buffer" project-switch-to-buffer)
          (?q "Query replace" project-query-replace-regexp)
          (?v "VC dir" project-vc-dir)
          (?t "Vterm" vterm)))

  (defun my/project-try-local (dir)
    "Determine if DIR is a non-Git project.
DIR must include a .project file to be considered a project."
    (catch 'ret
      ;;(dolist (flag-file '(".project" "README.org" "README.md" "Makefile" "pom.xml" "go.mod" "project.clj"))
      (dolist (flag-file '(".project" ".project."))
    (when-let ((root (locate-dominating-file dir flag-file)))
          (throw 'ret (cons 'local root))))))

  (setq project-find-functions '(my/project-try-local project-try-vc))

  (cl-defmethod project-root ((project (head local)))
    (cdr project))

  (defun my/project-info ()
    (interactive)
    (message "%s" (project-current t)))

  (defun my/project-discover ()
    (interactive)
    (dolist (search-path '("~/codes/" "~/go/src/github.com/*" "~/go/src/k8s.io/*" "~/go/src/gitlab.*/*/*"))
      (dolist (file (file-expand-wildcards search-path))
    (message "-> %s" file)
    (when (file-directory-p file)
          (when-let ((pr (project-current nil file)))
            (project-remember-project pr)
            (message "add project %s..." pr))))))

  (defun my/project-add (dir)
    (interactive "DWhich dir:")
    (let* ((project-flag-file (expand-file-name ".project." dir)))
      (if-let ((pr (project-current nil dir)))
          (if (string-equal (project-root pr) dir)
              (project-remember-project pr)
            (progn
              (make-empty-file project-flag-file)
              (project-remember-project (cons 'local dir))))
    (progn
          (make-empty-file project-flag-file)
          (project-remember-project (cons 'local dir)))))
    (message "Add project %s..." dir))

  (defun my/project-remove ()
    "Remove project from `project--list' using completion."
    (interactive)
    (project--ensure-read-project-list)
    (let* ((projects project--list)
           (dir (completing-read "REMOVE project: " projects nil t)))
      (setq project--list (delete (assoc dir projects) projects))
      (project--write-project-list)))
  )
#+end_src


#+begin_src emacs-lisp :tangle no
(require 'package)
(setq package-archives '(("celpa" . "https://celpa.conao3.com/packages/")
                         ("elpa" . "https://elpa.gnu.org/packages/")
                         ("melpa" . "https://melpa.org/packages/")))
;; activate all the packages (in particular autoloads)
(package-initialize)
;; fetch the list of packages available
(unless package-archive-contents (package-refresh-contents))
(setq package-native-compile t)

(setq use-package-always-ensure t
      use-package-always-demand t)
(setq use-package-verbose t)
(unless (package-installed-p 'use-package)
  (package-refresh-contents)
  (package-install 'use-package))
(setq use-package-compute-statistics t)

;; ç”±äºç¼–è¯‘ emacs 29 æ—¶æŒ‡å®šäº† no title-bar, æ‰€ä»¥ä¸å†éœ€è¦è¿™ä¸ªé…ç½®äº†
(use-package ns-auto-titlebar
  :demand t
  :config
  (when (eq system-type 'darwin)
    (ns-auto-titlebar-mode)))

;; Mac native fullscreen ä¼šå¯¼è‡´ç™½å±å’Œå·¦å³æ»‘åŠ¨é—®é¢˜ï¼Œæ•…ä½¿ç”¨ä¼ ç»Ÿå…¨å±æ¨¡å¼ã€‚
;; Emacs 28 å¼€å¯åä¸èƒ½æ­£å¸¸ max-frame æˆ– fullscreen
(when (eq system-type 'darwin)
  (setq ns-use-native-fullscreen nil
        ns-use-fullscreen-animation nil))

;; Make cursor movement an order of magnitude faster
;; https://emacs.stackexchange.com/questions/28736/emacs-pointcursor-movement-lag/28746
;; ä¼šå¯¼è‡´ buffer éƒ¨åˆ† fontify ä¸å‡†ç¡®
(setq fast-but-imprecise-scrolling 't)

(use-package origami
  :straight (origami :host github :repo "elp-revive/origami.el")
  :demand t
  :config
  (define-prefix-command 'origami-mode-map)
  (global-set-key (kbd "C-x C-z") 'origami-mode-map)
  (global-origami-mode)
  :bind
  (:map origami-mode-map
        ("o" . origami-open-node)
        ("O" . origami-open-node-recursively)
        ("c" . origami-close-node)
        ("C" . origami-close-node-recursively)
        ("a" . origami-toggle-node)
        ("A" . origami-recursively-toggle-node)
        ("R" . origami-open-all-nodes)
        ("M" . origami-close-all-nodes)
        ("v" . origami-show-only-node)
        ("k" . origami-previous-fold)
        ("j" . origami-forward-fold)
        ("x" . origami-reset)))

(use-package lsp-origami
  :after (lsp origami)
  :demand t
  :config
  (add-hook 'lsp-after-open-hook #'lsp-origami-try-enable))

(use-package emmet-mode
  :after(web-mode js2-mode)
  :config
  (add-hook 'sgml-mode-hook 'emmet-mode)
  (add-hook 'css-mode-hook  'emmet-mode)
  (add-hook 'web-mode-hook  'emmet-mode)
  (add-hook 'emmet-mode-hook (lambda () (setq emmet-indent-after-insert nil)))
  (add-hook 'emmet-mode-hook (lambda () (setq emmet-indentation 2)))
  (setq emmet-expand-jsx-className? t)
  ;; Make `emmet-expand-yas' not conflict with yas/mode
  (setq emmet-preview-default nil))

;; flycheck
;; åœ¨å½“å‰çª—å£åº•éƒ¨æ˜¾ç¤ºé”™è¯¯åˆ—è¡¨
(add-to-list 'display-buffer-alist
             `(,(rx bos "*Flycheck errors*" eos)
               (display-buffer-reuse-window
                display-buffer-in-side-window)
               (side            . bottom)
               (reusable-frames . visible)
               (window-height   . 0.33)))

(use-package modus-themes
  :init
  (setq modus-themes-italic-constructs t
        modus-themes-bold-constructs nil
        modus-themes-region '(bg-only no-extend)
        modus-themes-variable-pitch-ui t
        modus-themes-variable-pitch-headings t
        modus-themes-scale-headings t
        modus-themes-scale-1 1.1
        modus-themes-scale-2 1.15
        modus-themes-scale-3 1.21
        modus-themes-scale-4 1.27
        modus-themes-scale-title 1.33)
  ;; Load the theme files before enabling a theme
  (modus-themes-load-themes)
  :config
  ;; modus è¦æ±‚åˆ‡æ¢ä¸»é¢˜æ—¶è®¾ç½®å­—ä½“ï¼Œå¦åˆ™ org code å­—ä½“ä¸å¯¹ã€‚
  ;;(add-hook 'modus-themes-after-load-theme-hook #'my/faces)
  (modus-themes-load-operandi) ;; æµ…è‰²ä¸»é¢˜
  ;;(modus-themes-load-vivendi)  ;; æ·±è‰²ä¸»é¢˜
  )

(defun my/faces  (&optional theme &rest _)
  (interactive)
  ;; Main typeface ï¼ˆè‹±æ–‡å­—ä½“ï¼‰
  (set-face-attribute 'default nil :font "Iosevka SS14-14")
  ;; Proportionately spaced typeface
  (set-face-attribute 'variable-pitch nil :family "Iosevka SS14")
  ;; Monospaced typeface
  (set-face-attribute 'fixed-pitch nil :family "Iosevka SS14")

  (when (display-graphic-p)
    ;; ä¸­æ–‡å­—ä½“
    (dolist (charset '(kana han symbol cjk-misc bopomofo))
      (set-fontset-font
       (frame-parameter nil 'font)
       charset
       (font-spec :name "Sarasa Mono SC" :weight 'normal :slant 'normal :size 15.0)))
    ;; è®¾ç½®å­—ä½“ç¼©æ”¾æ¯”ä¾‹, ä½¿å­—ä½“å¯¹é½ã€‚
    (setq face-font-rescale-alist '(("Iosevka SS14" . 1.0)
                                    ("Sarasa Mono SC" . 1.0714285714285714)
                                    ("HanaMinB" . 1.1428571428571428)))))

(use-package mini-frame
  :disabled
  :config
  (setq x-gtk-resize-child-frames 'resize-mode)
  ;; å…‰æ ‡ä½ç½®æ˜¾ç¤º minibuffer
  (setq mini-frame-show-parameters
        (lambda ()
          (let* ((info (posframe-poshandler-argbuilder))
                 (posn (posframe-poshandler-point-bottom-left-corner info))
                 (left (car posn))
                 (top (cdr posn)))
            `((left . ,left)
              (top . ,top)))))
  ;; å›ºå®šåœ¨ frame é¡¶éƒ¨æ˜¾å¼ã€‚
  ;;(custom-set-variables '(mini-frame-show-parameters '((top . 10) (width . 0.7) (left . 0.5)  (height . 10))))
  (mini-frame-mode))

;; åœ¨ side-window æ˜¾ç¤ºçª—å£ï¼Œside-window ä¼šä¸€ç›´æ˜¾ç¤ºï¼Œä¸º vterm mode ä¸“ç”¨ï¼ˆä¸èƒ½æœ€å¤§åŒ–ï¼‰ï¼Œ
;; vterm-toggle-forward å’Œ  'vterm-toggle-backward ä¹Ÿéƒ½æ˜¾ç¤ºåœ¨è¿™ä¸ª side-window ä¸­ã€‚
;; (setq vterm-toggle-fullscreen-p nil)
;; (add-to-list 'display-buffer-alist
;;              '((lambda(bufname _) (with-current-buffer bufname (equal major-mode 'vterm-mode)))
;;                (display-buffer-reuse-window display-buffer-in-side-window)
;;                (side . bottom)
;;                (dedicated . t)
;;                (reusable-frames . visible)
;;                (window-height . 0.3)))


(transient-mark-mode t)

(add-to-list 'default-frame-alist '(height . 600))
(add-to-list 'default-frame-alist '(width . 600))

;; That tells auth-source (the package responsible for retrieving and storing
;; passwords from the environment) to consult the keychain for your credentials
;; - instead of putting them into ~/.authinfo in plaintext
;; https://www.reddit.com/r/emacs/comments/ew75ib/comment/fg23tcj/?utm_source=share&utm_medium=web2x&context=3
(eval-after-load 'auth-source
  '(when (member window-system '(mac ns))
     (add-to-list 'auth-sources 'macos-keychain-internet)
     (add-to-list 'auth-sources 'macos-keychain-generic)))

;; buffer æ™ºèƒ½åˆ†ç»„ï¼ˆå–ä»£ ibufferï¼‰
;; æ˜¾ç¤º buffer åˆ—è¡¨æ—¶ä¼šè‡ªåŠ¨è¿æ¥ TRAMP buffer, å¯èƒ½ä¼šå¡ä½ã€‚
(use-package bufler :config (global-set-key (kbd "C-x C-b") 'bufler))

;; å¤šå…‰æ ‡ç¼–è¾‘
(use-package iedit)

(defconst sys/macp (eq system-type 'darwin) "Are we running on a Mac system?")
(defconst sys/mac-x-p (and (display-graphic-p) sys/macp) "Are we running under X on a Mac system?")
(defconst sys/mac-ns-p (eq window-system 'ns) "Are we running on a GNUstep or Macintosh Cocoa display?")
(defconst sys/mac-cocoa-p (featurep 'cocoa) "Are we running with Cocoa on a Mac system?")
(defconst sys/mac-port-p (eq window-system 'mac) "Are we running a macport build on a Mac system?")

;; cnfont ä¼šè‡ªåŠ¨è®¾ç½® hookï¼Œå¼€å¯ cnfont çš„æƒ…å†µä¸‹ï¼Œä¸éœ€è¦é…ç½®è¿™ä¸ª hook
(add-hook 'emacs-startup-hook #'my/faces)

;; ä¸èƒ½åœ¨ load-theme æ—¶æ‰§è¡Œè¿™ä¸ªå‡½æ•°ï¼Œå¦åˆ™å­—ä½“ç¼©æ”¾æœ‰é—®é¢˜ã€‚
;; è¿™ä¸ªå‡½æ•°åªè¢« modus-theme åœ¨åˆ‡æ¢ä¸»é¢˜æ—¶è°ƒç”¨ã€‚
;;(advice-add #'load-theme :after #'my/faces)

;; (add-hook 'emacs-startup-hook
;;           (lambda () (load-theme 'doom-dracula t))
;;           'append)

;; Get rid of "For information about GNU Emacs..." message at startup, unless
;; we're in a daemon session where it'll say "Starting Emacs daemon." instead,
;; which isn't so bad.
(unless (daemonp)
  (advice-add #'display-startup-echo-area-message :override #'ignore))

;; ä¸­è‹±æ–‡ä¹‹é—´è‡ªåŠ¨åŠ ç©ºæ ¼
(use-package pangu-spacing
  :config
  ;; åªæ˜¯åœ¨ä¸­è‹±æ–‡ä¹‹é—´æ˜¾ç¤ºç©ºæ ¼
  (global-pangu-spacing-mode 1)
  ;; ä¿å­˜æ—¶çœŸæ­£æ’å…¥ç©ºæ ¼
  (setq pangu-spacing-real-insert-separtor t))

(use-package eshell-toggle
  :custom
  (eshell-toggle-size-fraction 3)
  ;;(eshell-toggle-use-projectile-root t)
  (eshell-toggle-run-command nil)
  (eshell-toggle-init-function #'eshell-toggle-init-ansi-term)
  :bind
  ("s-`" . eshell-toggle))

(use-package native-complete
  :custom
  (with-eval-after-load 'shell
    (native-complete-setup-bash)))

(use-package company-native-complete
  :after (company)
  :custom
  (add-to-list 'company-backends 'company-native-complete))

(use-package persp-mode
  :custom
  (persp-keymap-prefix (kbd "C-x p"))
  :config
  (persp-mode))

(use-package treemacs-persp
  :after (treemacs persp-mode)
  :config
  (treemacs-set-scope-type 'Perspectives))

;;lsp-treemacs åœ¨ treemacs æ˜¾ç¤ºæ–‡ä»¶çš„ symbolã€errors å’Œ hierarchyï¼š
(use-package lsp-treemacs
  :after (lsp-mode treemacs)
  :config
  ;; bidirectional synchronization of lsp workspace folders and treemacs projects
  (lsp-treemacs-sync-mode 1))

;; minibuffer è‡ªåŠ¨è¡¥å…¨æ—¶æ˜¾ç¤ºå›¾æ ‡ä¼šå¯¼è‡´ TRAMP å˜æ…¢ï¼Œæ•…å…³é—­ã€‚
(use-package all-the-icons-completion
  :after (marginalia)
  :config
  (all-the-icons-completion-mode)
  (add-hook 'marginalia-mode-hook #'all-the-icons-completion-marginalia-setup))

;; pyenv-mode é€šè¿‡ç»™é¡¹ç›®è®¾ç½®ç¯å¢ƒå˜é‡ ~PYENV_VERSION~ æ¥è¾¾åˆ°æŒ‡å®š pyenv ç¯å¢ƒçš„ç›®çš„ï¼š
(use-package pyenv-mode
  ;;:after (projectile)
  :init
  (add-to-list 'exec-path "~/.pyenv/shims")
  (setenv "WORKON_HOME" "~/.pyenv/versions/")
  :config
  (pyenv-mode)
  ;; (defun projectile-pyenv-mode-set ()
  ;;   (let ((project (projectile-project-name)))
  ;;     (if (member project (pyenv-mode-versions))
  ;;         (pyenv-mode-set project)
  ;;       (pyenv-mode-unset))))
  ;;(add-hook 'projectile-after-switch-project-hook 'projectile-pyenv-mode-set)
  :bind
  ;; é˜²æ­¢å’Œ org-mode å¿«æ·é”®å†²çª
  (:map pyenv-mode-map ("C-c C-u") . nil)
  (:map pyenv-mode-map ("C-c C-s") . nil))

(use-package selectrum :init (selectrum-mode +1))
(use-package prescient  :config (prescient-persist-mode +1))
(use-package selectrum-prescient :init (selectrum-prescient-mode +1))

;;company-prescient ç²¾å‡†æ’åºï¼š
(use-package company-prescient
  :after (company prescient)
  :init (company-prescient-mode +1))

(use-package modus-themes
  :init
  (setq modus-themes-italic-constructs t
        modus-themes-bold-constructs nil
        modus-themes-region '(bg-only no-extend)
        modus-themes-variable-pitch-ui t
        modus-themes-variable-pitch-headings t
        modus-themes-scale-headings t
        modus-themes-scale-1 1.1
        modus-themes-scale-2 1.15
        modus-themes-scale-3 1.21
        modus-themes-scale-4 1.27
        modus-themes-scale-title 1.33)
  ;; Load the theme files before enabling a theme
  (modus-themes-load-themes)
  :config
  ;; modus è¦æ±‚åˆ‡æ¢ä¸»é¢˜æ—¶è®¾ç½®å­—ä½“ï¼Œå¦åˆ™ org code å­—ä½“ä¸å¯¹ã€‚
  (add-hook 'modus-themes-after-load-theme-hook #'my/faces)
  ;;(modus-themes-load-operandi) ;; æµ…è‰²ä¸»é¢˜
  ;;(modus-themes-load-vivendi)  ;; æ·±è‰²ä¸»é¢˜
  )

(defun my/faces  (&optional theme &rest _)
  (interactive)
  ;; Main typeface ï¼ˆè‹±æ–‡å­—ä½“ï¼‰
  (set-face-attribute 'default nil :font "Iosevka SS14-14")
  ;; Proportionately spaced typeface
  (set-face-attribute 'variable-pitch nil :family "Iosevka SS14")
  ;; Monospaced typeface
  (set-face-attribute 'fixed-pitch nil :family "Iosevka SS14")

  (when (display-graphic-p)
    ;; ä¸­æ–‡å­—ä½“
    (dolist (charset '(kana han symbol cjk-misc bopomofo))
      (set-fontset-font
       (frame-parameter nil 'font)
       charset
       (font-spec :name "Sarasa Mono SC" :weight 'normal :slant 'normal :size 15.0)))
    ;; è®¾ç½®å­—ä½“ç¼©æ”¾æ¯”ä¾‹, ä½¿å­—ä½“å¯¹é½ã€‚
    (setq face-font-rescale-alist '(("Iosevka SS14" . 1.0)
                                    ("Sarasa Mono SC" . 1.0714285714285714)
                                    ("HanaMinB" . 1.1428571428571428)))))

;; cnfont ä¼šè‡ªåŠ¨è®¾ç½®å­—ä½“å’Œç¼©æ”¾ï¼Œå¼€å¯ cnfont æ—¶ä¸éœ€è¦é…ç½®è¿™ä¸ª hook ã€‚è€Œä¸”è¿™ä¸ªåªæ˜¯
;; å¾ˆå¯¹ç‰¹å®šå­—å·çš„scale, å¦‚æœç¼©æ”¾å±å¹•å°±ä¼šå‡ºç°ä¸­è‹±æ–‡æ··ä¹±çš„æƒ…å†µï¼Œæ‰€ä»¥æœ€å¥½ä½¿ç”¨
;; cnfonts
(add-hook 'emacs-startup-hook (lambda ()
                                ;; åªä¼šå¯¹åˆå§‹ frame ç”Ÿæ•ˆ
                                (my/faces)
                                ;; åˆ›å»ºæ–° frame æ—¶ä¹Ÿç”Ÿæ•ˆ
                                (add-to-list 'after-make-frame-functions
                                             (lambda (new-frame)
                                               (select-frame new-frame)
                                               (if window-system
                                                   (my/faces))))))

;; https://github.com/minad/mini-popup
;; https://raw.githubusercontent.com/minad/mini-popup/main/mini-popup.el
(use-package mini-popup
  :ensure nil
  :load-path "/Users/zhangjun/.emacs.d/site-lisp"
  :config
  ;; Configure a height function (Example for Vertico)
  (defun mini-popup-height-resize ()
    (* (1+ (min vertico--total vertico-count)) (default-line-height)))
  (defun mini-popup-height-fixed ()
    (* (1+ (if vertico--input vertico-count 0)) (default-line-height)))
  (setq mini-popup--height-function #'mini-popup-height-resize)

  ;; Disable the minibuffer resizing of Vertico (HACK)
  (advice-add #'vertico--resize-window :around
              (lambda (&rest args)
                (unless mini-popup-mode
                  (apply args))))

  ;; Ensure that the popup is updated after refresh (Consult-specific)
  (add-hook 'consult--completion-refresh-hook
            (lambda (&rest _) (mini-popup--setup)) 99)
  (mini-popup-mode t))

;; é”®ç›˜é»æ»é”®
(use-package key-chord
  :config
  (key-chord-mode 1)
  (key-chord-define-global ".." 'ebuku)
  (key-chord-define-global ",," '(lamba ()(find-file "~/Downloads/history.json"))))

;; ç”»å›¾
(use-package svg
  :ensure nil
  :load-path "/Users/zhangjun/.emacs.d/site-lisp")

;; è‡ªåŠ¨è°ƒæ•´çª—å£å¤§å°
(use-package zoom
  :disabled
  :custom
  (zoom-size '(0.618 . 0.618))
  (zoom-ignored-major-modes '(dired-mode markdown-mode ediff-mode))
  (zoom-ignored-buffer-names '("zoom.el" "init.el" "*Ediff Control Panel*"))
  (zoom-ignored-buffer-name-regexps '("^\\*calc" "^\\*[eE]diff.*"))
  (zoom-ignore-predicates (list (lambda () (< (count-lines (point-min) (point-max)) 20))))
  :config
  (zoom-mode t))

;; ä½¿ç”¨ embark C-h æ›¿æ¢ which-key
;; which-key ä¼šå¯¼è‡´ ediff çš„ gX å‘½ä»¤å¡ä½ï¼Œè§£å†³åŠæ³•æ˜¯å‘ Emacs å‘é€ USR2 ä¿¡å·
(use-package which-key
  :init (which-key-mode)
  :diminish which-key-mode
  :config (setq which-key-idle-delay 0.8))

;; org-msg åœ¨å›å¤æ¶ˆæ¯æ—¶ï¼Œåªèƒ½çœ‹åˆ°å›å¤å¼•ç”¨çš„å†…å®¹ï¼Œè€Œçœ‹ä¸åˆ°æ¶ˆæ¯æœ¬èº«ï¼Œæ•…ä¸å†ä½¿ç”¨ã€‚
(use-package org-msg
  :ensure t
  :disabled
  :config
  (setq mail-user-agent 'mu4e-user-agent)
  (setq org-msg-options "html-postamble:nil H:5 num:nil ^:{} toc:nil author:nil email:nil \\n:t"
        org-msg-startup "hidestars indent inlineimages"
        org-msg-greeting-fmt "\nHi%s,\n\n"
        org-msg-recipient-names '(("geekard@qq.com" . "zhangjun"))
        org-msg-greeting-name-limit 3
        org-msg-default-alternatives '((new		. (text html))
                                       (reply-to-html	. (text html))
                                       (reply-to-text	. (text)))
        org-msg-convert-citation t)
  (org-msg-mode)
  )

;;company-box ä¸ºå€™é€‰è€…æ˜¾ç¤ºå›¾æ ‡å’Œå¸®åŠ©æ–‡æ¡£, ä¼šå¯¼è‡´ RIME è¾“å…¥æ³•æç¤ºæ—¶å¡ä½, æ•…å…³é—­ã€‚
(use-package company-box
  :after (company all-the-icons)
  :init
  ;;(setq company-box-doc-enable nil)
  (setq company-box-doc-delay 0.1)
  :hook (company-mode . company-box-mode))

;;Buffer è¯­æ³•é«˜äº®æ¸²æŸ“å˜æ…¢ï¼Œæš‚æ—¶å…³é—­ã€‚
(use-package tree-sitter
  :config
  (global-tree-sitter-mode)
  ;; å¯¹äºæ”¯æŒçš„è¯­è¨€ï¼ˆæŸ¥çœ‹å˜é‡ tree-sitter-major-mode-language-alistï¼‰ä½¿ç”¨
  ;; tree-sitter æä¾›çš„é«˜äº®æ¥å–ä»£å†…ç½®çš„ã€åŸºäº font-lock æ­£åˆ™çš„ä½æ•ˆé«˜äº®æ¨¡å¼ã€‚
  (add-hook 'tree-sitter-after-on-hook #'tree-sitter-hl-mode))

(use-package  tree-sitter-langs)

;;origami æä¾›ä»£ç æŠ˜å åŠŸèƒ½ï¼Œæœ€æ–°ç‰ˆæœ¬[[https://github.com/elp-revive/origami.el/issues/1][ä» celpa æºå®‰è£…]]ï¼š
;; ç”±äºå¯ä»¥ä½¿ç”¨ consult-line å’Œ occur æ¥æ›¿ä»£ï¼Œæ‰€ä»¥ä¸å†ä½¿ç”¨ã€‚
(use-package origami
  :config
  (define-prefix-command 'origami-mode-map)
  (global-set-key (kbd "C-x C-z") 'origami-mode-map)
  (global-origami-mode)
  :bind
  (:map origami-mode-map
        ("o" . origami-open-node)
        ("O" . origami-open-node-recursively)
        ("c" . origami-close-node)
        ("C" . origami-close-node-recursively)
        ("a" . origami-toggle-node)
        ("A" . origami-recursively-toggle-node)
        ("R" . origami-open-all-nodes)
        ("M" . origami-close-all-nodes)
        ("v" . origami-show-only-node)
        ("k" . origami-previous-fold)
        ("j" . origami-forward-fold)
        ("x" . origami-reset)))

;; youdao
(defun my-youdao-dictionary-search-at-point ()
  "Search word at point and display result with `posframe', `pos-tip', or buffer."
  (interactive)
  (if (display-graphic-p)
      (youdao-dictionary-search-at-point-posframe)
    (youdao-dictionary-search-at-point)))

(with-no-warnings
  (defun my-youdao-dictionary--posframe-tip (string)
    "Show STRING using posframe-show."
    (unless (and (require 'posframe nil t) (posframe-workable-p))
      (error "Posframe not workable"))

    (let ((word (youdao-dictionary--region-or-word)))
      (if word
          (progn
            (with-current-buffer (get-buffer-create youdao-dictionary-buffer-name)
              (let ((inhibit-read-only t))
                (erase-buffer)
                (youdao-dictionary-mode)
                (insert (propertize "\n" 'face '(:height 0.5)))
                (insert string)
                (insert (propertize "\n" 'face '(:height 0.5)))
                (set (make-local-variable 'youdao-dictionary-current-buffer-word) word)))
            (posframe-show youdao-dictionary-buffer-name
                           :position (point)
                           :left-fringe 16
                           :right-fringe 16
                           :posframe-width 100
                           :background-color (face-background 'tooltip nil t)
                           :internal-border-color (face-foreground 'font-lock-comment-face nil t)
                           :internal-border-width 1)
            (unwind-protect
                (push (read-event) unread-command-events)
              (progn
                (posframe-hide youdao-dictionary-buffer-name)
                (other-frame 0))))
        (message "Nothing to look up"))))

  (advice-add #'youdao-dictionary--posframe-tip
              :override #'my-youdao-dictionary--posframe-tip))

;;å®‰è£…å¤–ç½®è¾“å…¥æ³•åˆ‡æ¢å·¥å…· [[https://github.com/laishulu/macism#install][macism]]ï¼Œ
;;è§£å†³ Mac åˆ‡æ¢è¾“å…¥æ³•åå¿…é¡»è¾“å…¥ä¸€ä¸ªå­—ç¬¦æ‰èƒ½ç”Ÿæ•ˆçš„é—®é¢˜ã€‚åŒæ—¶ç³»ç»Ÿçš„ â€œå¿«æ·é”®â€->â€œé€‰
;;æ‹©ä¸Šä¸€ä¸ªè¾“å…¥æ³•â€ å¿«æ·é”®å¿…é¡»è¦å¼€å¯ï¼Œå¦åˆ™ macism
;;[[https://github.com/laishulu/macism/issues/2][ä¼šåˆ‡æ¢å¤±è´¥]]ã€‚å¿…é¡»åœ¨å¯ç”¨
;;=respect-mode= ä¹‹å‰è®¾ç½® =sis-prefix-override-keys= å˜é‡ï¼Œå¦åˆ™å˜é‡ä¸ç”Ÿæ•ˆã€‚
(use-package sis
  ;; mac è¾“å…¥æ³•é€‰æ‹©
  :ensure-system-package (macism . "brew tap laishulu/macism; brew install macism")
  :config
  (sis-ism-lazyman-config "com.apple.keylayout.ABC" "com.sogou.inputmethod.sogou.pinyin")
  ;; è‡ªåŠ¨åˆ‡æ¢åˆ°è‹±æ–‡çš„å‰ç¼€å¿«æ·é”®
  (push "C-;" sis-prefix-override-keys)
  (push "M-o" sis-prefix-override-keys)
  (push "M-g" sis-prefix-override-keys)
  (push "M-s" sis-prefix-override-keys)
  (sis-global-context-mode nil)
  (sis-global-respect-mode t)
  (global-set-key (kbd "C-\\") 'sis-switch))

;; å¿«é€Ÿè·³è½¬å½“å‰æ ‡è®°ç¬¦
(use-package symbol-overlay
  :config
  (global-set-key (kbd "M-i") 'symbol-overlay-put)
  (global-set-key (kbd "M-n") 'symbol-overlay-jump-next)
  (global-set-key (kbd "M-p") 'symbol-overlay-jump-prev)
  (global-set-key (kbd "<f7>") 'symbol-overlay-mode)
  (global-set-key (kbd "<f8>") 'symbol-overlay-remove-all)
  :hook (prog-mode . symbol-overlay-mode))

;;isearch ä¸ rime [[https://github.com/DogLooksGood/emacs-rime/issues/21][ä¸å…¼
;;å®¹]]ï¼Œä¼šå¯¼è‡´è¾“å…¥çš„ä¸­æ–‡ä¸èƒ½å€™é€‰ï¼Œå¯ä»¥ä½¿ç”¨ phi-search è§£å†³ï¼š
;; æ³¨: occur æ¯” isearch æ›´å¥½ç”¨ï¼Œä¸ rime å…¼å®¹ã€‚
(use-package phi-search
  :after (rime)
  :config
  (global-set-key (kbd "C-s") 'phi-search)
  (global-set-key (kbd "C-r") 'phi-search-backward))

(defun my/disable-vertico (orig-fun &rest args)
  (print args)
  (apply orig-fun args)
  ;; (if (string-match ".*(ssh|scp):.*" args)
  ;;     (progn (vertico-mode -1)
  ;;            (apply orig-fun args))
  ;;   (progn (vertico-mode t)
  ;;          (apply orig-fun args))
  )
(advice-add 'find-file-noselect :around #'my/disable-vertico)

(defun my/time-advice (func-orig &rest r)
  ;;(print r)
  (apply func-orig r))
(setq my/completion-func-to-advise #'completion-all-completions)
(advice-add my/completion-func-to-advise :around #'my/time-advice)

(use-package mu4e-dashboard
  :straight (mu4e-dashboard :host github :repo "rougier/mu4e-dashboard"))
#+end_src
