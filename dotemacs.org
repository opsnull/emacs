:PROPERTIES:
:GPTEL_MODEL: gpt-4o
:GPTEL_BACKEND: Azure
:GPTEL_SYSTEM: You are a large language model living in Emacs and a helpful assistant. Respond concisely.
:GPTEL_BOUNDS: ((118723 . 118739) (118782 . 119759) (119815 . 121106))
:END:
#+Title: My Emacs Dotfile
#+DATE: 2023-08-20 Sun
#+LASTMOD: 2024-11-20T21:11:08+0800
#+AUTHOR: å¼ ä¿Š(geekard@qq.com)
#+STARTUP: overview hideblocks
#+PROPERTY: header-args:emacs-lisp :tangle yes :eval no :results silent :exports code
#+HUGO_BASE_DIR: ~/blog/blog.opsnull.com
#+HUGO_SECTION: emacs
#+HUGO_BUNDLE: my-emacs-dotfile
#+EXPORT_FILE_NAME: index
#+HUGO_AUTO_SET_LASTMOD: t
#+HUGO_TAGS: emacs
#+HUGO_LOCALE: zh
#+OPTIONS: title:t prop:t ^:nil
#+HUGO_WEIGHT: -1

Emacs æ˜¯ Hacker çš„ä¸€ç§ç”Ÿæ´»æ–¹å¼ï¼Œè€Œè¿™æ˜¯ç¬¦åˆæˆ‘å£å‘³çš„ç§äººå®šåˆ¶ã€‚

#+hugo: more

æ›´å¤š Emacs å†…å®¹è¯·è®¿é—®[[https://blog.opsnull.com/emacs/][æˆ‘çš„åšå®¢]]ã€‚

#+ATTR_HTML: :width 400 :align center
[[file:static/images/2024-09-03_10-55-30_screenshot.png]]

* ç¼–è¯‘å®‰è£…

ä»æºç ç¼–è¯‘ã€å®‰è£…æœ€æ–° Emacs 30 ç‰ˆæœ¬:

#+begin_src bash :tangle ~/.emacs.d/init.sh
brew uninstall emacs-plus@30
brew install emacs-plus@30  --with-xwidgets --with-imagemagick --with-poll \
     --with-dragon-icon --with-native-comp --with-poll
brew unlink emacs-plus@30 && brew link emacs-plus@30
ln -sf /opt/homebrew/opt/emacs-plus@30/Emacs.app /Applications/
#+end_src

* åˆå§‹åŒ–

å®‰è£… native ç¼–è¯‘æ‰€éœ€çš„ gcc å·¥å…·é“¾ï¼š

#+begin_src bash :tangle ~/.emacs.d/init.sh
brew install gcc
current_gcc="/opt/homebrew/opt/gcc/lib/gcc/current"
export LIBRARY_PATH="${LIBRARY_PATH}:${current_gcc}:${current_gcc}/gcc/aarch64-apple-darwin23/14/"
#+end_src

=early-init.el= æ˜¯ Emacs å¯åŠ¨æ—©æœŸæ‰§è¡Œçš„ç¬¬ä¸€ä¸ªåˆå§‹åŒ–æ–‡ä»¶ï¼š

#+begin_src emacs-lisp :tangle ~/.emacs.d/early-init.el
;; ä¸ªäººä¿¡æ¯ã€‚
(setq user-full-name "zhangjun")
(setq user-mail-address "geekard@qq.com")

;; native ç¼–è¯‘ã€‚
(when (fboundp 'native-compile-async)
  (setenv "LIBRARY_PATH"
	  (concat (getenv "LIBRARY_PATH")
		  ":/opt/homebrew/opt/gcc/lib/gcc/current/"
		  ":/opt/homebrew/opt/gcc/lib/gcc/current/gcc/aarch64-apple-darwin23/14/"))
  (setq native-comp-speed 4)
  (setq native-comp-async-jobs-number 8)
  ;;(setq inhibit-automatic-native-compilation t)
  (setq native-comp-async-report-warnings-errors 'silent))

;; è§£å†³ cmake å’Œ Xcode 15.0 å…¼å®¹æ€§é—®é¢˜ï¼Œå¦åˆ™åç»­ç¼–è¯‘ vterm-module æ—¶æŠ¥é”™ã€‚
;;; æŸ¥çœ‹å½“å‰ Xcode SDK è·¯å¾„ï¼šxcrun --sdk macosx --show-sdk-path
(setenv "SDKROOT" "/Applications/Xcode.app/Contents/Developer/Platforms/MacOSX.platform/Developer/SDKs/MacOSX.sdk")

;; åŠ è½½è¾ƒæ–°çš„ .el æ–‡ä»¶ã€‚
(setq-default load-prefer-newer t)
(setq-default lexical-binding t)
(setq lexical-binding t)

;; åœ¨ç‹¬ç«‹æ–‡ä»¶ä¿å­˜ Emacs è‡ªåŠ¨å†™å…¥çš„é…ç½®å‚æ•°ï¼Œé¿å…æ±¡æŸ“ ~/.emacs æ–‡ä»¶ã€‚
(setq custom-file (expand-file-name "~/.emacs.d/custom.el"))
(add-hook 'after-init-hook
	  (lambda ()
	    (when (file-exists-p custom-file)
	      (load custom-file))))

;; éç³»ç»Ÿæ ‡å‡†è·¯å¾„çš„äºŒè¿›åˆ¶ç›®å½•åˆ—è¡¨ã€‚
(setq my-bin-path
      '("/opt/homebrew/bin"
        "/opt/homebrew/opt/findutils/libexec/gnubin"
        "/opt/homebrew/opt/openjdk/bin"
        "/Users/alizj/go/bin"
        "/Users/alizj/.cargo/bin"))

;; æ·»åŠ åˆ° PATH ç¯å¢ƒå˜é‡ã€‚
(mapc (lambda (p)
	(setenv "PATH" (concat p ":" (getenv "PATH"))))
      my-bin-path)

;; æ·»åŠ åˆ° Emacs æœç´¢è·¯å¾„ï¼šEmacs æŸ¥æ‰¾å¤–éƒ¨ç¨‹åºæ—¶ä½¿ç”¨ `exec-path` è€Œé `PATH` å˜é‡ã€‚
(let ((paths my-bin-path))
  (dolist (path paths)
    (setq exec-path (cons path exec-path))))
#+end_src

è®¾ç½®è½¯ä»¶åŒ…æºï¼š
+ =M-x use-package-report= : æŸ¥çœ‹åŒ…åŠ è½½æ—¶é—´ï¼ˆæŒ‰ S æ’åºï¼‰ï¼›
+ =M-x package-vc-upgrade-all= ï¼šæ›´æ–°ä½¿ç”¨ ~:vc~ æŒ‡ä»¤é…ç½®çš„ï¼Œä» ~github~ å®‰è£…çš„åŒ…ï¼›

#+begin_src emacs-lisp
(require 'package)
(setq package-archives
      '(("elpa" . "http://mirrors.tuna.tsinghua.edu.cn/elpa/gnu/")
        ("elpa-devel" . "http://mirrors.tuna.tsinghua.edu.cn/elpa/gnu-devel/")
        ("melpa" . "http://mirrors.tuna.tsinghua.edu.cn/elpa/melpa/")
        ("nongnu" . "http://mirrors.tuna.tsinghua.edu.cn/elpa/nongnu/")
        ("nongnu-devel" . "http://mirrors.tuna.tsinghua.edu.cn/elpa/nongnu-devel/")))
(package-initialize)
(when (not package-archive-contents)
  (package-refresh-contents))

(setq use-package-verbose t)
(setq use-package-always-ensure t)
(setq use-package-always-demand t)
(setq use-package-compute-statistics t)
(setq use-package-vc-prefer-newest t)

;; å…è®¸å‡çº§ Emacs å†…ç½®çš„åŒ…ã€‚
;;(setq package-install-upgrade-built-in t)
#+end_src

è®¾ç½® GPG åŠ è§£å¯†ï¼š

#+begin_src emacs-lisp
(setq auth-sources '("~/.authinfo.gpg"))
;;(setq auth-source-debug t)

(use-package epa
  :config
  (setq-default
   ;; ç¼ºçœä½¿ç”¨ email åœ°å€åŠ å¯†ã€‚
   epa-file-encrypt-to user-mail-address
   ;; ä½¿ç”¨ minibuffer è¾“å…¥ GPG å¯†ç ã€‚
   epa-pinentry-mode 'loopback)

  (require 'epa-file)
  (epa-file-enable))
#+end_src

æŒ‰é”®è°ƒæ•´ï¼š

#+begin_src emacs-lisp
;; command ä½œä¸º Meta é”®ã€‚
(setq mac-command-modifier 'meta)

;; option ä½œä¸º Super é”®ã€‚
(setq mac-option-modifier 'super)

;; fn ä½œä¸º Hyper é”®ã€‚
(setq ns-function-modifier 'hyper)

;; å…³é—­å®¹æ˜“è¯¯æ“ä½œçš„æŒ‰é”®ã€‚
;; s- è¡¨ç¤º Superï¼ŒS- è¡¨ç¤º Shift, H- è¡¨ç¤º Hyper:
(let ((keys '(
              "s-w"
              "C-z"
              "<mouse-2>"
              "s-k"
              "s-,"
              "s-."
              "s--"
              "s-+"
              "C-<wheel-down>"
              "C-<wheel-up>"
              "C-M-<wheel-down>"
              "C-M-<wheel-up>"
              ;;"<down-mouse-1>"
              ;;"<drag-mouse-1>"
              )))
  (dolist (key keys)
    (global-unset-key (kbd key))))
#+end_src

æå‡ IO æ€§èƒ½ï¼Œå‚è€ƒ [[https://github.com/hlissner/doom-emacs/blob/develop/core/core.el][doom core.el]] ï¼š

#+begin_src emacs-lisp
(setq process-adaptive-read-buffering nil)
(setq read-process-output-max (* 1024 1024 4))

(setq inhibit-compacting-font-caches t)
(setq-default message-log-max t)

;; Garbage Collector Magic Hack, æå‡ GC æ€§èƒ½ã€‚
(use-package gcmh
  :init
  ;;(setq gcmh-verbose t)
  (setq gcmh-idle-delay 'auto) ;; ç¼ºçœ 15s
  (setq gcmh-auto-idle-delay-factor 10)
  (setq gcmh-high-cons-threshold (* 32 1024 1024))
  (gcmh-mode 1)
  (gcmh-set-high-threshold))

;;(setq garbage-collection-messages t)
(add-hook 'after-init-hook #'garbage-collect t)
#+end_src

* ä»£ç†

~MacOS~ è‡ªå¸¦çš„ ~curl~ ä¸æ”¯æŒ ~socks5~ ä»£ç†, è¿™é‡Œå®‰è£…æ”¯æŒ ~socks5~ çš„ ~GNU curl~ ç‰ˆæœ¬:

#+begin_src bash :tangle ~/.emacs.d/init.sh
brew install curl
export PATH="/opt/homebrew/opt/curl/bin:$PATH"
#+end_src

å°† ~GNU curl~ æ·»åŠ åˆ° ~Emacs~ çš„ ~PATH~ ç¯å¢ƒå˜é‡å’Œ ~exec-path~ å˜é‡ä¸­ï¼š

#+begin_src emacs-lisp
(setq my-coreutils-path "/opt/homebrew/opt/curl/bin/")
(setenv "PATH" (concat my-coreutils-path ":" (getenv "PATH")))
(setq exec-path (cons my-coreutils-path  exec-path))
#+end_src

~Emacs~ ä½¿ç”¨ ~url-retrieve~ è®¿é—® URLï¼Œè¿™é‡Œè®¾ç½®å®ƒä½¿ç”¨ ~curl~ åç«¯ï¼Œè¿™æ ·å…¨å±€å¯ä½¿ç”¨ socks5 ä»£ç†ï¼š

#+begin_src emacs-lisp
;; socks5 ä»£ç†ä¿¡æ¯ã€‚
(setq my/socks-host "127.0.0.1")
(setq my/socks-port 1080)
(setq my/socks-proxy (format "socks5h://%s:%d" my/socks-host my/socks-port))

;; ä¸ç»è¿‡ socks ä»£ç†çš„ CIDR æˆ–åŸŸååˆ—è¡¨, éœ€è¦åŒæ—¶æ»¡è¶³ socks-noproxy å’Œ NO_RROXY å€¼è¦æ±‚:
;; + socks-noproxy: åŸŸåæ˜¯æ­£åˆ™è¡¨è¾¾å¼, å¦‚ \\.baidu.com;
;; + NO_PROXY: åŸŸåæ”¯æŒ *.baidu.com æˆ– baidu.com;
;; æ‰€ä»¥è¿™é‡Œä½¿ç”¨çš„æ˜¯åŒæ—¶æ»¡è¶³ä¸¤è€…çš„åŸŸååç¼€å½¢å¼, å¦‚ .baidu.com;
(setq my/no-proxy
      '(
        "127.0.0.1/32"
        "10.0.0.0/8"
        "172.0.0.0/8"
        "0.0.0.0/32"
        "localhost"
        "192.168.0.0/16"
        ".cn"
        ".alibaba-inc.com"
        ".taobao.com"
        ".antfin-inc.com"
        ".openai.azure.com"
        ".baidu.com"
        ".aliyun-inc.com"
        ".aliyun-inc.test"
        ))

(setq my/user-agent
      "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/94.0.4606.71 Safari/537.36")

(use-package mb-url-http
  :demand
  :vc (:url "https://github.com/dochang/mb-url")
  :init
  (require 'auth-source)
  (let ((credential (auth-source-user-and-password "api.github.com")))
    (setq github-user (car credential)
          github-password (cadr credential))
    (setq github-auth (concat github-user ":" github-password))
    (setq mb-url-http-backend 'mb-url-http-curl
          mb-url-http-curl-program "/opt/homebrew/opt/curl/bin/curl"
          mb-url-http-curl-switches
          `("-k"
            "-x" ,my/socks-proxy
            "--keepalive-time" "60"
            "--keepalive"
            "--max-time" "300"
            ;;é˜²æ­¢ POST è¶…è¿‡ 1024 Bytes æ—¶å‘é€ `Expect: 100-continue` å¯¼è‡´ 1s å»¶è¿Ÿã€‚
            "-H" "Expect: ''"
            ;;"-u" ,github-auth
            "--user-agent" ,my/user-agent
            ))))

;; å¼€å¯ socks5 ä»£ç†ã€‚
(defun proxy-socks-enable ()
  (interactive)
  (require 'socks)
  (setq url-gateway-method 'socks
        socks-noproxy my/no-proxy
        socks-server `("Default server" ,my/socks-host ,my/socks-port 5))
  (let ((no-proxy (mapconcat 'identity my/no-proxy ",")))
    (setenv "no_proxy" no-proxy))
  (setenv "ALL_PROXY" my/socks-proxy)
  (setenv "ALL_PROXY" my/socks-proxy)
  (setenv "HTTP_PROXY" nil)
  (setenv "HTTPS_PROXY" nil)
  (advice-add 'url-http :around 'mb-url-http-around-advice))

;; å…³é—­ socks5 ä»£ç†ã€‚
(defun proxy-socks-disable ()
  (interactive)
  (require 'socks)
  (setq url-gateway-method 'native socks-noproxy nil)
  (setenv "all_proxy" "")
  (setenv "ALL_PROXY" ""))

;; é»˜è®¤å¯åŠ¨æ—¶å¼€å¯ socks5 ä»£ç†ã€‚
(proxy-socks-enable)
#+end_src

* ç•Œé¢

å…³é—­éƒ¨åˆ† UI å…ƒç´ ï¼š

#+begin_src emacs-lisp
(when (memq window-system '(mac ns x))
  (tool-bar-mode -1)
  (scroll-bar-mode -1)
  (menu-bar-mode -1)
  (setq use-file-dialog nil)
  (setq use-dialog-box nil))
#+end_src

å…‰æ ‡å’Œè¡Œå·ï¼š

#+begin_src emacs-lisp
;; é«˜äº®å½“å‰è¡Œã€‚
(global-hl-line-mode t)
(setq global-hl-line-sticky-flag t)

;; æ˜¾ç¤ºè¡Œå·ã€‚
(global-display-line-numbers-mode t)

;; è®¾ç½®å…‰æ ‡æ ·å¼ã€‚
(setq-default cursor-type 'bar)

;; å…‰æ ‡å’Œå­—ç¬¦å®½åº¦ä¸€è‡´ï¼ˆå¦‚ TAB)ã€‚
(setq x-stretch-cursor t)
#+end_src

Frame è®¾ç½®ï¼š

#+begin_src emacs-lisp
;; frame è¾¹è§’æ ·å¼ï¼šundecorated, round corner: undecorated-round
(add-to-list 'default-frame-alist '(undecorated . t))
(add-to-list 'default-frame-alist '(ns-transparent-titlebar . t))
(add-to-list 'default-frame-alist '(selected-frame) 'name nil)
(add-to-list 'default-frame-alist '(ns-appearance . dark))

;; ä¸åœ¨æ–° frame æ‰“å¼€æ–‡ä»¶ï¼ˆå¦‚ Finder çš„ "Open with Emacs") ã€‚
(setq ns-pop-up-frames nil)

;; å¤ç”¨å½“å‰ frameã€‚
(setq display-buffer-reuse-frames t)
(setq frame-resize-pixelwise t)

;; 30: å·¦å³åˆ†å±, nil: ä¸Šä¸‹åˆ†å±ã€‚
(setq split-width-threshold nil)

;; åˆ·æ–°æ˜¾ç¤ºã€‚
(global-set-key (kbd "<f5>") #'redraw-display)

(setq switch-to-buffer-obey-display-actions t)

;; åœ¨ frame åº•éƒ¨æ˜¾ç¤ºçš„çª—å£åˆ—è¡¨ã€‚
(add-to-list
 'display-buffer-alist
 `((,(regexp-opt
      '("\\*compilation\\*"
        "\\*Apropos\\*"
        "\\*Help\\*"
        "\\*helpful"
        "\\*info\\*"
        "\\*Summary\\*"
        "\\*vt"
        "\\*lsp-bridge"
        "\\*Org"
        "\\*Google Translate\\*"
        " \\*eglot"
        "Shell Command Output"))
    ;; å¤ç”¨åŒå buffer çª—å£ã€‚
    (display-buffer-reuse-window
     . (
	;; åœ¨ frame åº•éƒ¨æ˜¾ç¤ºçª—å£ã€‚
	(side . bottom)
	;; çª—å£é«˜åº¦æ¯”ä¾‹ã€‚
	(window-height . 0.35)
	)))))

;; å¯åŠ¨åæ˜¾ç¤ºæ¨¡å¼ï¼ŒåŠ  t å‚æ•°è®© togg-frame-XX æœ€åè¿è¡Œï¼Œè¿™æ ·æ‰ç”Ÿæ•ˆï¼š
(add-hook 'window-setup-hook 'toggle-frame-maximized t) ;; toggle-frame-fullscreen
#+end_src

çª—å£å’Œæ»šåŠ¨ï¼š

#+begin_src emacs-lisp
;; åˆ‡æ¢çª—å£ã€‚
(global-set-key (kbd "s-o") #'other-window)

(setq window-combination-resize t)

;; åƒç´ å¹³æ»‘æ»šåŠ¨ã€‚
(pixel-scroll-precision-mode t)
(setq fast-but-imprecise-scrolling t)
(setq scroll-conservatively 10
      scroll-margin 2
      scroll-preserve-screen-position t
      mouse-wheel-scroll-amount '(2 ((shift) . hscroll))
      mouse-wheel-scroll-amount-horizontal 2)
#+end_src

dashboardï¼š

#+begin_src emacs-lisp
(use-package dashboard
  :config
  (dashboard-setup-startup-hook)
  (setq-local global-hl-line-mode nil)
  (setq dashboard-banner-logo-title "Happy Hacking & Writing ğŸ¯")
  (setq dashboard-projects-backend #'project-el)
  (setq dashboard-center-content t)
  (setq dashboard-set-heading-icons t)
  (setq dashboard-set-navigator t)
  (setq dashboard-set-file-icons t)
  (setq dashboard-path-max-length 30)
  ;; æ˜¾ç¤º org-mode agendaã€‚
  (add-to-list 'dashboard-items '(agenda) t)
  (setq dashboard-items '((recents . 20) (projects . 8) (agenda . 3))))
#+end_src

doom-modelineï¼š

#+begin_src emacs-lisp
;; ä½¿ç”¨ Symbols Nerd Fonts Mono åœ¨ modeline ä¸Šæ˜¾ç¤º iconsï¼Œéœ€è¦å•ç‹¬ä¸‹è½½å’Œå®‰è£…è¯¥å­—ä½“ã€‚
(use-package nerd-icons)

(use-package doom-modeline
  :hook (after-init . doom-modeline-mode)
  :custom
  (doom-modeline-buffer-encoding nil)
  (doom-modeline-env-version nil)
  (doom-modeline-env-enable-rust nil)
  (doom-modeline-env-enable-go nil)
  (doom-modeline-buffer-file-name-style 'truncate-nil)
  (doom-modeline-vcs-max-length 30)
  (doom-modeline-github nil)
  (doom-modeline-time-icon nil)
  (doom-modeline-check-simple-format t)
  :config
  (display-battery-mode 0)
  (column-number-mode t)
  (display-time-mode t)
  (setq display-time-24hr-format t)
  (setq display-time-default-load-average nil)
  (setq display-time-load-average-threshold 20)
  (setq display-time-format "%H:%M ") ;; é»˜è®¤ï¼š"%m/%d[%w]%H:%M "
  (setq indicate-buffer-boundaries (quote left)))

;; ä¸º vterm-mode å®šä¹‰ç®€åŒ–çš„ modelineï¼Œé¿å… vterm buffer å†…å®¹è¿‡å¤šæ—¶æ›´æ–° modeline å½±å“æ€§èƒ½ã€‚
(doom-modeline-def-modeline 'my-vterm-modeline
  '(buffer-info) ;; å·¦ä¾§
  '(misc-info minor-modes input-method)) ;; å³ä¾§
(add-to-list 'doom-modeline-mode-alist '(vterm-mode . my-vterm-modeline))
#+end_src

dired-sidebarï¼šä½¿ç”¨ dired æ˜¾ç¤ºç›®å½•ï¼Œç›¸æ¯” treemacs/neotree çš„ä¼˜åŠ¿æ˜¯é€Ÿåº¦å¿«å’Œä½¿ç”¨ dired æŒ‰é”®ï¼š

#+begin_src emacs-lisp
(use-package vscode-icon
  :commands (vscode-icon-for-file))

(use-package dired-sidebar
  :bind (("s-1" . dired-sidebar-toggle-sidebar))
  :commands (dired-sidebar-toggle-sidebar)
  :init
  (add-hook 'dired-sidebar-mode-hook
            (lambda ()
              (unless (file-remote-p default-directory)
                (auto-revert-mode))))
  :config
  (push 'toggle-window-split dired-sidebar-toggle-hidden-commands)
  (push 'rotate-windows dired-sidebar-toggle-hidden-commands)
  (setq dired-sidebar-subtree-line-prefix "-")
  (setq dired-sidebar-theme 'vscode) ;;'ascii
  (setq dired-sidebar-use-term-integration t)
  (setq dired-sidebar-use-one-instance t)
  (setq dired-sidebar-use-custom-font t)
  (setq dired-sidebar-icon-scale 0.1)
  (setq dired-sidebar-follow-file-idle-delay 0.5))
#+end_src

å­—ä½“ï¼šè‹±æ–‡å­—ä½“ Iosevka/Sarasa å’Œä¸­æ–‡å­—ä½“ LxgwWenKaiï¼ŒæŒ‰ç…§ 1:1 ç¼©æ”¾ï¼Œåœ¨å¶æ•°å­—å·çš„æƒ…å†µ
ä¸‹å¯ä»¥å®ç°ä¸­è‹±æ–‡ç­‰å®½ç­‰é«˜ã€‚
+ è‹±æ–‡ï¼š[[https://github.com/protesilaos/iosevka-comfy][Iosevka Comfy]];
+ ä¸­æ–‡ï¼šéœé¹œæ–‡æ¥·å±å¹•é˜…è¯»ç‰ˆ [[https://github.com/lxgw/LxgwWenKai-Screen/releases][LxgwWenKai-Screen]]ï¼Œå¯¹å­—ä½“åšäº†åŠ ç²—ï¼Œä¾¿äºå±å¹•é˜…è¯»;

å¸¸ç”¨å­—ä½“å‘½ä»¤:
+ æŸ¥çœ‹ Emacs æ”¯æŒçš„å­—ä½“åç§°ï¼š =(print (font-family-list))=
+ æŸ¥çœ‹å…‰æ ‡å¤„å­—ä½“ï¼š =M-x describe-char=
+ æŸ¥çœ‹ Emacs æ”¯æŒçš„å­—ä½“åç§°ï¼š =(print (font-family-list))=

#+begin_src emacs-lisp
(use-package fontaine
  :config
  (setq fontaine-latest-state-file (locate-user-emacs-file "fontaine-latest-state.eld"))
  (setq fontaine-presets
	'((regular) ;; ä½¿ç”¨ç¼ºçœé…ç½®ã€‚
	  (t
	   :default-family "Iosevka Comfy"
	   :default-weight regular
	   :default-height 180 ;; é»˜è®¤å­—å·, éœ€è¦æ˜¯å¶æ•°æ‰èƒ½å®ç°ä¸­è‹±æ–‡ç­‰å®½ç­‰é«˜ã€‚
	   :fixed-pitch-family "Iosevka Comfy"
	   :fixed-pitch-weight nil
	   :fixed-pitch-height 1.0
	   :fixed-pitch-serif-family "Iosevka Comfy"
	   :fixed-pitch-serif-weight nil
	   :fixed-pitch-serif-height 1.0
	   :variable-pitch-family "Iosevka Comfy Duo"
	   :variable-pitch-weight nil
	   :variable-pitch-height 1.0
	   :line-spacing nil)))
  (fontaine-mode 1)
  (add-hook 'enable-theme-functions #'fontaine-apply-current-preset)
  (fontaine-set-preset (or (fontaine-restore-latest-preset) 'regular))
  (add-hook 'kill-emacs-hook #'fontaine-store-latest-preset))

;; è®¾ç½® emoji/symbol å’Œä¸­æ–‡å­—ä½“ã€‚
(defun my/set-font ()
  (when window-system
    (setq use-default-font-for-symbols nil)
    (set-fontset-font t 'emoji (font-spec :family "Apple Color Emoji")) ;; Noto Color Emoji
    (set-fontset-font t 'symbol (font-spec :family "Symbola")) ;; Apple Symbols, Symbola
    (let ((font (frame-parameter nil 'font))
	  (font-spec (font-spec :family "LXGW WenKai Screen")))
      (dolist (charset '(kana han hangul cjk-misc bopomofo))
	(set-fontset-font font charset font-spec)))))

;; Emacs å¯åŠ¨åæˆ– fontaine preset åˆ‡æ¢æ—¶è®¾ç½®å­—ä½“ã€‚
(add-hook 'after-init-hook 'my/set-font)
(add-hook 'fontaine-set-preset-hook 'my/set-font)

;; è®¾ç½®å­—ä½“ç¼©æ”¾æ¯”ä¾‹ï¼Œè®¾ç½®ä¸º 1.172 å¯ä»¥ç¡®ä¿ 2 å€æ”¾å¤§åå¯¹åº”çš„æ˜¯ 22 å·å¶æ•°å­—ä½“ï¼Œè¿™æ ·è¡¨æ ¼
;; å¯ä»¥å¯¹é½ã€‚16 * 1.172 * 1.172 = 21.97ï¼ˆEmacs å–æ•´ä¸º 22ï¼‰ã€‚
(setq text-scale-mode-step 1.172)

;; org-table åªä½¿ç”¨ä¸­è‹±æ–‡ä¸¥æ ¼ç­‰å®½çš„ LXGW WenKai Mono Screen å­—ä½“, é¿å…ä¸­è‹±æ–‡ä¸å¯¹é½ã€‚
(custom-theme-set-faces 'user '(org-table ((t (:family "LXGW WenKai Mono Screen")))))
#+end_src

ef-themes: Emacs ä¸»é¢˜åˆ—è¡¨ï¼šhttps://emacsthemes.com/popular/index.html

#+begin_src emacs-lisp
(use-package ef-themes
  :demand
  :config
  (mapc #'disable-theme custom-enabled-themes)
  (setq ef-themes-variable-pitch-ui t)
  (setq ef-themes-mixed-fonts t)
  (setq ef-themes-headings
        '(
          ;; level 0 æ˜¯æ–‡æ¡£ titleï¼Œ1-8 æ˜¯æ–‡æ¡£ headerã€‚
          (0 . (variable-pitch light 1.9))
          (1 . (variable-pitch light 1.8))
          (2 . (variable-pitch regular 1.7))
          (3 . (variable-pitch regular 1.6))
          (4 . (variable-pitch regular 1.5))
          (5 . (variable-pitch 1.4))
          (6 . (variable-pitch 1.3))
          (7 . (variable-pitch 1.2))
          (8 . (variable-pitch 1.1))
          (t . (variable-pitch 1.1))))
  (setq ef-themes-region '(intense no-extend neutral)))
#+end_src

è‡ªåŠ¨åˆ‡æ¢æ·±æµ…ä¸»é¢˜:

#+begin_src emacs-lisp
(defun my/load-theme (appearance)
  (interactive)
  (pcase appearance
    ('light (load-theme 'ef-light t))
    ('dark (load-theme 'ef-elea-dark t))))
(add-hook 'ns-system-appearance-change-functions 'my/load-theme)
(add-hook 'after-init-hook (lambda () (my/load-theme ns-system-appearance)))
#+end_src

tab-barï¼š

#+begin_src emacs-lisp
(use-package tab-bar
  :custom
  (tab-bar-close-button-show nil)
  (tab-bar-new-button-show nil)
  (tab-bar-history-limit 20)
  (tab-bar-new-tab-choice "*dashboard*")
  (tab-bar-show 1)
  ;; ä½¿ç”¨ super + N åˆ‡æ¢ tabã€‚
  (tab-bar-select-tab-modifiers "super")
  :config
  ;; å»æ‰æœ€å·¦ä¾§çš„ < å’Œ > ã€‚
  (setq tab-bar-format '(tab-bar-format-tabs tab-bar-separator))
  ;; å¼€å¯ tar-bar history mode åæ‰æ”¯æŒ history-back/forward å‘½ä»¤ã€‚
  (tab-bar-history-mode t)
  (global-set-key (kbd "s-f") 'tab-bar-history-forward)
  (global-set-key (kbd "s-b") 'tab-bar-history-back)
  (global-set-key (kbd "s-t") 'tab-bar-new-tab)
  (keymap-global-set "s-n" 'tab-bar-switch-to-next-tab)
  (keymap-global-set "s-p" 'tab-bar-switch-to-prev-tab)
  (keymap-global-set "s-w" 'tab-bar-close-tab)

  ;; ä¸º tab æ·»åŠ åºå·ï¼Œç”¨äºå¿«é€Ÿåˆ‡æ¢ã€‚
  (defvar ct/circle-numbers-alist
    '((0 . "â“ª")
      (1 . "â‘ ")
      (2 . "â‘¡")
      (3 . "â‘¢")
      (4 . "â‘£")
      (5 . "â‘¤")
      (6 . "â‘¥")
      (7 . "â‘¦")
      (8 . "â‘§")
      (9 . "â‘¨"))
    "Alist of integers to strings of circled unicode numbers.")
  (setq tab-bar-tab-hints t)
  (defun ct/tab-bar-tab-name-format-default (tab i)
    (let ((current-p (eq (car tab) 'current-tab))
          (tab-num (if (and tab-bar-tab-hints (< i 10))
                       (alist-get i ct/circle-numbers-alist) "")))
      (propertize
       (concat tab-num
               " "
               (alist-get 'name tab)
               (or (and tab-bar-close-button-show
                        (not (eq tab-bar-close-button-show
                                 (if current-p 'non-selected 'selected)))
                        tab-bar-close-button)
                   "")
               " ")
       'face (funcall tab-bar-tab-face-function tab))))
  (setq tab-bar-tab-name-format-function #'ct/tab-bar-tab-name-format-default)

  (global-set-key (kbd "s-1") 'tab-bar-select-tab)
  (global-set-key (kbd "s-2") 'tab-bar-select-tab)
  (global-set-key (kbd "s-3") 'tab-bar-select-tab)
  (global-set-key (kbd "s-4") 'tab-bar-select-tab)
  (global-set-key (kbd "s-5") 'tab-bar-select-tab)
  (global-set-key (kbd "s-6") 'tab-bar-select-tab)
  (global-set-key (kbd "s-7") 'tab-bar-select-tab)
  (global-set-key (kbd "s-8") 'tab-bar-select-tab)
  (global-set-key (kbd "s-9") 'tab-bar-select-tab))
#+end_src

* è¾“å…¥æ³•

ä½¿ç”¨ ~RIME~ è¾“å…¥æ³• + ~iDevel/rime-ice~ é›¾å‡‡æ‹¼éŸ³è¾“å…¥æ³•æ–¹æ¡ˆã€‚

å®‰è£… ~RIME~ è¾“å…¥æ³•åç«¯å¼•æ“ [[https://github.com/rime/librime/releases][librime]] ï¼š ~emacs-rime~ ç›´æ¥å’Œè¯¥å¼•æ“æ‰“äº¤é“ï¼Œä¸éœ€è¦å®‰è£…å‰ç«¯ç¨‹åº
"é¼ é¡»ç®¡squirrel"ã€‚

#+begin_src bash :tangle ~/.emacs.d/init.sh
wget https://github.com/rime/librime/releases/download/1.11.2/rime-5b09f35-macOS-universal.tar.bz2
tar -xvf rime-5b09f35-macOS-universal.tar.bz2
mv ~/.emacs.d/librime/dist{,.bak}
mv dist ~/.emacs.d/librime
# å¦‚æœ MacOS Gatekeeper é˜»æ­¢ç¬¬ä¸‰æ–¹è½¯ä»¶è¿è¡Œï¼Œå¯ä»¥æš‚æ—¶å…³é—­å®ƒï¼š
sudo spctl --master-disable
# åç»­å†å¼€å¯ï¼šsudo spctl --master-enable
#+end_src

ä¸‹è½½ [[https://github.com/iDvel/rime-ice.git][iDvel/rime-ice]] é›¾å‡‡æ‹¼éŸ³è¾“å…¥æ³•æ–¹æ¡ˆï¼š

#+begin_src bash :tangle ~/.emacs.d/init.sh
mv ~/Library/Rime ~/Library/Rime.bak
git clone https://github.com/iDvel/rime-ice --depth=1
mv rime-ice ~/Library/Rime
# åç»­å¯ä»¥ git pull æ›´æ–° rime-iceã€‚
cd ~/Library/Rime
# è‡ªå®šä¹‰è¯é¢‘æ–‡ä»¶
cp custom_phrase.txt  opsnull_custom_phrase.txt
# ä¿®æ”¹å…¶ä¸­çš„ db_name
sed -i -e 's/custom_phrase.txt/opsnull_custom_phrase/g' opsnull_custom_phrase.txt
#+end_src

rime_ice æ‹¼éŸ³æ–¹æ¡ˆè°ƒæ•´(å¦‚æ¨¡ç³ŠéŸ³ï¼ŒåŠ¨æ€è¯é¢‘ï¼Œè‡ªå®šä¹‰è¯è¯­æ–‡ä»¶ç­‰):
+ è‡ªå®šä¹‰çŸ­è¯­ï¼šå‘è‡ªå®šä¹‰çŸ­è¯­è¯å…¸æ–‡ä»¶ =opsnull_custom_phrase.txt= æ·»åŠ è‡ªå®šä¹‰çŸ­è¯­ï¼Œ
  custom_prase/db_class ä¸º stabledbï¼Œæ˜¯åªè¯»çš„ï¼Œä¸ä¼šåŠ¨æ€è°ƒé¢‘ã€‚ï¼ˆå¯ä»¥è®¾ç½®ä¸º tabledb æ¥
  åŠ¨æ€è°ƒé¢‘ï¼‰ã€‚
+ é¦–æ¬¡æ·»åŠ è¯¥æ–‡ä»¶åéœ€è¦æ‰§è¡Œ =M-x rime-deploy= å’Œ =M-x rime-sync= ç”Ÿæ•ˆã€‚

#+begin_src yaml :tangle ~/Library/Rime/rime_ice.custom.yaml
patch:
  switches:
  - name: ascii_mode
    states: [ ä¸­, ï¼¡ ]
  - name: ascii_punct  # ä¸­è‹±æ ‡ç‚¹
    states: [ Â¥, $ ]
  # ä¸‹é¢è¿™äº›å¼€å…³ä¸€èˆ¬ç”¨ä¸åˆ°, æ•…å…³é—­(å¦‚å€™é€‰è¯ä¸­ä¸å†æ˜¾ç¤º emoji).
  # - name: traditionalization
  #   states: [ ç®€, ç¹ ]
  #   reset: 0
  # - name: emoji
  #   states: [ ğŸ’€, ğŸ˜„ ]
  #   reset: 1
  # - name: full_shape
  #   states: [ åŠè§’, å…¨è§’ ]
  #   reset: 0
  # - name: search_single_char  # search.lua çš„åŠŸèƒ½å¼€å…³ï¼Œè¾…ç æŸ¥è¯æ—¶æ˜¯å¦å•å­—ä¼˜å…ˆ
  #   abbrev: [è¯, å•]
  #   states: [æ­£å¸¸, å•å­—]
  #   reset: 0

  translator/spelling_hints: 0           # ä¸æ˜¾ç¤ºå€™é€‰è¯çš„æ‹¼éŸ³ã€‚
  translator/always_show_comments: false #ä¸æ˜¾ç¤ºå€™é€‰è€…çš„æ‹¼éŸ³ã€‚
  translator/enable_user_dict: true      # æ ¹æ®ä¸Šå±è‡ªåŠ¨è°ƒæ•´è¯é¢‘, å¦åˆ™æ ¹æ® *.dict.yaml ä¸­çš„é™æ€å®šä¹‰çš„è¯é¢‘ç‡ã€‚
  custom_phrase/user_dict: "opsnull_custom_phrase"  # è‡ªå®šä¹‰çŸ­è¯­è¯å…¸æ–‡ä»¶ï¼Œæƒé‡æœ€é«˜ã€‚

  speller/algebra:
  # æ¨¡ç³Šæ‹¼éŸ³
  # å£°æ¯
  - derive/^([zcs])h/$1/          # z c s â†’ zh ch sh
  - derive/^([zcs])([^h])/$1h$2/  # zh ch sh â†’ z c s
  #- derive/^l/n/  # n â†’ l
  #- derive/^n/l/  # l â†’ n
  # éŸµæ¯
  - derive/eng$/en/
  - derive/en$/eng/
  - derive/in/ing/
  - derive/ing/in/

  # è‡ªåŠ¨çº é”™(åè€…ç”¨å‰è€…æ›¿æ¢)
  # ai
  - derive/^([wghk])ai$/$1ia/  # wia â†’ wai
  # ei
  - derive/([wfghkz])ei$/$1ie/  # wie â†’ wei
  # ie
  - derive/([jqx])ie$/$1ei/  # jei â†’ jie
#+end_src

Rime è¾“å…¥æ³•å…¨å±€é…ç½®ï¼Œè¯¦ç»†å‚è€ƒ [[https://github.com/iDvel/rime-ice/blob/main/default.yaml][iDvel/rime-ice]]
#+begin_src yaml :tangle ~/Library/Rime/default.custom.yaml
patch:
  schema_list:
  - schema: rime_ice  # åªå¯ç”¨ rime_ice é›¾å‡‡æ‹¼éŸ³è¾“å…¥æ³•æ–¹æ¡ˆã€‚
  menu/page_size: 9   # æ˜¾ç¤º 9 ä¸ªå€™é€‰è¯ã€‚
  # æ–¹æ¡ˆé€‰å•åˆ‡æ¢
  switcher/hotkeys:
  - F4
  - "Control+plus" # æŒ‰ C-Shit-+ è°ƒå‡ºæ–¹æ¡ˆé€‰å•ã€‚
  switcher/fold_options: false # å‘¼å‡ºæ—¶ä¸æŠ˜å ã€‚
  switcher/abbreviate_options: false # æŠ˜å æ—¶ä¸ç¼©å†™é€‰é¡¹
  ascii_composer: # ä¸­è‹±æ–‡åˆ‡æ¢
    switch_key:   # å…³é—­å·¦è¾¹ Shift ä¸­è¥¿æ–‡åˆ‡æ¢ï¼Œè€Œæ˜¯ä½¿ç”¨å³ä¾§ Shiftï¼ˆé¿å…é¢‘ç¹è¯¯æŒ‰ï¼‰ã€‚
      Shift_L: noop
      Shift_R: commit_code
  key_binder/bindings:
  - { when: has_menu, accept: equal, send: Page_Down }             # ä¸‹ä¸€é¡µ
  - { when: paging, accept: minus, send: Page_Up }                 # ä¸Šä¸€é¡µ
  - { when: always, accept: "Control+period", toggle: ascii_mode}  # ä¸­è‹±æ–‡åˆ‡æ¢
  - { when: always, accept: "Control+comma", toggle: ascii_punct}  # ä¸­è‹±æ–‡æ ‡ç‚¹åˆ‡æ¢
  #- { when: always, accept: "Control+comma", toggle: full_shape}  # å…¨è§’/åŠè§’åˆ‡æ¢

  # å¼€å¯ emacs ç»‘å®šæƒ¯ä¾‹ï¼Œè¿™æ ·å¯ä»¥ä½¿ç”¨ C-x æ¥ä¿®æ­£æ‹¼éŸ³ã€‚éœ€è¦å°†è¿™äº›æŒ‰é”®åŠ åˆ°
  # rime-translate-keybindingså˜é‡é‡Œåæ‰ä¼šç”Ÿæ•ˆã€‚ composing æŒ‡çš„æ˜¯å‡ºç°å€™é€‰è¯åˆ—è¡¨çš„æ—¶æœºã€‚
  - { When: composing, accept: Control+p, send: Up }
  - { when: composing, accept: Control+n, send: Down }
  - { when: composing, accept: Control+b, send: Left }
  - { when: composing, accept: Control+f, send: Right }
  - { when: composing, accept: Control+a, send: Home }
  - { when: composing, accept: Control+e, send: End }
  - { when: composing, accept: Control+d, send: Delete }
  # ä»ç”¨æˆ·æ•°æ®åº“ä¸­åˆ é™¤è¯¯ä¸Šå±çš„è¯è¯­
  - { when: composing, accept: Control+k, send: Shift+Delete }
  - { when: composing, accept: Control+h, send: BackSpace }
  - { when: composing, accept: Control+g, send: Escape }
  - { when: composing, accept: Control+bracketleft, send: Escape }
  - { when: composing, accept: Control+y, send: Page_Up }
  - { when: composing, accept: Alt+v, send: Page_Up }
  - { when: composing, accept: Control+v, send: Page_Down }

# æ›´å¤šæŒ‰é”®åç§°å‚è€ƒ: https://github.com/LEOYoon-Tsaw/Rime_collections/blob/master/Rime_description.md
#+end_src

é…ç½® Emacs:
+ =rime-disable-predicates= å®šä¹‰äº†ä¸€ç»„æ–­è¨€å‡½æ•°ï¼Œå½“ä»»ä¸€å‡½æ•°æ–­è¨€æˆç«‹æ—¶ï¼ŒRime è‡ªåŠ¨å°†è¾“å…¥æ³•
  åˆ‡æ¢ä¸ºè‹±æ–‡ï¼ˆinlineã€ascii-inlineã€ascii-mode éƒ½æŒ‡çš„æ˜¯è‹±æ–‡ï¼‰ã€‚å¦‚æœåŒæ—¶å®šä¹‰äº†
  rime-inline-predicates å˜é‡ï¼Œåˆ™å½“è¿™ä¸¤ç»„å‡½æ•°éƒ½è‡³å°‘æœ‰ä¸€ä¸ªæ–­è¨€æˆç«‹æ—¶æ‰ä¼šåˆ‡æ¢ä¸ºè‹±æ–‡ã€‚
+ =rime-predicate-after-alphabet-char-p= å’Œ =rime-predicate-in-code-string-p= æ¡ä»¶éƒ½ä¼šå¯¼
  è‡´ä¸èƒ½æ­£ç¡®çš„ä¸­è‹±æ–‡æ··æ’ã€‚

#+begin_src emacs-lisp
(use-package rime
  :custom
  (rime-user-data-dir "~/Library/Rime/")
  (rime-librime-root "~/.emacs.d/librime/dist")
  (rime-emacs-module-header-root "/opt/homebrew/opt/emacs-plus@30/include")
  :hook
  (emacs-startup . (lambda () (setq default-input-method "rime")))
  :bind
  (
   :map rime-active-mode-map
   ;; åœ¨å·²ç»æ¿€æ´» Rime å€™é€‰èœå•æ—¶ï¼Œå¼ºåˆ¶åˆ‡æ¢åˆ°è‹±æ–‡ç›´åˆ°æŒ‰å›è½¦ã€‚
   ("M-j" . 'rime-inline-ascii)
   :map rime-mode-map
   ;; å¼ºåˆ¶åˆ‡æ¢åˆ°ä¸­æ–‡æ¨¡å¼.
   ("M-j" . 'rime-force-enable)
   ;; ä¸‹é¢è¿™äº›å¿«æ·é”®éœ€è¦å‘é€ç»™ rime æ¥å¤„ç†, éœ€è¦ä¸ default.custom.yaml æ–‡ä»¶ä¸­çš„
   ;; key_binder/bindingsé…ç½®ç›¸åŒ¹é…ã€‚
   ("C-." . 'rime-send-keybinding)      ;; ä¸­è‹±æ–‡åˆ‡æ¢
   ("C-+" . 'rime-send-keybinding)      ;; è¾“å…¥æ³•èœå•
   ("C-," . 'rime-send-keybinding)      ;; ä¸­è‹±æ–‡æ ‡ç‚¹åˆ‡æ¢
   ;;("C-," . 'rime-send-keybinding)    ;; å…¨åŠè§’åˆ‡æ¢
   )
  :config
  ;; åœ¨ modline é«˜äº®è¾“å…¥æ³•å›¾æ ‡, å¯ç”¨æ¥å¿«é€Ÿåˆ†è¾¨åˆ†ä¸­è‹±æ–‡è¾“å…¥çŠ¶æ€ã€‚
  (setq mode-line-mule-info '((:eval (rime-lighter))))
  ;; å°†å¦‚ä¸‹å¿«æ·é”®å‘é€ç»™ rimeï¼ŒåŒæ—¶éœ€è¦åœ¨ rime çš„ key_binder/bindings çš„éƒ¨åˆ†é…ç½®æ‰ä¼šç”Ÿ
  ;; æ•ˆã€‚
  (add-to-list 'rime-translate-keybindings "C-h") ;; åˆ é™¤æ‹¼éŸ³å­—ç¬¦
  (add-to-list 'rime-translate-keybindings "C-d")
  (add-to-list 'rime-translate-keybindings "C-k") ;; åˆ é™¤è¯¯ä¸Šå±çš„è¯è¯­
  (add-to-list 'rime-translate-keybindings "C-a") ;; è·³è½¬åˆ°ç¬¬ä¸€ä¸ªæ‹¼éŸ³å­—ç¬¦
  (add-to-list 'rime-translate-keybindings "C-e") ;; è·³è½¬åˆ°æœ€åä¸€ä¸ªæ‹¼éŸ³å­—ç¬¦support
  ;; shift-l, shift-r, control-l, control-r, åªæœ‰å½“ä½¿ç”¨ç³»ç»Ÿ RIME è¾“å…¥æ³•æ—¶æ‰æœ‰æ•ˆã€‚
  (setq rime-inline-ascii-trigger 'shift-r)
  ;; ä¸´æ—¶è‹±æ–‡æ¨¡å¼, è¯¥åˆ—è¡¨ä¸­ä»»ä½•ä¸€ä¸ªæ–­è¨€è¿”å› t æ—¶è‡ªåŠ¨åˆ‡æ¢åˆ°è‹±æ–‡ã€‚å¦‚æœ
  ;; rime-inline-predicates ä¸ä¸ºç©ºï¼Œåˆ™å½“å…¶ä¸­ä»»æ„ä¸€ä¸ªæ–­è¨€ä¹Ÿè¿”å› t æ—¶æ‰ä¼šè‡ªåŠ¨åˆ‡æ¢åˆ°è‹±æ–‡
  ;; ï¼ˆinline ç­‰æ•ˆäº ascii-modeï¼‰ã€‚è‡ªå®šä¹‰ avy æ–­è¨€å‡½æ•°ã€‚
  (defun rime-predicate-avy-p () (bound-and-true-p avy-command))
  (setq rime-disable-predicates
        '(rime-predicate-ace-window-p
          rime-predicate-hydra-p
          ;;rime-predicate-current-uppercase-letter-p
          ;; åœ¨ä¸Šä¸€ä¸ªå­—ç¬¦æ˜¯è‹±æ–‡æ—¶æ‰è‡ªåŠ¨åˆ‡æ¢åˆ°è‹±æ–‡ï¼Œé€‚åˆå­—ç¬¦ä¸²ä¸­ä¸­è‹±æ–‡æ··åˆçš„æƒ…å†µã€‚
          ;;rime-predicate-in-code-string-after-ascii-p
          ;; ä»£ç å—å†…ä¸èƒ½è¾“å…¥ä¸­æ–‡, ä½†æ³¨é‡Šå’Œå­—ç¬¦ä¸²ä¸å—å½±å“ã€‚
          ;;rime-predicate-prog-in-code-p
          ;;rime-predicate-avy-p
          ))
  (setq rime-show-candidate 'posframe)
  (setq default-input-method "rime")

  (setq rime-posframe-properties
        (list :background-color "#333333"
              :foreground-color "#dcdccc"
              :internal-border-width 2))

  ;; éƒ¨åˆ† mode å…³é—­ RIME è¾“å…¥æ³•ã€‚
  (defadvice switch-to-buffer (after activate-input-method activate)
    (if (or (string-match "vterm-mode" (symbol-name major-mode))
            (string-match "dired-mode" (symbol-name major-mode))
            (string-match "image-mode" (symbol-name major-mode))
            (string-match "compilation-mode" (symbol-name major-mode))
            (string-match "isearch-mode" (symbol-name major-mode))
            (string-match "minibuffer-mode" (symbol-name major-mode)))
        (activate-input-method nil)
      (activate-input-method "rime"))))
#+end_src

* è¡¥å…¨å’Œé¢„è§ˆ

æœ¬éƒ¨åˆ†ä½¿ç”¨çš„ä¸‰æ–¹åŒ…è¯´æ˜ï¼š
1. verticoï¼šminibuffer è¡¥å…¨ï¼›
2. corfuï¼šå…‰æ ‡å¤„è¡¥å…¨ï¼›
3. orderlessï¼šæä¾› flex/regex è¿‡æ»¤é£æ ¼ï¼›
4. consultï¼šå®æ—¶é¢„è§ˆå’Œé«˜çº§è¿‡æ»¤ï¼›
5. embarkï¼šä¸º minibuffer/buffer é€‰ä¸­çš„å†…å®¹æä¾›å¿«æ·æ“ä½œï¼›
6. marginaliaï¼šä¸ºå€™é€‰è€…æä¾›å…ƒæ•°æ®ï¼ˆå¦‚ dired é£æ ¼çš„æƒé™ã€ä¿®æ”¹æ—¶é—´ç­‰ï¼‰ï¼›

vertico æä¾› minibuffer è‡ªåŠ¨è¡¥å…¨ï¼ˆcorfu æä¾›å…‰æ ‡å¤„çš„è‡ªåŠ¨è¡¥å…¨ï¼‰, å¯ä»¥ä½¿ç”¨ orderless è¿‡æ»¤å€™é€‰è€…ï¼š
+ =C-] (abort-recursive-edit)= å…³é—­ minibuffer ç¼–è¾‘å’Œè¡¥å…¨çŠ¶æ€ã€‚
+ =M-RETï¼ˆvertico-exit-input)= é€€å‡ºè¾“å…¥å€™é€‰æ¨¡å¼ï¼Œç›´æ¥ä½¿ç”¨è¾“å…¥çš„å†…å®¹ï¼Œå¯ä»¥æ˜¯ file æˆ– buffer nameã€‚
+ =M-} (vertico-next-group)= é€‰æ‹©å€™é€‰è€…åˆ—è¡¨ä¸­çš„ä¸‹ä¸€ä¸ªåˆ†ç»„ï¼Œå¦‚ä¸åŒçš„ file æˆ– projectã€‚
+ =TAB (vertico-insert)= æ’å…¥å½“å‰é€‰ä¸­çš„å€™é€‰è€…ï¼›

#+begin_src emacs-lisp
(use-package vertico
  :config
  (setq vertico-count 15)
  (vertico-mode 1)
  (define-key vertico-map (kbd "<backspace>") #'vertico-directory-delete-char)
  (define-key vertico-map (kbd "RET") #'vertico-directory-enter))

(use-package emacs
  :init
  ;; minibuffer ä¸æ˜¾ç¤ºå…‰æ ‡ã€‚
  (setq minibuffer-prompt-properties '(read-only t cursor-intangible t face minibuffer-prompt))
  (add-hook 'minibuffer-setup-hook #'cursor-intangible-mode)
  ;; M-x åªæ˜¾ç¤ºå½“å‰ mode æ”¯æŒçš„å‘½ä»¤ã€‚
  (setq read-extended-command-predicate #'command-completion-default-include-p)
  ;; å¼€å¯ minibuffer é€’å½’ç¼–è¾‘ã€‚
  (setq enable-recursive-minibuffers t))
#+end_src

corf åœ¨å…‰æ ‡å¤„æ˜¾ç¤ºå€™é€‰åˆ—è¡¨å’Œæ–‡æ¡£, å¯ä»¥ä½¿ç”¨ orderless æ¥è¿‡æ»¤å€™é€‰è€…ï¼š

#+begin_src emacs-lisp
(use-package corfu
  :init
  (global-corfu-mode 1)
  (corfu-popupinfo-mode 1) ;; æ˜¾ç¤ºå€™é€‰è€…æ–‡æ¡£ã€‚
  :bind
  ;; æ»šåŠ¨æ˜¾ç¤º corfu-popupinfo å†…å®¹çš„å¿«æ·é”®ã€‚
  (:map corfu-popupinfo-map
        ("C-M-j" . corfu-popupinfo-scroll-up)
        ("C-M-k" . corfu-popupinfo-scroll-down))
  :custom
  (corfu-cycle t)                ;; è‡ªåŠ¨è½®è½¬ã€‚
  (corfu-auto t)                 ;; è‡ªåŠ¨è¡¥å…¨(ä¸éœ€è¦æŒ‰ TAB)ã€‚
  (corfu-auto-prefix 2)          ;; è§¦å‘è‡ªåŠ¨è¡¥å…¨çš„å‰ç¼€é•¿åº¦ã€‚
  (corfu-auto-delay 0.1)         ;; è§¦å‘è‡ªåŠ¨è¡¥å…¨çš„å»¶è¿Ÿ, å½“æ»¡è¶³å‰ç¼€é•¿åº¦æˆ–å»¶è¿Ÿæ—¶, éƒ½ä¼šè‡ªåŠ¨è¡¥å…¨ã€‚
  (corfu-separator ?\s)          ;; ä½¿ç”¨ Orderless è¿‡æ»¤åˆ†éš”ç¬¦ã€‚
  (corfu-preselect 'prompt)      ;; Preselect the prompt
  (corfu-scroll-margin 5)
  (corfu-on-exact-match nil)     ;; é»˜è®¤ä¸é€‰ä¸­å€™é€‰è€…(å³ä½¿åªæœ‰ä¸€ä¸ª)ã€‚
  (corfu-popupinfo-delay '(0.1 . 0.2)) ;; å€™é€‰è€…å¸®åŠ©æ–‡æ¡£æ˜¾ç¤ºå»¶è¿Ÿã€‚
  (corfu-popupinfo-max-width 80)
  (corfu-popupinfo-max-height 50)
  (corfu-popupinfo-direction '(force-right)) ;; å¼ºåˆ¶åœ¨å³ä¾§æ˜¾ç¤ºæ–‡æ¡£ã€‚
  :config
  (defun corfu-enable-always-in-minibuffer ()
    (setq-local corfu-auto nil)
    (corfu-mode 1))
  (add-hook 'minibuffer-setup-hook #'corfu-enable-always-in-minibuffer 1)

  ;; corfu æ”¯æŒ eshell çš„ pcomplete è‡ªåŠ¨è¡¥å…¨ã€‚
  (add-hook 'eshell-mode-hook
            (lambda ()
              (setq-local corfu-auto nil)
              (corfu-mode))))

;; è®°å½• minibuffer å’Œ corfu è¡¥å…¨å†å²ï¼Œåç»­æ˜¾ç¤ºå€™é€‰è€…æ—¶æŒ‰ç…§é¢‘ç‡æ’åºã€‚
(use-package savehist
  :hook (after-init . savehist-mode)
  :config
  (setq history-length 100)
  (setq savehist-save-minibuffer-history t)
  (setq savehist-autosave-interval 300)
  (add-to-list 'savehist-additional-variables #'corfu-history)
  (add-to-list 'savehist-additional-variables 'mark-ring)
  (add-to-list 'savehist-additional-variables 'global-mark-ring)
  (add-to-list 'savehist-additional-variables 'extended-command-history))

(use-package emacs
  :init
  ;; æ€»æ˜¯åœ¨å¼¹å‡ºèœå•ä¸­æ˜¾ç¤ºå€™é€‰è€…ã€‚
  (setq completion-cycle-threshold nil)
  ;; ä½¿ç”¨ TAB æ¥ indentation + completion(completion-at-point é»˜è®¤æ˜¯ M-TAB) ã€‚
  (setq tab-always-indent 'complete))
#+end_src

orderless è¡¥å…¨é£æ ¼ï¼šä½¿ç”¨ç©ºæ ¼åˆ†å‰²ä¸€ä¸ªæˆ–å¤šä¸ªåŒ¹é…æ¨¡å¼ï¼Œæ¨¡å¼æ— é¡ºåºï¼Œæ˜¯ AND å…³ç³»ã€‚

orderless é»˜è®¤ä½¿ç”¨ =orderless-matching-styles= å˜é‡é…ç½®çš„ =æ­£åˆ™å’Œå­—é¢é‡= åŒ¹é…æ–¹å¼ï¼Œé€šè¿‡ç»™å„æ¨¡å¼æŒ‡å®šå‰
ç¼€æˆ–åç¼€å­—ç¬¦, ä¹Ÿå¯ä»¥çµæ´»æŒ‡å®šå…¶å®ƒåŒ¹é…æ¨¡å¼:
+ ~=~ : =orderless-literal=, å­—é¢é‡åŒ¹é…;
+ ~~~ : =orderless-flex=, æ¨¡ç³ŠåŒ¹é…ï¼Œå¦‚ abc å®é™…å¯¹åº”æ­£åˆ™ a.*b.*c;
+ ~^~ : =orderless-literal-prefix= ï¼Œå‰ç¼€åŒ¹é…ï¼›
+ ~&~ : =orderless-annotation= ï¼Œä½¿ç”¨ marginalia ç­‰æä¾›çš„ meta ä¿¡æ¯æ¥è¿‡æ»¤ï¼›
+ ~,~ : =orderless-initialism=, é¦–å­—æ¯ç¼©å†™ï¼Œå¦‚ ,abc å®é™…å¯¹åº”æ­£åˆ™ \<a.*\<b.*\c;
+ ~!~ : makes the rest of the component match using =orderless-without-literal=, that is, both =!bad
  and bad!= will match strings that =do not contain the substring bad=.
+ ~%~ : makes the string match ignoring diacritics and similar inflections on characters (it uses
  the function =char-fold-to-regexp= to do this).

! åªèƒ½å¯¹ =å­—é¢é‡= åŒ¹é…å–åï¼ˆorderless-without-literal) ï¼Œå’Œå…¶ä»– dispatch å­—ç¬¦è¿ç”¨æ—¶, ! éœ€è¦å‰ç¼€å½¢å¼ï¼Œ
å¦‚ ~!=.go~ å°†ä¸åŒ¹é…å«æœ‰å­—é¢é‡ .go çš„å€™é€‰è€…ã€‚

#+begin_src  emacs-lisp
(use-package orderless
  :demand t
  :config
  ;; https://github.com/minad/consult/wiki#minads-orderless-configuration
  (defun +orderless--consult-suffix ()
    "Regexp which matches the end of string with Consult tofu support."
    (if (and (boundp 'consult--tofu-char) (boundp 'consult--tofu-range))
        (format "[%c-%c]*$"
                consult--tofu-char
                (+ consult--tofu-char consult--tofu-range -1))
      "$"))

  ;; Recognizes the following patterns:
  ;; * .ext (file extension)
  ;; * regexp$ (regexp matching at end)
  (defun +orderless-consult-dispatch (word _index _total)
    (cond
     ;; Ensure that $ works with Consult commands, which add disambiguation suffixes
     ((string-suffix-p "$" word)
      `(orderless-regexp . ,(concat (substring word 0 -1) (+orderless--consult-suffix))))
     ;; File extensions
     ((and (or minibuffer-completing-file-name
               (derived-mode-p 'eshell-mode))
           (string-match-p "\\`\\.." word))
      `(orderless-regexp . ,(concat "\\." (substring word 1) (+orderless--consult-suffix))))))

  ;; åœ¨ orderless-affix-dispatch çš„åŸºç¡€ä¸Šæ·»åŠ ä¸Šé¢æ”¯æŒæ–‡ä»¶åæ‰©å±•å’Œæ­£åˆ™è¡¨è¾¾å¼çš„ dispatchersã€‚
  (setq orderless-style-dispatchers
        (list #'+orderless-consult-dispatch
              #'orderless-affix-dispatch))

  ;; è‡ªå®šä¹‰åä¸º +orderless-with-initialism çš„ orderless é£æ ¼ã€‚
  (orderless-define-completion-style +orderless-with-initialism
    (orderless-matching-styles '(orderless-initialism orderless-literal orderless-regexp)))

  ;; ä½¿ç”¨ orderless å’Œ Emacs åŸç”Ÿçš„ basic è¡¥å…¨é£æ ¼ï¼Œä½† orderless çš„ä¼˜å…ˆçº§æ›´é«˜ã€‚
  (setq completion-styles '(orderless basic))
  (setq completion-category-defaults nil)

  ;; è®¾ç½® Emacs minibuffer å„ category ä½¿ç”¨çš„è¡¥å…¨é£æ ¼ã€‚
  (setq completion-category-overrides
        '(
          ;; buffer name è¡¥å…¨
          ;;(buffer (styles +orderless-with-initialism))

          ;; æ–‡ä»¶åå’Œè·¯å¾„è¡¥å…¨, partial-completion æä¾›äº† wildcard æ”¯æŒã€‚
          (file (styles partial-completion))
          (command (styles +orderless-with-initialism))
          (variable (styles +orderless-with-initialism))
          (symbol (styles +orderless-with-initialism))

          ;; eglot will change the completion-category-defaults to flex, BAD!
          ;; https://github.com/minad/corfu/issues/136#issuecomment-eglot
          ;; ä½¿ç”¨ M-SPC æ¥åˆ†éš”å…‰æ ‡å¤„çš„å¤šä¸ªç­›é€‰æ¡ä»¶ã€‚
          (eglot (styles . (orderless basic)))
          (eglot-capf (styles . (orderless basic)))
          ))

  ;; ä½¿ç”¨ SPACE æ¥åˆ†å‰²è¿‡æ»¤å­—ç¬¦ä¸²ã€‚
  (setq orderless-component-separator #'orderless-escapable-split-on-space))
#+end_src
+ partial-completion æ”¯æŒ shell wildcards å’Œéƒ¨åˆ†æ–‡ä»¶è·¯å¾„ï¼Œå¦‚ /u/s/l å¯¹åº” /usr/share/local;
+ å·²çŸ¥çš„ [[https://gitlab.com/protesilaos/dotfiles/-/blob/master/emacs/.emacs.d/prot-emacs-modules/prot-emacs-completion-common.el#L60][completion categories]];

åœ¨å¤šä¸ªè¿‡æ»¤æ¨¡å¼é—´æ’å…¥åˆ†éš”ç¬¦ï¼š
+ å¯¹äº buffer ä¸­å…‰æ ‡å¤„çš„è¿ç»­è¾“å…¥, ä½¿ç”¨ =M-SPC(corfu-insert-separator)= æ’å…¥ orderless åˆ†éš”ç¬¦ï¼›
+ å¯¹äº minibuffer åŒºåŸŸçš„è¡¥å…¨, ä½¿ç”¨ =SPC= (orderless é»˜è®¤çš„åˆ†éš”ç¬¦) åˆ†å‰²å¤šä¸ªè¿‡æ»¤æ¡ä»¶ï¼Œå¦‚æœè¦æ’å…¥ SPC
  æœ¬èº«ï¼Œéœ€è¦ä½¿ç”¨ \ è½¬ä¹‰ï¼Œå¦‚ =results\ no=.

consultï¼šæä¾›å€™é€‰è€…å®æ—¶è¿‡æ»¤å’Œé¢„è§ˆç­‰åŠŸèƒ½ï¼š

#+begin_src emacs-lisp
(use-package consult
  :hook
  (completion-list-mode . consult-preview-at-point-mode)
  :init
  ;; å¦‚æœæœç´¢å­—ç¬¦å°‘äº 3ï¼Œå¯ä»¥æ·»åŠ åç¼€ # å¼€å§‹æœç´¢ï¼Œå¦‚ #gr#ã€‚
  (setq consult-async-min-input 3)
  ;; ä»å¤´å¼€å§‹æœç´¢ï¼ˆè€Œéå‰ä½ç½®ï¼‰ã€‚
  (setq consult-line-start-from-top t)
  ;; å¯„å­˜å™¨é¢„è§ˆã€‚
  (setq register-preview-function #'consult-register-format)
  (advice-add #'register-preview :override #'consult-register-window)
  :config
  ;; ä¸æœç´¢ go vendor ç›®å½•ã€‚
  (setq consult-ripgrep-args (concat consult-ripgrep-args " -g !vendor/"))
  ;; æŒ‰ C-l æ‰æ¿€æ´»é¢„è§ˆï¼Œå¦åˆ™ Buffer åˆ—è¡¨ä¸­æœ‰å¤§æ–‡ä»¶æˆ–è¿œç¨‹æ–‡ä»¶æ—¶ä¼šå¡ä½ã€‚
  (setq consult-preview-key "C-l")
  ;; ä¸å¯¹ consult-line ç»“æœè¿›è¡Œæ’åºï¼ˆæŒ‰è¡Œå·æ’åºï¼‰ã€‚
  (consult-customize consult-line :prompt "Search: " :sort nil)
  ;; Buffer åˆ—è¡¨ä¸­ä¸æ˜¾ç¤ºçš„ Buffer åç§°ã€‚
  (mapcar
   (lambda (pattern) (add-to-list 'consult-buffer-filter pattern))
   '("\\*scratch\\*"
     "\\*Warnings\\*"
     "\\*helpful.*"
     "\\*Help\\*"
     "\\*Org Src.*"
     "Pfuture-Callback.*"
     "\\*epc con"
     "\\*dashboard"
     "\\*Ibuffer"
     "\\*sort-tab"
     "\\*Google Translate\\*"
     "\\*straight-process\\*"
     "\\*Native-compile-Log\\*"
     "\\*EGLOT"
     "[0-9]+.gpg")))

;; æ‰§è¡Œ consult-line å‘½ä»¤æ—¶è‡ªåŠ¨å±•å¼€ org å†…å®¹ã€‚
;; https://github.com/minad/consult/issues/563#issuecomment-1186612641
(defun my/org-show-entry (fn &rest args)
  (interactive)
  (when-let ((pos (apply fn args)))
    (when (derived-mode-p 'org-mode)
      (org-fold-show-entry))))
(advice-add 'consult-line :around #'my/org-show-entry)

;; æ˜¾ç¤º mode ç›¸å…³çš„å‘½ä»¤ã€‚
(global-set-key (kbd "C-c M-x") #'consult-mode-command)

;; æœç´¢ Emacs å„ package/mode çš„ info å’Œ man æ–‡æ¡£ã€‚
(global-set-key (kbd "C-c i") #'consult-info)
(global-set-key (kbd "C-c m") #'consult-man)

;; ä½¿ç”¨ savehist æŒä¹…åŒ–ä¿å­˜çš„ minibuffer å†å²ã€‚
(global-set-key (kbd "C-M-;") #'consult-complex-command)

;; consult-buffer æ˜¾ç¤ºçš„ File åˆ—è¡¨æ¥æºäºå˜é‡ recentf-listã€‚
(global-set-key (kbd "C-x b") #'consult-buffer)
(global-set-key (kbd "C-x 4 b") #'consult-buffer-other-window)
(global-set-key (kbd "C-x 5 b") #'consult-buffer-other-frame)
(global-set-key (kbd "C-x r b") #'consult-bookmark)
(global-set-key (kbd "C-x p b") #'consult-project-buffer)

(global-set-key (kbd "M-y") #'consult-yank-pop)
(global-set-key (kbd "M-Y") #'consult-yank-from-kill-ring)

(global-set-key (kbd "M-g g") #'consult-goto-line)
(global-set-key (kbd "M-g o") #'consult-outline)

;; å¯„å­˜å™¨ï¼Œä¿å­˜ pointã€fileã€windowã€frame çš„ä½ç½®ã€‚
(global-set-key (kbd "C-'") #'consult-register-store)
(global-set-key (kbd "C-M-'") #'consult-register)

;; æ˜¾ç¤ºç¼–è¯‘é”™è¯¯åˆ—è¡¨ã€‚
(global-set-key (kbd "M-g e") #'consult-compile-error)
;; æ˜¾ç¤º flymake è¯Šæ–­é”™è¯¯åˆ—è¡¨ã€‚
(global-set-key (kbd "M-g f") #'consult-flymake)

;; consult-buffer é»˜è®¤å·²åŒ…å« recent fileã€‚
;;(global-set-key (kbd "M-g r") #'consult-recent-file)

(global-set-key (kbd "M-g m") #'consult-mark)
(global-set-key (kbd "M-g k") #'consult-global-mark)

;; é¢„è§ˆå½“å‰ buffer çš„ imenuã€‚
(global-set-key (kbd "M-g i") #'consult-imenu)
;; é¢„è§ˆå½“å‰ project æ‰“å¼€çš„æ‰€æœ‰ buffer çš„ imenuã€‚
(global-set-key (kbd "M-g I") #'consult-imenu-multi)

;; æœç´¢æ–‡ä»¶å†…å®¹ã€‚
(global-set-key (kbd "M-s g") #'consult-grep)
(global-set-key (kbd "M-s G") #'consult-git-grep)
(global-set-key (kbd "M-s r") #'consult-ripgrep)

;; æœç´¢æ–‡ä»¶åï¼ˆæ­£åˆ™åŒ¹é…ï¼‰ã€‚
(global-set-key (kbd "M-s d") #'consult-find)
(global-set-key (kbd "M-s D") #'consult-locate)

;; æœç´¢å½“å‰ buffer
(global-set-key (kbd "M-s l") #'consult-line)
(global-set-key (kbd "M-s M-l") #'consult-line)
;; æœç´¢å¤šä¸ª bufferï¼Œé»˜è®¤ä¸º project çš„å¤šä¸ª buffersã€‚
;; å¦‚æœä½¿ç”¨å‰ç¼€å‚æ•°ï¼Œåˆ™æœç´¢æ‰€æœ‰ buffersã€‚
(global-set-key (kbd "M-s L") #'consult-line-multi)

;; Isearch é›†æˆã€‚
(global-set-key (kbd "M-s e") #'consult-isearch-history)
;;:map isearch-mode-map
(define-key isearch-mode-map (kbd "M-e") #'consult-isearch-history)
(define-key isearch-mode-map (kbd "M-s e") #'consult-isearch-history)
(define-key isearch-mode-map (kbd "M-s l") #'consult-line)
(define-key isearch-mode-map (kbd "M-s L") #'consult-line-multi)

;; Minibuffer å†å²ã€‚
;;:map minibuffer-local-map)
(define-key minibuffer-local-map (kbd "M-s") #'consult-history)
(define-key minibuffer-local-map (kbd "M-r") #'consult-history)

;; ä½¿ç”¨ consult æ¥é¢„è§ˆ xref çš„å¼•ç”¨å®šä¹‰å’Œè·³è½¬ã€‚
(setq xref-show-xrefs-function #'consult-xref)
(setq xref-show-definitions-function #'consult-xref)

;; é™åˆ¶ xref history ä»…å±€é™äºå½“å‰çª—å£ï¼ˆé»˜è®¤å…¨å±€ï¼‰ã€‚
(setq xref-history-storage 'xref-window-local-history)

;; åœ¨å…¶å®ƒçª—å£æŸ¥çœ‹å®šä¹‰ã€‚
(global-set-key (kbd "C-M-.") 'xref-find-definitions-other-window)
#+end_src

embarkï¼š ä¸ºé€‰ä¸­çš„å†…å®¹æä¾›å¿«æ·æ“ä½œå‘½ä»¤ï¼š

#+begin_src emacs-lisp
(use-package embark
  :init
  ;; ä½¿ç”¨ C-h æ˜¾ç¤º key preifx ç»‘å®šã€‚
  (setq prefix-help-command #'embark-prefix-help-command)
  :config
  (setq embark-prompter 'embark-keymap-prompter)
  (global-set-key (kbd "C-;") #'embark-act) ;; embark-dwim
  ;; æ ¹æ®å½“å‰ buffer çš„ modeï¼Œæ˜¾ç¤ºå¯ä»¥ä½¿ç”¨çš„å¿«æ·é”®ã€‚
  (define-key global-map [remap describe-bindings] #'embark-bindings))

;; embark-consult æ”¯æŒ embark å’Œ consult é›†æˆï¼Œä½¿ç”¨ wgrep ç¼–è¾‘ consult grep/line çš„ export çš„ç»“æœã€‚
(use-package embark-consult
  :after (embark consult)
  :hook  (embark-collect-mode . consult-preview-at-point-mode))

;; ç¼–è¾‘ grep buffers, å¯ä»¥å’Œ consult-grep å’Œ embark-export è”åˆä½¿ç”¨ã€‚
(use-package wgrep
  :config
  ;; æ‰§è¡Œ wgre-finished-edit æ—¶ä¿å­˜æ‰€æœ‰ä¿®æ”¹çš„ bufferã€‚
  (setq wgrep-auto-save-buffer t)
  (setq wgrep-change-readonly-file t))
#+end_src

marginaliaï¼šä¸ºå€™é€‰è€…æä¾›å…ƒæ•°æ®ï¼ˆå¦‚ dired é£æ ¼çš„æƒé™ã€ä¿®æ”¹æ—¶é—´ç­‰ï¼‰ï¼š

#+begin_src  emacs-lisp
(use-package marginalia
  :init
  ;; æ˜¾ç¤ºç»å¯¹æ—¶é—´ã€‚
  (setq marginalia-max-relative-age 0)
  (marginalia-mode))
#+end_src

* org-mode

#+begin_src emacs-lisp
(use-package org
  :config
  (setq
   org-ellipsis "..." ;; " â­"

   ;; ä½¿ç”¨ UTF-8 æ˜¾ç¤º LaTeX æˆ– \xxx ç‰¹æ®Šå­—ç¬¦ï¼Œ M-x org-entities-help æŸ¥çœ‹æ‰€æœ‰ç‰¹æ®Šå­—ç¬¦ã€‚
   org-pretty-entities t
   org-highlight-latex-and-related '(latex)

   ;; åªæ˜¾ç¤ºè€Œä¸å¤„ç†å’Œè§£é‡Š latex æ ‡è®°ï¼Œä¾‹å¦‚ \xxx æˆ– \being{xxx}, é¿å… export pdf æ—¶å‡º
   ;; é”™ã€‚
   org-export-with-latex 'verbatim
   org-export-with-broken-links 'mark
   ;; export æ—¶ä¸å¤„ç† super/sub scripting, ç­‰æ•ˆäº #+OPTIONS: ^:nil ã€‚
   org-export-with-sub-superscripts nil
   org-export-default-language "zh-CN"
   org-export-coding-system 'utf-8

   ;; ä½¿ç”¨ R_{s} å½¢å¼çš„ä¸‹æ ‡ï¼ˆé»˜è®¤æ˜¯ R_s, å®¹æ˜“ä¸æ­£å¸¸å†…å®¹æ··æ·†) ã€‚
   org-use-sub-superscripts nil

   ;; æ–‡ä»¶é“¾æ¥ä½¿ç”¨ç›¸å¯¹è·¯å¾„, è§£å†³ hugo ç­‰ image å¼•ç”¨çš„é—®é¢˜ã€‚
   org-link-file-path-type 'relative
   org-html-validation-link nil
   ;; å…³é—­é¼ æ ‡ç‚¹å‡»é“¾æ¥ã€‚
   org-mouse-1-follows-link nil

   org-hide-emphasis-markers t
   org-hide-block-startup t
   org-hidden-keywords '(title)
   org-hide-leading-stars t

   org-cycle-separator-lines 2
   org-cycle-level-faces t
   org-n-level-faces 4
   org-indent-indentation-per-level 2

   ;; å†…å®¹ç¼©è¿›ä¸å¯¹åº” headerline ä¸€è‡´ã€‚
   org-adapt-indentation t
   org-list-indent-offset 2

   ;; ä»£ç å—ç¼©è¿›ã€‚
   org-src-preserve-indentation t
   org-edit-src-content-indentation 0

   ;; TODO çŠ¶æ€æ›´æ–°è®°å½•åˆ° LOGBOOK Drawer ä¸­ã€‚
   org-log-into-drawer t
   ;; TODO çŠ¶æ€æ›´æ–°æ—¶è®°å½• note.
   org-log-done 'note ;; note, time

   ;; ä¸æ˜¾ç¤ºå›¾ç‰‡ï¼ˆæ‰‹åŠ¨ç‚¹å‡»æ˜¾ç¤ºæ›´å®¹æ˜“æ§åˆ¶å¤§å°ï¼‰ã€‚
   org-startup-with-inline-images nil
   org-startup-folded 'content
   org-cycle-inline-images-display nil

   ;; å¦‚æœå¯¹ headline ç¼–å·åˆ™ latext è¾“å‡ºæ—¶ä¼šå¯¼è‡´ toc ç¼ºå¤±ï¼Œæ•…å…³é—­ã€‚
   org-startup-numerated nil
   org-startup-indented t

   ;; å…ˆä» #+ATTR.* è·å–å®½åº¦ï¼Œå¦‚æœæ²¡æœ‰è®¾ç½®åˆ™é»˜è®¤ä¸º 300 ã€‚
   org-image-actual-width '(300)

   ;; org-timer åˆ°æœŸæ—¶å‘é€å£°éŸ³æç¤ºã€‚
   org-clock-sound t
   ;; å…³é—­å®¹æ˜“è¯¯æŒ‰çš„ archive å‘½ä»¤ã€‚
   org-archive-default-command nil

   ;; ä¸è‡ªåŠ¨å¯¹é½ tagã€‚
   org-tags-column 0
   org-auto-align-tags nil

   ;; æ˜¾ç¤ºä¸å¯è§çš„ç¼–è¾‘ã€‚
   org-catch-invisible-edits 'show-and-error
   org-fold-catch-invisible-edits t

   ;; æ”¯æŒ ID property ä½œä¸º internal link target(é»˜è®¤æ˜¯ CUSTOM_ID property)
   org-id-link-to-org-use-id t
   org-M-RET-may-split-line nil

   ;; å…³é—­é¢‘ç¹å¼¹å‡ºçš„ org-element-cache è­¦å‘Š buffer ã€‚
   org-element-use-cache nil

   org-todo-keywords
   '((sequence "TODO(t!)" "DOING(d@)" "|" "DONE(D)")
     (sequence "WAITING(w@/!)" "NEXT(n!/!)" "SOMEDAY(S)" "|" "CANCELLED(c@/!)"))

   org-special-ctrl-a/e t
   org-insert-heading-respect-content t)

  ;;(add-hook 'org-mode-hook 'turn-on-auto-fill)
  (add-hook 'org-mode-hook (lambda () (display-line-numbers-mode 0))))

(global-set-key (kbd "C-c l") #'org-store-link)
(global-set-key (kbd "C-c a") #'org-agenda)
(global-set-key (kbd "C-c c") #'org-capture)
(global-set-key (kbd "C-c b") #'org-switchb)

;; å…³é—­ org-mode çš„ C-c C-j å¿«æ·é”®, ä¸ journal å†²çª.
(define-key org-mode-map (kbd "C-c C-j") nil)
;; å…³é—­ org-mode çš„ C-' å¯¹åº”çš„ org-cycle-agenda-files å‘½ä»¤, ä¸ consult-register-store
;; å†²çª.
(define-key org-mode-map (kbd "C-'") nil)

;; å…‰æ ‡ä½äº src block ä¸­æ‰§è¡Œ C-c C-f æ—¶è‡ªåŠ¨æ ¼å¼åŒ– block ä¸­ä»£ç ã€‚
(defun my/format-src-block ()
  "Formats the code in the current src block."
  (interactive)
  (org-edit-special)
  (indent-region (point-min) (point-max))
  (org-edit-src-exit))

(defun my/org-mode-keys ()
  "Modify keymaps used in org-mode."
  (let ((map (if (org-in-src-block-p)
                 org-src-mode-map
               org-mode-map)))
    (define-key map (kbd "C-c C-f") 'my/format-src-block)))
(add-hook 'org-mode-hook 'my/org-mode-keys)

;; å»ºç«‹ org ç›¸å…³ç›®å½•ã€‚
(dolist (dir '("~/docs/org" "~/docs/org/journal"))
  (unless (file-directory-p dir)
    (make-directory dir)))
#+end_SRC

é…ç½® babelï¼š

#+begin_src emacs-lisp
;; å…³é—­ C-c C-c è§¦å‘æ‰§è¡Œä»£ç .
(setq org-babel-no-eval-on-ctrl-c-ctrl-c t)

;; ç¡®è®¤æ‰§è¡Œä»£ç çš„æ“ä½œã€‚
(setq org-confirm-babel-evaluate t)

;; ä½¿ç”¨è¯­è¨€çš„ mode æ¥æ ¼å¼åŒ–ä»£ç .
(setq org-src-fontify-natively t)

;; ä½¿ç”¨å„è¯­è¨€çš„ Major Mode æ¥ç¼–è¾‘ src blockã€‚
(setq org-src-tab-acts-natively t)

;; yaml ä»å¤–éƒ¨çš„ yaml-mode åˆ‡æ¢åˆ°å†…ç½®çš„ yaml-ts-modeï¼Œå‘Šè¯‰ babel ä½¿ç”¨è¯¥å†…ç½® modeï¼Œå¦
;; åˆ™ç¼–è¾‘ yaml src block æ—¶æç¤ºæ‰¾ä¸åˆ° yaml-modeã€‚
(add-to-list 'org-src-lang-modes '("yaml" . yaml-ts))
(add-to-list 'org-src-lang-modes '("cue" . cue))

(require 'org)
;; org bable å®Œæ•´æ”¯æŒçš„è¯­è¨€åˆ—è¡¨ï¼ˆob- å¼€å¤´çš„æ–‡ä»¶ï¼‰ï¼š
;; https://git.savannah.gnu.org/cgit/emacs/org-mode.git/tree/lisp å¯¹äºå®˜æ–¹ä¸æ”¯æŒçš„è¯­
;; è¨€ï¼Œå¯ä»¥é€šè¿‡ use-pacakge æ¥å®‰è£…ã€‚
(use-package ob-go)
(use-package ob-rust)
(org-babel-do-load-languages
 'org-babel-load-languages
 '((shell . t)
   (js . t)
   (makefile . t)
   (go . t)
   (emacs-lisp . t)
   (rust . t)
   (python . t)
   (C . t) ;; æ”¯æŒ C/C++/D
   (java . t)
   (awk . t)
   (css . t)))

(use-package org-contrib)
#+end_src

org-mode å†…å®¹å±…ä¸­æ˜¾ç¤ºï¼š

#+begin_src emacs-lisp
(use-package olivetti
  :config
  ;; æ–‡æœ¬åŒºåŸŸå®½åº¦ï¼Œè¶…è¿‡åè‡ªåŠ¨æŠ˜è¡Œã€‚
  (setq-default olivetti-body-width 130)
  (add-hook 'org-mode-hook 'olivetti-mode))

;; fill-column å€¼è¦å°äº olivetti-body-width æ‰èƒ½æ­£å¸¸æŠ˜è¡Œã€‚
(setq-default fill-column 85)

;; ç”±äº auto-fill å¯èƒ½ä¼šæ‰“ä¹±ä»£ç çš„å­—ç¬¦ä¸²å’Œæ³¨é‡Šï¼Œæ•…ä¸º prog-mode/text-mode ç­‰å…¨å±€å…³é—­ auto-fillã€‚
;;(add-hook 'text-mode-hook 'turn-on-auto-fill)
#+end_src

org-modern å’Œ org-appear ç¾åŒ–ï¼š

#+begin_src emacs-lisp
(use-package org-modern
  :after (org)
  :config
  ;; å„ç§ç¬¦å·å­—ä½“ï¼šhttps://github.com/rime/rime-prelude/blob/master/symbols.yaml
  ;;(setq org-modern-star '("â—‰" "â—‹" "âœ¸" "âœ¿" "âœ¤" "âœœ" "â—†" "â–¶"))
  (setq org-modern-star '("âš€" "âš" "âš‚" "âšƒ" "âš„" "âš…"))
  (setq org-modern-block-fringe nil)
  (setq org-modern-block-name
        '((t . t)
          ("src" "Â»" "Â«")
          ("SRC" "Â»" "Â«")
          ("example" "Â»â€“" "â€“Â«")
          ("quote" "â" "â")))
  ;; ç¾åŒ–è¡¨æ ¼ã€‚
  (setq org-modern-table t)
  (setq org-modern-list
        '(
          (?* . "âœ¤")
          (?+ . "â–¶")
          (?- . "â—†")))
  (with-eval-after-load 'org (global-org-modern-mode)))

;; æ˜¾ç¤ºè½¬ä¹‰å­—ç¬¦ã€‚
(use-package org-appear
  :custom
  (org-appear-autolinks t)
  :hook (org-mode . org-appear-mode))
#+end_src

org-downloadï¼šæ‹–æ‹½å›¾ç‰‡æˆ–å°†å‰ªè´´æ¿ä¸­å›¾ç‰‡æ’å…¥åˆ° org-mode buffer ä¸­ï¼ˆä½¿ç”¨ pngpaste å‘½ä»¤ï¼‰:
+ éœ€è¦ç¼–è¯‘ Emacs æ—¶æŒ‡å®š =--with-imagemagick= å‚æ•°ï¼ŒEmacs ä½¿ç”¨ imagemagick å‘½ä»¤æ¥å®æ—¶è½¬
  æ¢å›¾ç‰‡å¤§å°ã€‚

#+begin_src emacs-lisp
(use-package org-download
  :config
  ;; ä¿å­˜è·¯å¾„åŒ…å« /static/ æ—¶, ox-hugo åœ¨å¯¼å‡ºæ—¶ä¿ç•™åé¢çš„ç›®å½•å±‚æ¬¡ã€‚
  (setq-default org-download-image-dir "./static/images/")
  (setq org-download-method 'directory
        org-download-display-inline-images 'posframe
        org-download-screenshot-method "pngpaste %s"
        org-download-image-attr-list '("#+ATTR_HTML: :width 400 :align center"))
  (add-hook 'dired-mode-hook 'org-download-enable)
  (org-download-enable)
  (global-set-key (kbd "<f6>") #'org-download-screenshot)
  ;; ä¸æ·»åŠ  #+DOWNLOADED: æ³¨é‡Šã€‚
  (setq org-download-annotate-function (lambda (link) (previous-line 1) "")))
#+end_src

tex å’Œ PDF å¯¼å‡ºï¼š

#+begin_src emacs-lisp
;; å°†å®‰è£…çš„ tex äºŒè¿›åˆ¶ç›®å½•æ·»åŠ åˆ° PATH ç¯å¢ƒå˜é‡å’Œ exec-path å˜é‡ä¸­ï¼Œ Emacs æ‰§è¡Œ
;; xelatex å‘½ä»¤æ—¶ä½¿ç”¨ã€‚
(setq my-tex-path "/Library/TeX/texbin")
(setenv "PATH" (concat my-tex-path ":" (getenv "PATH")))
(setq exec-path (cons my-tex-path  exec-path))

;; engrave-faces æ¯” minted æ¸²æŸ“é€Ÿåº¦æ›´å¿«ã€‚
(use-package engrave-faces
  :after ox-latex
  :config
  (require 'engrave-faces-latex)
  (setq org-latex-src-block-backend 'engraved)
  ;; ä»£ç å—å·¦ä¾§æ·»åŠ è¡Œå·ã€‚
  (add-to-list 'org-latex-engraved-options '("numbers" . "left"))
  ;; ä»£ç å—ä¸»é¢˜ã€‚
  (setq org-latex-engraved-theme 'ef-light))

(defun my/export-pdf (backend)
  (progn
    ;;(setq org-export-with-toc nil)
    (setq org-export-headline-levels 2))
  )
(add-hook 'org-export-before-processing-functions #'my/export-pdf)

;; ox- ä¸º org-mode çš„å¯¼å‡ºåç«¯åŒ…çš„æƒ¯ä¾‹å‰ç¼€ã€‚

;;(use-package ox-reveal) ;; reveal.js
(use-package ox-gfm :defer t) ;; github flavor markdown

(require 'ox-latex)
(with-eval-after-load 'ox-latex
  ;; latex image çš„é»˜è®¤å®½åº¦, å¯ä»¥é€šè¿‡ #+ATTR_LATEX :width xx é…ç½®ã€‚
  (setq org-latex-image-default-width "0.7\\linewidth")
  ;; ä½¿ç”¨ booktabs style æ¥æ˜¾ç¤ºè¡¨æ ¼ï¼Œä¾‹å¦‚æ”¯æŒéš”è¡Œé¢œè‰², è¿™æ · #+ATTR_LATEX: ä¸­ä¸éœ€è¦æ·»
  ;; åŠ  :booktabs tã€‚
  (setq org-latex-tables-booktabs t)
  ;; ä¸ä¿å­˜ LaTeX æ—¥å¿—æ–‡ä»¶ï¼ˆè°ƒè¯•æ—¶è®¾ç½®ä¸º nilï¼‰ã€‚
  (setq org-latex-remove-logfiles t)
  ;; ä½¿ç”¨æ”¯æŒä¸­æ–‡çš„ xelatexã€‚
  (setq org-latex-pdf-process '("latexmk -xelatex -quiet -shell-escape -f %f"))
  (add-to-list 'org-latex-classes
	       '("ctexart"
                 "\\documentclass[lang=cn,11pt,a4paper,table]{ctexart}
                    [NO-DEFAULT-PACKAGES]
                    [PACKAGES]
                    [EXTRA]"
                 ("\\section{%s}" . "\\section*{%s}")
                 ("\\subsection{%s}" . "\\subsection*{%s}")
                 ("\\subsubsection{%s}" . "\\subsubsection*{%s}")
                 ("\\paragraph{%s}" . "\\paragraph*{%s}")
                 ("\\subparagraph{%s}" . "\\subparagraph*{%s}"))))

;; org export html æ ¼å¼æ—¶éœ€è¦ htmlize.el åŒ…æ¥æ ¼å¼åŒ–ä»£ç ã€‚
(use-package htmlize)
#+end_src

è‡ªå®šä¹‰å¯¼å‡º PDF çš„ LaTeX æ ·å¼ mystyle.sty: å¯¹äºè¡¨æ ¼ï¼Œå¦‚æœåˆ—å†…å®¹è¿‡å®½åˆ™å¯¼å‡ºçš„ PDF ä¸­è¯¥åˆ—
çš„å†…å®¹ä¼šè¢«æˆªæ–­ï¼Œå¯ä»¥ä¸ºè¡¨æ ¼è®¾ç½®å¦‚ä¸‹å±æ€§ï¼Œå°†è¶…å®½åˆ— align è®¾ç½®ä¸º X æ¥è§£å†³ï¼š
: #+ATTR_LATEX: :environment tabularx :booktabs t :width \linewidth :align l|l|X

#+begin_src latex :tangle  ~/emacs/mystyle.sty
\usepackage{wallpaper} % æ˜¾ç¤ºå°é¢å›¾ç‰‡æˆ–é¡µé¢å›¾ç‰‡ã€‚

\usepackage{color}
\usepackage{xcolor}
\definecolor{winered}{rgb}{0.5,0,0}
\definecolor{lightgrey}{rgb}{0.9,0.9,0.9}
\definecolor{tableheadcolor}{gray}{0.92}
\definecolor{commentcolor}{RGB}{0,100,0}
\definecolor{frenchplum}{RGB}{190,20,83}

% æç¤º title
\usepackage[explicit]{titlesec}
% æ¯ä¸ª chapter å¦èµ·ä¸€é¡µ
\newcommand{\sectionbreak}{\clearpage}
\usepackage{titling}
\setlength{\droptitle}{-6em}

% è¶…é“¾æ¥å’Œä¹¦ç­¾
\usepackage[colorlinks]{hyperref}
\hypersetup{
  pdfborder={0 0 0},
  colorlinks=true,
  bookmarksopen=true,
  bookmarksnumbered=true, % ä¹¦ç­¾ç›®å½•æ˜¾ç¤ºç¼–å·ã€‚
  linkcolor={winered},
  urlcolor={winered},
  filecolor={winered},
  citecolor={winered},
  linktoc=all}

% å®‰è£… noto-cjk ä¸­æ–‡å­—ä½“: git clone https://github.com/googlefonts/noto-cjk.git
\usepackage{fontspec}
\usepackage[utf8x]{inputenc}
\setmainfont{Noto Serif SC}
\setsansfont{Noto Sans SC}[Scale=MatchLowercase]
\setmonofont{Noto Sans Mono CJK SC}[Scale=MatchLowercase]
\setCJKmainfont[BoldFont=Noto Serif SC]{Noto Serif SC}
\setCJKsansfont{Noto Sans SC}
\setCJKmonofont{Noto Sans Mono CJK SC}

\XeTeXlinebreaklocale "zh"
\XeTeXlinebreakskip = 0pt plus 1pt minus 0.1pt

% æ·»åŠ  email å‘½ä»¤ã€‚
\newcommand\email[1]{\href{mailto:#1}{\nolinkurl{#1}}}

% sidewaytable ä¾èµ– rotfloat
\usepackage {rotfloat}

% tabularx çš„ç‰¹æ®Š align å‚æ•° X ç”¨æ¥å¯¹æŒ‡å®šåˆ—å†…å®¹è‡ªåŠ¨æ¢è¡Œï¼Œå¦åˆ™è¯¥åˆ—å†…å®¹æœ‰å¯èƒ½è¢«æˆªæ–­ï¼Œ
% è§£å†³åŠæ³•æ˜¯ï¼šåœ¨ org-mode è¡¨æ ¼å‰éœ€è¦åŠ å¦‚ä¸‹å±æ€§ï¼š
% #+ATTR_LATEX: :environment tabularx :booktabs t :width \linewidth :align l|X
\usepackage{tabularx}
% ç¾åŒ–è¡¨æ ¼æ˜¾ç¤ºæ•ˆæœ
\usepackage{booktabs}
% è¡¨æ ¼éš”è¡Œé¢œè‰², {1} å¼€å§‹è¡Œ, {lightgrep} å¥‡æ•°è¡Œé¢œè‰², {} å¶æ•°è¡Œé¢œè‰²(ç©ºè¡¨ç¤ºç™½è‰²)
\rowcolors{1}{lightgrey}{}

\usepackage{parskip}
\setlength{\parskip}{1em}
\setlength{\parindent}{0pt}

\usepackage{etoolbox}
\usepackage{calc}

\usepackage[scale=0.85]{geometry}
%\setlength{\headsep}{5pt}

\usepackage{amsthm}
\usepackage{amsmath}
\usepackage{amssymb}
\usepackage{indentfirst}
\usepackage{multicol}
\usepackage{multirow}
\usepackage{linegoal}
\usepackage{graphicx}
\usepackage{fancyvrb}
\usepackage{abstract}
\usepackage{hologo}

\linespread{1}
\graphicspath{{image/}{figure/}{fig/}{img/}{images/}}

\usepackage[font=small,labelfont={bf}]{caption}
\captionsetup[table]{skip=3pt}
\captionsetup[figure]{skip=3pt}

% ä¸‹åˆ’çº¿ã€å¼ºè°ƒå’Œåˆ é™¤çº¿ç­‰
\usepackage[normalem]{ulem}
% åˆ—è¡¨
\usepackage[shortlabels,inline]{enumitem}
\setlist{nolistsep}
% xeCJK é»˜è®¤ä¼šæŠŠé»‘ç‚¹ç”¨æ±‰å­—æ˜¾ç¤ºï¼Œè€Œ Noto æ²¡æœ‰è¿™ä¸ªå­—ä½“ï¼Œæ‰€ä»¥æ˜¾ç¤ºæ•ˆæœä¸ºä¸€ä¸ªå°ç‚¹ã€‚è§£å†³åŠ
% æ³•æ˜¯å°†å®ƒè®¾ç½®ä¸º \bullet, è¿™æ ·æ˜¾ç¤ºä¸ºå®å¿ƒé»‘ç‚¹ã€‚Windows å¸¦çš„æ¥·ä½“ã€ä»¿å®‹æ²¡æœ‰è¿™ä¸ªé—®é¢˜ã€‚
\setlist[itemize]{label=$\bullet$}
% æˆ–è€…ï¼š
%\renewcommand\labelitemi{\ensuremath{\bullet}}
#+end_src

åˆ›å»ºä¸€ä¸ª tempel æ¨¡æ¿ï¼Œä¾¿äºåœ¨ org-mode æ–‡ä»¶ä¸­å¿«é€Ÿæ’å…¥å¯¼å‡º PDF çš„ tex é…ç½®å‚æ•°ï¼š
+ å¦‚æœç”Ÿæˆçš„ pdf ä¸æ˜¾ç¤ºç›®å½•ï¼Œæ£€æŸ¥æ–‡æ¡£ ~#+OPTIONS~ å‚æ•°ä¸­çš„ ~toc:nil~ å’Œ ~num: 2~ æ˜¯å¦ç”Ÿæ•ˆï¼›

#+begin_src emacs-lisp :tangle no
(my-latex "#+DATE: " (format-time-string "%Y-%m-%d %a") n
	  "#+SUBTITLE: å†…éƒ¨èµ„æ–™ï¼Œæ³¨æ„ä¿å¯†!
#+AUTHOR: å¼ ä¿Š(zj@opsnull.com)
# ä¸­æ–‡è¯­è¨€ç¯å¢ƒï¼ˆç›®å½•ç­‰ç”¨ä¸­æ–‡æ˜¾ç¤ºï¼‰ã€‚
#+LANGUAGE: zh-CN
# ä¸è‡ªåŠ¨è¾“å‡º titile å’Œ tocï¼Œåç»­ latext mystyle ä¸­å®šåˆ¶è¾“å‡ºã€‚
# ä½†æ˜¯éœ€è¦æ˜ç¡®é€šè¿‡ num æ§åˆ¶è¾“å‡ºçš„ç›®å½•çº§åˆ«ã€‚
#+OPTIONS: prop:t title:nil num:2 toc:nil ^:nil
#+LATEX_COMPILER: xelatex
#+LATEX_CLASS: ctexart
#+LATEX_HEADER: \\usepackage{/Users/alizj/emacs/mystyle}

# å®šåˆ¶ PDF å°é¢å’Œç›®å½•ã€‚
#+begin_export latex
% å°é¢é¡µ
\\begin{titlepage}
% æ’å…¥æ ‡é¢˜
\\maketitle
% æ’å…¥å°é¢å›¾
%\\ThisCenterWallPaper{0.4}{/path/to/image.png}
% å°é¢é¡µä¸ç¼–å·
\\noindent\\fboxsep=0pt
\\setcounter{page}{0}
\\thispagestyle{empty}
\\end{titlepage}

% æ‘˜è¦é¡µ
\\begin{abstract}
è¿™æ˜¯ä¸€ä¸ªæ‘˜è¦ã€‚
\\end{abstract}

% ç›®å½•é¡µ
\\newpage
\\tableofcontents
\\newpage
#+end_export
")
#+end_src

slide æ¼”ç¤ºï¼šorg-tree-slide ä¸å†æ´»è·ƒç»´æŠ¤äº†ï¼Œdslide æ˜¯å®ƒçš„çš„æ›¿ä»£å“ã€‚

#+begin_src emacs-lisp
(use-package dslide
  :vc(:url "https://github.com/positron-solutions/dslide.git")
  :hook
  ((dslide-start
    .
    (lambda ()
      (org-fold-hide-block-all)
      (setq-default x-stretch-cursor -1)
      (redraw-display)
      (blink-cursor-mode -1)
      (setq cursor-type 'bar)
      ;;(org-display-inline-images)
      ;;(hl-line-mode -1)
      (text-scale-increase 2)
      (read-only-mode 1)))
   (dslide-stop
    .
    (lambda ()
      (blink-cursor-mode +1)
      (setq-default x-stretch-cursor t)
      (setq cursor-type t)
      (text-scale-increase 0)
      ;;(hl-line-mode 1)
      (read-only-mode -1))))
  :config
  (setq dslide-margin-content 0.5)
  (setq dslide-animation-duration 0.5)
  (setq dslide-margin-title-above 0.3)
  (setq dslide-margin-title-below 0.3)
  (setq dslide-header-email nil)
  (setq dslide-header-date nil)
  (define-key org-mode-map (kbd "<f8>") #'dslide-deck-start)
  (define-key dslide-mode-map (kbd "<f9>") #'dslide-deck-stop))
#+end_src

journal æ—¥è®°ï¼š

#+begin_src emacs-lisp
(use-package org-journal
  :commands org-journal-new-entry
  :bind (("C-c j" . org-journal-new-entry))
  :init
  (setq org-journal-prefix-key "C-c j")
  (defun org-journal-save-entry-and-exit()
    (interactive)
    (save-buffer)
    (kill-buffer-and-window))
  :config
  (define-key org-journal-mode-map (kbd "C-c C-e") #'org-journal-save-entry-and-exit)
  (define-key org-journal-mode-map (kbd "C-c C-j") #'org-journal-new-entry)
  (global-set-key (kbd "C-c C-j") #'org-journal-new-entry)

  ;; è®¾ç½®æ—¥å¿—æ–‡ä»¶å¤´ã€‚
  (defun org-journal-file-header-func (time)
    "Custom function to create journal header."
    (concat
     (pcase org-journal-file-type
       (`daily "#+TITLE: Daily Journal\n#+STARTUP: showeverything")
       (`weekly "#+TITLE: Weekly Journal\n#+STARTUP: folded")
       (`monthly "#+TITLE: Monthly Journal\n#+STARTUP: folded")
       (`yearly "#+TITLE: Yearly Journal\n#+STARTUP: folded"))))
  (setq org-journal-file-header 'org-journal-file-header-func)
  (setq org-journal-file-type 'daily) ;; æŒ‰å¤©è®°å½•ã€‚

  (setq org-journal-dir "~/docs/org/journal")
  (setq org-journal-find-file 'find-file)

  ;; åŠ å¯†æ—¥è®°æ–‡ä»¶ã€‚
  (setq org-journal-enable-encryption t)
  (setq org-journal-encrypt-journal t)
  (defun my-old-carryover (old_carryover)
    (save-excursion
      (let ((matcher (cdr (org-make-tags-matcher org-journal-carryover-items))))
	(dolist (entry (reverse old_carryover))
          (save-restriction
            (narrow-to-region (car entry) (cadr entry))
            (goto-char (point-min))
            (org-scan-tags '(lambda ()
                              (org-set-tags ":carried:"))
                           matcher org--matcher-tags-todo-only))))))
  (setq org-journal-handle-old-carryover 'my-old-carryover))
#+end_src

åˆ›å»ºä¸€ä¸ª templ æ¨¡æ¿ï¼Œä¾¿äºåœ¨æ–‡ä»¶å¼€å¤´æ·»åŠ å†…å®¹ï¼Œå¯é¿å…æ¯æ¬¡æ‰“å¼€æ—¶æç¤ºé€‰æ‹© GPG key:

#+begin_example :tangle no
;; æ’å…¥è‡ªå·±çš„ GnuPG åŠ å¯† keyã€‚
(my-gpg "# -*- mode:org; epa-file-encrypt-to: (\"geekard@qq.com\") -*-")
#+end_example

ox-hugo åšå®¢ï¼š

#+begin_src emacs-lisp
(use-package ox-hugo
  :demand
  :config
  (setq org-hugo-base-dir (expand-file-name "~/blog/blog.opsnull.com/"))
  (setq org-hugo-section "posts")
  (setq org-hugo-front-matter-format "yaml")
  (setq org-hugo-export-with-section-numbers t)
  (setq org-export-backends '(go md gfm html latex man hugo))
  (setq org-hugo-auto-set-lastmod t))
#+end_src

* ç¼–ç¨‹å¼€å‘
** ç¼©è¿›

ç¼©è¿›å±‚æ¬¡å¯è§†åŒ–ï¼š

#+begin_src emacs-lisp
(use-package indent-bars
  :vc (:url "https://github.com/jdtsmith/indent-bars")
  :config
  (require 'indent-bars-ts)
  :custom
  (indent-bars-treesit-support t)
  (indent-bars-treesit-ignore-blank-lines-types '("module"))
  (indent-bars-treesit-scope
   '((python
      function_definition
      class_definition
      for_statement
      if_statement
      with_statement
      while_statement)))
  :hook
  ((python-base-mode
    yaml-ts-mode
    json-ts-mode
    js-ts-mode) . indent-bars-mode))
#+end_src

ç¼©è¿›é£æ ¼ï¼šc/c++/go-mode/kernel å‡ä½¿ç”¨ tab ç¼©è¿›ï¼š

#+begin_src emacs-lisp
;; é»˜è®¤ä¸ä½¿ç”¨ tab ç¼©è¿›ã€‚
;;(setq indent-tabs-mode t)
(setq c-ts-mode-indent-offset 8)
(setq c-ts-common-indent-offset 8)
(setq c-basic-offset 8)
;; kernel é£æ ¼ï¼štable å’Œ offset éƒ½æ˜¯ tab ç¼©è¿›ï¼Œè€Œä¸”éƒ½æ˜¯ 8 å­—ç¬¦ã€‚
;; https://www.kernel.org/doc/html/latest/process/coding-style.html
(setq c-default-style "linux")
(setq tab-width 8)

;; å…³é—­ electric-indent-modeï¼ŒåŒæ—¶é‡æ–°å®šä¹‰ C-j å’Œ C-m å¿«æ·é”®ï¼Œä½¿ç”¨ major-mode çš„ç¼©è¿›è§„åˆ™ã€‚
;;(electric-indent-mode 0)
#+end_src

** æ‹¬å·

å½©è‰²æ‹¬å·ï¼š

#+begin_src emacs-lisp
(use-package rainbow-delimiters
  :hook (prog-mode . rainbow-delimiters-mode))
#+end_src

é«˜äº®åŒ¹é…çš„æ‹¬å·ï¼š

#+begin_src emacs-lisp
(use-package paren
  :hook (after-init . show-paren-mode)
  :init
  (setq show-paren-delay 0.1)
  (setq show-paren-when-point-inside-paren t
        show-paren-when-point-in-periphery t)
  (setq show-paren-style 'parenthesis) ;; parenthesis, expression
  (set-face-attribute 'show-paren-match nil :weight 'extra-bold))
#+end_src

æ™ºèƒ½è¡¥å…¨æ‹¬å·ï¼š

#+begin_src emacs-lisp
(electric-pair-mode 1)
(setq electric-pair-pairs
      '(
        (?\" . ?\")
        (?\{ . ?\})))
(setq electric-pair-preserve-balance t
      electric-pair-delete-adjacent-pairs t
      electric-pair-skip-self 'electric-pair-default-skip-self
      electric-pair-open-newline-between-pairs t)
#+end_src

** project

project ä½¿ç”¨ top-down æ–¹å¼æ¥æ£€æŸ¥é¡¹ç›®è·¯å¾„ä¸­æ˜¯å¦å­˜åœ¨ .project æ–‡ä»¶ï¼Œæ‰€ä»¥åœ¨ä¸Šå±‚å„è·¯å¾„çš„
ç›®å½•ä¸­ä¸åº”è¯¥å­˜åœ¨ .project æ–‡ä»¶ï¼Œå¦åˆ™ä¼šå¯¼è‡´åˆ¤æ–­å¤±è´¥ã€‚

1. æ‰‹åŠ¨æ ‡è®°é¡¹ç›®æ ¹ç›®å½•ï¼šåœ¨ç›®å½•ä¸‹åˆ›å»º =.project= æ–‡ä»¶
2. æŸ¥çœ‹å½“å‰é¡¹ç›®çš„ project rootï¼š =(project-current)=
3. æ‰‹åŠ¨æ·»åŠ  project ç›®å½•ï¼š =M-x project-remember-projects-under=
4. è°ƒè¯•ç›®å½•çš„ project root è¯†åˆ«æƒ…å†µï¼š =(my/project-try-local "/path/to/directory")=

#+begin_src emacs-lisp
(use-package project
  :custom
  (project-switch-commands
   '(
     (consult-project-buffer "buffer" ?b)
     (project-dired "dired" ?d)
     (magit-project-status "magit status" ?g)
     (project-find-file "find file" ?p)
     (consult-ripgrep "rigprep" ?r)
     (vterm-toggle-cd "vterm" ?t)))
  (project-vc-merge-submodules nil)
  :config
  ;; project-find-file å¿½ç•¥çš„ç›®å½•æˆ–æ–‡ä»¶åˆ—è¡¨ã€‚
  (add-to-list 'vc-directory-exclusion-list "vendor") ;; go
  (add-to-list 'vc-directory-exclusion-list "node_modules") ;; node
  (add-to-list 'vc-directory-exclusion-list "target") ;; rust
  )

(defun my/project-try-local (dir)
  "Determine if DIR is a non-Git project."
  (catch 'ret
    (let ((pr-flags '(
		      ;; é¡ºç€ç›®å½• top-down æŸ¥æ‰¾ç¬¬ä¸€ä¸ªåŒ¹é…çš„æ–‡ä»¶ã€‚æ‰€ä»¥ä¸­é—´ç›®å½•ä¸èƒ½æœ‰
		      ;; .project ç­‰æ–‡ä»¶ï¼Œå¦åˆ™åˆ¤æ–­ project root é”™è¯¯ã€‚
		      ("go.mod" "Cargo.toml" "pom.xml" "package.json" ".project" )
                      ;; ä»¥ä¸‹æ–‡ä»¶å®¹æ˜“å¯¼è‡´ project root åˆ¤æ–­é”™è¯¯, æ•…ä¸æ·»åŠ ã€‚
                      ;; ("Makefile" "README.org" "README.md")
                      )))
      (dolist (current-level pr-flags)
        (dolist (f current-level)
          (when-let ((root (locate-dominating-file dir f)))
            (throw 'ret (cons 'local root))))))))
(setq project-find-functions '(my/project-try-local project-try-vc))

(cl-defmethod project-root ((project (head local)))
  (cdr project))

(defun my/project-discover ()
  (interactive)
  ;; å»æ‰ "~/go/src/k8s.io/*" ç›®å½•ã€‚
  (dolist (search-path
	   '("~/go/src/github.com/*"
	     "~/go/src/github.com/*/*"
	     "~/go/src/gitlab.*/*/*"))
    (dolist (file (file-expand-wildcards search-path))
      (when (file-directory-p file)
        (message "dir %s" file)
        ;; project-remember-projects-under åˆ—å‡º file ä¸‹çš„ç›®å½•, åˆ†åˆ«åŠ åˆ°
        ;; project-list-file ä¸­ã€‚
        (project-remember-projects-under file nil)
        (message "added project %s" file)))))

;; ä¸å°† tramp é¡¹ç›®è®°å½•åˆ° projects æ–‡ä»¶ä¸­ï¼Œé˜²æ­¢ emacs-dashboard å¯åŠ¨æ—¶æ£€æŸ¥ project å¡
;; ä½ã€‚
(defun my/project-remember-advice (fn pr &optional no-write)
  (let* ((remote? (file-remote-p (project-root pr)))
         (no-write (if remote? t no-write)))
    (funcall fn pr no-write)))
(advice-add 'project-remember-project :around 'my/project-remember-advice)
#+end_src

** magit

#+begin_src emacs-lisp
(setq vc-follow-symlinks t)

;; è‡ªåŠ¨ revert bufferï¼Œç¡®ä¿ modeline ä¸Šçš„åˆ†æ”¯åæ­£ç¡®ã€‚
(setq auto-revert-check-vc-info t)

(use-package magit
  :custom
  ;; åœ¨å½“å‰ window ä¸­æ˜¾ç¤º magit bufferã€‚
  (magit-display-buffer-function #'magit-display-buffer-same-window-except-diff-v1)
  (magit-log-arguments '("-n256" "--graph" "--decorate" "--color"))
  ;; æŒ‰ç…§ word å±•ç¤º diffã€‚
  (magit-diff-refine-hunk t)
  (magit-clone-default-directory "~/go/src/")
  :config
  ;; diff org-mode æ—¶å±•å¼€å†…å®¹ã€‚
  (add-hook 'magit-diff-visit-file-hook (lambda() (when (derived-mode-p 'org-mode)(org-fold-show-entry)))))
#+end_src

git-link ä¸ºå…‰æ ‡ä½ç½®ç”Ÿæˆ git ä»“åº“ URL:

#+begin_src emacs-lisp
(use-package git-link
  :config
  (setq git-link-use-commit t)
  ;; é‡å†™ gitlab çš„ format å­—ç¬¦ä¸²ä»¥åŒ¹é…å†…éƒ¨ç³»ç»Ÿã€‚
  (defun git-link-commit-gitlab (hostname dirname commit)
    (format "https://%s/%s/commit/%s" hostname dirname commit))
  (defun git-link-gitlab (hostname dirname filename branch commit start end)
    (format "https://%s/%s/blob/%s/%s" hostname dirname
	    (or branch commit)
            (concat filename
                    (when start
                      (concat "#"
                              (if end
                                  (format "L%s-%s" start end)
				(format "L%s" start))))))))
#+end_src

** treesit

treesit-auto è‡ªåŠ¨å®‰è£… grammer å’Œè‡ªåŠ¨å°† major-mode remap åˆ°å¯¹åº”çš„ xx-ts-mode ä¸Šã€‚å…·ä½“
å‚è€ƒå˜ =treesit-auto-recipe-list= :

#+begin_src emacs-lisp
(use-package treesit-auto
  :demand t
  :config
  (setq treesit-auto-install 'prompt)
  (global-treesit-auto-mode))
#+end_src

grammer è¢«å®‰è£…åˆ° =~/.emacs.d/tree-sitter=, å¦‚
=~/.emacs.d/tree-sitter/libtree-sitter-python.dylib=
+ æ‰§è¡Œ =M-x treesit-auto-install-all= æ¥å®‰è£…æ‰€æœ‰çš„ treesit modulesã€‚
+ å¦‚æœè¦é‡æ–°å®‰è£…(å‡çº§) grammer, éœ€è¦å…ˆåˆ é™¤ dylib æ–‡ä»¶æˆ– tree-sitter ç›®å½•, é‡å¯ emacs
  åå†æ‰§è¡Œ =M-x treesit-auto-install-all=.

ä»£ç æŠ˜å ï¼š

#+begin_src emacs-lisp
(use-package treesit-fold
  :vc (:url "https://github.com/emacs-tree-sitter/treesit-fold")
  :config
  (global-set-key (kbd "C-c f f") 'treesit-fold-close)
  (global-set-key (kbd "C-c f o") 'treesit-fold-open)
  (global-set-key (kbd "C-c f O") 'treesit-fold-open-recursively)
  (global-set-key (kbd "C-c f F") 'treesit-fold-close-all)
  (global-set-key (kbd "C-c f u") 'treesit-fold-open-all)
  (global-set-key (kbd "C-c f t") 'treesit-fold-toggle))
#+end_src

** flymake

flymake ä¸ºå½“å‰ buffer æä¾›é”™è¯¯æ£€æŸ¥/è¯Šæ–­åŠŸèƒ½ï¼Œå®ƒåœ¨å¦‚ä¸‹æƒ…å†µæ£€æŸ¥ï¼ˆè¯Šæ–­ï¼‰buffer æ˜¯å¦æœ‰é”™
è¯¯ï¼Œé”™è¯¯ä¿¡æ¯ç›´æ¥æ˜¾ç¤ºåœ¨ buffer åŒºåŸŸï¼Œå¹¶å‘é€ç»™ eldocï¼š
1. æ‰§è¡Œ ~M-x flymake-start~;
2. è¶…è¿‡ ~flymake-no-changes-timeout(é»˜è®¤ 0.5)~ ï¼›
3. ä¿å­˜ buffer æ—¶ (é™¤éè®¾ç½® flymake-start-on-save-buffer ä¸º nil);

å°† flymake-no-changes-timeout è®¾ç½®ä¸º nil åï¼Œeglot ä¸ä¼šæ˜¾ç¤º LSP å®æ—¶è¯Šæ–­æ¶ˆæ¯ï¼Œè€Œæ˜¯å½“
ä¿å­˜ buffer åç»è¿‡ eglot-send-changes-idle-time æ—¶é—´åæ‰æ˜¾ç¤ºè¯Šæ–­æ¶ˆæ¯ï¼Œè¿™æ ·å¯ä»¥é¿å…æ˜¾
ç¤ºç¼–ç è¿‡ç¨‹æ— æ„ä¹‰çš„é”™è¯¯ã€‚

#+begin_src emacs-lisp
(use-package flymake
  :config
  ;; ä¸è‡ªåŠ¨æ£€æŸ¥ buffer é”™è¯¯ã€‚
  (setq flymake-no-changes-timeout nil)

  ;; åœ¨è¡Œå°¾æ˜¾ç¤ºè¯Šæ–­æ¶ˆæ¯ï¼ˆEmacs 30 å¼€å§‹æ”¯æŒï¼‰, 'short åªæ˜¾ç¤ºä¸€æ¡æœ€é‡è¦ä¿¡æ¯ï¼Œt æ˜¾ç¤ºæ‰€æœ‰
  ;; ä¿¡æ¯ã€‚
  (setq flymake-show-diagnostics-at-end-of-line 'short)

  ;; å¦‚æœ buffer å‡ºç°é”™è¯¯çš„è¯Šæ–­æ¶ˆæ¯ï¼Œæ‰§è¡Œ flymake-start é‡æ–°è§¦å‘è¯Šæ–­ã€‚
  (define-key flymake-mode-map (kbd "C-c C-c") #'flymake-start)

  ;; æ˜¾ç¤ºè¯Šæ–­é”™è¯¯åˆ—è¡¨
  (global-set-key (kbd "C-s-l") #'consult-flymake)
  (define-key flymake-mode-map (kbd "C-s-n") #'flymake-goto-next-error)
  (define-key flymake-mode-map (kbd "C-s-p") #'flymake-goto-prev-error))

;; è§£å†³ flymake-no-changes-timeout ä¸º nil æ—¶è¯Šæ–­å»¶è¿Ÿçš„é—®é¢˜ã€‚
;;; https://github.com/joaotavora/eglot/issues/1296
;; (cl-defmethod eglot-handle-notification :after
;;   (_server (_method (eql textDocument/publishDiagnostics)) &key uri
;;            &allow-other-keys)
;;   (when-let ((buffer (find-buffer-visiting (eglot-uri-to-path uri))))
;;     (with-current-buffer buffer
;;       (if (and (eq nil flymake-no-changes-timeout)
;;                (not (buffer-modified-p)))
;;           (flymake-start t)))))
#+end_src

** eglot

elgot ä½¿ç”¨ Emacs å†…ç½®çš„ flymakeï¼ˆè€Œé flycheckï¼‰ã€xrefã€eldocã€project ç­‰åŒ…ã€‚

eglot ä½¿ç”¨ flymake æ¥æ¥æ”¶å’Œæ˜¾ç¤º LSP Server å‘é€çš„ publishDiagnostics äº‹ä»¶ï¼Œè¿™æ˜¯é€šè¿‡å‘
flymake-diagnostic-functions hook æ·»åŠ  'eglot-flymake-backend å®ç°çš„ã€‚

eglot é»˜è®¤å°† flymake çš„ backend æ¸…ç©ºï¼Œåªä¿ç•™ eglot è‡ªèº«ï¼Œå¯ä»¥é€šè¿‡é…ç½® ~(add-to-list
'eglot-stay-out-of 'flymake)~ æ¥å…³é—­ eglot å¯¹ flymake çš„æ¸…ç©ºè¡Œä¸ºï¼Œè¿™æ ·å¯ä»¥ä½¿ç”¨è‡ªå®šä¹‰çš„
flymake backendsï¼Œä½†åç»­éœ€è¦æ·»åŠ  hook æ¥æ‰‹åŠ¨å¯åŠ¨å’Œé…ç½® eglot-flymake-backendã€‚

#+begin_src emacs-lisp
(use-package eglot
  :demand
  :after (flymake)
  :preface
  (defun my/eglot-eldoc ()
    ;; eglot will change the completion-category-defaults to flex, BAD!
    ;; https://github.com/minad/corfu/issues/136#issuecomment-eglot
    ;; è¿™é‡Œå°† completion-category-defaults è®¾ç½®ä¸º nilï¼Œç„¶ååœ¨ completion-category-overrides
    ;; ä¸­è®¾ç½® eglot ä½¿ç”¨ orderless è¡¥å…¨é£æ ¼ã€‚
    (setq completion-category-defaults nil)

    ;; åœ¨ eldoc buffer å¼€å§‹ä¼˜å…ˆæ˜¾ç¤º flymake è¯Šæ–­ä¿¡æ¯ã€‚
    (setq eldoc-documentation-functions
          (cons #'flymake-eldoc-function
                (remove #'flymake-eldoc-function eldoc-documentation-functions)))
    )
  :hook ((eglot-managed-mode . my/eglot-eldoc))
  :bind
  (:map eglot-mode-map
        ("C-c C-a" . eglot-code-actions)
        ("C-c C-f" . eglot-format-buffer)
        ("C-c C-r" . eglot-rename)
	("C-c C-c" . flymake-start)
	("C-c C-d" . eldoc))
  :config
  ;; å°† eglot-events-buffer-size è®¾ç½®ä¸º 0 åå°†å…³é—­æ˜¾ç¤º *EGLOT event* buferï¼Œä¸ä¾¿äºè°ƒ
  ;; è¯•é—®é¢˜ã€‚ä¹Ÿä¸èƒ½è®¾ç½®çš„å¤ªå¤§ï¼Œå¦åˆ™å¯èƒ½å½±å“æ€§èƒ½ã€‚
  (setq eglot-events-buffer-size (* 1024 1024 1))

  ;; å°† flymake-no-changes-timeout è®¾ç½®ä¸º nil åï¼Œeglot ä¿å­˜ buffer å†…å®¹åï¼Œç»è¿‡ idle
  ;; time æ‰ä¼šå‘LSP å‘é€è¯Šæ–­è¯·æ±‚ã€‚
  (setq eglot-send-changes-idle-time 0.1)

  ;; å½“æœ€åä¸€ä¸ªæºç  buffer å…³é—­æ—¶è‡ªåŠ¨å…³é—­ eglot serverã€‚
  (customize-set-variable 'eglot-autoshutdown t)
  (customize-set-variable 'eglot-connect-timeout 60)

  ;;ä¸ç»™æ‰€æœ‰ prog-mode éƒ½å¼€å¯ eglotï¼Œå¦åˆ™å½“å®ƒæ²¡æœ‰ language server æ—¶ eglot æŠ¥é”™ã€‚
  ;;
  ;;ç”±äº treesit-auto å·²ç»å¯¹ major-mode åšäº† remap ï¼Œéœ€è¦å¯¹ xx-ts-mode-hook æ·»åŠ  hookï¼Œ
  ;;è€Œä¸æ˜¯ä»¥å‰çš„ xx-mode-hook, å¦åˆ™æ·»åŠ åˆ° xx-mode-hook çš„å†…å®¹ä¸ä¼šè¢«è‡ªåŠ¨æ‰§è¡Œã€‚
  (add-hook 'c-ts-mode-hook #'eglot-ensure)
  (add-hook 'go-ts-mode-hook #'eglot-ensure)
  (add-hook 'bash-ts-mode-hook #'eglot-ensure)
  (add-hook 'python-mode-hook #'eglot-ensure)
  (add-hook 'python-ts-mode-hook #'eglot-ensure)
  (add-hook 'rust-ts-mode-hook #'eglot-ensure)
  (add-hook 'rust-mode-hook #'eglot-ensure)
  (add-hook 'yaml-mode-hook #'eglot-ensure)
  (add-hook 'yaml-ts-mode-hook #'eglot-ensure)

  (setq eglot-ignored-server-capabilities
        '(
          ;;:hoverProvider ;; æ˜¾ç¤ºå…‰æ ‡ä½ç½®ä¿¡æ¯ã€‚
          ;;:documentHighlightProvider ;; é«˜äº®å½“å‰ symbolã€‚
          ;;:inlayHintProvider ;; æ˜¾ç¤º inlay hint æç¤ºã€‚
          ))

  ;; åŠ å¼ºé«˜äº®çš„ symbol æ•ˆæœã€‚
  ;;(set-face-attribute 'eglot-highlight-symbol-face nil :background "#b3d7ff")

  ;; t: true, false: :json-false(ä¸æ˜¯ nil)ã€‚
  ;; gopls é…ç½®å‚æ•°: https://github.com/golang/tools/blob/master/gopls/doc/settings.setq
  (setq-default eglot-workspace-configuration
                '((:gopls . ((staticcheck . t)
                             (usePlaceholders . :json-false)
                             ;; gopls é»˜è®¤è®¾ç½® GOPROXY=Off, å¯èƒ½ä¼šå¯¼è‡´ package ç¼ºå¤±è¿›
                             ;; è€Œå¼•èµ·è¡¥å…¨å¼‚å¸¸. å¼€å¯ allowImplicitNetworkAccess åå°†
                             ;; å…³é—­ GOPROXY=Off.
                             ;;(allowImplicitNetworkAccess . t)
                             )))))
#+end_src

consult-eglot æä¾› ~consult-eglot-symbols~ å‡½æ•°ï¼Œæ–¹ä¾¿é€‰æ‹© workspace ä¸­çš„ symbolï¼š

#+begin_src emacs-lisp
(use-package consult-eglot
  :after (eglot consult))
#+end_src

ä¸‹è½½ [[https://github.com/blahgeek/emacs-lsp-booster][emacs-lsp-booster]] å¯æ‰§è¡Œç¨‹åºï¼Œç„¶åä½¿ç”¨ emacs-lsp-booster æ¥åŠ é€Ÿ eglot çš„å“åº”æ€§èƒ½ï¼š

#+begin_src emacs-lisp
(use-package eglot-booster
  :vc (:url "https://github.com/jdtsmith/eglot-booster")
  :after (eglot)
  :config (eglot-booster-mode))
#+end_src

** eldoc

eldoc åœ¨ minibuffer echo-area æˆ– eldoc buffer ä¸­æ˜¾ç¤ºæ–‡æ¡£å’Œå‡½æ•°ç­¾åä¿¡æ¯ã€‚

#+begin_src emacs-lisp
(use-package eldoc
  :after (eglot)
  :bind
  (:map eglot-mode-map ("C-c C-d" . eldoc))
  :config
  (setq eldoc-idle-delay 0.1)

  ;; æ‰“å¼€ eldoc-buffer æ—¶å…³é—­ echo-area æ˜¾ç¤º, eldoc-buffer ä¼šè·Ÿéšæ˜¾ç¤º hover ä¿¡æ¯, å¦‚
  ;; å‡½æ•°ç­¾åã€‚
  (setq eldoc-echo-area-prefer-doc-buffer t)

  ;; åœ¨å±å¹•å³ä¾§æ˜¾ç¤º eldoc-buffer
  (add-to-list 'display-buffer-alist
               '("^\\*eldoc.*\\*"
                 (display-buffer-reuse-window display-buffer-in-side-window)
                 (dedicated . t)
                 (side . right)
                 (inhibit-same-window . t)))

  ;; å°† minibuffer çª—å£é«˜åº¦è®¾ä¸º 1ï¼Œå¯ä»¥ç¡®ä¿åªæ˜¾ç¤ºä¸€è¡Œï¼ˆé»˜è®¤ä¸ºå°æ•°ï¼Œè¡¨ç¤º frame é«˜åº¦å 
  ;; æ¯”ï¼Œä¼šå¯¼è‡´æ˜¾ç¤ºå¤šè¡Œï¼‰ã€‚
  (setq max-mini-window-height 1)
  ;; ä¸º nil æ—¶åªå•è¡Œæ˜¾ç¤º eldoc ä¿¡æ¯.
  (setq eldoc-echo-area-use-multiline-p nil)

  ;; ä¸€é”®æ˜¾ç¤ºå’Œå…³é—­ eldoc bufferã€‚
  (global-set-key (kbd "M-`")
                  (lambda()
                    (interactive)
                    (if (get-buffer-window "*eldoc*")
			(delete-window (get-buffer-window "*eldoc*"))
                      (display-buffer "*eldoc*")))))
#+end_src

æ³¨ï¼šeglot ä¸ç»™ eldoc æä¾›åœ¨ echo-area æ˜¾ç¤ºçš„ç»“æ„åŒ–æˆå‘˜æˆ–å‡½æ•°ç­¾åä¿¡æ¯, ä½†æ˜¯å¯ä»¥åœ¨ =M-x
eldoc-doc-buffer(C-h-.)= æ‰“å¼€çš„ eldoc buffer ä¸­ä¼šæ˜¾ç¤ºè¿™äº›ä¿¡æ¯ã€‚

eldoc-box åœ¨ frame å³ä¸Šè§’æˆ–å…‰æ ‡ä½ç½®æ˜¾ç¤º eldoc-doc-buffer çš„å†…å®¹ã€‚

#+begin_src emacs-lisp
(use-package eldoc-box
  :after (eglot eldoc)
  :bind
  (:map eglot-mode-map
        ("C-M-k" . (lambda () (interactive) (eldoc-box-scroll-down 1)))
        ("C-M-j" . (lambda () (interactive) (eldoc-box-scroll-up 1)))
	;; æŒ‰éœ€å¼¹å‡º posframe æ¥æ˜¾ç¤º eldoc buffer å†…å®¹ã€‚
	("C-c C-d" . eldoc-box-help-at-point)
	)

  :config
  (setq eldoc-box-max-pixel-height 600)
  (setq eldoc-box-max-pixel-width 1200)

  ;; C-g å…³é—­å¼¹å‡ºçš„ child frameã€‚
  (setq eldoc-box-clear-with-C-g t)

  ;; åœ¨å³ä¸Šè§’æ˜¾ç¤º eldoc å¸®åŠ©ï¼›
  ;;(add-hook 'eglot-managed-mode-hook #'eldoc-box-hover-mode t)

  ;; åœ¨å…‰æ ‡ä½ç½®æ˜¾ç¤º eldoc å¸®åŠ©ï¼›
  ;;(add-hook 'eglot-managed-mode-hook #'eldoc-box-hover-at-point-mode t)
  )
#+end_src

** python

=brew install python= ç›®å‰(2024.03.17)å®‰è£…çš„æ˜¯ python@12 ç‰ˆæœ¬ï¼Œä»è¯¥ç‰ˆæœ¬å¼€å§‹, å¦‚æœè¦ pip
å®‰è£… python åŒ…, å¿…é¡»å®‰è£…åˆ°ç”¨æˆ·è‡ªå·±çš„ venv ç¯å¢ƒ, å¦åˆ™æŠ¥é”™(error:
externally-managed-environment)ã€‚å…·ä½“å‚è€ƒ: https://docs.brew.sh/Homebrew-and-Python

#+begin_src shell :tangle no
$ brew reinstall python
$ brew unlink python@3.12 && brew link python@3.12
# æŸ¥çœ‹å®‰è£…çš„ä½ç½®
$ ls -l $(brew --prefix python)/libexec/bin

$ pip3 install  pygments
error: externally-managed-environment
#+end_src

åˆ›å»ºä¸€ä¸ª =~/.venv= python è™šæ‹Ÿç¯å¢ƒ, ç„¶åå°† pip åŒ…å®‰è£…åˆ°è¯¥ç¯å¢ƒä¸­:
#+begin_src shell :tangle no
zj@a:~$ python3 -m venv .venv
zj@a:~$ source ~/.venv/bin/activate
# å®‰è£…ç›¸å…³çš„åŒ…åˆ°è™šæ‹Ÿç¯å¢ƒä¸­
(.venv) zj@a:~$ pip3 install pygments jinji2 ipython markdown flake8 yapf pyright grip debugpy

# å°† /Users/alizj/.venv/bin æ·»åŠ åˆ° PATH ä¸­ï¼Œè¿™æ ·åç»­ä¸éœ€è¦æ¯æ¬¡æ‰‹åŠ¨ active
# æ›´æ–° ~/.bashrc ä¸­çš„ PATHï¼š PATH=/Users/alizj/.venv/bin:$PATH
#+end_src

é…ç½® Emacs ä½¿ç”¨å†…ç½®çš„ python-ts-mode å’Œ venv è™šæ‹Ÿç¯å¢ƒ:
#+begin_src emacs-lisp
;; å°† ~/.venv/bin æ·»åŠ åˆ° PATH ç¯å¢ƒå˜é‡å’Œ exec-path å˜é‡ä¸­ã€‚
(setq my-venv-path "/Users/alizj/.venv/bin")
(setenv "PATH" (concat my-venv-path ":" (getenv "PATH")))
(setq exec-path (cons my-venv-path  exec-path))

;; æŒ‡å®š python.el ä½¿ç”¨è™šæ‹Ÿç¯å¢ƒç›®å½•ã€‚
(setq python-shell-virtualenv-root "/Users/alizj/.venv")

(defun my/python-setup-shell (&rest args)
  (if (executable-find "ipython3")
      (progn
        ;; ä½¿ç”¨ ipython3 ä½œä¸º python shell.
        (setq python-shell-interpreter "ipython3")
        (setq python-shell-interpreter-args "--simple-prompt -i --InteractiveShell.display_page=True"))
    (progn
      ;; æŸ¥æ‰¾ python-shell-virtualenv-root ä¸­çš„è§£é‡Šå™¨.
      (setq python-shell-interpreter "python3")
      (setq python-interpreter "python3")
      (setq python-shell-interpreter-args "-i"))))

;; ä½¿ç”¨å†…ç½® python mode å’Œ LSP æ¥æ ¼å¼åŒ–ä»£ç ï¼ˆä¸é€‚ç”¨ yapfifyï¼‰
(use-package python
  :init
  ;;(setq python-indent-guess-indent-offset t)
  ;;(setq python-indent-guess-indent-offset-verbose nil)
  ;;(setq python-indent-offset 2)
  :hook
  (python-mode . (lambda ()
                   (my/python-setup-shell))))
#+end_src

Python LSP Server ä½¿ç”¨ basedpyrightï¼Œå®ƒæ˜¯å¾®è½¯ VSCode ä½¿ç”¨çš„ pyright å’Œ pyglance çš„å¼€
æº fork ç‰ˆæœ¬ã€‚

å®‰è£… basepyright:

#+begin_src shell :tangle no
which  basedpyright || pip install basedpyright
#+end_src

é…ç½® eglot ä½¿ç”¨ basedpyrightï¼š

#+begin_src emacs-lisp
(add-to-list 'eglot-server-programs
             '((python-mode python-ts-mode)
               "basedpyright-langserver" "--stdio"))
#+end_src

pyright _ä¸ä½¿ç”¨_ pyenv ~.python-version~ æŒ‡å®šçš„ python ç‰ˆæœ¬æˆ– venv æ¥æœç´¢ä¾èµ–çš„ moduleï¼Œ
è€Œæ˜¯ä½¿ç”¨=pyrightconfig.json= æ–‡ä»¶ä¸­é…ç½®çš„ venv å’Œ venvPath:
+ venvPathï¼šæŒ‡å®šæŸ¥æ‰¾ venv ç›®å½•çš„ä¸Šçº§ç›®å½•ï¼Œå¯ä»¥åŒ…å«å¤šä¸ª venv ç¯å¢ƒï¼›
+ venvï¼šæŒ‡å®š venvPath ç›®å½•ä¸‹çš„ã€ä½¿ç”¨çš„è™šæ‹Ÿç¯å¢ƒåç§°, pyright åœ¨è¯¥ venv ä¸­æœç´¢ä¾èµ–çš„
  package;

å®‰è£… =pyenv-pyright= æ’ä»¶æ¥æ–¹ä¾¿çš„åˆ›å»ºå’Œæ›´æ–° =pyrightconfig.json= æ–‡ä»¶ï¼š

#+begin_src bash :tangle ~/.emacs.d/init.sh
git clone https://github.com/alefpereira/pyenv-pyright.git $(pyenv root)/plugins/pyenv-pyright
#+end_src

ä½¿ç”¨æ–¹æ³•ï¼š
1. ä½¿ç”¨ =pyenv local= ä¸ºé¡¹ç›®æŒ‡å®š ~pyenv virtualenv~;
2. ä½¿ç”¨ =pyenv pyright= æ¥è‡ªåŠ¨é…ç½® =pyrightconfig.json= ä½¿ç”¨ä¸Šä¸€æ­¥æŒ‡å®šçš„ virtualenvï¼›

pyright å‡è®¾æºæ–‡ä»¶ä½äºé¡¹ç›® scr ç›®å½•ä¸‹ï¼Œä½†å®é™…å¯èƒ½ä¼šåœ¨å¤šä¸ªå…¶å®ƒå­ç›®å½•ï¼ˆç”šè‡³åµŒå¥—æƒ…å†µï¼‰ä¸­
æ”¾ç½®é¡¹ç›®æºç ï¼Œå³ =multi-root= æ¨¡å¼ï¼ˆå¯¹åº”äº vscode ä¸­çš„å¤š worksapce ç›®å½•)ï¼Œè¿™æ—¶å¯èƒ½å‡ºç°
å¤§é‡ import é”™è¯¯ï¼Œå¯ä»¥é€šè¿‡åœ¨é¡¹ç›®æ ¹ç›®å½•é…ç½® =pyrightconfig.json= æ–‡ä»¶æ¥è§£å†³ï¼Œä¾‹å¦‚ï¼ˆå‚è€ƒï¼š
python module [[https://github.com/microsoft/pyright/blob/main/docs/import-resolution.md][Import Resolution]]ï¼‰ï¼š
#+begin_src javascript :tangle no
{
    "venv": "venv-2.7.18",
    "venvPath": "/Users/zhangjun/.pyenv/versions",
    "verboseOutput": true,
    "reportMissingTypeStubs": false,
    "executionEnvironments": [
        {
            "root": "scripts",
            "extraPaths": [
                ".",  // scripts ç›®å½•ä¸‹ py æ–‡ä»¶å¯¼å…¥åŒçº§ py æ–‡ä»¶çš„æƒ…å†µ
                "scripts/appinstance_apply"
            ]
        }
    ]
}
#+end_src

executionEnvironmentsï¼š
1. åˆ—è¡¨ä¸­ root æŒ‡å®šå„ workspace çš„å­ç›®å½•ï¼Œæ˜¯æœ‰æœç´¢ä¼˜å…ˆçº§çš„ï¼Œæ‰€ä»¥å¦‚æœæœ‰ç›¸åŒè·¯å¾„å‰ç¼€çš„
   æƒ…å†µï¼Œåº”è¯¥ä»é•¿åˆ°çŸ­ä¾åˆ—å‡ºæ¥ï¼šæ ¹æ® python æ–‡ä»¶çš„ from/import è¯­å¥æ¥ç¡®å®šroot è·¯å¾„ï¼šå³
   ä»é¡¹ç›®æ ¹ç›®å½•ï¼ˆpyrightconfig.json æ–‡ä»¶æ‰€åœ¨ç›®å½•ï¼‰å¼€å§‹åˆ°æ–‡ä»¶ä¸­å¯¼å…¥è·¯å¾„æœ€å¼€å§‹æ‰€åœ¨ç›®å½•
   ä¹‹é—´çš„ç›®å½•ï¼Œéƒ½åº”è¯¥æ˜¯ rootã€‚
2. extraPaths åˆ—è¡¨ä¸­çš„è·¯å¾„å¯ä»¥æ˜¯ç»å¯¹è·¯å¾„æˆ–ç›¸å¯¹è·¯å¾„ï¼ˆç›¸å¯¹äº pyrightconfig.json æ–‡ä»¶ï¼‰ï¼Œ
   ç”¨äºæ·»åŠ é¢å¤–çš„ python module æœç´¢è·¯å¾„ï¼›
   + æ·»åŠ  "." æ˜¯å› ä¸ºéœ€è¦å°† scripts æ‰€åœ¨çš„ç›®å½•ä¹Ÿæ·»åŠ åˆ° module æœç´¢è·¯å¾„ï¼Œè€Œä¸ä»…ä»…æ˜¯ scripts ä¸‹çš„å­ç›®å½•ï¼›
3. å®˜æ–¹çš„å®ä¾‹å‚è€ƒï¼š[[https://github.com/microsoft/pyright/blob/main/docs/configuration.md#sample-config-file][Sample Config File]] å’Œ [[https://github.com/microsoft/pyright/blob/main/packages/pyright-internal/src/tests/testState.test.ts][testState.test.ts]]ï¼›

[[https://github.com/Microsoft/pyright/issues/21][pyright ä¸æ”¯æŒ python 2.x]]ï¼Œå¦‚æœåœ¨ä¸Šé¢æ–‡ä»¶é…ç½® ="pythonVersion": "2.7"= åˆ™ä¼šæŠ¥é”™ã€‚

** go

å®‰è£…æœ€æ–° gopls å·¥å…·:

#+begin_src bash :tangle ~/.emacs.d/init.sh
go install golang.org/x/tools/gopls@latest
#+end_src

ä½¿ç”¨ Emacs å†…ç½®çš„ go-ts-mode, æ•…ä¸éœ€è¦å†å•ç‹¬å®‰è£… go-mode åŒ…ï¼š

#+begin_src emacs-lisp
(require 'go-ts-mode)
;; go ä½¿ç”¨ TAB ç¼©è¿›ã€‚
(add-hook 'go-ts-mode-hook (lambda () (setq indent-tabs-mode t)))
#+end_src

è®¾ç½® go ç¯å¢ƒå˜é‡, eglot å¯åŠ¨ gopls æ—¶ä¼ é€’å®ƒä»¬:

#+begin_src emacs-lisp
(dolist (env '(("GOPATH" "/Users/alizj/go")
               ("GOPROXY" "https://goproxy.cn,https://goproxy.io,direct")
               ("GOPRIVATE" "*.alibaba-inc.com")
	       ("GOOS" "linux")
	       ("GOARCH" "arm64")))
  (setenv (car env) (cadr env)))
#+end_src

æŸ¥çœ‹æœ¬åœ°å’Œåœ¨çº¿ go æ–‡æ¡£:

#+begin_src emacs-lisp
(require 'go-ts-mode)
;; æŸ¥çœ‹å…‰æ ‡å¤„ç¬¦å·çš„æœ¬åœ°æ–‡æ¡£.
(define-key go-ts-mode-map (kbd "C-c d .") #'godoc-at-point)

;; æŸ¥çœ‹ go std æ–‡æ¡£ã€‚
(defun my/browser-gostd ()
  (interactive)
  (xwidget-webkit-browse-url "https://pkg.go.dev/std"))
(define-key go-ts-mode-map (kbd "C-c d s") 'my/browser-gostd)

;; æœç´¢ pkg.go.dev åœ¨çº¿ web æ–‡æ¡£ã€‚
(defun my/browser-pkggo (query)
  (interactive "ssearch: ")
  (xwidget-webkit-browse-url
   (concat "https://pkg.go.dev/search?q=" (string-replace " " "%20" query)) t))
(define-key go-ts-mode-map (kbd "C-c d w") 'my/browser-pkggo) ;; åŠ©è®°: w -> web
#+end_src

å®‰è£…æˆ–æ›´æ–°å·¥å…·ï¼š
#+begin_src emacs-lisp
;; (setq gofmt-command "golangci-lint")
;; (setq gofmt-args "run --config /Users/alizj/.golangci.yml --fix")

(defvar go--tools '("golang.org/x/tools/gopls"
                    "github.com/rogpeppe/godef"
                    "golang.org/x/tools/cmd/goimports"
                    "honnef.co/go/tools/cmd/staticcheck"
                    "github.com/go-delve/delve/cmd/dlv"
                    "github.com/zmb3/gogetdoc"
                    "github.com/josharian/impl"
                    "github.com/cweill/gotests/..."
                    "github.com/fatih/gomodifytags"
                    "github.com/golangci/golangci-lint/cmd/golangci-lint"
                    "github.com/davidrjenni/reftools/cmd/fillstruct"))

(defun go-update-tools ()
  (interactive)
  (unless (executable-find "go")
    (user-error "Unable to find `go' in `exec-path'!"))
  (message "Installing go tools...")
  (dolist (pkg go--tools)
    (set-process-sentinel
     (start-process "go-tools" "*Go Tools*" "go" "install" "-v" "-x" (concat pkg "@latest"))
     (lambda (proc _)))))

(use-package go-fill-struct)

(use-package go-impl)

;; è‡ªåŠ¨ä¸º struct field æ·»åŠ  json tagã€‚
(use-package go-tag
  :init
  (setq go-tag-args (list "-transform" "camelcase"))
  :config
  (require 'go-ts-mode)
  (define-key go-ts-mode-map (kbd "C-c t a") #'go-tag-add)
  (define-key go-ts-mode-map (kbd "C-c t r") #'go-tag-remove))

(use-package go-playground
  :commands (go-playground-mode)
  :config
  (setq go-playground-init-command "go mod init"))
#+end_src

è°ƒè¯•:
1. å¦‚æœä¸€ä¸ª git é¡¹ç›®ä¸‹æœ‰å¤šä¸ª go module, åˆ™éœ€è¦åœ¨ä¸Šå±‚ç›®å½•åˆ›å»º workspace, å¹¶å°†å„ module
   åŠ å…¥å…¶ä¸­ï¼Œå¦åˆ™å¯èƒ½å‡ºç° package import å¤±è´¥çš„æƒ…å†µï¼š

   #+begin_src bash :tangle no
   go work init
   go work use ./path/to/module1 ./path/to/module2
   #+end_src

2. å¦‚æœè¡¥å…¨æˆ–è‡ªåŠ¨æç¤ºå¼‚å¸¸, æ‰§è¡Œ ~M-x eglot-events-buffer~ çœ‹æ˜¯å¦æœ‰æŠ¥é”™(ä¾‹å¦‚ GOPROXY=Off
   å¯¼è‡´çš„é—®é¢˜.)

** rust

ä½¿ç”¨ rustup å®‰è£…å’Œç®¡ç† rust å·¥å…·é“¾ï¼š
#+begin_src bash :tangle ~/.emacs.d/init.sh
# æ¸…ç†æ—§ç¯å¢ƒ
mv ~/.cargo{,.bak}
brew uninstall rust rust-analyzer

brew install rustup-init
echo 'export PATH=$HOME/.cargo/bin:$PATH' >>~/.bashrc

rustup-init   # ä¸‹è½½å®‰è£… rust stable å·¥å…·é“¾
rustup component add rust-analyzer # å®‰è£… rust lsp server
rustup component add clippy  # rust lints
rustup component add rustfmt # rust formater
rustup component add rust-src
rustup component add rust-docs # æ·»åŠ  rust æ ‡å‡†åº“æ–‡æ¡£

rustup toolchain list   # æŸ¥çœ‹å·²å®‰è£…çš„å·¥å…·é“¾

# å®‰è£… nightly å·¥å…·é“¾
rustup toolchain install nightly

# è®¾ç½®ç¼ºçœå·¥å…·é“¾ä¸º nightly
rustup default nightly

# cargo ä¹Ÿæ”¯æŒåœ¨å‘½ä»¤è¡Œä¸ŠæŒ‡å®š toolchain ç‰ˆæœ¬
cargo +nightly expand
#+end_src

æŸ¥çœ‹æ–‡æ¡£ï¼š
#+begin_src bash :tangle no
rustup component add rust-docs # æ·»åŠ  rust æ ‡å‡†åº“æ–‡æ¡£
rustup doc # æŸ¥çœ‹æ ‡å‡†åº“æ–‡æ¡£
rustup doc topic # æŸ¥çœ‹æŸä¸ª topic çš„å¸®åŠ©æ–‡æ¡£ï¼Œå¦‚ coreï¼Œfnï¼Œstd:char ç­‰ã€‚
cargo doc --open # æŸ¥çœ‹å½“å‰é¡¹ç›®å’Œä¾èµ–çš„æ–‡æ¡£
#+end_src

æ¸…ç†æ²¡æœ‰ä½¿ç”¨çš„ crateï¼š
#+begin_src shell :tangle no
cargo install cargo-sweep
cargo sweep --time 30
cargo sweep --installed
#+end_src

å…¶å®ƒ cargo æ’ä»¶ï¼š
#+begin_src shell :tangle no
cargo install cargo-watch
# ç¤ºä¾‹ï¼šå…ˆ cargo checkï¼Œå† cargo testï¼Œæœ€å cargo run
cargo watch -x check -x test -x run

# æä¾› cargo add å‘½ä»¤
cargo install cargo-edit
cargo add actix-web --vers 4.0.0

# æä¾› cargo expand å®å±•å¼€å‘½ä»¤
cargo install cargo-expand

# æä¾› cargo +nightly udeps å‘½ä»¤ï¼Œæ‰“å°å½“å‰é¡¹ç›®æœªä½¿ç”¨çš„ crate
cargo install cargo-udeps

# æä¾› cargo info å‘½ä»¤ï¼ŒæŸ¥çœ‹ crate çš„ features å’Œ version ä¿¡æ¯
cargo install cargo-information
#+end_src

å°† Rust å·¥å…·é“¾ç›®å½•æ·»åŠ åˆ° PATH ç¯å¢ƒå˜é‡å’Œ Emacs å˜é‡ exec-path ä¸­:
#+begin_src emacs-lisp
(setq my-cargo-path "/Users/alizj/.cargo/bin")
(setenv "PATH" (concat my-cargo-path ":" (getenv "PATH")))
(setq exec-path (cons my-cargo-path  exec-path))

;; https://github.com/mozilla/sccache?tab=readme-ov-file
;; cargo install sccache --locked
(setenv "RUSTC_WRAPPER" "/Users/alizj/.cargo/bin/sccache")
#+end_src

é…ç½® rust-mode:

#+begin_src emacs-lisp
;; https://github.com/jwiegley/dot-emacs/blob/master/init.org#rust-mode
(use-package rust-mode
  :after (eglot)
  :init
  (require 'rust-ts-mode)
  ;; rust-mode ä½œä¸º rust-ts-mode è€Œé prog-mode çš„å­ modeã€‚
  (setq rust-mode-treesitter-derive t)
  :config

  ;; rust-analyzer ä½¿ç”¨ rustfmt æ¥æ ¼å¼åŒ–ä»£ç 
  ;;(setq rust-format-on-save t)
  (setq rust-rustfmt-switches '("--edition" "2021"))

  ;; treesit-auto é»˜è®¤ä¸å°† XX-mode-hook æ·»åŠ åˆ°å¯¹åº”çš„ XX-ts-mode-hook ä¸Š, éœ€è¦æ‰‹åŠ¨æŒ‡å®šã€‚
  (setq rust-ts-mode-hook rust-mode-hook)

  ;; rust å»ºè®®ä½¿ç”¨ç©ºæ ¼è€Œé TAB æ¥ç¼©è¿›.
  (add-hook 'rust-ts-mode-hook (lambda () (setq indent-tabs-mode nil)))

  ;; å‚æ•°åˆ—è¡¨å‚è€ƒï¼šhttps://rust-analyzer.github.io/manual.html#configuration
  (add-to-list
   'eglot-server-programs
   '((rust-ts-mode rust-mode) .
     ("rust-analyzer"
      :initializationOptions
      (
       :rustfmt
       (
	:extraArgs ["+nightly"]
	)
       ;; 20240910 ä¸èƒ½å…³é—­ checkOnSaveï¼Œå¦åˆ™ flymake diagnose å¯èƒ½ä¸ç”Ÿæ•ˆã€‚
       ;;:checkOnSave :json-false
       ;;:cachePriming (:enable :json-false) ;; å¯åŠ¨æ—¶ä¸é¢„çƒ­ç¼“å­˜.
       :check
       (
        :command "clippy"
        ;;https://esp-rs.github.io/book/tooling/visual-studio-code.html#using-rust-analyzer-with-no_std
        :allTargets :json-false
	;; ä¸å‘é€ --workspace ç»™ cargo check, åªæ£€æŸ¥å½“å‰ package.
	;; 20240910 å¯èƒ½å¯¼è‡´åŸºäº workspace çš„ æ ‡å‡†åº“ lsp ä¸ç”Ÿæ•ˆï¼Œæ•…ä¸èƒ½è®¾ç½®ã€‚
        ;;:workspace :json-false
        )
       ;;:procMacro (:attributes (:enable t) :enable :json-false)
       :cargo
       (
        ;;:buildScripts (:enable :json-false)
        ;;:extraArgs ["--offline"] ;; ä¸è”ç½‘èŠ‚çœæ—¶é—´.
        ;;:features "all"
        ;;:noDefaultFeatures t
        :cfgs (:tokio_unstable "")
        ;;:autoreload :json-false
        )
       :diagnostics
       (
	;;:enable :json-false
	:disabled ["unresolved-proc-macro" "unresolved-macro-call"]
	)
       :inlayHints
       (
	:bindingModeHints (:enable t)
	:closureCaptureHints (:enable t)
	:closureReturnTypeHints (:enable t)
	:lifetimeElisionHints (:enable t)
	:expressionAdjustmentHints (:enable t)
	)
       ;; :linkedProjects
       ;; [
       ;;  "/Users/alizj/.rustup/toolchains/stable-aarch64-apple-darwin/lib/rustlib/src/rust/library/std/Cargo.toml",
       ;;  "/Users/alizj/.rustup/toolchains/stable-aarch64-apple-darwin/lib/rustlib/src/rust/library/core/Cargo.toml",
       ;;  "/Users/alizj/.rustup/toolchains/stable-aarch64-apple-darwin/lib/rustlib/src/rust/library/proc_macro/Cargo.toml",
       ;;  "/Users/alizj/.rustup/toolchains/stable-aarch64-apple-darwin/lib/rustlib/src/rust/library/test/Cargo.toml"
       ;;  ]
       )))))
#+end_src

rust-analyzer è°ƒç”¨ rustfmt (rustup component add rustfmt) æ¥æ ¼å¼åŒ–ä»£ç ï¼Œä¸ºä»£ç æ·»
åŠ ~#[rustfmt::skip]~ å¯ä»¥å¿½ç•¥æ ¼å¼åŒ–ã€‚

åˆ›å»ºå¦‚ä¸‹å…¨å±€ rustfmt é…ç½®æ–‡ä»¶ï¼›

#+begin_src toml :tangle ~/.rustfmt.toml
# é…ç½®é€‰é¡¹å‚è€ƒï¼š
# https://rust-lang.github.io/rustfmt/?version=v1.7.1&search=#chain_width
edition = "2021"
# ç¡®ä¿æ–¹æ³•é“¾å¼è°ƒç”¨æ—¶ï¼Œæ¯è¡Œä¸€ä¸ªæ–¹æ³•è°ƒç”¨ï¼Œè¿™æ · inlayhint ä¼šæ˜¾ç¤ºä¸Šä¸€ä¸ªæ–¹æ³•çš„è¿”å›å€¼ç±»å‹ã€‚
chain_width = 0
# æ˜¯å¦æ ¼å¼åŒ–ä¸ºå•è¡Œå‡½æ•°ã€‚
fn_single_line = true
# æœ€å¤§è¡Œé•¿åº¦ï¼Œè¶…è¿‡åè‡ªåŠ¨æŠ˜è¡Œã€‚
max_width = 80
# å‡½æ•°å„å‚æ•°å•ç‹¬ä¸€è¡Œ
fn_args_layout = "Vertical"

# ä»¥ä¸‹æ˜¯ unstable featuresï¼Œåªèƒ½åœ¨ nightly channel ä½¿ç”¨ã€‚
wrap_comments = true
normalize_comments = true
format_code_in_doc_comments = true
comment_width = 80
format_strings = true
imports_granularity = "Crate"
enum_discrim_align_threshold = 20
#+end_src

rust-playground å¿«é€Ÿæµ‹è¯•ç¯å¢ƒ:
1. BUGFIX: https://github.com/grafov/rust-playground/pull/11/files
2. è®¾ç½® Cargo.toml æ¨¡æ¿æ–‡ä»¶å˜é‡ä¸­ edition å€¼ä¸º 2021ï¼ˆé»˜è®¤æ˜¯ 2018ï¼‰ã€‚
#+begin_src emacs-lisp
(use-package rust-playground
  :config
  (setq rust-playground-cargo-toml-template
        "[package]
name = \"foo\"
version = \"0.1.0\"
authors = [\"opsnull <geekard@qq.com>\"]
edition = \"2021\"

[dependencies]"))
#+end_src

eglot-x ä¸º Rust æä¾›äº†å‡ ä¸ªå¥½ç”¨çš„å‘½ä»¤ï¼š
1. =M-x eglot-x-reload-workspace= ï¼šåœ¨ Cargo.toml æ–‡ä»¶å‘ç”Ÿå˜åŒ–æ—¶æ‰‹åŠ¨æ‰§è¡Œè€Œä¸éœ€è¦é‡å¯
   eglotï¼›
2. =M-x eglot-x-expand-macro= ï¼šå±•å¼€å®å®šä¹‰ï¼ˆæˆ–è€…ä½¿ç”¨ cargo expand å‘½ä»¤æ¥æ˜¾ç¤ºå®å±•å¼€åçš„
   å®šä¹‰ï¼‰ï¼›
3. =M-x eglot-x-open-external-documentation= ï¼šç”¨æµè§ˆå™¨æŸ¥çœ‹å…‰æ ‡å¤„çš„ rust æ–‡æ¡£ï¼›
#+begin_src emacs-lisp
(use-package eglot-x
  :after (eglot rust-mode)
  :vc (:url "https://github.com/nemethf/eglot-x")
  :init
  (require 'rust-ts-mode) ;; ç»‘å®š rust-ts-mode-map éœ€è¦ã€‚
  :config
  (eglot-x-setup))
#+end_src

æŸ¥çœ‹æœ¬åœ°å’Œåœ¨çº¿æ–‡æ¡£:
#+begin_src emacs-lisp
(with-eval-after-load 'rust-ts-mode
  ;; ä½¿ç”¨ xwidget æ‰“å¼€å…‰æ ‡å¤„ symbol çš„æœ¬åœ° crate æ–‡æ¡£ï¼Œç”±äºæ˜¯ web ç½‘é¡µï¼Œé“¾æ¥å’Œç±»å‹éƒ½
  ;; å¯ä»¥ç‚¹å‡»ã€‚
  (define-key rust-ts-mode-map (kbd "C-c d .") #'eglot-x-open-external-documentation)

  ;; æŸ¥çœ‹æœ¬åœ° rust std æ–‡æ¡£;
  (defun my/browser-ruststd ()
    (interactive)
    (xwidget-webkit-browse-url "file:///Users/alizj/.rustup/toolchains/stable-aarch64-apple-darwin/share/doc/rust/html/std/index.html"  t))
  (define-key rust-ts-mode-map (kbd "C-c d s") 'my/browser-ruststd)

  ;; åœ¨çº¿ https:://docs.rs/ æœç´¢æ–‡æ¡£.
  (defun my/browser-docsrs (query)
    (interactive "ssearch: ")
    (xwidget-webkit-browse-url
     (concat "https://docs.rs/releases/search?query=" (string-replace " " "%20" query)) t))
  (define-key rust-ts-mode-map (kbd "C-c d w") 'my/browser-docsrs) ;; åŠ©è®°: w -> web

  ;; åœ¨çº¿æœç´¢ crate åŒ…ã€‚
  (defun my/search-crates.io (query)
    (interactive "ssearch: ")
    (xwidget-webkit-browse-url
     (concat "https://crates.io/search?q=" (string-replace " " "%20" query)) t))
  (global-set-key (kbd "C-c d c") 'my/browser-docsrs) ;; åŠ©è®°: c -> crates.io
  )
#+end_src

cargo package ä¸å†ç»´æŠ¤, æ•…åˆ‡æ¢åˆ° cargo-mode package, å®ƒæä¾›äº† Cargo.toml ç®¡ç†å‘½ä»¤ã€‚
+ C-c a e(cargo-execute-task) ï¼šåˆ—å‡ºæ‰€æœ‰æ”¯æŒçš„ cargo taskï¼Œå¦‚ build/test ç­‰ï¼ŒåŒæ—¶å¯ä»¥
  æ·»åŠ å’Œåˆ é™¤ä¾èµ–ï¼ˆéœ€è¦æŒ‡å®š PREFIX å‘½ä»¤æ¥è¾“å…¥ä¾èµ–åç§°ï¼‰ã€‚

#+begin_src emacs-lisp
(use-package cargo-mode
  :after (rust-mode)
  :custom
  ;; cargo-mode ç¼ºçœä¸º compilation buffer ä½¿ç”¨ comint mode, è®¾ç½®ä¸º nil ä½¿ç”¨
  ;; compilationã€‚
  (cargo-mode-use-comint nil)
  :hook
  (rust-ts-mode . cargo-minor-mode)
  :config
  ;; è‡ªåŠ¨æ»šåŠ¨æ˜¾ç¤º compilation buffer å†…å®¹ã€‚
  (setq compilation-scroll-output t))
#+end_src

å…¶ä»–æŠ€å·§:
1. åˆ›å»ºä¸€ä¸ª struct å¯¹è±¡æ—¶, å¯ä»¥ä½¿ç”¨ eglot code-action æ¥è‡ªåŠ¨å¡«å……å¯¹è±¡æˆå‘˜;
3. Cargo.toml æ–‡ä»¶å‘ç”Ÿå˜åŒ–æ—¶, rust-analyzer ä¸ä¼šè‡ªåŠ¨æ›´æ–°å¤„ç†, éœ€è¦é‡å¯ eglot æ‰èƒ½è‡ªåŠ¨
   è¡¥å…¨æ–°çš„crate. ä¸¤ä¸ªè§£å†³åŠæ³•:
     1. ä½¿ç”¨ eglot-x ä¸­çš„ M-x eglot-x-reload-workspace å‘½ä»¤;
     2. æˆ–è€…å…ˆå°† =æ‰€æœ‰ä¾èµ–= æå‰æ·»åŠ åˆ° Cargo.toml æ–‡ä»¶, ç„¶åå†å¯åŠ¨ eglot;

** markdown

å®‰è£…ä¾èµ–å·¥å…·ï¼š

#+begin_src bash :tangle ~/.emacs.d/init.sh
brew install multimarkdown
pip3 install grip
#+end_src

multimarkdown å°† markdown è½¬æ¢ä¸º html è¿›è¡Œ previewï¼Œå¯ä»¥ç»“åˆ xwidget webkit æˆ– grip
è¿›è¡Œå®æ—¶é¢„è§ˆï¼š

#+begin_src emacs-lisp
(use-package markdown-mode
  :commands (markdown-mode gfm-mode)
  :mode
  (("README\\.md\\'" . gfm-mode)
   ("\\.md\\'" . markdown-mode)
   ("\\.markdown\\'" . markdown-mode))
  :init
  (when (executable-find "multimarkdown")
    (setq markdown-command "multimarkdown"))
  (setq markdown-enable-wiki-links t)
  (setq markdown-italic-underscore t)
  (setq markdown-asymmetric-header t)
  (setq markdown-make-gfm-checkboxes-buttons t)
  (setq markdown-gfm-uppercase-checkbox t)
  (setq markdown-fontify-code-blocks-natively t)
  (setq markdown-gfm-additional-languages "Mermaid")
  (setq markdown-content-type "application/xhtml+xml")
  (setq markdown-css-paths
	'("https://cdn.jsdelivr.net/npm/github-markdown-css/github-markdown.min.css"
          "https://cdn.jsdelivr.net/gh/highlightjs/cdn-release/build/styles/github.min.css"))
  (setq markdown-xhtml-header-content "
<meta name='viewport' content='width=device-width, initial-scale=1, shrink-to-fit=no'>
<style>
body {
  box-sizing: border-box;
  max-width: 740px;
  width: 100%;
  margin: 40px auto;
  padding: 0 10px;
}
</style>
<link rel='stylesheet' href='https://cdn.jsdelivr.net/gh/highlightjs/cdn-release/build/styles/default.min.css'>
<script src='https://cdn.jsdelivr.net/gh/highlightjs/cdn-release/build/highlight.min.js'></script>
<script>
document.addEventListener('DOMContentLoaded', () => {
  document.body.classList.add('markdown-body');
  document.querySelectorAll('pre code').forEach((code) => {
    if (code.className != 'mermaid') {
      hljs.highlightBlock(code);
    }
  });
});
</script>
<script src='https://unpkg.com/mermaid@8.4.8/dist/mermaid.min.js'></script>
<script>
mermaid.initialize({
  theme: 'default',  // default, forest, dark, neutral
  startOnLoad: true
});
</script>
"))
#+end_src

ä½¿ç”¨ grip æ¥é¢„è§ˆ markdown æ–‡ä»¶ï¼Œå®ƒè°ƒç”¨ github markdown API æ¥æ¸²æŸ“æ–‡ä»¶ï¼Œä»è€Œç¡®ä¿æ¸²æŸ“å
é£æ ¼å’Œ Githubä¸€è‡´ã€‚ä¸ºäº†é¿å… API è°ƒç”¨é¢‘ç‡é™åˆ¶ï¼Œå¯ä»¥åˆ›å»ºä¸€ä¸ªç©º scop çš„ Access Tokenï¼Œç„¶
åå°† username å’Œ token ä¿å­˜åˆ° =~/.authinfo.gpg= æ–‡ä»¶ä¸­ï¼š

#+begin_src bash :tangle no
machine api.github.com login geekard@qq.com password YOUR_TOKEN
#+end_src

åœ¨ Markdown Buffer ä¸­ï¼Œæ‰§è¡Œ =M-x grip-mode= æ¥å¯ç”¨å®æ—¶é¢„è§ˆï¼Œç„¶åå¯ä»¥æ‰§è¡Œå¦‚ä¸‹å‘½ä»¤ï¼š
+ M-x grip-start-preview
+ M-x grip-stop-preview
+ M-x grip-restart-preview
+ M-x grip-browse-preview
#+begin_src emacs-lisp
(use-package grip-mode
  :defer
  :after (markdown-mode)
  :config
  (setq grip-preview-use-webkit nil)
  (setq grip-preview-host "127.0.0.1")
  ;; ä¿å­˜æ–‡ä»¶æ—¶æ‰æ›´æ–°é¢„è§ˆã€‚
  (setq grip-update-after-change nil)
  ;; ä» ~/.authinfo æ–‡ä»¶è·å–è®¤è¯ä¿¡æ¯ã€‚
  (require 'auth-source)
  (let ((credential (auth-source-user-and-password "api.github.com")))
    (setq grip-github-user (car credential)
          grip-github-password (cadr credential)))
  (define-key markdown-mode-command-map (kbd "g") #'grip-mode))
#+end_src

ä¸º markdown æ–‡ä»¶æ·»åŠ ç›®å½•ï¼š
#+begin_src emacs-lisp
(use-package markdown-toc
  :after(markdown-mode)
  :config
  (define-key markdown-mode-command-map (kbd "r") #'markdown-toc-generate-or-refresh-toc))
#+end_src

** yaml

ä½¿ç”¨ emacs å†…ç½®çš„ yaml-ts-modeã€‚

å®‰è£… yaml è¯­è¨€æœåŠ¡å™¨ï¼š

#+begin_src shell :tangle no
which yaml-language-server || npm install -g yaml-language-server
#+end_src

yaml æ ¼å¼è¯´æ˜ï¼š
1. ä¸ä½¿ç”¨ TAB è€Œä½¿ç”¨ç©ºæ ¼ç¼©è¿›ï¼›
2. å¯¹äºå¤šè¡Œå­—ç¬¦ä¸²ï¼Œä½¿ç”¨ name: | æ ¼å¼ï¼Œåç»­ç¬¬ä¸€è¡Œç¼©è¿›å¿…é¡»å¤§äº name: æ‰€åœ¨è¡Œï¼Œè€Œä¸”ä»¥åç»­
   ä»¥ç¬¬ä¸€è¡Œç¼©è¿›ä¸ºå‡†æ¥åˆ é™¤åç»­å„è¡Œå‰é¢çš„ç©ºç™½ï¼Œæ‰€ä»¥å„è¡Œçš„ç¼©è¿›å¿…é¡»å¤§äºç­‰äºç¬¬ä¸€è¡Œçš„ç¼©è¿›ï¼Œ
   è¶…è¿‡çš„éƒ¨åˆ†ç©ºç™½å¾—ä»¥ä¿ç•™ï¼›

** shell

Emacs ä½¿ç”¨ =bash-ts-mode= æ¥ç¼–è¾‘ shell è„šæœ¬ã€‚

å®‰è£… bash language server:

#+begin_src bash :tangle ~/.emacs.d/init.sh
npm i -g bash-language-server
#+end_src

bash language server ä½¿ç”¨ shellcheck å·¥å…·æ¥åšè¯­æ³•æ£€æŸ¥å’Œé™æ€åˆ†æ:

#+begin_src bash ~/.emacs.d/init.sh
brew install shellcheck
#+end_src

è®¾ç½®è„šæœ¬ç¼©è¿›è§„åˆ™ï¼š
#+begin_src emacs-lisp
(setq sh-basic-offset 4)
(setq sh-indentation 4)
#+end_src

å‚è€ƒï¼š
1. [[https://google.github.io/styleguide/shellguide.html][Google Shell Style Guide]]

** clang

å®‰è£… llvm/clang/clang-format åŒ…:

#+begin_src bash :tangle ~/.emacs.d/init.sh
brew install llvm lld clang-format

export LDFLAGS="-L/opt/homebrew/opt/llvm/lib"
export CPPFLAGS="-I/opt/homebrew/opt/llvm/include"
export PATH="/opt/homebrew/opt/llvm/bin:$PATH"

# æ‰“å°æ ¼å¼åŒ–é…ç½®å‚æ•°
clang-format --dump-config
#+end_src

å°† llvm bin ç›®å½•æ·»åŠ åˆ° emacsï¼š

#+begin_src emacs-lisp
(setq my-llvm-path "/opt/homebrew/opt/llvm/bin")
(setenv "PATH" (concat my-llvm-path ":" (getenv "PATH")))
(setq exec-path (cons my-llvm-path  exec-path))
#+end_src

åˆ›å»ºå…¨å±€ ~/.clang-format æ–‡ä»¶ï¼Œä¹Ÿå¯ä»¥åœ¨å„ project root ç›®å½•åˆ›å»ºé¡¹ç›®é…ç½®æ–‡ä»¶ï¼Œä¸»è¦é…ç½®
çš„æ˜¯ï¼š
1. Tab å’Œ Indent ç¼©è¿›ï¼›
2. ä¸å¯¹å¤´æ–‡ä»¶è¿›è¡Œæ’åºï¼Œé˜²æ­¢ç¼–è¯‘æŠ¥é”™ï¼›

#+begin_src text :tangle ~/.clang-format
# clang-format configuration file. Intended for clang-format >= 11.
#
# For more information, see:
#
#   Documentation/process/clang-format.rst
#   https://clang.llvm.org/docs/ClangFormat.html
#   https://clang.llvm.org/docs/ClangFormatStyleOptions.html

# linux å†…æ ¸å¼€å‘é£æ ¼ï¼š
# https://raw.githubusercontent.com/torvalds/linux/master/.clang-format
---
# åŸºæœ¬é…ç½®
DisableFormat: false
Language:        Cpp  # å¯ä»¥æ˜¯ 'Cpp', 'Java', 'JavaScript', 'Proto', 'TableGen' ç­‰ç­‰
BasedOnStyle:    WebKit  # åŸºäº WebKit é£æ ¼ï¼Œå› ä¸ºå®ƒæœ€æ¥è¿‘ Linux å†…æ ¸çš„é£æ ¼

# ç¼©è¿›
IndentWidth:     8  # ç¼©è¿›å®½åº¦
TabWidth:        8  # åˆ¶è¡¨ç¬¦å®½åº¦
UseTab:          ForIndentation  # ä½¿ç”¨åˆ¶è¡¨ç¬¦è¿›è¡Œç¼©è¿›ï¼Œç©ºæ ¼ç”¨äºå¯¹é½

# æ¢è¡Œ
AllowShortIfStatementsOnASingleLine: false  # ç¦æ­¢ if è¯­å¥åœ¨å•è¡Œå†…
AllowShortLoopsOnASingleLine: false  # ç¦æ­¢å¾ªç¯è¯­å¥åœ¨å•è¡Œå†…
AlwaysBreakBeforeMultilineStrings: true  # å¤šè¡Œå­—ç¬¦ä¸²ä¹‹å‰æ€»æ˜¯æ¢è¡Œ
BreakBeforeBraces: Linux  # ä½¿ç”¨ Linux é£æ ¼çš„å¤§æ‹¬å·ä½ç½®
ColumnLimit: 100  # æ¯è¡Œçš„å­—ç¬¦é™åˆ¶

# ç©ºæ ¼
SpaceBeforeParens: ControlStatements  # åœ¨æ§åˆ¶è¯­å¥çš„æ‹¬å·å‰åŠ ç©ºæ ¼ï¼ˆif, for, while, ç­‰ï¼‰
SpaceAfterCStyleCast: true  # C é£æ ¼çš„å¼ºåˆ¶ç±»å‹è½¬æ¢ååŠ ç©ºæ ¼

# æ³¨é‡Š
CommentPragmas: '^ IWYU pragma:'  # æ”¯æŒ IWYU pragmas æ³¨é‡Š
IndentExternBlock: AfterExternBlock  # åœ¨ extern "C" å—åè¿›è¡Œç¼©è¿›

# åŒ…å«æ–‡ä»¶
SortIncludes: false  # ç¦ç”¨å¤´æ–‡ä»¶æ’åºï¼Œé˜²æ­¢ç¼–è¯‘å‡ºé”™ã€‚
IncludeBlocks: Preserve  # ä¿æŒå¤´æ–‡ä»¶åˆ†ç»„

# å‡½æ•°å®šä¹‰
AlignTrailingComments: true  # å°¾éƒ¨æ³¨é‡Šå¯¹é½
AlignConsecutiveDeclarations: true  # è¿ç»­çš„å£°æ˜å¯¹é½

# å…¶ä»–
NamespaceIndentation: All  # æ‰€æœ‰å‘½åç©ºé—´å†…çš„ä»£ç éƒ½ç¼©è¿›
ReflowComments: true  # é‡æ–°æ ¼å¼åŒ–æ³¨é‡Š

# ç‰¹å®šäº C è¯­è¨€çš„è®¾ç½®
Standard:        Cpp11  # ä½¿ç”¨ C++11 æ ‡å‡†
#+end_src

** tempel

#+begin_src emacs-lisp
(use-package tempel
  :bind
  (("M-+" . tempel-complete)
   ("M-*" . tempel-insert))
  :init
  ;; è‡ªå®šä¹‰æ¨¡æ¿æ–‡ä»¶ã€‚
  (setq tempel-path "/Users/alizj/emacs/templates")
  (add-hook 'conf-mode-hook 'tempel-setup-capf)
  (add-hook 'prog-mode-hook 'tempel-setup-capf)
  (add-hook 'text-mode-hook 'tempel-setup-capf)

  (defun tempel-setup-capf ()
    (setq-local completion-at-point-functions (cons #'tempel-expand completion-at-point-functions)))
  ;; ç¡®ä¿ tempel-setup-capf ä½äº eglot-managed-mode-hook å‰ï¼Œè¿™æ · corfu æ‰ä¼šæ˜¾ç¤º
  ;; tempel çš„è‡ªåŠ¨è¡¥å…¨ã€‚
  ;; https://github.com/minad/tempel/issues/103#issuecomment-1543510550
  (add-hook #'eglot-managed-mode-hook 'tempel-setup-capf))

(use-package tempel-collection)
#+end_src

** compilation

#+begin_src emacs-lisp
;; https://gitlab.com/skybert/my-little-friends/-/blob/master/emacs/.emacs#L295
(setq compilation-ask-about-save nil
      compilation-always-kill t
      compilation-scroll-output 'first-error ;; æ»šåŠ¨æ˜¾ç¤ºåˆ°ç¬¬ä¸€ä¸ªå‡ºé”™ä½ç½®ã€‚
      compilation-context-lines 10
      compilation-skip-threshold 2
      ;;compilation-window-height 100
      )

(define-key compilation-mode-map (kbd "q") 'delete-window)

;; æ˜¾ç¤º shell è½¬ä¹‰å­—ç¬¦çš„é¢œè‰²ã€‚
(add-hook 'compilation-filter-hook
          (lambda ()
	    (ansi-color-apply-on-region (point-min) (point-max))))

;; ç¼–è¯‘ç»“æŸä¸”å¤±è´¥æ—¶è‡ªåŠ¨åˆ‡æ¢åˆ° compilation bufferã€‚
(setq compilation-finish-functions
      (lambda (buf str)
        (if (null (string-match ".*exited abnormally.*" str))
            ;; æ²¡æœ‰é”™è¯¯, ä»€ä¹ˆä¹Ÿä¸åšã€‚
            nil
          ;; æœ‰é”™è¯¯æ—¶åˆ‡æ¢åˆ° compilation bufferã€‚
          (switch-to-buffer-other-window buf)
          (end-of-buffer))))
#+end_src

** citre

citre æ˜¯åŸºäº Ctagsï¼ˆUniversal Ctags ç‰ˆæœ¬ï¼‰çš„ä»£ç æµè§ˆå™¨å·¥å…·ï¼Œä¹Ÿæ”¯æŒ[[https://github.com/universal-ctags/citre/blob/master/docs/user-manual/citre-global.md][é›†æˆä½¿ç”¨ GNU global
çš„ GTAGS æ–‡ä»¶]]ã€‚

å®‰è£… GNU global å’Œ pygments, global ä¾èµ–å¹¶è‡ªåŠ¨å®‰è£… universal-ctags, é€šè¿‡ pygments èƒ½
ç”Ÿæˆæ›´ä¸°å¯Œçš„TAG å†…å®¹ï¼ŒåŒæ—¶æ”¯æŒ reference æœç´¢ã€‚
+ https://github.com/universal-ctags/citre/blob/master/docs/user-manual/citre-global.md
+ global é»˜è®¤ä½¿ç”¨ brew å®‰è£…çš„ python@3.12 å’Œ pygments, è€Œä¸èƒ½ç›´æ¥ä½¿ç”¨ pip install
  pygments.

#+begin_src bash :tangle ~/.emacs.d/init.sh
brew install global pygments # æä¾› globalã€gtags å‘½ä»¤, gtags ä½¿ç”¨ pygments æ”¯æŒå¤šè¯­è¨€

# åœ¨ ~/.bashrc ä¸­æ·»åŠ å¦‚ä¸‹é…ç½®ï¼š
# ç»Ÿä¸€çš„ tags æ–‡ä»¶ç›®å½•
export GTAGSOBJDIRPREFIX=~/.cache/gtags/
mkdir $GTAGSOBJDIRPREFIX
export GTAGSCONF=/opt/homebrew/opt/global/share/gtags/gtags.conf
# ä½¿ç”¨ pygments æ”¯æŒæ›´å¤šçš„è¯­è¨€ï¼Œæ”¯æŒ reference æœç´¢ã€‚
export GTAGSLABEL=pygments
#+end_src

åˆ›å»ºå’Œæ›´æ–° GNU global GTAGS æ–‡ä»¶ï¼ˆä¿å­˜åˆ° GTAGSOBJDIRPREFIX ç¯å¢ƒå˜é‡æŒ‡å®šçš„ä½ç½®ï¼Œå¦‚
~/.cache/gtags/)ï¼š
+ M-x citre-global-create-database
+ M-x citre-global-update-database

#+begin_src shell :tangle no
zj@a:~/.cache/gtags/Users/alizj/go/src/**/bp-agent$ ls -l
total 2.8M
-rw-r--r-- 1 alizj  32K  3 30 11:53 GPATH
-rw-r--r-- 1 alizj 600K  3 30 11:53 GRTAGS  # reference tags
-rw-r--r-- 1 alizj 1.9M  3 30 11:53 GTAGS   # tags
#+end_src

æ³¨æ„ï¼šä»¥ä¸‹ä¸¤ä¸ªå‘½ä»¤åˆ›å»º Universal Ctags çš„ ctags æ–‡ä»¶ï¼ˆé¡¹ç›®æœ‰ .tags/ ç›®å½•æˆ– .tags æˆ–
tags æ–‡ä»¶ï¼‰ï¼Œè€Œé GNU global GTAGS æ–‡ä»¶ï¼Œä¸æ”¯æŒ referencesï¼Œæ•…ä¸å»ºè®®ä½¿ç”¨ï¼š
+ M-x citre-create-tags-file
+ M-x citre-update-tags-file

å¦‚æœè¯¯ä½¿ç”¨äº†ä¸Šé¢çš„å‘½ä»¤åˆ›å»º ctags æ–‡ä»¶åˆ™åç»­ä½¿ç”¨ xref-find-references ä¼š hangï¼Œéœ€è¦åˆ 
é™¤ã€‚

å¯¹äºå¼€å¯äº† citre-mode çš„ bufferï¼Œcitre å‘ xref-backend-functions ä¸­æ·»åŠ 
citre-xref-backend, è€Œä¸”ä½äºåˆ—è¡¨çš„å¼€å§‹ï¼Œè¿™æ · xref å…ˆä½¿ç”¨ citre-xref-backendï¼Œå½“æ— è¿”å›
ç»“æœæ—¶å†æŸ¥æ‰¾å…¶å®ƒæ³¨å†Œçš„ xref backend å¦‚eglot-xref-backend ç­‰ã€‚
+ xref-backend-functions å¯èƒ½ä¼šè¢«æ·»åŠ å¤šä¸ª backendï¼Œä½† xref ä½¿ç”¨ç¬¬ä¸€ä¸ªè¿”å›éç©ºæ•°æ®çš„ backendï¼Œè€Œå¿½
  ç•¥åç»­ backendã€‚

æ–°ç‰ˆæœ¬çš„ citre-xref-backend æ”¯æŒè‡ªåŠ¨é›†æˆ eglotï¼Œå®ƒå…ˆä½¿ç”¨ eglot çš„ç»“æœï¼Œå¦‚æœä¸ºç©ºï¼Œå†ä½¿
ç”¨ tags æ–‡ä»¶çš„ç»“æœä½œä¸ºåå¤‡ï¼Œæ‰€ä»¥ä¸ç®¡é¡¹ç›®æ˜¯å¦å­˜åœ¨ tags æ–‡ä»¶ï¼Œéƒ½å¯ä»¥ä¸ºæ‰€æœ‰ prog-mode å¼€
å¯ citre-modeã€‚

å…¶ä»– xref ç‰¹æ€§ï¼Œå¦‚ imenu/xref-find-references/xref-find-definitions ç­‰éƒ½ä¼šä½¿ç”¨ citre
æä¾›çš„è¾“å…¥ã€‚åŒæ—¶ xref å’Œ consult ç»“åˆï¼Œå¯ä»¥ä½¿ç”¨ consult æ¥é¢„è§ˆ xref çš„ç»“æœã€‚

é…ç½® citreï¼š

#+begin_src emacs-lisp
(setenv "GTAGSOBJDIRPREFIX" (expand-file-name "~/.cache/gtags/"))
(setenv "GTAGSCONF" (car (file-expand-wildcards "/opt/homebrew/opt/global/share/gtags/gtags.conf")))
(setenv "GTAGSLABEL" "pygments")

(use-package citre
  :after (eglot)
  :config
  ;; åªä½¿ç”¨æ”¯æŒ reference çš„ GNU Global tagsã€‚
  (setq citre-completion-backends '(global))
  (setq citre-find-definition-backends '(global))
  (setq citre-find-reference-backends '(global))
  (setq citre-tags-in-buffer-backends  '(global))
  (setq citre-auto-enable-citre-mode-backends '(global))
  (setq citre-use-project-root-when-creating-tags t)
  (setq citre-peek-file-content-height 20)

  ;; æ‰“å¼€åˆ—è¡¨ä¸­çš„ major mode æ–‡ä»¶ä¸”é¡¹ç›®å…·æœ‰ global tags æ–‡ä»¶æ—¶ï¼Œæ‰è‡ªåŠ¨å¼€å¯ citreã€‚
  (setq citre-auto-enable-citre-mode-modes
	'(
	  c-mode
	  c-ts-mode
	  rust-mode
	  rust-ts-mode
	  ;; go-mode
	  ;; go-ts-mode
	  ))

  ;; ä½¿ç”¨ eglot-managed-mode-hook è€Œé find-file-hookï¼Œä»è€Œç¡®ä¿ citre-mode åœ¨ eglot
  ;; å¯åŠ¨åæ‰å¼€å¯ã€‚

  ;; æ‰§è¡Œ citre-auto-enable-citre-mode è€Œé citre-mode å‘½ä»¤ï¼š

  ;; 1. å‰è€…ä¼šæ£€æŸ¥ citre-auto-enable-citre-mode-modes å˜é‡ä¸­çš„ major mode å’Œé¡¹ç›®æ˜¯å¦
  ;; æœ‰ global tagsæ–‡ä»¶ï¼Œåªæœ‰ä¸¤è€…å‡æ»¡è¶³æ—¶ï¼Œæ‰å¼€å¯ citreã€‚

  ;; 2. åè€…æ˜¯ä¸ç®¡ major mode ç±»å‹å’Œæ˜¯å¦æœ‰ tags æ–‡ä»¶ï¼Œå‡å¼€å¯ citreã€‚
  (add-hook 'eglot-managed-mode-hook #'citre-auto-enable-citre-mode)

  (define-key citre-mode-map (kbd "s-.") 'citre-jump)
  (define-key citre-mode-map (kbd "s-,") 'citre-jump-back)
  (define-key citre-mode-map (kbd "s-?") 'citre-peek-reference)
  (define-key citre-mode-map (kbd "s-p") 'citre-peek)
  (define-key citre-peek-keymap (kbd "s-n") 'citre-peek-next-line)
  (define-key citre-peek-keymap (kbd "s-p") 'citre-peek-prev-line)
  (define-key citre-peek-keymap (kbd "s-N") 'citre-peek-next-tag)
  (define-key citre-peek-keymap (kbd "s-P") 'citre-peek-prev-tag))
#+end_src

* gptel

#+begin_src emacs-lisp
(use-package gptel
  :ensure t
  :config
  (setq
   gptel-default-mode 'org-mode
   gptel-model 'gpt-4o
   gptel-backend
   (gptel-make-azure "Azure"         
     :protocol "https"
     :host "westus3ai.openai.azure.com"
     :endpoint "/openai/deployments/4fouro/chat/completions?api-version=2024-02-15-preview" ;or equivalent
     :stream t        
     :key #'gptel-api-key
     :models '(gpt-4o))
   ))
#+end_src

åœ¨ ~/.authinfo.gpg ä¸­æ·»åŠ  api.openai.com keyï¼Œç„¶åä½¿ç”¨æœ¬åœ° socks5h ä»£ç†è®¿é—® APIã€‚
+ azure å„ region çš„è®¿é—®é€Ÿåº¦æµ‹è¯•ï¼šhttps://www.azurespeed.com/Azure/Latency
+ åˆ‡æ¢ promptï¼šM-x chatgpt-shell-swap-system-prompt

#+begin_src emacs-lisp
;; (use-package shell-maker)
;; (use-package ob-chatgpt-shell :defer t)
;; (use-package ob-dall-e-shell :defer t)
;; (use-package chatgpt-shell
;;   :requires shell-maker
;;   :defer t
;;   :config
;;   (setq chatgpt-shell-model-version "gpt-4o")
;;   (setq chatgpt-shell-model-temperature 0.7)
;;   (setq chatgpt-shell-request-timeout 300)
;;   (setq chatgpt-shell-highlight-blocks t)
;;   (setq chatgpt-shell-insert-queries-inline t)
;;   (setq chatgpt-shell-chatgpt-streaming t)
;;   (setq chatgpt-shell-system-prompt 2) ;; é»˜è®¤ä½¿ç”¨ Programming prompt

;;   ;; (setq chatgpt-shell-system-prompts
;;   ;;   `(("tl;dr" . "Be as succint but informative as possible and respond in tl;dr form to my queries")
;;   ;;     ("General" . "You use org-mode format to structure responses. Always show code snippets in org-mode source code block format.")
;;   ;;     ;; Based on https://github.com/benjamin-asdf/dotfiles/blob/8fd18ff6bd2a1ed2379e53e26282f01dcc397e44/mememacs/.emacs-mememacs.d/init.el#L768
;;   ;;     ("Programming" . ,(chatgpt-shell--append-system-info
;;   ;; 			 "The user is a programmer with very limited time.
;;   ;;                       You treat their time as precious. You do not repeat obvious things, including their query.
;;   ;;                       You are as concise as possible in responses.
;;   ;;                       You never apologize for confusions because it would waste their time.
;;   ;;                       You use emacs org-mode format to structure responses.
;;   ;;                       Always show code snippets in org-mode source code block format.
;;   ;;                       Don't explain code snippets.
;;   ;;                       Whenever you output updated code for the user, only show diffs, instead of entire snippets."))
;;   ;;     ("Positive Programming" . ,(chatgpt-shell--append-system-info
;;   ;;                                 "Your goal is to help the user become an amazing computer programmer.
;;   ;;                       You are positive and encouraging.
;;   ;;                       You love see them learn.
;;   ;;                       You do not repeat obvious things, including their query.
;;   ;;                       You are as concise in responses. You always guide the user go one level deeper and help them see patterns.
;;   ;;                       You never apologize for confusions because it would waste their time.
;;   ;;                       You use markdown liberally to structure responses. Always show code snippets in markdown blocks with language labels.
;;   ;;                       Don't explain code snippets. Whenever you output updated code for the user, only show diffs, instead of entire snippets."))))

;;   (require 'ob-chatgpt-shell)
;;   (ob-chatgpt-shell-setup)
;;   (require 'ob-dall-e-shell)
;;   (ob-dall-e-shell-setup)
;;   ;;(setq chatgpt-shell-api-url-base "http://127.0.0.1:1090")
;;   (setq chatgpt-shell-api-url-base "https://westus3ai.openai.azure.com")
;;   (setq chatgpt-shell-api-url-path  "/openai/deployments/4fouro/chat/completions?api-version=2024-02-15-preview")
;;   (setq chatgpt-shell-openai-key (auth-source-pick-first-password :host "westus3ai.openai.azure.com"))
;;   ;; azure ä½¿ç”¨ api-key è€Œé openai çš„ Authorization: Bearer è®¤è¯å¤´éƒ¨ã€‚
;;   (setq chatgpt-shell-auth-header
;; 	(lambda ()
;; 	  (format "api-key: %s" (auth-source-pick-first-password :host "westus3ai.openai.azure.com"))))
;;   )
#+end_src

* ç»ˆç«¯

å®‰è£… vterm ä¾èµ–:

#+begin_src bash :tangle ~/.emacs.d/init.sh
brew install cmake libtool exiftran
#+end_src

é…ç½® vterm:

#+begin_src emacs-lisp
(use-package vterm
  :hook
  (vterm-mode . (lambda ()
		  ;; å…³é—­ä¸€äº› modeï¼Œæå‡æ˜¾ç¤ºæ€§èƒ½ã€‚
		  (setf truncate-lines nil)
		  (setq-local show-paren-mode nil)
		  (setq-local global-hl-line-mode nil)
	          (display-line-numbers-mode -1) ;; ä¸æ˜¾ç¤ºè¡Œå·ã€‚
		  ;;; vterm buffer ä½¿ç”¨ fixed pitch çš„ mono å­—ä½“ï¼Œå¦åˆ™éƒ¨åˆ†ç»ˆç«¯è¡¨æ ¼ä¹‹
		  ;;; ç±»çš„ç¨‹åºä¼šå¯¹ä¸é½ã€‚
		  (set (make-local-variable 'buffer-face-mode-face) 'fixed-pitch)
		  (buffer-face-mode t)))
  :config
  (setq vterm-set-bold-hightbright t)
  (setq vterm-always-compile-module t)
  (setq vterm-max-scrollback 100000)
  (setq vterm-timer-delay 0.01) ;; nil: no delay
  (add-to-list 'vterm-tramp-shells '("ssh" "/bin/bash"))
  ;; vterm buffer åç§°ï¼Œ%s ä¸º shell çš„ PROMPT_COMMAND å˜é‡çš„è¾“å‡ºã€‚
  (setq vterm-buffer-name-string "*vt: %s")
  ;; ä½¿ç”¨ M-y(consult-yank-pop) ç²˜è´´å‰ªè´´æ¿å†å²ä¸­çš„å†…å®¹ã€‚
  (define-key vterm-mode-map [remap consult-yank-pop] #'vterm-yank-pop)
  (define-key vterm-mode-map (kbd "C-l") nil)
  ;; é˜²æ­¢è¾“å…¥æ³•åˆ‡æ¢å†²çªã€‚
  (define-key vterm-mode-map (kbd "C-\\") nil))

(use-package multi-vterm
  :after (vterm)
  :config
  (define-key vterm-mode-map  [(control return)] #'multi-vterm))
#+end_src

vterm-toggle:

#+begin_src emacs-lisp
(use-package vterm-toggle
  :after (vterm)
  :custom
  ;; ç”±äº TRAMP æ¨¡å¼ä¸‹å…³é—­äº† projectileï¼Œscope ä¸èƒ½è®¾ç½®ä¸º 'projectã€‚
  ;;(vterm-toggle-scope 'dedicated)
  (vterm-toggle-scope 'project)
  :config
  (global-set-key (kbd "C-`") 'vterm-toggle)
  (global-set-key (kbd "C-M-`") 'vterm-toggle-cd)
  (define-key vterm-mode-map (kbd "M-RET") #'vterm-toggle-insert-cd)
  ;; åˆ‡æ¢åˆ°ç©ºé—²çš„ vterm buffer å¹¶æ’å…¥ä¸€ä¸ª cd å‘½ä»¤ï¼Œæˆ–è€…åˆ›å»ºä¸€ä¸ªæ–°çš„ vterm bufferã€‚
  (define-key vterm-mode-map (kbd "M-i") 'vterm-toggle-cd-show)
  (define-key vterm-mode-map (kbd "M-n") 'vterm-toggle-forward)
  (define-key vterm-mode-map (kbd "M-p") 'vterm-toggle-backward)
  (define-key vterm-copy-mode-map (kbd "M-i") 'vterm-toggle-cd-show)
  (define-key vterm-copy-mode-map (kbd "M-n") 'vterm-toggle-forward)
  (define-key vterm-copy-mode-map (kbd "M-p") 'vterm-toggle-backward))
#+end_src

vterm-extra æä¾›äº† vterm buffer å‘½ä»¤è¡Œç¼–è¾‘çš„èƒ½åŠ›ï¼Œç»“æŸåæŒ‰ C-c C-c è‡ªåŠ¨ç²˜è´´åˆ°å¯¹åº”çš„ vterm ä¸­ï¼š

#+begin_src emacs-lisp
(use-package vterm-extra
  :vc (:url "https://github.com/Sbozzolo/vterm-extra")
  :config
  (define-key vterm-mode-map (kbd "C-c C-e") #'vterm-extra-edit-command-in-new-buffer))
#+end_src

eshell:

#+begin_src emacs-lisp
(setq eshell-history-size 300)
(setq explicit-shell-file-name "/bin/bash")
(setq shell-file-name "/bin/bash")
(setq shell-command-prompt-show-cwd t)
(setq explicit-bash-args '("--noediting" "--login" "-i"))
;; æç¤ºç¬¦åªè¯»
(setq comint-prompt-read-only t)
;; å‘½ä»¤è¡¥å…¨
(setq shell-command-completion-mode t)
;; é«˜äº®æ¨¡å¼
(autoload 'ansi-color-for-comint-mode-on "ansi-color" nil t)
(add-hook 'shell-mode-hook 'ansi-color-for-comint-mode-on t)
(setenv "SHELL" shell-file-name)
(setenv "ESHELL" "bash")
(add-hook 'comint-output-filter-functions 'comint-strip-ctrl-m)

;; åœ¨å½“å‰ frame ä¸‹æ–¹æ‰“å¼€æˆ–å…³é—­ eshell bufferã€‚
(defun startup-eshell ()
  "Fire up an eshell buffer or open the previous one"
  (interactive)
  (if (get-buffer-window "*eshell*<42>")
      (delete-window (get-buffer-window "*eshell*<42>"))
    (progn
      (eshell 42))))
(global-set-key (kbd "s-`") 'startup-eshell)

(add-to-list 'display-buffer-alist
	     '("\\*eshell\\*<42>"
	       (display-buffer-below-selected display-buffer-at-bottom)
	       (inhibit-same-window . t)
	       (window-height . 0.33)))

;; eshell history ä½¿ç”¨ consult-historyã€‚
(load-library "em-hist.el")
(keymap-set eshell-hist-mode-map "C-s" #'consult-history)
(keymap-set eshell-hist-mode-map "C-r" #'consult-history)
;; é‡ç½® M-r/s å¿«æ·é”®ï¼Œè¿™æ · consult-line ç­‰å¯ç”¨ã€‚
(define-key eshell-hist-mode-map (kbd "M-r") nil)
(define-key eshell-hist-mode-map (kbd "M-s") nil)
#+end_src

* å…¶å®ƒ

ä½¿ç”¨ GNU ç³»åˆ—æ›¿æ¢ MacOS è‡ªå¸¦çš„ BSD é£æ ¼çš„ coreutils åŒ…ï¼š

#+begin_src bash :tangle  ~/.emacs.d/init.sh
which tac || brew install coreutils
which trash || brew install trash
#+end_src

#+begin_src emacs-lisp
;; é¿å… undo-more: No further undo information æŠ¥é”™.
;; 10X bump of the undo limits to avoid issues with premature.
;; Emacs GC which truncages the undo history very aggresively
(setq undo-limit 800000)
(setq undo-strong-limit 12000000)
(setq undo-outer-limit 120000000)

(global-auto-revert-mode 1)
(setq revert-without-query (list "\\.png$" "\\.svg$")
      auto-revert-verbose nil)

(setq global-mark-ring-max 600)
(setq mark-ring-max 600)
(setq kill-ring-max 600)

(use-package emacs
  :init
  ;; ç²˜è´´äºå…‰æ ‡å¤„, è€Œä¸æ˜¯é¼ æ ‡æŒ‡é’ˆå¤„ã€‚
  (setq mouse-yank-at-point t)
  (setq initial-major-mode 'fundamental-mode)
  ;; æŒ‰ä¸­æ–‡æŠ˜è¡Œã€‚
  (setq word-wrap-by-category t)
  ;; é€€å‡ºè‡ªåŠ¨æ€æ‰è¿›ç¨‹ã€‚
  (setq confirm-kill-processes nil)
  (setq use-short-answers t)
  (setq confirm-kill-emacs #'y-or-n-p)
  (setq ring-bell-function 'ignore)
  ;; ä¸æ˜¾ç¤ºè¡Œå·, å¦åˆ™é¼ æ ‡ä¼šé£˜ã€‚
  (add-hook 'artist-mode-hook (lambda () (display-line-numbers-mode -1)))
  ;; bookmark å‘ç”Ÿå˜åŒ–æ—¶è‡ªåŠ¨ä¿å­˜ï¼ˆé»˜è®¤æ˜¯ Emacs æ­£å¸¸é€€å‡ºæ—¶ä¿å­˜ï¼‰ã€‚
  (setq bookmark-save-flag 1)
  ;; ä¸åˆ›å»º lock æ–‡ä»¶ã€‚
  (setq create-lockfiles nil)
  ;; å¯åŠ¨ Server ã€‚
  (unless (and (fboundp 'server-running-p)
               (server-running-p))
    (server-start)))

(use-package hydra :commands defhydra)
#+end_src
+ å‚è€ƒï¼š [[https://www.masteringemacs.org/article/mastering-key-bindings-emacs][Mastering Key Bindings in Emacs]]

å†å²è®°å½•:
#+begin_src emacs-lisp
(use-package recentf
  :config
  (setq recentf-save-file "~/.emacs.d/recentf")

  ;; è‡ªåŠ¨æ¸…ç† recentf è®°å½•ï¼ˆæ— æ•ˆçš„ã€é‡å¤çš„ã€è¢« exclude çš„ç­‰ï¼‰ï¼Œé˜²æ­¢å·²ç»åˆ é™¤çš„æ–‡ä»¶ç»§ç»­
  ;; å‡ºç°åœ¨ consult-buffer åˆ—è¡¨ä¸­
  (setq recentf-auto-cleanup 'mode)

  ;; æ¯ 5min ä»¥åŠ emacs é€€å‡ºæ—¶ä¿å­˜ recentf-listã€‚
  ;; 20241017: é…ç½®è¿™ä¸¤ä¸ªå‚æ•°åï¼Œrecentf å°†è¢«æ¸…ç©ºã€‚
  ;;(run-at-time nil (* 5 60) 'recentf-save-list)
  ;;(add-hook 'kill-emacs-hook #'recentf-save-list)

  (setq recentf-max-menu-items 100)
  (setq recentf-max-saved-items 100)

  ;; recentf-exclude çš„å‚æ•°æ˜¯æ­£åˆ™è¡¨è¾¾å¼åˆ—è¡¨ï¼Œä¸æ”¯æŒ ~ å¼•ç”¨å®¶ç›®å½•ã€‚
  ;;; emacs-dashboard ä¸æ˜¾ç¤ºè¿™é‡Œæ’é™¤çš„æ–‡ä»¶ã€‚
  (setq recentf-exclude
	`(
	  ,(recentf-expand-file-name "~/.emacs.d/\\(straight\\|ln-cache\\|etc\\|var\\|.cache\\|backup\\|elfeed\\)/.*")
          ,(recentf-expand-file-name "~/.emacs.d/\\(recentf\\|bookmarks\\|archived.org\\)")
	  ,(recentf-expand-file-name "~/go/mod/.*")
	  ;; ä¸åœ¨ recentf ä¸­è®°å½• tramp æ–‡ä»¶ï¼Œé˜²æ­¢ tramp æ‰«ææ—¶å¡ä½ã€‚
          ,tramp-file-name-regexp
          "^/tmp"
	  "\\.bak\\'"
	  "\\.gpg\\'"
	  "\\.gz\\'"
	  "\\.tgz\\'"
	  "\\.xz\\'"
	  "\\.zip\\'"
	  "^/ssh:"
	  "\\.png\\'"
          "\\.jpg\\'"
	  "/\\.git/"
	  "\\.gitignore\\'"
	  "\\.log\\'"
	  "COMMIT_EDITMSG"
	  "\\.pyi\\'"
	  "\\.pyc\\'"
          "/private/var/.*"
	  "^/usr/local/Cellar/.*"
	  ".*/vendor/.*"
	  ".*/target/.*"
	  "/Applications/.*"
          ,(concat package-user-dir "/.*-autoloads\\.egl\\'")))
  (recentf-mode 1))
#+end_src

dired:

#+begin_src emacs-lisp
;; dired
(setq my-coreutils-path "/opt/homebrew/opt/coreutils/libexec/gnubin")
(setenv "PATH" (concat my-coreutils-path ":" (getenv "PATH")))
(setq exec-path (cons my-coreutils-path  exec-path))

(use-package emacs
  :config
  (setq dired-dwim-target t)
  ;; @see
  ;; https://emacs.stackexchange.com/questions/5649/sort-file-names-numbered-in-dired/5650#5650
  ;; ä¸‹é¢çš„å‚æ•°åªå¯¹å®‰è£…äº† coreutils (brew install coreutils) çš„åŒ…æœ‰æ•ˆï¼Œå¦åˆ™ä¼šæŠ¥é”™ã€‚
  (setq dired-listing-switches "-laGh1v --group-directories-first"))

(use-package diredfl :config (diredfl-global-mode))
#+end_src

æœç´¢ grep/isearch:

#+begin_src emacs-lisp
(use-package grep
  :config
  (setq grep-highlight-matches t)
  (setq grep-find-ignored-directories
        (append (list ".git" ".cache" "vendor" "node_modules" "target")
                grep-find-ignored-directories))
  (setq grep-find-ignored-files
        (append (list "*.blob" "*.gz" "TAGS" "projectile.cache" "GPATH" "GRTAGS" "GTAGS" "TAGS" ".project" )
                grep-find-ignored-files)))

(global-set-key "\C-cn" 'find-dired)
(global-set-key "\C-cN" 'grep-find)

(setq isearch-allow-scroll 'unlimited)
;; æ˜¾ç¤ºå½“å‰å’Œæ€»çš„æ•°é‡ã€‚
(setq isearch-lazy-count t)
(setq isearch-lazy-highlight t)
#+end_src

diff/ediff:

#+begin_src emacs-lisp
;; diff
(use-package diff-mode
  :init
  (setq diff-default-read-only t)
  (setq diff-advance-after-apply-hunk t)
  (setq diff-update-on-the-fly t))

(use-package ediff
  :config
  (setq ediff-keep-variants nil)
  (setq ediff-split-window-function 'split-window-horizontally)
  ;; ä¸åˆ›å»ºæ–°çš„ frame æ¥æ˜¾ç¤º Control-Panelã€‚
  (setq ediff-window-setup-function #'ediff-setup-windows-plain))
#+end_src

å‰ªè´´æ¿å’Œå­—ç¬¦ç¼–ç :

#+begin_src emacs-lisp
;; ä½¿ç”¨ç³»ç»Ÿå‰ªè´´æ¿ï¼Œå®ç°ä¸å…¶å®ƒç¨‹åºç›¸äº’ç²˜è´´ã€‚
(setq x-select-enable-clipboard t)
(setq select-enable-clipboard t)
(setq x-select-enable-primary t)
(setq select-enable-primary t)

;; UTF8 å­—ç¬¦ã€‚
(prefer-coding-system 'utf-8)
(setq locale-coding-system 'utf-8
      default-buffer-file-coding-system 'utf-8)
(set-buffer-file-coding-system 'utf-8)
(set-language-environment "UTF-8")
(setq-default buffer-file-coding-system 'utf8)
(set-default-coding-systems 'utf-8)
(setenv "LC_ALL" "zh_CN.UTF-8")
#+end_src

buffer/file:

#+begin_src emacs-lisp
(use-package ibuffer
  :config
  (setq ibuffer-expert t)
  (setq ibuffer-use-other-window nil)
  (setq ibuffer-movement-cycle nil)
  (setq ibuffer-default-sorting-mode 'recency)
  (setq ibuffer-use-header-line t)
  (add-hook 'ibuffer-mode-hook #'hl-line-mode)
  (global-set-key (kbd "C-x C-b") #'ibuffer))

;; ä¿å­˜ Buffer æ—¶è‡ªåŠ¨æ›´æ–° #+LASTMOD: æ—¶é—´æˆ³ã€‚
(setq time-stamp-start "#\\+\\(LASTMOD\\|lastmod\\):[ \t]*")
(setq time-stamp-end "$")
(setq time-stamp-format "%Y-%m-%dT%02H:%02m:%02S%5z")
;; #+LASTMOD: å¿…é¡»ä½äºæ–‡ä»¶å¼€å¤´çš„ line-limit è¡Œå†…, å¦åˆ™è‡ªåŠ¨æ›´æ–°ä¸ç”Ÿæ•ˆã€‚
(setq time-stamp-line-limit 30)
(add-hook 'before-save-hook 'time-stamp t)

;; ä»¥ä¸‹è‡ªå®šä¹‰å‡½æ•°å‚è€ƒè‡ªï¼šhttps://github.com/jiacai2050/dotfiles/blob/master/.config/emacs/i-edit.el
(defun my/json-format ()
  (interactive)
  (save-excursion
    (if mark-active
        (json-pretty-print (mark) (point))
      (json-pretty-print-buffer))))

(defun my/delete-file-and-buffer (buffername)
  "Delete the file visited by the buffer named BUFFERNAME."
  (interactive "bDelete file")
  (let* ((buffer (get-buffer buffername))
         (filename (buffer-file-name buffer)))
    (when filename
      (delete-file filename)
      (message "Deleted file %s" filename)
      (kill-buffer))))

(defun my/diff-buffer-with-file ()
  "Compare the current modified buffer with the saved version."
  (interactive)
  (let ((diff-switches "-u")) ;; unified diff
    (diff-buffer-with-file (current-buffer))
    (other-window 1)))

(defun my/copy-current-filename-to-clipboard ()
  "Copy `buffer-file-name' to system clipboard."
  (interactive)
  (let ((filename (if-let (f buffer-file-name)
                      f
                    default-directory)))
    (if filename
        (progn
          (message (format "Copying %s to clipboard..." filename))
          (kill-new filename))
      (message "Not a file..."))))

;; https://gitlab.com/skybert/my-little-friends/-/blob/2022-emacs-from-scratch/emacs/.emacs
;; Rename current buffer, as well as doing the related version control commands to
;; rename the file.
(defun my/rename-this-buffer-and-file ()
  "Renames current buffer and file it is visiting."
  (interactive)
  (let ((filename (buffer-file-name)))
    (if (not (and filename (file-exists-p filename)))
        (message "Buffer is not visiting a file!")
      (let ((new-name (read-file-name "New name: " filename)))
        (cond
         ((vc-backend filename) (vc-rename-file filename new-name))
         (t
          (rename-file filename new-name t)
          (rename-buffer new-name)
          (set-visited-file-name new-name)
          (set-buffer-modified-p nil)
          (message
           "File '%s' successfully renamed to '%s'"
           filename
           (file-name-nondirectory new-name))))))))
(global-set-key (kbd "C-x C-r") 'my/rename-this-buffer-and-file)
#+end_src

C-a/C-e ç§»åŠ¨åˆ°è¡Œæˆ–ä»£ç çš„å¼€å¤´ã€ç»“å°¾ï¼š

#+begin_src emacs-lisp
(use-package mwim
  :config
  (define-key global-map [remap move-beginning-of-line] #'mwim-beginning-of-code-or-line)
  (define-key global-map [remap move-end-of-line] #'mwim-end-of-code-or-line))
#+end_src

å¢é‡æ‰©å±•é€‰æ‹©çš„åŒºåŸŸï¼š

#+begin_src emacs-lisp
(use-package expand-region
  :config
  (global-set-key (kbd "C-=") #'er/expand-region))
#+end_src

è‡ªåŠ¨å¤‡ä»½:

#+begin_src emacs-lisp
(defvar backup-dir (expand-file-name "~/.emacs.d/backup/"))
(if (not (file-exists-p backup-dir))
    (make-directory backup-dir t))
;; æ–‡ä»¶ç¬¬ä¸€æ¬¡ä¿å­˜æ—¶å¤‡ä»½ã€‚
(setq make-backup-files t)
(setq backup-by-copying t)
;; ä¸å¤‡ä»½ tramp æ–‡ä»¶ï¼Œå…¶å®ƒæ–‡ä»¶éƒ½ä¿å­˜åˆ° backup-dir, https://stackoverflow.com/a/22077775
(setq backup-directory-alist `((,tramp-file-name-regexp . nil) (".*" . ,backup-dir)))
;; å¤‡ä»½æ–‡ä»¶æ—¶ä½¿ç”¨ç‰ˆæœ¬å·ã€‚
(setq version-control t)
;; åˆ é™¤è¿‡å¤šçš„ç‰ˆæœ¬ã€‚
(setq delete-old-versions t)
(setq kept-new-versions 6)
(setq kept-old-versions 2)
;; ä¸å¤‡ä»½ç‰ˆæœ¬æ§åˆ¶çš„æ–‡ä»¶.
(setq vc-make-backup-files nil)

(defvar autosave-dir (expand-file-name "~/.emacs.d/autosave/"))
(if (not (file-exists-p autosave-dir))
    (make-directory autosave-dir t))

;; auto-save è®¿é—®çš„æ–‡ä»¶ã€‚
(setq auto-save-default t)
(setq auto-save-list-file-prefix autosave-dir)
(setq auto-save-file-name-transforms `((".*" ,autosave-dir t)))
(setq kill-buffer-delete-auto-save-files t)
(setq auto-save-include-big-deletions t)
#+end_src

Emacs 30 xwidget-webkit å¯¹ Mac æ”¯æŒä¸å¥½( [[https://github.com/d12frosted/homebrew-emacs-plus/issues/519][Better support for xwidget-webkit]]), éƒ¨åˆ†åŠŸèƒ½åªæœ‰ GTK/X11æ‰
æ”¯æŒ, å¦‚: buffer å†…æœç´¢ increase-search/webkit-history:
+ å¦‚æœè¦å¤åˆ¶ xwidget çš„å†…å®¹ï¼Œéœ€è¦é€‰æ‹©åå³å‡»ï¼Œä»ä¸Šä¸‹æ–‡èœå•ä¸­é€‰æ‹© copyã€‚
+ å¦‚æœ window çª—å£è¾ƒå°ï¼Œå¯ä»¥æŒ‰ a æ¥è‡ªåŠ¨è°ƒæ•´ï¼ˆå¯¹åº” xwidget-webkit-adjust-size-dispatch å‘½ä»¤ï¼‰ã€‚
#+begin_src emacs-lisp
(setq url-user-agent
      "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/94.0.4606.71 Safari/537.36")
(setq xwidget-webkit-buffer-name-format "*webkit* [%T] - %U")
(setq xwidget-webkit-enable-plugins t)
(setq browse-url-firefox-program "/Applications/Firefox.app/Contents/MacOS/firefox")
;; browse-url-firefox, browse-url-default-macosx-browser
(setq browse-url-browser-function 'xwidget-webkit-browse-url)
(setq xwidget-webkit-cookie-file "~/.emacs.d/cookie.txt")

(add-hook 'xwidget-webkit-mode-hook
          (lambda ()
            ;;(setq kill-buffer-query-functions nil)
            (setq header-line-format nil)
            (display-line-numbers-mode 0)
            ;;(local-set-key "q" (lambda () (interactive) (kill-this-buffer)))
            (local-set-key (kbd "C-t") (lambda () (interactive) (xwidget-webkit-browse-url "https://google.com" t)))))

(defun my/browser-open-at-point (url)
  (interactive
   (list (let ((url (thing-at-point 'url)))
           (if (equal major-mode 'xwidget-webkit-mode)
               (read-string "url: " (xwidget-webkit-uri (xwidget-webkit-current-session)))
             (read-string "url: " url)))))
  (xwidget-webkit-browse-url url t))

(defun my/browser-search (query)
  (interactive "ssearch: ")
  (xwidget-webkit-browse-url
   (concat "https://duckduckgo.com?q=" (string-replace " " "%20" query)) t))

(define-prefix-command 'my-browser-prefix)
(global-set-key (kbd "C-c o") 'my-browser-prefix)
(define-key my-browser-prefix (kbd "o") 'my/browser-open-at-point)
(define-key my-browser-prefix (kbd "s") 'my/browser-search)

;; https://github.com/syl20bnr/spacemacs/issues/6587#issuecomment-232890021
;; make these keys behave like normal browser
(require 'xwidget)
(define-key xwidget-webkit-mode-map [mouse-4] 'xwidget-webkit-scroll-down)
(define-key xwidget-webkit-mode-map [mouse-5] 'xwidget-webkit-scroll-up)
(define-key xwidget-webkit-mode-map (kbd "<up>") 'xwidget-webkit-scroll-down)
(define-key xwidget-webkit-mode-map (kbd "<down>") 'xwidget-webkit-scroll-up)
(define-key xwidget-webkit-mode-map (kbd "M-w") 'xwidget-webkit-copy-selection-as-kill)
(define-key xwidget-webkit-mode-map (kbd "C-c") 'xwidget-webkit-copy-selection-as-kill)

;; è‡ªåŠ¨è°ƒæ•´ xwidget-webkit çª—å£å¤§å°ï¼ˆä¹Ÿå¯ä»¥æ‰‹åŠ¨æŒ‰ a æ¥è°ƒæ•´ï¼‰ã€‚
(add-hook 'window-configuration-change-hook
	  (lambda ()
	    (when (equal major-mode 'xwidget-webkit-mode)
	      (xwidget-webkit-adjust-size-dispatch))))

;; make xwidget default browser
(setq browse-url-browser-function
      (lambda (url session)
	(other-window 1)
	(xwidget-webkit-browse-url url)))
#+end_src

åœ¨çº¿æ–‡æ¡£å’Œç¿»è¯‘:

#+begin_src emacs-lisp
;;åœ¨çº¿æœç´¢, å…ˆé€‰ä¸­ region å†æ‰§è¡Œæœç´¢ã€‚
(use-package engine-mode
  :config
  (engine/set-keymap-prefix (kbd "C-c s"))
  (engine-mode t)
  ;;(setq engine/browser-function 'eww-browse-url)
  (setq engine/browser-function 'xwidget-webkit-browse-url)
  (defengine github "https://github.com/search?ref=simplesearch&q=%s" :keybinding "h")
  (defengine google "https://google.com/search?q=%s" :keybinding "g"))

;; Google ç¿»è¯‘
(use-package google-translate
  :config
  ;; C-n/p åˆ‡æ¢ç¿»è¯‘ç±»å‹ã€‚
  (setq google-translate-translation-directions-alist
        '(("en" . "zh-CN") ("zh-CN" . "en")))
  (global-set-key (kbd "C-c d t") #'google-translate-smooth-translate))
#+end_src

MacOS äº’æ“ä½œ:
+ osx-trash ä¸æ”¯æŒ TRAMP åˆ é™¤è¿œç¨‹æ–‡ä»¶ï¼Œè§£å†³åŠæ³•ï¼šç”¨ %m æ ‡è®°æ–‡ä»¶ï¼Œç„¶åæŒ‰ ! æ‰§è¡Œ rm å‘½
  ä»¤ã€‚
+ åœ¨ finder ä¸­æ‰“å¼€å½“å‰æ–‡ä»¶æˆ–ç›®å½•ï¼šM-! åæ‰§è¡Œå‘½ä»¤ï¼š =open .=

#+begin_src emacs-lisp
;; åˆ é™¤æ–‡ä»¶æ—¶, å°†æ–‡ä»¶ç§»åŠ¨åˆ°å›æ”¶ç«™ã€‚
(use-package osx-trash
  :config
  (when (eq system-type 'darwin)
    (osx-trash-setup))
  (setq-default delete-by-moving-to-trash t))

;; åœ¨ Finder ä¸­æ‰“å¼€å½“å‰æ–‡ä»¶ã€‚
(use-package reveal-in-osx-finder
  :commands (reveal-in-osx-finder))
#+end_src

å¸®åŠ©å¢å¼º:

#+begin_src emacs-lisp
;; åœ¨å¸®åŠ©æ–‡æ¡£åº•éƒ¨æ˜¾ç¤º lisp demo.
(use-package elisp-demos
  :config
  (advice-add 'describe-function-1 :after #'elisp-demos-advice-describe-function-1)
  (advice-add 'helpful-update :after #'elisp-demos-advice-helpful-update))

;; ç›¸æ¯” Emacs å†…ç½® Help, æä¾›æ›´å¤šä¸Šä¸‹æ–‡ä¿¡æ¯ã€‚
(use-package helpful
  :config
  (global-set-key (kbd "C-h f") #'helpful-callable)
  (global-set-key (kbd "C-h v") #'helpful-variable)
  (global-set-key (kbd "C-h k") #'helpful-key)
  (global-set-key (kbd "C-c C-d") #'helpful-at-point)
  (global-set-key (kbd "C-h F") #'helpful-function)
  (global-set-key (kbd "C-h C") #'helpful-command))
#+end_src

* pdf

å®‰è£…ä¾èµ–ï¼š
#+begin_src shell :tangle no
brew install poppler automake mupdf
#+end_src

é…ç½® pdf-toolsï¼š
#+begin_src emacs-lisp
(use-package pdf-tools
  ;; :ensure-system-package
  ;; ((pdfinfo . poppler)
  ;;  (automake . automake)
  ;;  (mutool . mupdf)
  ;;  ("/usr/local/opt/zlib" . zlib))
  :init
  ;; ä½¿ç”¨ scaling ç¡®ä¿ä¸­æ–‡å­—ä½“ä¸æ¨¡ç³Š
  (setq pdf-view-use-scaling t)
  (setq pdf-view-use-imagemagick nil)
  (setq pdf-annot-activate-created-annotations t)
  (setq pdf-view-resize-factor 1.1)
  (setq-default pdf-view-display-size 'fit-page)
  (setq pdf-annot-activate-created-annotations t)
  :hook
  ((pdf-view-mode . pdf-view-themed-minor-mode)
   (pdf-view-mode . pdf-view-auto-slice-minor-mode)
   (pdf-view-mode . pdf-isearch-minor-mode))
  :config
  (define-key pdf-view-mode-map (kbd "C-s") 'isearch-forward)
  ;;(add-hook 'pdf-view-mode-hook (lambda() (linum-mode -1)))
  (setq pdf-info-epdfinfo-program "/opt/homebrew/bin/epdfinfo")
  (setenv "PKG_CONFIG_PATH" "/opt/homebrew/opt/zlib/lib/pkgconfig:/opt/homebrew/opt/pkgconfig:/opt/homebrew/lib/pkgconfig")
  (pdf-tools-install))

;; pdf è½¬ä¸º png æ—¶ä½¿ç”¨æ›´é«˜åˆ†è¾¨ç‡ï¼ˆé»˜è®¤ 90ï¼‰ã€‚
(setq doc-view-resolution 144)

;;(use-package org-noter)
#+end_src

+ pdf-tools é»˜è®¤æ˜¯ç™½åº•é»‘å­—ï¼Œå¯ä»¥ï¼š
  + æ·±è‰²æ¨¡å¼ï¼š =M-x pdf-view-midnight-minor-mode=
  + ä¸»é¢˜æ¨¡å¼ï¼š =M-x pdf-view-themed-minor-mode=
+ æœç´¢ä¸­æ–‡æ—¶ï¼Œéœ€è¦ä½¿ç”¨ç³»ç»Ÿä¸­æ–‡è¾“å…¥æ³•å’Œ isearch æ¨¡å¼, æˆ–è€…ä½¿ç”¨ =M-s o(occur)= ï¼›

* refs
:PROPERTIES:
:ANKI_NOTE_HASH: 64901ec4f38ae35f38b42523c75cb9ea
:ANKI_NOTE_ID: 1703514360198
:END:

æœ¬é…ç½®å‚è€ƒäº†ä»¥ä¸‹ä»“åº“ä»£ç ï¼š

1. [[https://github.com/seagle0128/.emacs.d][seagle0128/.emacs.d]]
2. [[https://gitlab.com/protesilaos/dotfiles][protesilaos/dotfiles]]
3. [[https://github.com/bbatsov/prelude][bbatsov/prelude]]
4. [[https://github.com/MatthewZMD/.emacs.d][MatthewZMD/.emacs.d]]
5. [[https://github.com/condy0919/.emacs.d][condy0919/.emacs.d]]
6. [[https://github.com/manateelazycat/lazycat-emacs][manateelazycat/lazycat-emacs]]
7. [[https://github.com/jiacai2050/dotfiles][jiacai2050/dotfiles]]
8. [[https://github.com/natecox/dotfiles/][natecox/dotfiles]]
9. [[https://config.daviwil.com/emacs][daviwil]]
10. [[https://gitlab.com/skybert/my-little-friends/-/blob/master/emacs/.emacs][skybert/my-little-friends]]
11. [[https://github.com/casouri/lunarymacs/commits/master][casouri/lunarymacs]]
